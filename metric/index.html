<!DOCTYPE html>
<html lang="zh">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
<title>metric - Joe|博客</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



    <meta name="description" content="1 介绍 Gauges Meters Histograms Timers   2 源码包分析 metrics-annotation metrics-benchmarks metrics-collectd metrics-core CachedGauge.java Clock.java Counter.java Reservoir.java Histogram.java MetricName.j">
<meta name="keywords" content="源码,开源项目">
<meta property="og:type" content="article">
<meta property="og:title" content="metric">
<meta property="og:url" content="https://joeskye1701.github.io/metric/index.html">
<meta property="og:site_name" content="Joe|博客">
<meta property="og:description" content="1 介绍 Gauges Meters Histograms Timers   2 源码包分析 metrics-annotation metrics-benchmarks metrics-collectd metrics-core CachedGauge.java Clock.java Counter.java Reservoir.java Histogram.java MetricName.j">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-10-23T04:21:56.858Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="metric">
<meta name="twitter:description" content="1 介绍 Gauges Meters Histograms Timers   2 源码包分析 metrics-annotation metrics-benchmarks metrics-collectd metrics-core CachedGauge.java Clock.java Counter.java Reservoir.java Histogram.java MetricName.j">





<link rel="icon" href="/images/thank-you-kobe.jpg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/xcode.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    

    
    
<script>
var _hmt = _hmt || [];
(function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?c422b171d3bdb7dbfae47ff3f70f9d30";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();
</script>

    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    
    
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                Joe|博客
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item" href="/">主页</a>
                
                <a class="navbar-item" href="/archives">归档</a>
                
                <a class="navbar-item" href="/categories">分类</a>
                
                <a class="navbar-item" href="/tags">标签</a>
                
                <a class="navbar-item" href="/about">关于</a>
                
            </div>
            
            <div class="navbar-end">
                
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-6-widescreen has-order-2 column-main"><div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2017-01-04T04:37:22.000Z">2017-01-04</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/开源项目/">开源项目</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    2 小时 读完 (大约 18072 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                metric
            
        </h1>
        <div class="content">
            <!-- TOC -->
<ul>
<li><a href="#1-介绍">1 介绍</a><ul>
<li><a href="#gauges">Gauges</a></li>
<li><a href="#meters">Meters</a></li>
<li><a href="#histograms">Histograms</a></li>
<li><a href="#timers">Timers</a></li>
</ul>
</li>
<li><a href="#2-源码包分析">2 源码包分析</a><ul>
<li><a href="#metrics-annotation">metrics-annotation</a></li>
<li><a href="#metrics-benchmarks">metrics-benchmarks</a></li>
<li><a href="#metrics-collectd">metrics-collectd</a></li>
<li><a href="#metrics-core">metrics-core</a><ul>
<li><a href="#cachedgaugejava">CachedGauge.java</a></li>
<li><a href="#clockjava">Clock.java</a></li>
<li><a href="#counterjava">Counter.java</a></li>
<li><a href="#reservoirjava">Reservoir.java</a></li>
<li><a href="#histogramjava">Histogram.java</a></li>
<li><a href="#metricnamejava">MetricName.java</a></li>
<li><a href="#metricregistryjava">MetricRegistry.java</a></li>
<li><a href="#snapshotjava">Snapshot.java</a></li>
<li><a href="#instrumentedexecutorsjava">InstrumentedExecutors.java</a></li>
<li><a href="#instrumentedthreadfactoryjava">InstrumentedThreadFactory.java</a></li>
<li><a href="#instrumentedexecutorservicejava">InstrumentedExecutorService.java</a></li>
<li><a href="#instrumentedscheduledexecutorservicejava">InstrumentedScheduledExecutorService.java</a></li>
</ul>
</li>
<li><a href="#metrics-healthchecks">metrics-healthchecks</a><ul>
<li><a href="#healthcheckjava">HealthCheck.java</a></li>
<li><a href="#healthcheckregistryjava">HealthCheckRegistry.java</a></li>
<li><a href="#sharedhealthcheckregistriesjava">SharedHealthCheckRegistries.java</a></li>
<li><a href="#threaddeadlockhealthcheckjava">ThreadDeadlockHealthCheck.java</a></li>
</ul>
</li>
<li><a href="#metrics-httpclient">metrics-httpclient</a><ul>
<li><a href="#httpclientmetricnamestrategiesjava">HttpClientMetricNameStrategies.java</a></li>
<li><a href="#httpclientmetricnamestrategyjava">HttpClientMetricNameStrategy.java</a></li>
<li><a href="#instrumentedhttpclientconnectionmanagerjava">InstrumentedHttpClientConnectionManager.java</a></li>
<li><a href="#instrumentedhttprequestexecutorjava">InstrumentedHttpRequestExecutor.java</a></li>
<li><a href="#instrumentedhttpclientsjava">InstrumentedHttpClients.java</a></li>
</ul>
</li>
<li><a href="#metrics-jvm">metrics-jvm</a><ul>
<li><a href="#bufferpoolmetricsetjava">BufferPoolMetricSet.java</a></li>
<li><a href="#cachedthreadstatesgaugesetjava">CachedThreadStatesGaugeSet.java</a></li>
<li><a href="#classloadinggaugesetjava">ClassLoadingGaugeSet.java</a></li>
<li><a href="#filedescriptorratiogaugejava">FileDescriptorRatioGauge.java</a></li>
<li><a href="#garbagecollectormetricsetjava">GarbageCollectorMetricSet.java</a></li>
<li><a href="#memoryusagegaugesetjava">MemoryUsageGaugeSet.java</a></li>
<li><a href="#threaddeadlockdetectorjava">ThreadDeadlockDetector.java</a></li>
<li><a href="#threaddumpjava">ThreadDump.java</a></li>
<li><a href="#threadstatesgaugesetjava">ThreadStatesGaugeSet.java</a></li>
</ul>
</li>
<li><a href="#metrics-servlet">metrics-servlet</a><ul>
<li><a href="#abstractinstrumentedfilterjava">AbstractInstrumentedFilter.java</a></li>
<li><a href="#instrumentedfilterjava">InstrumentedFilter.java</a></li>
<li><a href="#instrumentedfiltercontextlistenerjava">InstrumentedFilterContextListener.java</a></li>
</ul>
</li>
<li><a href="#metrics-servlets">metrics-servlets</a><ul>
<li><a href="#adminservletjava">AdminServlet.java</a></li>
<li><a href="#cpuprofileservletjava">CpuProfileServlet.java</a></li>
<li><a href="#healthcheckservletjava">HealthCheckServlet.java</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h1 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1 介绍"></a>1 介绍</h1><p>Metrics Registries类似一个metrics容器，维护一个Map，可以是一个服务一个实例。支持五种metric类型：Gauges、Counters、Meters、Histograms和Timers。<br>git:<a href="https://github.com/dropwizard/metrics" target="_blank" rel="noopener">https://github.com/dropwizard/metrics</a></p>
<h2 id="Gauges"><a href="#Gauges" class="headerlink" title="Gauges"></a>Gauges</h2><p>Gauges是一个最简单的计量，一般用来统计瞬时状态的数据信息，比如系统中处于pending状态的job</p>
<h2 id="Meters"><a href="#Meters" class="headerlink" title="Meters"></a>Meters</h2><p>Meters用来度量某个时间段的平均处理次数（request per second），每1、5、15分钟的TPS。比如一个service的请求数，通过metrics.meter()实例化一个Meter之后，然后通过 meter.mark()方法就能将本次请求记录下来。统计结果有总的请求数，平均每秒的请求数，以及最近的1、5、15分钟的平均TPS。</p>
<h2 id="Histograms"><a href="#Histograms" class="headerlink" title="Histograms"></a>Histograms</h2><p>Histograms主要使用来统计数据的分布情况，最大值、最小值、平均值、中位数，百分比（75%、90%、95%、98%、99%和99.9%）。例如，需要统计某个页面的请求响应时间分布情况，可以使用该种类型的Metrics进行统计。</p>
<h2 id="Timers"><a href="#Timers" class="headerlink" title="Timers"></a>Timers</h2><p>Timers主要是用来统计某一块代码段的执行时间以及其分布情况，具体是基于Histograms和Meters来实现的。</p>
<a id="more"></a>
<h1 id="2-源码包分析"><a href="#2-源码包分析" class="headerlink" title="2 源码包分析"></a>2 源码包分析</h1><h2 id="metrics-annotation"><a href="#metrics-annotation" class="headerlink" title="metrics-annotation"></a>metrics-annotation</h2><p>Counted，Gauge，Metered，Metric，Timed注解的方式设置name，tags</p>
<h2 id="metrics-benchmarks"><a href="#metrics-benchmarks" class="headerlink" title="metrics-benchmarks"></a>metrics-benchmarks</h2><p>Counter标准</p>
<h2 id="metrics-collectd"><a href="#metrics-collectd" class="headerlink" title="metrics-collectd"></a>metrics-collectd</h2><p>Collectd - 收集服务客服端<br>打开InetSocketAddress，通过DatagramChannel发送字节数据。</p>
<h2 id="metrics-core"><a href="#metrics-core" class="headerlink" title="metrics-core"></a>metrics-core</h2><p>核心类包</p>
<h3 id="CachedGauge-java"><a href="#CachedGauge-java" class="headerlink" title="CachedGauge.java"></a>CachedGauge.java</h3><p>gauge缓存抽象类<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * A &#123;<span class="hljs-doctag">@link</span> Gauge&#125; implementation which caches its value for a period of time.</span></span><br><span class="line"><span class="hljs-comment"> * gauge 的 缓存</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &lt;T&gt;    the type of the gauge's value</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CachedGauge</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">Gauge</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Clock clock;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicLong reloadAt;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> timeoutNS;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> T value;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a new cached gauge with the given timeout period.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> timeout        the timeout</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> timeoutUnit    the unit of &#123;<span class="hljs-doctag">@code</span> timeout&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">CachedGauge</span><span class="hljs-params">(<span class="hljs-keyword">long</span> timeout, TimeUnit timeoutUnit)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>(Clock.defaultClock(), timeout, timeoutUnit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a new cached gauge with the given clock and timeout period.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> clock          the clock used to calculate the timeout</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> timeout        the timeout</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> timeoutUnit    the unit of &#123;<span class="hljs-doctag">@code</span> timeout&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">CachedGauge</span><span class="hljs-params">(Clock clock, <span class="hljs-keyword">long</span> timeout, TimeUnit timeoutUnit)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.clock = clock;</span><br><span class="line">        <span class="hljs-keyword">this</span>.reloadAt = <span class="hljs-keyword">new</span> AtomicLong(<span class="hljs-number">0</span>);</span><br><span class="line">        <span class="hljs-keyword">this</span>.timeoutNS = timeoutUnit.toNanos(timeout);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Loads the value and returns it.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * 读取缓存数据</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the new value</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> T <span class="hljs-title">loadValue</span><span class="hljs-params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (shouldLoad()) &#123;</span><br><span class="line">            <span class="hljs-comment">//从缓存获取数据</span></span><br><span class="line">            <span class="hljs-keyword">this</span>.value = loadValue();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">shouldLoad</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">for</span> (; ; ) &#123;</span><br><span class="line">            <span class="hljs-comment">//系统时间</span></span><br><span class="line">            <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> time = clock.getTick();</span><br><span class="line">            <span class="hljs-comment">//缓存时间</span></span><br><span class="line">            <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> current = reloadAt.get();</span><br><span class="line">            <span class="hljs-comment">//缓存时间 &gt; 系统时间 ，获取缓存</span></span><br><span class="line">            <span class="hljs-keyword">if</span> (current &gt; time) &#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-comment">//更新缓存数据，重新设置缓存超时时间</span></span><br><span class="line">            <span class="hljs-keyword">if</span> (reloadAt.compareAndSet(current, time + timeoutNS)) &#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> String.valueOf(<span class="hljs-keyword">this</span>.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Clock-java"><a href="#Clock-java" class="headerlink" title="Clock.java"></a>Clock.java</h3><p>抽象的时间类<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.ManagementFactory;</span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.ThreadMXBean;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * An abstraction for how time passes. It is passed to &#123;<span class="hljs-doctag">@link</span> Timer&#125; to track timing.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * 抽象的时间类</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Clock</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns the current time tick.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> time tick in nanoseconds</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getTick</span><span class="hljs-params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns the current time in milliseconds.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> time in milliseconds</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getTime</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> Long.toString(<span class="hljs-keyword">this</span>.getTime());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Clock DEFAULT = <span class="hljs-keyword">new</span> UserTimeClock();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * The default clock to use.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the default &#123;<span class="hljs-doctag">@link</span> Clock&#125; instance</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Clock.UserTimeClock</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Clock <span class="hljs-title">defaultClock</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * A clock implementation which returns the current time in epoch nanoseconds.</span></span><br><span class="line"><span class="hljs-comment">     * 系统时间</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserTimeClock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Clock</span> </span>&#123;</span><br><span class="line">        <span class="hljs-meta">@Override</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getTick</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> System.nanoTime();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * A clock implementation which returns the current thread's CPU time.</span></span><br><span class="line"><span class="hljs-comment">     * 返回当前CPU时间</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CpuTimeClock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Clock</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadMXBean THREAD_MX_BEAN = ManagementFactory.getThreadMXBean();</span><br><span class="line"></span><br><span class="line">        <span class="hljs-meta">@Override</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getTick</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> THREAD_MX_BEAN.getCurrentThreadCpuTime();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Counter-java"><a href="#Counter-java" class="headerlink" title="Counter.java"></a>Counter.java</h3><p>计数抽象类<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * An incrementing and decrementing counter metric.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Counter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Metric</span>, <span class="hljs-title">Counting</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 原子自增</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LongAdder count;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Counter</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.count = LongAdderFactory.create();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Increment the counter by one.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">inc</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        inc(<span class="hljs-number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Increment the counter by &#123;<span class="hljs-doctag">@code</span> n&#125;.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> n the amount by which the counter will be increased</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">inc</span><span class="hljs-params">(<span class="hljs-keyword">long</span> n)</span> </span>&#123;</span><br><span class="line">        count.add(n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Decrement the counter by one.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">dec</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        dec(<span class="hljs-number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Decrement the counter by &#123;<span class="hljs-doctag">@code</span> n&#125;.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> n the amount by which the counter will be decreased</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">dec</span><span class="hljs-params">(<span class="hljs-keyword">long</span> n)</span> </span>&#123;</span><br><span class="line">        count.add(-n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns the counter's current value.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the counter's current value</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getCount</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> count.sum();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> String.valueOf(<span class="hljs-keyword">this</span>.count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Reservoir-java"><a href="#Reservoir-java" class="headerlink" title="Reservoir.java"></a>Reservoir.java</h3><p>统计存储层的数据流，数据流处理<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * A statistically representative reservoir of a data stream.</span></span><br><span class="line"><span class="hljs-comment"> * 统计代表储层数据流</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Reservoir</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns the number of values recorded.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the number of values recorded</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">size</span><span class="hljs-params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Adds a new recorded value to the reservoir.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> value a new recorded value</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">update</span><span class="hljs-params">(<span class="hljs-keyword">long</span> value)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns a snapshot of the reservoir's values.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> a snapshot of the reservoir's values</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function">Snapshot <span class="hljs-title">getSnapshot</span><span class="hljs-params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Histogram-java"><a href="#Histogram-java" class="headerlink" title="Histogram.java"></a>Histogram.java</h3><p>直方图<br>实现：快照，Counting接口<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="hljs-keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="hljs-keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * A metric which calculates the distribution of a value.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * 计算分布式数据的值</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> &lt;a href="http://www.johndcook.com/standard_deviation.html"&gt;Accurately computing running</span></span><br><span class="line"><span class="hljs-comment"> *      variance&lt;/a&gt;</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Histogram</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Metric</span>, <span class="hljs-title">Sampling</span>, <span class="hljs-title">Counting</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 数据流</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Reservoir reservoir;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LongAdder count;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a new &#123;<span class="hljs-doctag">@link</span> Histogram&#125; with the given reservoir.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> reservoir the reservoir to create a histogram from</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Histogram</span><span class="hljs-params">(Reservoir reservoir)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.reservoir = reservoir;</span><br><span class="line">        <span class="hljs-keyword">this</span>.count = LongAdderFactory.create();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Adds a recorded value.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> value the length of the value</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">update</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        update((<span class="hljs-keyword">long</span>) value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Adds a recorded value.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> value the length of the value</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">update</span><span class="hljs-params">(<span class="hljs-keyword">long</span> value)</span> </span>&#123;</span><br><span class="line">        count.increment();</span><br><span class="line">        reservoir.update(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns the number of values recorded.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the number of values recorded</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getCount</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> count.sum();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 从数据流中获取快照</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> Snapshot <span class="hljs-title">getSnapshot</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> reservoir.getSnapshot();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> ByteArrayOutputStream out = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="hljs-keyword">this</span>.getSnapshot().dump(out);</span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> out.toString(StandardCharsets.UTF_8.name());</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="MetricName-java"><a href="#MetricName-java" class="headerlink" title="MetricName.java"></a>MetricName.java</h3><p>设置metric的名字，tag<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Map;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Set;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.TreeSet;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * A metric name with the ability to include semantic tags.</span></span><br><span class="line"><span class="hljs-comment"> * 度量的名字，可能包含的标签</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * This replaces the previous style where metric names where strictly</span></span><br><span class="line"><span class="hljs-comment"> * dot-separated strings.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> udoprog</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MetricName</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Comparable</span>&lt;<span class="hljs-title">MetricName</span>&gt; </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SEPARATOR = <span class="hljs-string">"."</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, String&gt; EMPTY_TAGS = Collections.unmodifiableMap(<span class="hljs-keyword">new</span> HashMap&lt;String, String&gt;());</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> MetricName EMPTY = <span class="hljs-keyword">new</span> MetricName();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String key;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, String&gt; tags;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MetricName</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.key = <span class="hljs-keyword">null</span>;</span><br><span class="line">        <span class="hljs-keyword">this</span>.tags = EMPTY_TAGS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MetricName</span><span class="hljs-params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.key = key;</span><br><span class="line">        <span class="hljs-keyword">this</span>.tags = EMPTY_TAGS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MetricName</span><span class="hljs-params">(String key, Map&lt;String, String&gt; tags)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.key = key;</span><br><span class="line">        <span class="hljs-keyword">this</span>.tags = checkTags(tags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> Map&lt;String, String&gt; <span class="hljs-title">checkTags</span><span class="hljs-params">(Map&lt;String, String&gt; tags)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (tags == <span class="hljs-keyword">null</span> || tags.isEmpty()) &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> EMPTY_TAGS;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> Collections.unmodifiableMap(tags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getKey</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, String&gt; <span class="hljs-title">getTags</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> tags;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 重新构建metric的name</span></span><br><span class="line"><span class="hljs-comment">     * Build the MetricName that is this with another path appended to it.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * The new MetricName inherits the tags of this one.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> p The extra path element to add to the new metric.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> A new metric name relative to the original by the path specified</span></span><br><span class="line"><span class="hljs-comment">     *         in p.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> MetricName <span class="hljs-title">resolve</span><span class="hljs-params">(String p)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> String next;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (p != <span class="hljs-keyword">null</span> &amp;&amp; !p.isEmpty()) &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (key != <span class="hljs-keyword">null</span> &amp;&amp; !key.isEmpty()) &#123;</span><br><span class="line">                next = key + SEPARATOR + p;</span><br><span class="line">            &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                next = p;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            next = <span class="hljs-keyword">this</span>.key;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MetricName(next, tags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Add tags to a metric name and return the newly created MetricName.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> add Tags to add.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> A newly created metric name with the specified tags associated with it.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> MetricName <span class="hljs-title">tagged</span><span class="hljs-params">(Map&lt;String, String&gt; add)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> Map&lt;String, String&gt; tags = <span class="hljs-keyword">new</span> HashMap&lt;String, String&gt;(add);</span><br><span class="line">        tags.putAll(<span class="hljs-keyword">this</span>.tags);</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MetricName(key, tags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Same as &#123;<span class="hljs-doctag">@link</span> #tagged(Map)&#125;, but takes a variadic list</span></span><br><span class="line"><span class="hljs-comment">     * of arguments.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> #tagged(Map)</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pairs An even list of strings acting as key-value pairs.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> A newly created metric name with the specified tags associated</span></span><br><span class="line"><span class="hljs-comment">     *         with it.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> MetricName <span class="hljs-title">tagged</span><span class="hljs-params">(String... pairs)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (pairs == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (pairs.length % <span class="hljs-number">2</span> != <span class="hljs-number">0</span>) &#123;</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"Argument count must be even"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">final</span> Map&lt;String, String&gt; add = <span class="hljs-keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; pairs.length; i += <span class="hljs-number">2</span>) &#123;</span><br><span class="line">            add.put(pairs[i], pairs[i+<span class="hljs-number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> tagged(add);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Join the specified set of metric names.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> parts Multiple metric names to join using the separator.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> A newly created metric name which has the name of the specified</span></span><br><span class="line"><span class="hljs-comment">     *         parts and includes all tags of all child metric names.</span></span><br><span class="line"><span class="hljs-comment">     **/</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> MetricName <span class="hljs-title">join</span><span class="hljs-params">(MetricName... parts)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> StringBuilder nameBuilder = <span class="hljs-keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="hljs-keyword">final</span> Map&lt;String, String&gt; tags = <span class="hljs-keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">boolean</span> first = <span class="hljs-keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">for</span> (MetricName part : parts) &#123;</span><br><span class="line">            <span class="hljs-keyword">final</span> String name = part.getKey();</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">if</span> (name != <span class="hljs-keyword">null</span> &amp;&amp; !name.isEmpty()) &#123;</span><br><span class="line">                <span class="hljs-keyword">if</span> (first) &#123;</span><br><span class="line">                    first = <span class="hljs-keyword">false</span>;</span><br><span class="line">                &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                    nameBuilder.append(SEPARATOR);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                nameBuilder.append(name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">if</span> (!part.getTags().isEmpty())</span><br><span class="line">                tags.putAll(part.getTags());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MetricName(nameBuilder.toString(), tags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Build a new metric name using the specific path components.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> parts Path of the new metric name.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> A newly created metric name with the specified path.</span></span><br><span class="line"><span class="hljs-comment">     **/</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> MetricName <span class="hljs-title">build</span><span class="hljs-params">(String... parts)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (parts == <span class="hljs-keyword">null</span> || parts.length == <span class="hljs-number">0</span>)</span><br><span class="line">            <span class="hljs-keyword">return</span> MetricName.EMPTY;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (parts.length == <span class="hljs-number">1</span>)</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MetricName(parts[<span class="hljs-number">0</span>], EMPTY_TAGS);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MetricName(buildName(parts), EMPTY_TAGS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">buildName</span><span class="hljs-params">(String... names)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> StringBuilder builder = <span class="hljs-keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="hljs-keyword">boolean</span> first = <span class="hljs-keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">for</span> (String name : names) &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (name == <span class="hljs-keyword">null</span> || name.isEmpty())</span><br><span class="line">                <span class="hljs-keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">if</span> (first) &#123;</span><br><span class="line">                first = <span class="hljs-keyword">false</span>;</span><br><span class="line">            &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                builder.append(SEPARATOR);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            builder.append(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> builder.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (tags.isEmpty()) &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> key;</span><br><span class="line">            <span class="hljs-comment">//return key + "&#123;&#125;";</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> key + tags;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> prime = <span class="hljs-number">31</span>;</span><br><span class="line">        <span class="hljs-keyword">int</span> result = <span class="hljs-number">1</span>;</span><br><span class="line">        result = prime * result + ((key == <span class="hljs-keyword">null</span>) ? <span class="hljs-number">0</span> : key.hashCode());</span><br><span class="line">        result = prime * result + ((tags == <span class="hljs-keyword">null</span>) ? <span class="hljs-number">0</span> : tags.hashCode());</span><br><span class="line">        <span class="hljs-keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">equals</span><span class="hljs-params">(Object obj)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> == obj)</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (obj == <span class="hljs-keyword">null</span>)</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (getClass() != obj.getClass())</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        MetricName other = (MetricName) obj;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (key == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (other.key != <span class="hljs-keyword">null</span>)</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!key.equals(other.key))</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (!tags.equals(other.tags))</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compareTo</span><span class="hljs-params">(MetricName o)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (o == <span class="hljs-keyword">null</span>)</span><br><span class="line">            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">int</span> c = compareName(key, o.getKey());</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (c != <span class="hljs-number">0</span>)</span><br><span class="line">            <span class="hljs-keyword">return</span> c;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> compareTags(tags, o.getTags());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compareName</span><span class="hljs-params">(String left, String right)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (left == <span class="hljs-keyword">null</span> &amp;&amp; right == <span class="hljs-keyword">null</span>)</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (left == <span class="hljs-keyword">null</span>)</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (right == <span class="hljs-keyword">null</span>)</span><br><span class="line">            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> left.compareTo(right);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compareTags</span><span class="hljs-params">(Map&lt;String, String&gt; left, Map&lt;String, String&gt; right)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (left == <span class="hljs-keyword">null</span> &amp;&amp; right == <span class="hljs-keyword">null</span>)</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (left == <span class="hljs-keyword">null</span>)</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (right == <span class="hljs-keyword">null</span>)</span><br><span class="line">            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">final</span> Iterable&lt;String&gt; keys = uniqueSortedKeys(left, right);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> String key : keys) &#123;</span><br><span class="line">            <span class="hljs-keyword">final</span> String a = left.get(key);</span><br><span class="line">            <span class="hljs-keyword">final</span> String b = right.get(key);</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">if</span> (a == <span class="hljs-keyword">null</span> &amp;&amp; b == <span class="hljs-keyword">null</span>)</span><br><span class="line">                <span class="hljs-keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">if</span> (a == <span class="hljs-keyword">null</span>)</span><br><span class="line">                <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">if</span> (b == <span class="hljs-keyword">null</span>)</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">int</span> c = a.compareTo(b);</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">if</span> (c != <span class="hljs-number">0</span>)</span><br><span class="line">                <span class="hljs-keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> Iterable&lt;String&gt; <span class="hljs-title">uniqueSortedKeys</span><span class="hljs-params">(Map&lt;String, String&gt; left, Map&lt;String, String&gt; right)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> Set&lt;String&gt; set = <span class="hljs-keyword">new</span> TreeSet&lt;String&gt;(left.keySet());</span><br><span class="line">        set.addAll(right.keySet());</span><br><span class="line">        <span class="hljs-keyword">return</span> set;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="MetricRegistry-java"><a href="#MetricRegistry-java" class="headerlink" title="MetricRegistry.java"></a>MetricRegistry.java</h3><p>注册MetricRegistry，构建简单metric类型对象，创建和获取counter,histogram,meter,timer监测的数据。<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.Counter;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.ExponentiallyDecayingReservoir;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.Gauge;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.Histogram;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.Meter;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.Metric;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.MetricFilter;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.MetricRegistry;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.MetricRegistryListener;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.MetricSet;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.Timer;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.util.*;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentMap;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.CopyOnWriteArrayList;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * A registry of metric instances.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * 监测实例：新增监测对象，监测分类</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MetricRegistry</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MetricSet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> #name(String, String...)</span></span><br><span class="line"><span class="hljs-comment">     * 名字</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> MetricName <span class="hljs-title">name</span><span class="hljs-params">(Class&lt;?&gt; klass, String... names)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> name(klass.getName(), names);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Shorthand method for backwards compatibility in creating metric names.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * Uses &#123;<span class="hljs-doctag">@link</span> MetricName#build(String...)&#125; for its</span></span><br><span class="line"><span class="hljs-comment">     * heavy lifting.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> MetricName#build(String...)</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name The first element of the name</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> names The remaining elements of the name</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> A metric name matching the specified components.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> MetricName <span class="hljs-title">name</span><span class="hljs-params">(String name, String... names)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> length;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (names == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            length = <span class="hljs-number">0</span>;</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            length = names.length;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">final</span> String[] parts = <span class="hljs-keyword">new</span> String[length + <span class="hljs-number">1</span>];</span><br><span class="line">        parts[<span class="hljs-number">0</span>] = name;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            parts[i+<span class="hljs-number">1</span>] = names[i];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> MetricName.build(parts);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">//监测tag名字，监测实现类</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentMap&lt;MetricName, Metric&gt; metrics;</span><br><span class="line">    <span class="hljs-comment">//监听对象列表</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;MetricRegistryListener&gt; listeners;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a new &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125;.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MetricRegistry</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>(<span class="hljs-keyword">new</span> ConcurrentHashMap&lt;MetricName, Metric&gt;());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; with a custom &#123;<span class="hljs-doctag">@link</span> ConcurrentMap&#125; implementation for use</span></span><br><span class="line"><span class="hljs-comment">     * inside the registry. Call as the super-constructor to create a &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; with</span></span><br><span class="line"><span class="hljs-comment">     * space- or time-bounded metric lifecycles, for example.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">MetricRegistry</span><span class="hljs-params">(ConcurrentMap&lt;MetricName, Metric&gt; metricsMap)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.metrics = metricsMap;</span><br><span class="line">        <span class="hljs-keyword">this</span>.listeners = <span class="hljs-keyword">new</span> CopyOnWriteArrayList&lt;MetricRegistryListener&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> #register(MetricName, Metric)</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)</span><br><span class="line">    <span class="hljs-keyword">public</span> &lt;T extends Metric&gt; <span class="hljs-function">T <span class="hljs-title">register</span><span class="hljs-params">(String name, T metric)</span> <span class="hljs-keyword">throws</span> IllegalArgumentException </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> register(MetricName.build(name), metric);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Given a &#123;<span class="hljs-doctag">@link</span> Metric&#125;, registers it under the given name.</span></span><br><span class="line"><span class="hljs-comment">     *  注册</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name   the name of the metric</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> metric the metric</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> &lt;T&gt;    the type of the metric</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@code</span> metric&#125;</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException if the name is already registered</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)</span><br><span class="line">    <span class="hljs-keyword">public</span> &lt;T extends Metric&gt; <span class="hljs-function">T <span class="hljs-title">register</span><span class="hljs-params">(MetricName name, T metric)</span> <span class="hljs-keyword">throws</span> IllegalArgumentException </span>&#123;</span><br><span class="line">        <span class="hljs-comment">//注册metric列表</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (metric <span class="hljs-keyword">instanceof</span> MetricSet) &#123;</span><br><span class="line">            registerAll(name, (MetricSet) metric);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            <span class="hljs-comment">//存在metric</span></span><br><span class="line">            <span class="hljs-keyword">final</span> Metric existing = metrics.putIfAbsent(name, metric);</span><br><span class="line">            <span class="hljs-keyword">if</span> (existing == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">                onMetricAdded(name, metric);</span><br><span class="line">            &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"A metric named "</span> + name + <span class="hljs-string">" already exists"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> metric;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Given a metric set, registers them.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> metrics    a set of metrics</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException if any of the names are already registered</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerAll</span><span class="hljs-params">(MetricSet metrics)</span> <span class="hljs-keyword">throws</span> IllegalArgumentException </span>&#123;</span><br><span class="line">        registerAll(<span class="hljs-keyword">null</span>, metrics);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> #counter(MetricName)</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> Counter <span class="hljs-title">counter</span><span class="hljs-params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> counter(MetricName.build(name));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Return the &#123;<span class="hljs-doctag">@link</span> Counter&#125; registered under this name; or create and register</span></span><br><span class="line"><span class="hljs-comment">     * a new &#123;<span class="hljs-doctag">@link</span> Counter&#125; if none is registered.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name the name of the metric</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> a new or pre-existing &#123;<span class="hljs-doctag">@link</span> Counter&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> Counter <span class="hljs-title">counter</span><span class="hljs-params">(MetricName name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> getOrAdd(name, MetricBuilder.COUNTERS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> #histogram(MetricName)</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> Histogram <span class="hljs-title">histogram</span><span class="hljs-params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> histogram(MetricName.build(name));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Return the &#123;<span class="hljs-doctag">@link</span> Histogram&#125; registered under this name; or create and register</span></span><br><span class="line"><span class="hljs-comment">     * a new &#123;<span class="hljs-doctag">@link</span> Histogram&#125; if none is registered.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name the name of the metric</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> a new or pre-existing &#123;<span class="hljs-doctag">@link</span> Histogram&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> Histogram <span class="hljs-title">histogram</span><span class="hljs-params">(MetricName name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> getOrAdd(name, MetricBuilder.HISTOGRAMS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> #meter(MetricName)</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> Meter <span class="hljs-title">meter</span><span class="hljs-params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> meter(MetricName.build(name));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Return the &#123;<span class="hljs-doctag">@link</span> Meter&#125; registered under this name; or create and register</span></span><br><span class="line"><span class="hljs-comment">     * a new &#123;<span class="hljs-doctag">@link</span> Meter&#125; if none is registered.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name the name of the metric</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> a new or pre-existing &#123;<span class="hljs-doctag">@link</span> Meter&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> Meter <span class="hljs-title">meter</span><span class="hljs-params">(MetricName name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> getOrAdd(name, MetricBuilder.METERS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> #timer(MetricName)</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> Timer <span class="hljs-title">timer</span><span class="hljs-params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> timer(MetricName.build(name));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Return the &#123;<span class="hljs-doctag">@link</span> Timer&#125; registered under this name; or create and register</span></span><br><span class="line"><span class="hljs-comment">     * a new &#123;<span class="hljs-doctag">@link</span> Timer&#125; if none is registered.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name the name of the metric</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> a new or pre-existing &#123;<span class="hljs-doctag">@link</span> Timer&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> Timer <span class="hljs-title">timer</span><span class="hljs-params">(MetricName name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> getOrAdd(name, MetricBuilder.TIMERS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Removes the metric with the given name.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name the name of the metric</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> whether or not the metric was removed</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">remove</span><span class="hljs-params">(MetricName name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> Metric metric = metrics.remove(name);</span><br><span class="line">        <span class="hljs-keyword">if</span> (metric != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            onMetricRemoved(name, metric);</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Removes all metrics which match the given filter.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> filter a filter</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> whether or not a metric was removed</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">removeMatching</span><span class="hljs-params">(MetricFilter filter)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">boolean</span> removed = <span class="hljs-keyword">false</span>;</span><br><span class="line">        <span class="hljs-keyword">for</span> (Map.Entry&lt;MetricName, Metric&gt; entry : metrics.entrySet()) &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (filter.matches(entry.getKey(), entry.getValue())) &#123;</span><br><span class="line">                removed |= remove(entry.getKey());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> removed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Adds a &#123;<span class="hljs-doctag">@link</span> MetricRegistryListener&#125; to a collection of listeners that will be notified on</span></span><br><span class="line"><span class="hljs-comment">     * metric creation.  Listeners will be notified in the order in which they are added.</span></span><br><span class="line"><span class="hljs-comment">     * &lt;p/&gt;</span></span><br><span class="line"><span class="hljs-comment">     * &lt;b&gt;N.B.:&lt;/b&gt; The listener will be notified of all existing metrics when it first registers.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> listener the listener that will be notified</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addListener</span><span class="hljs-params">(MetricRegistryListener listener)</span> </span>&#123;</span><br><span class="line">        listeners.add(listener);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">for</span> (Map.Entry&lt;MetricName, Metric&gt; entry : metrics.entrySet()) &#123;</span><br><span class="line">            notifyListenerOfAddedMetric(listener, entry.getValue(), entry.getKey());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Removes a &#123;<span class="hljs-doctag">@link</span> MetricRegistryListener&#125; from this registry's collection of listeners.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> listener the listener that will be removed</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">removeListener</span><span class="hljs-params">(MetricRegistryListener listener)</span> </span>&#123;</span><br><span class="line">        listeners.remove(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns a set of the names of all the metrics in the registry.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the names of all the metrics</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> SortedSet&lt;MetricName&gt; <span class="hljs-title">getNames</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> Collections.unmodifiableSortedSet(<span class="hljs-keyword">new</span> TreeSet&lt;MetricName&gt;(metrics.keySet()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns a map of all the gauges in the registry and their names.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> all the gauges in the registry</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> SortedMap&lt;MetricName, Gauge&gt; <span class="hljs-title">getGauges</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> getGauges(MetricFilter.ALL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns a map of all the gauges in the registry and their names which match the given filter.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> filter    the metric filter to match</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> all the gauges in the registry</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> SortedMap&lt;MetricName, Gauge&gt; <span class="hljs-title">getGauges</span><span class="hljs-params">(MetricFilter filter)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> getMetrics(Gauge.class, filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns a map of all the counters in the registry and their names.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> all the counters in the registry</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> SortedMap&lt;MetricName, Counter&gt; <span class="hljs-title">getCounters</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> getCounters(MetricFilter.ALL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns a map of all the counters in the registry and their names which match the given</span></span><br><span class="line"><span class="hljs-comment">     * filter.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> filter    the metric filter to match</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> all the counters in the registry</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> SortedMap&lt;MetricName, Counter&gt; <span class="hljs-title">getCounters</span><span class="hljs-params">(MetricFilter filter)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> getMetrics(Counter.class, filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns a map of all the histograms in the registry and their names.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> all the histograms in the registry</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> SortedMap&lt;MetricName, Histogram&gt; <span class="hljs-title">getHistograms</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> getHistograms(MetricFilter.ALL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns a map of all the histograms in the registry and their names which match the given</span></span><br><span class="line"><span class="hljs-comment">     * filter.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> filter    the metric filter to match</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> all the histograms in the registry</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> SortedMap&lt;MetricName, Histogram&gt; <span class="hljs-title">getHistograms</span><span class="hljs-params">(MetricFilter filter)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> getMetrics(Histogram.class, filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns a map of all the meters in the registry and their names.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> all the meters in the registry</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> SortedMap&lt;MetricName, Meter&gt; <span class="hljs-title">getMeters</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> getMeters(MetricFilter.ALL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns a map of all the meters in the registry and their names which match the given filter.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> filter    the metric filter to match</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> all the meters in the registry</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> SortedMap&lt;MetricName, Meter&gt; <span class="hljs-title">getMeters</span><span class="hljs-params">(MetricFilter filter)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> getMetrics(Meter.class, filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns a map of all the timers in the registry and their names.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> all the timers in the registry</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> SortedMap&lt;MetricName, Timer&gt; <span class="hljs-title">getTimers</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> getTimers(MetricFilter.ALL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns a map of all the timers in the registry and their names which match the given filter.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> filter    the metric filter to match</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> all the timers in the registry</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> SortedMap&lt;MetricName, Timer&gt; <span class="hljs-title">getTimers</span><span class="hljs-params">(MetricFilter filter)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> getMetrics(Timer.class, filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 获取metric，如果没有metric，则新增</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> builder</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)</span><br><span class="line">    <span class="hljs-keyword">private</span> &lt;T extends Metric&gt; <span class="hljs-function">T <span class="hljs-title">getOrAdd</span><span class="hljs-params">(MetricName name, MetricBuilder&lt;T&gt; builder)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> Metric metric = metrics.get(name);</span><br><span class="line">        <span class="hljs-keyword">if</span> (builder.isInstance(metric)) &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> (T) metric;</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (metric == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> register(name, builder.newMetric());</span><br><span class="line">            &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">                <span class="hljs-keyword">final</span> Metric added = metrics.get(name);</span><br><span class="line">                <span class="hljs-keyword">if</span> (builder.isInstance(added)) &#123;</span><br><span class="line">                    <span class="hljs-keyword">return</span> (T) added;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(name + <span class="hljs-string">" is already used for a different type of metric"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)</span><br><span class="line">    <span class="hljs-keyword">private</span> &lt;T extends Metric&gt; <span class="hljs-function">SortedMap&lt;MetricName, T&gt; <span class="hljs-title">getMetrics</span><span class="hljs-params">(Class&lt;T&gt; klass, MetricFilter filter)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> TreeMap&lt;MetricName, T&gt; timers = <span class="hljs-keyword">new</span> TreeMap&lt;MetricName, T&gt;();</span><br><span class="line">        <span class="hljs-keyword">for</span> (Map.Entry&lt;MetricName, Metric&gt; entry : metrics.entrySet()) &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (klass.isInstance(entry.getValue()) &amp;&amp; filter.matches(entry.getKey(),</span><br><span class="line">                                                                     entry.getValue())) &#123;</span><br><span class="line">                timers.put(entry.getKey(), (T) entry.getValue());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> Collections.unmodifiableSortedMap(timers);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 新增metric</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> metric</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onMetricAdded</span><span class="hljs-params">(MetricName name, Metric metric)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">for</span> (MetricRegistryListener listener : listeners) &#123;</span><br><span class="line">            notifyListenerOfAddedMetric(listener, metric, name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 根据类型新增metric</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> listener</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> metric</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">notifyListenerOfAddedMetric</span><span class="hljs-params">(MetricRegistryListener listener, Metric metric, MetricName name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (metric <span class="hljs-keyword">instanceof</span> Gauge) &#123;</span><br><span class="line">            listener.onGaugeAdded(name, (Gauge&lt;?&gt;) metric);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (metric <span class="hljs-keyword">instanceof</span> Counter) &#123;</span><br><span class="line">            listener.onCounterAdded(name, (Counter) metric);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (metric <span class="hljs-keyword">instanceof</span> Histogram) &#123;</span><br><span class="line">            listener.onHistogramAdded(name, (Histogram) metric);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (metric <span class="hljs-keyword">instanceof</span> Meter) &#123;</span><br><span class="line">            listener.onMeterAdded(name, (Meter) metric);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (metric <span class="hljs-keyword">instanceof</span> Timer) &#123;</span><br><span class="line">            listener.onTimerAdded(name, (Timer) metric);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"Unknown metric type: "</span> + metric.getClass());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 删除</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> metric</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onMetricRemoved</span><span class="hljs-params">(MetricName name, Metric metric)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">for</span> (MetricRegistryListener listener : listeners) &#123;</span><br><span class="line">            notifyListenerOfRemovedMetric(name, metric, listener);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">notifyListenerOfRemovedMetric</span><span class="hljs-params">(MetricName name, Metric metric, MetricRegistryListener listener)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (metric <span class="hljs-keyword">instanceof</span> Gauge) &#123;</span><br><span class="line">            listener.onGaugeRemoved(name);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (metric <span class="hljs-keyword">instanceof</span> Counter) &#123;</span><br><span class="line">            listener.onCounterRemoved(name);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (metric <span class="hljs-keyword">instanceof</span> Histogram) &#123;</span><br><span class="line">            listener.onHistogramRemoved(name);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (metric <span class="hljs-keyword">instanceof</span> Meter) &#123;</span><br><span class="line">            listener.onMeterRemoved(name);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (metric <span class="hljs-keyword">instanceof</span> Timer) &#123;</span><br><span class="line">            listener.onTimerRemoved(name);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"Unknown metric type: "</span> + metric.getClass());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 注册metric列表</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> prefix</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> metrics</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerAll</span><span class="hljs-params">(MetricName prefix, MetricSet metrics)</span> <span class="hljs-keyword">throws</span> IllegalArgumentException </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (prefix == <span class="hljs-keyword">null</span>)</span><br><span class="line">            prefix = MetricName.EMPTY;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">for</span> (Map.Entry&lt;MetricName, Metric&gt; entry : metrics.getMetrics().entrySet()) &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (entry.getValue() <span class="hljs-keyword">instanceof</span> MetricSet) &#123;</span><br><span class="line">                registerAll(MetricName.join(prefix, entry.getKey()), (MetricSet) entry.getValue());</span><br><span class="line">            &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                register(MetricName.join(prefix, entry.getKey()), entry.getValue());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 返回metricsMap，一个不能修改的map</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;MetricName, Metric&gt; <span class="hljs-title">getMetrics</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> Collections.unmodifiableMap(metrics);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * A quick and easy way of capturing the notion of default metrics.</span></span><br><span class="line"><span class="hljs-comment">     * 简单快速自定义接口</span></span><br><span class="line"><span class="hljs-comment">     * 实现不同metric类型</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MetricBuilder</span>&lt;<span class="hljs-title">T</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Metric</span>&gt; </span>&#123;</span><br><span class="line">        <span class="hljs-comment">//counters</span></span><br><span class="line">        MetricBuilder&lt;Counter&gt; COUNTERS = <span class="hljs-keyword">new</span> MetricBuilder&lt;Counter&gt;() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> Counter <span class="hljs-title">newMetric</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Counter();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isInstance</span><span class="hljs-params">(Metric metric)</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> Counter.class.isInstance(metric);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="hljs-comment">//histograms</span></span><br><span class="line">        MetricBuilder&lt;Histogram&gt; HISTOGRAMS = <span class="hljs-keyword">new</span> MetricBuilder&lt;Histogram&gt;() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> Histogram <span class="hljs-title">newMetric</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Histogram(<span class="hljs-keyword">new</span> ExponentiallyDecayingReservoir());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isInstance</span><span class="hljs-params">(Metric metric)</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> Histogram.class.isInstance(metric);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="hljs-comment">//meters</span></span><br><span class="line">        MetricBuilder&lt;Meter&gt; METERS = <span class="hljs-keyword">new</span> MetricBuilder&lt;Meter&gt;() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> Meter <span class="hljs-title">newMetric</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Meter();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isInstance</span><span class="hljs-params">(Metric metric)</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> Meter.class.isInstance(metric);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="hljs-comment">//timers</span></span><br><span class="line">        MetricBuilder&lt;Timer&gt; TIMERS = <span class="hljs-keyword">new</span> MetricBuilder&lt;Timer&gt;() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> Timer <span class="hljs-title">newMetric</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Timer();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isInstance</span><span class="hljs-params">(Metric metric)</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> Timer.class.isInstance(metric);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-function">T <span class="hljs-title">newMetric</span><span class="hljs-params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isInstance</span><span class="hljs-params">(Metric metric)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Snapshot-java"><a href="#Snapshot-java" class="headerlink" title="Snapshot.java"></a>Snapshot.java</h3><p>输出数据到流中<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.io.OutputStream;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * A statistical snapshot of a &#123;<span class="hljs-doctag">@link</span> Snapshot&#125;.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * 统计快照</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Snapshot</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns the value at the given quantile.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> quantile    a given quantile, in &#123;<span class="hljs-doctag">@code</span> [0..1]&#125;</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the value in the distribution at &#123;<span class="hljs-doctag">@code</span> quantile&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getValue</span><span class="hljs-params">(<span class="hljs-keyword">double</span> quantile)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns the entire set of values in the snapshot.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the entire set of values</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">long</span>[] getValues();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns the number of values in the snapshot.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the number of values</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">int</span> <span class="hljs-title">size</span><span class="hljs-params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns the median value in the distribution.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the median value</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getMedian</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> getValue(<span class="hljs-number">0.5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns the value at the 75th percentile in the distribution.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the value at the 75th percentile</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">get75thPercentile</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> getValue(<span class="hljs-number">0.75</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns the value at the 95th percentile in the distribution.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the value at the 95th percentile</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">get95thPercentile</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> getValue(<span class="hljs-number">0.95</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns the value at the 98th percentile in the distribution.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the value at the 98th percentile</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">get98thPercentile</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> getValue(<span class="hljs-number">0.98</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns the value at the 99th percentile in the distribution.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the value at the 99th percentile</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">get99thPercentile</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> getValue(<span class="hljs-number">0.99</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns the value at the 99.9th percentile in the distribution.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the value at the 99.9th percentile</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">get999thPercentile</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> getValue(<span class="hljs-number">0.999</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns the highest value in the snapshot.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the highest value</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getMax</span><span class="hljs-params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns the arithmetic mean of the values in the snapshot.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the arithmetic mean</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getMean</span><span class="hljs-params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns the lowest value in the snapshot.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the lowest value</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getMin</span><span class="hljs-params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns the standard deviation of the values in the snapshot.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the standard value</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getStdDev</span><span class="hljs-params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Writes the values of the snapshot to the given stream.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> output an output stream</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">dump</span><span class="hljs-params">(OutputStream output)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="InstrumentedExecutors-java"><a href="#InstrumentedExecutors-java" class="headerlink" title="InstrumentedExecutors.java"></a>InstrumentedExecutors.java</h3><p>调用：InstrumentedExecutorService，InstrumentedScheduledExecutorService<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.ThreadFactory;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * Factory and utility methods for &#123;<span class="hljs-doctag">@link</span> InstrumentedExecutorService&#125;,</span></span><br><span class="line"><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> InstrumentedScheduledExecutorService&#125;, and &#123;<span class="hljs-doctag">@link</span> InstrumentedThreadFactory&#125;</span></span><br><span class="line"><span class="hljs-comment"> * classes defined in this package. This class supports the following kinds of methods:</span></span><br><span class="line"><span class="hljs-comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="hljs-comment"> * &lt;ul&gt;</span></span><br><span class="line"><span class="hljs-comment"> * &lt;li&gt; Methods that create and return an &#123;<span class="hljs-doctag">@link</span> InstrumentedExecutorService&#125;</span></span><br><span class="line"><span class="hljs-comment"> * set up with commonly useful configuration settings.</span></span><br><span class="line"><span class="hljs-comment"> * &lt;li&gt; Methods that create and return a &#123;<span class="hljs-doctag">@link</span> InstrumentedScheduledExecutorService&#125;</span></span><br><span class="line"><span class="hljs-comment"> * set up with commonly useful configuration settings.</span></span><br><span class="line"><span class="hljs-comment"> * &lt;li&gt; Methods that create and return a "wrapped" ExecutorService, that</span></span><br><span class="line"><span class="hljs-comment"> * disables reconfiguration by making implementation-specific methods</span></span><br><span class="line"><span class="hljs-comment"> * inaccessible.</span></span><br><span class="line"><span class="hljs-comment"> * &lt;li&gt; Methods that create and return a &#123;<span class="hljs-doctag">@link</span> InstrumentedThreadFactory&#125;</span></span><br><span class="line"><span class="hljs-comment"> * that sets newly created threads to a known state.</span></span><br><span class="line"><span class="hljs-comment"> * &lt;/ul&gt;</span></span><br><span class="line"><span class="hljs-comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> java.util.concurrent.Executors</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-comment">//线程执行服务</span></span><br><span class="line"><span class="hljs-comment">//创建线程池执行：newFixedThreadPool，newSingleThreadExecutor，newCachedThreadPool，newScheduledThreadPool</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InstrumentedExecutors</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates an instrumented thread pool that reuses a fixed number of threads</span></span><br><span class="line"><span class="hljs-comment">     * operating off a shared unbounded queue.  At any point, at most</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@code</span> nThreads&#125; threads will be active processing tasks.</span></span><br><span class="line"><span class="hljs-comment">     * If additional tasks are submitted when all threads are active,</span></span><br><span class="line"><span class="hljs-comment">     * they will wait in the queue until a thread is available.</span></span><br><span class="line"><span class="hljs-comment">     * If any thread terminates due to a failure during execution</span></span><br><span class="line"><span class="hljs-comment">     * prior to shutdown, a new one will take its place if needed to</span></span><br><span class="line"><span class="hljs-comment">     * execute subsequent tasks.  The threads in the pool will exist</span></span><br><span class="line"><span class="hljs-comment">     * until it is explicitly &#123;<span class="hljs-doctag">@link</span> ExecutorService#shutdown shutdown&#125;.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> nThreads the number of threads in the pool</span></span><br><span class="line"><span class="hljs-comment">     *                创建线程池</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name     the (metrics) name for this executor service, see &#123;<span class="hljs-doctag">@link</span> MetricRegistry#name(String, String...)&#125;.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the newly created thread pool</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException if &#123;<span class="hljs-doctag">@code</span> nThreads &lt;= 0&#125;</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#newFixedThreadPool(int)</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedExecutorService <span class="hljs-title">newFixedThreadPool</span><span class="hljs-params">(<span class="hljs-keyword">int</span> nThreads, MetricRegistry registry, String name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedExecutorService(Executors.newFixedThreadPool(nThreads), registry, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates an instrumented thread pool that reuses a fixed number of threads</span></span><br><span class="line"><span class="hljs-comment">     * operating off a shared unbounded queue.  At any point, at most</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@code</span> nThreads&#125; threads will be active processing tasks.</span></span><br><span class="line"><span class="hljs-comment">     * If additional tasks are submitted when all threads are active,</span></span><br><span class="line"><span class="hljs-comment">     * they will wait in the queue until a thread is available.</span></span><br><span class="line"><span class="hljs-comment">     * If any thread terminates due to a failure during execution</span></span><br><span class="line"><span class="hljs-comment">     * prior to shutdown, a new one will take its place if needed to</span></span><br><span class="line"><span class="hljs-comment">     * execute subsequent tasks.  The threads in the pool will exist</span></span><br><span class="line"><span class="hljs-comment">     * until it is explicitly &#123;<span class="hljs-doctag">@link</span> java.util.concurrent.ExecutorService#shutdown shutdown&#125;.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> nThreads the number of threads in the pool</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the newly created thread pool</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException if &#123;<span class="hljs-doctag">@code</span> nThreads &lt;= 0&#125;</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#newFixedThreadPool(int)</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedExecutorService <span class="hljs-title">newFixedThreadPool</span><span class="hljs-params">(<span class="hljs-keyword">int</span> nThreads, MetricRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedExecutorService(Executors.newFixedThreadPool(nThreads), registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates an instrumented thread pool that reuses a fixed number of threads</span></span><br><span class="line"><span class="hljs-comment">     * operating off a shared unbounded queue, using the provided</span></span><br><span class="line"><span class="hljs-comment">     * ThreadFactory to create new threads when needed.  At any point,</span></span><br><span class="line"><span class="hljs-comment">     * at most &#123;<span class="hljs-doctag">@code</span> nThreads&#125; threads will be active processing</span></span><br><span class="line"><span class="hljs-comment">     * tasks.  If additional tasks are submitted when all threads are</span></span><br><span class="line"><span class="hljs-comment">     * active, they will wait in the queue until a thread is</span></span><br><span class="line"><span class="hljs-comment">     * available.  If any thread terminates due to a failure during</span></span><br><span class="line"><span class="hljs-comment">     * execution prior to shutdown, a new one will take its place if</span></span><br><span class="line"><span class="hljs-comment">     * needed to execute subsequent tasks.  The threads in the pool will</span></span><br><span class="line"><span class="hljs-comment">     * exist until it is explicitly &#123;<span class="hljs-doctag">@link</span> ExecutorService#shutdown shutdown&#125;.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> nThreads      the number of threads in the pool</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> threadFactory the factory to use when creating new threads</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry      the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name          the (metrics) name for this executor service, see &#123;<span class="hljs-doctag">@link</span> MetricRegistry#name(String, String...)&#125;.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the newly created thread pool</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException     if threadFactory is null</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException if &#123;<span class="hljs-doctag">@code</span> nThreads &lt;= 0&#125;</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#newFixedThreadPool(int, ThreadFactory)</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedExecutorService <span class="hljs-title">newFixedThreadPool</span><span class="hljs-params">(<span class="hljs-keyword">int</span> nThreads, ThreadFactory threadFactory, MetricRegistry registry, String name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedExecutorService(Executors.newFixedThreadPool(nThreads, threadFactory), registry, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a thread pool that reuses a fixed number of threads</span></span><br><span class="line"><span class="hljs-comment">     * operating off a shared unbounded queue, using the provided</span></span><br><span class="line"><span class="hljs-comment">     * ThreadFactory to create new threads when needed.  At any point,</span></span><br><span class="line"><span class="hljs-comment">     * at most &#123;<span class="hljs-doctag">@code</span> nThreads&#125; threads will be active processing</span></span><br><span class="line"><span class="hljs-comment">     * tasks.  If additional tasks are submitted when all threads are</span></span><br><span class="line"><span class="hljs-comment">     * active, they will wait in the queue until a thread is</span></span><br><span class="line"><span class="hljs-comment">     * available.  If any thread terminates due to a failure during</span></span><br><span class="line"><span class="hljs-comment">     * execution prior to shutdown, a new one will take its place if</span></span><br><span class="line"><span class="hljs-comment">     * needed to execute subsequent tasks.  The threads in the pool will</span></span><br><span class="line"><span class="hljs-comment">     * exist until it is explicitly &#123;<span class="hljs-doctag">@link</span> ExecutorService#shutdown</span></span><br><span class="line"><span class="hljs-comment">     * shutdown&#125;.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> nThreads      the number of threads in the pool</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> threadFactory the factory to use when creating new threads</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry      the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the newly created thread pool</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException     if threadFactory is null</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException if &#123;<span class="hljs-doctag">@code</span> nThreads &lt;= 0&#125;</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#newFixedThreadPool(int, ThreadFactory)</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedExecutorService <span class="hljs-title">newFixedThreadPool</span><span class="hljs-params">(<span class="hljs-keyword">int</span> nThreads, ThreadFactory threadFactory, MetricRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedExecutorService(Executors.newFixedThreadPool(nThreads, threadFactory), registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates an InstrumentedExecutor that uses a single worker thread operating</span></span><br><span class="line"><span class="hljs-comment">     * off an unbounded queue. (Note however that if this single</span></span><br><span class="line"><span class="hljs-comment">     * thread terminates due to a failure during execution prior to</span></span><br><span class="line"><span class="hljs-comment">     * shutdown, a new one will take its place if needed to execute</span></span><br><span class="line"><span class="hljs-comment">     * subsequent tasks.)  Tasks are guaranteed to execute</span></span><br><span class="line"><span class="hljs-comment">     * sequentially, and no more than one task will be active at any</span></span><br><span class="line"><span class="hljs-comment">     * given time. Unlike the otherwise equivalent</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@code</span> newFixedThreadPool(1)&#125; the returned executor is</span></span><br><span class="line"><span class="hljs-comment">     * guaranteed not to be reconfigurable to use additional threads.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name     the (metrics) name for this executor service, see &#123;<span class="hljs-doctag">@link</span> MetricRegistry#name(String, String...)&#125;.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the newly created single-threaded Executor</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#newSingleThreadExecutor()</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedExecutorService <span class="hljs-title">newSingleThreadExecutor</span><span class="hljs-params">(MetricRegistry registry, String name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-comment">//单线程 - uses a single worker thread operating</span></span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedExecutorService(Executors.newSingleThreadExecutor(), registry, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates an Executor that uses a single worker thread operating</span></span><br><span class="line"><span class="hljs-comment">     * off an unbounded queue. (Note however that if this single</span></span><br><span class="line"><span class="hljs-comment">     * thread terminates due to a failure during execution prior to</span></span><br><span class="line"><span class="hljs-comment">     * shutdown, a new one will take its place if needed to execute</span></span><br><span class="line"><span class="hljs-comment">     * subsequent tasks.)  Tasks are guaranteed to execute</span></span><br><span class="line"><span class="hljs-comment">     * sequentially, and no more than one task will be active at any</span></span><br><span class="line"><span class="hljs-comment">     * given time. Unlike the otherwise equivalent</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@code</span> newFixedThreadPool(1)&#125; the returned executor is</span></span><br><span class="line"><span class="hljs-comment">     * guaranteed not to be reconfigurable to use additional threads.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the newly created single-threaded Executor</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#newSingleThreadExecutor()</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedExecutorService <span class="hljs-title">newSingleThreadExecutor</span><span class="hljs-params">(MetricRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedExecutorService(Executors.newSingleThreadExecutor(), registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates an InstrumentedExecutor that uses a single worker thread operating</span></span><br><span class="line"><span class="hljs-comment">     * off an unbounded queue, and uses the provided ThreadFactory to</span></span><br><span class="line"><span class="hljs-comment">     * create a new thread when needed. Unlike the otherwise</span></span><br><span class="line"><span class="hljs-comment">     * equivalent &#123;<span class="hljs-doctag">@code</span> newFixedThreadPool(1, threadFactory)&#125; the</span></span><br><span class="line"><span class="hljs-comment">     * returned executor is guaranteed not to be reconfigurable to use</span></span><br><span class="line"><span class="hljs-comment">     * additional threads.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> threadFactory the factory to use when creating new threads</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry      the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name          the (metrics) name for this executor service, see &#123;<span class="hljs-doctag">@link</span> MetricRegistry#name(String, String...)&#125;.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the newly created single-threaded Executor</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException if threadFactory is null</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#newSingleThreadExecutor(ThreadFactory)</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedExecutorService <span class="hljs-title">newSingleThreadExecutor</span><span class="hljs-params">(ThreadFactory threadFactory, MetricRegistry registry, String name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedExecutorService(Executors.newSingleThreadExecutor(threadFactory), registry, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates an InstrumentedExecutor that uses a single worker thread operating</span></span><br><span class="line"><span class="hljs-comment">     * off an unbounded queue, and uses the provided ThreadFactory to</span></span><br><span class="line"><span class="hljs-comment">     * create a new thread when needed. Unlike the otherwise</span></span><br><span class="line"><span class="hljs-comment">     * equivalent &#123;<span class="hljs-doctag">@code</span> newFixedThreadPool(1, threadFactory)&#125; the</span></span><br><span class="line"><span class="hljs-comment">     * returned executor is guaranteed not to be reconfigurable to use</span></span><br><span class="line"><span class="hljs-comment">     * additional threads.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> threadFactory the factory to use when creating new threads</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry      the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the newly created single-threaded Executor</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException if threadFactory is null</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#newSingleThreadExecutor(ThreadFactory)</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedExecutorService <span class="hljs-title">newSingleThreadExecutor</span><span class="hljs-params">(ThreadFactory threadFactory, MetricRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedExecutorService(Executors.newSingleThreadExecutor(threadFactory), registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates an instrumented thread pool that creates new threads as needed, but</span></span><br><span class="line"><span class="hljs-comment">     * will reuse previously constructed threads when they are</span></span><br><span class="line"><span class="hljs-comment">     * available.  These pools will typically improve the performance</span></span><br><span class="line"><span class="hljs-comment">     * of programs that execute many short-lived asynchronous tasks.</span></span><br><span class="line"><span class="hljs-comment">     * Calls to &#123;<span class="hljs-doctag">@code</span> execute&#125; will reuse previously constructed</span></span><br><span class="line"><span class="hljs-comment">     * threads if available. If no existing thread is available, a new</span></span><br><span class="line"><span class="hljs-comment">     * thread will be created and added to the pool. Threads that have</span></span><br><span class="line"><span class="hljs-comment">     * not been used for sixty seconds are terminated and removed from</span></span><br><span class="line"><span class="hljs-comment">     * the cache. Thus, a pool that remains idle for long enough will</span></span><br><span class="line"><span class="hljs-comment">     * not consume any resources. Note that pools with similar</span></span><br><span class="line"><span class="hljs-comment">     * properties but different details (for example, timeout parameters)</span></span><br><span class="line"><span class="hljs-comment">     * may be created using &#123;<span class="hljs-doctag">@link</span> ThreadPoolExecutor&#125; constructors.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name     the (metrics) name for this executor service, see &#123;<span class="hljs-doctag">@link</span> MetricRegistry#name(String, String...)&#125;.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the newly created thread pool</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#newCachedThreadPool()</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedExecutorService <span class="hljs-title">newCachedThreadPool</span><span class="hljs-params">(MetricRegistry registry, String name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedExecutorService(Executors.newCachedThreadPool(), registry, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates an instrumented thread pool that creates new threads as needed, but</span></span><br><span class="line"><span class="hljs-comment">     * will reuse previously constructed threads when they are</span></span><br><span class="line"><span class="hljs-comment">     * available.  These pools will typically improve the performance</span></span><br><span class="line"><span class="hljs-comment">     * of programs that execute many short-lived asynchronous tasks.</span></span><br><span class="line"><span class="hljs-comment">     * Calls to &#123;<span class="hljs-doctag">@code</span> execute&#125; will reuse previously constructed</span></span><br><span class="line"><span class="hljs-comment">     * threads if available. If no existing thread is available, a new</span></span><br><span class="line"><span class="hljs-comment">     * thread will be created and added to the pool. Threads that have</span></span><br><span class="line"><span class="hljs-comment">     * not been used for sixty seconds are terminated and removed from</span></span><br><span class="line"><span class="hljs-comment">     * the cache. Thus, a pool that remains idle for long enough will</span></span><br><span class="line"><span class="hljs-comment">     * not consume any resources. Note that pools with similar</span></span><br><span class="line"><span class="hljs-comment">     * properties but different details (for example, timeout parameters)</span></span><br><span class="line"><span class="hljs-comment">     * may be created using &#123;<span class="hljs-doctag">@link</span> ThreadPoolExecutor&#125; constructors.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the newly created thread pool</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#newCachedThreadPool()</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedExecutorService <span class="hljs-title">newCachedThreadPool</span><span class="hljs-params">(MetricRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedExecutorService(Executors.newCachedThreadPool(), registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates an instrumented thread pool that creates new threads as needed, but</span></span><br><span class="line"><span class="hljs-comment">     * will reuse previously constructed threads when they are</span></span><br><span class="line"><span class="hljs-comment">     * available, and uses the provided</span></span><br><span class="line"><span class="hljs-comment">     * ThreadFactory to create new threads when needed.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> threadFactory the factory to use when creating new threads</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry      the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name          the (metrics) name for this executor service, see &#123;<span class="hljs-doctag">@link</span> MetricRegistry#name(String, String...)&#125;.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the newly created thread pool</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException if threadFactory is null</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#newCachedThreadPool(ThreadFactory)</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedExecutorService <span class="hljs-title">newCachedThreadPool</span><span class="hljs-params">(ThreadFactory threadFactory, MetricRegistry registry, String name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedExecutorService(Executors.newCachedThreadPool(threadFactory), registry, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates an instrumented thread pool that creates new threads as needed, but</span></span><br><span class="line"><span class="hljs-comment">     * will reuse previously constructed threads when they are</span></span><br><span class="line"><span class="hljs-comment">     * available, and uses the provided</span></span><br><span class="line"><span class="hljs-comment">     * ThreadFactory to create new threads when needed.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> threadFactory the factory to use when creating new threads</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry      the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the newly created thread pool</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException if threadFactory is null</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#newCachedThreadPool(ThreadFactory)</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedExecutorService <span class="hljs-title">newCachedThreadPool</span><span class="hljs-params">(ThreadFactory threadFactory, MetricRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedExecutorService(Executors.newCachedThreadPool(threadFactory), registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a single-threaded instrumented executor that can schedule commands</span></span><br><span class="line"><span class="hljs-comment">     * to run after a given delay, or to execute periodically.</span></span><br><span class="line"><span class="hljs-comment">     * (Note however that if this single</span></span><br><span class="line"><span class="hljs-comment">     * thread terminates due to a failure during execution prior to</span></span><br><span class="line"><span class="hljs-comment">     * shutdown, a new one will take its place if needed to execute</span></span><br><span class="line"><span class="hljs-comment">     * subsequent tasks.)  Tasks are guaranteed to execute</span></span><br><span class="line"><span class="hljs-comment">     * sequentially, and no more than one task will be active at any</span></span><br><span class="line"><span class="hljs-comment">     * given time. Unlike the otherwise equivalent</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@code</span> newScheduledThreadPool(1)&#125; the returned executor is</span></span><br><span class="line"><span class="hljs-comment">     * guaranteed not to be reconfigurable to use additional threads.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name     the (metrics) name for this executor service, see &#123;<span class="hljs-doctag">@link</span> MetricRegistry#name(String, String...)&#125;.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the newly created scheduled executor</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#newSingleThreadScheduledExecutor()</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedScheduledExecutorService <span class="hljs-title">newSingleThreadScheduledExecutor</span><span class="hljs-params">(MetricRegistry registry, String name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedScheduledExecutorService(Executors.newSingleThreadScheduledExecutor(), registry, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a single-threaded instrumented executor that can schedule commands</span></span><br><span class="line"><span class="hljs-comment">     * to run after a given delay, or to execute periodically.</span></span><br><span class="line"><span class="hljs-comment">     * (Note however that if this single</span></span><br><span class="line"><span class="hljs-comment">     * thread terminates due to a failure during execution prior to</span></span><br><span class="line"><span class="hljs-comment">     * shutdown, a new one will take its place if needed to execute</span></span><br><span class="line"><span class="hljs-comment">     * subsequent tasks.)  Tasks are guaranteed to execute</span></span><br><span class="line"><span class="hljs-comment">     * sequentially, and no more than one task will be active at any</span></span><br><span class="line"><span class="hljs-comment">     * given time. Unlike the otherwise equivalent</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@code</span> newScheduledThreadPool(1)&#125; the returned executor is</span></span><br><span class="line"><span class="hljs-comment">     * guaranteed not to be reconfigurable to use additional threads.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the newly created scheduled executor</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#newSingleThreadScheduledExecutor()</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedScheduledExecutorService <span class="hljs-title">newSingleThreadScheduledExecutor</span><span class="hljs-params">(MetricRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedScheduledExecutorService(Executors.newSingleThreadScheduledExecutor(), registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a single-threaded instrumented executor that can schedule commands</span></span><br><span class="line"><span class="hljs-comment">     * to run after a given delay, or to execute periodically.  (Note</span></span><br><span class="line"><span class="hljs-comment">     * however that if this single thread terminates due to a failure</span></span><br><span class="line"><span class="hljs-comment">     * during execution prior to shutdown, a new one will take its</span></span><br><span class="line"><span class="hljs-comment">     * place if needed to execute subsequent tasks.)  Tasks are</span></span><br><span class="line"><span class="hljs-comment">     * guaranteed to execute sequentially, and no more than one task</span></span><br><span class="line"><span class="hljs-comment">     * will be active at any given time. Unlike the otherwise</span></span><br><span class="line"><span class="hljs-comment">     * equivalent &#123;<span class="hljs-doctag">@code</span> newScheduledThreadPool(1, threadFactory)&#125;</span></span><br><span class="line"><span class="hljs-comment">     * the returned executor is guaranteed not to be reconfigurable to</span></span><br><span class="line"><span class="hljs-comment">     * use additional threads.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> threadFactory the factory to use when creating new threads</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry      the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name          the (metrics) name for this executor service, see &#123;<span class="hljs-doctag">@link</span> MetricRegistry#name(String, String...)&#125;.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> a newly created scheduled executor</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException if threadFactory is null</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#newSingleThreadExecutor(ThreadFactory)</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedScheduledExecutorService <span class="hljs-title">newSingleThreadScheduledExecutor</span><span class="hljs-params">(ThreadFactory threadFactory, MetricRegistry registry, String name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedScheduledExecutorService(Executors.newSingleThreadScheduledExecutor(threadFactory), registry, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a single-threaded instrumented executor that can schedule commands</span></span><br><span class="line"><span class="hljs-comment">     * to run after a given delay, or to execute periodically.  (Note</span></span><br><span class="line"><span class="hljs-comment">     * however that if this single thread terminates due to a failure</span></span><br><span class="line"><span class="hljs-comment">     * during execution prior to shutdown, a new one will take its</span></span><br><span class="line"><span class="hljs-comment">     * place if needed to execute subsequent tasks.)  Tasks are</span></span><br><span class="line"><span class="hljs-comment">     * guaranteed to execute sequentially, and no more than one task</span></span><br><span class="line"><span class="hljs-comment">     * will be active at any given time. Unlike the otherwise</span></span><br><span class="line"><span class="hljs-comment">     * equivalent &#123;<span class="hljs-doctag">@code</span> newScheduledThreadPool(1, threadFactory)&#125;</span></span><br><span class="line"><span class="hljs-comment">     * the returned executor is guaranteed not to be reconfigurable to</span></span><br><span class="line"><span class="hljs-comment">     * use additional threads.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> threadFactory the factory to use when creating new threads</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry      the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> a newly created scheduled executor</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException if threadFactory is null</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#newSingleThreadExecutor(ThreadFactory)</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedScheduledExecutorService <span class="hljs-title">newSingleThreadScheduledExecutor</span><span class="hljs-params">(ThreadFactory threadFactory, MetricRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedScheduledExecutorService(Executors.newSingleThreadScheduledExecutor(threadFactory), registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates an instrumented thread pool that can schedule commands to run after a</span></span><br><span class="line"><span class="hljs-comment">     * given delay, or to execute periodically.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> corePoolSize the number of threads to keep in the pool,</span></span><br><span class="line"><span class="hljs-comment">     *                     even if they are idle</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry     the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name         the (metrics) name for this executor service, see &#123;<span class="hljs-doctag">@link</span> MetricRegistry#name(String, String...)&#125;.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> a newly created scheduled thread pool</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException if &#123;<span class="hljs-doctag">@code</span> corePoolSize &lt; 0&#125;</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#newScheduledThreadPool(int)</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedScheduledExecutorService <span class="hljs-title">newScheduledThreadPool</span><span class="hljs-params">(<span class="hljs-keyword">int</span> corePoolSize, MetricRegistry registry, String name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedScheduledExecutorService(Executors.newScheduledThreadPool(corePoolSize), registry, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates an instrumented thread pool that can schedule commands to run after a</span></span><br><span class="line"><span class="hljs-comment">     * given delay, or to execute periodically.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> corePoolSize the number of threads to keep in the pool,</span></span><br><span class="line"><span class="hljs-comment">     *                     even if they are idle</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry     the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> a newly created scheduled thread pool</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException if &#123;<span class="hljs-doctag">@code</span> corePoolSize &lt; 0&#125;</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#newScheduledThreadPool(int)</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedScheduledExecutorService <span class="hljs-title">newScheduledThreadPool</span><span class="hljs-params">(<span class="hljs-keyword">int</span> corePoolSize, MetricRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedScheduledExecutorService(Executors.newScheduledThreadPool(corePoolSize), registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates an instrumented thread pool that can schedule commands to run after a</span></span><br><span class="line"><span class="hljs-comment">     * given delay, or to execute periodically.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> corePoolSize  the number of threads to keep in the pool,</span></span><br><span class="line"><span class="hljs-comment">     *                      even if they are idle</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> threadFactory the factory to use when the executor</span></span><br><span class="line"><span class="hljs-comment">     *                      creates a new thread</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry      the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name          the (metrics) name for this executor service, see &#123;<span class="hljs-doctag">@link</span> MetricRegistry#name(String, String...)&#125;.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> a newly created scheduled thread pool</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException if &#123;<span class="hljs-doctag">@code</span> corePoolSize &lt; 0&#125;</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException     if threadFactory is null</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#newScheduledThreadPool(int, ThreadFactory)</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedScheduledExecutorService <span class="hljs-title">newScheduledThreadPool</span><span class="hljs-params">(<span class="hljs-keyword">int</span> corePoolSize, ThreadFactory threadFactory, MetricRegistry registry, String name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedScheduledExecutorService(Executors.newScheduledThreadPool(corePoolSize, threadFactory), registry, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates an instrumented thread pool that can schedule commands to run after a</span></span><br><span class="line"><span class="hljs-comment">     * given delay, or to execute periodically.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> corePoolSize  the number of threads to keep in the pool, even if they are idle</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> threadFactory the factory to use when the executor creates a new thread</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry      the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> a newly created scheduled thread pool</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException if &#123;<span class="hljs-doctag">@code</span> corePoolSize &lt; 0&#125;</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException     if threadFactory is null</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#newScheduledThreadPool(int, ThreadFactory)</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedScheduledExecutorService <span class="hljs-title">newScheduledThreadPool</span><span class="hljs-params">(<span class="hljs-keyword">int</span> corePoolSize, ThreadFactory threadFactory, MetricRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedScheduledExecutorService(Executors.newScheduledThreadPool(corePoolSize, threadFactory), registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns an instrumented default thread factory used to create new threads.</span></span><br><span class="line"><span class="hljs-comment">     * This factory creates all new threads used by an Executor in the</span></span><br><span class="line"><span class="hljs-comment">     * same &#123;<span class="hljs-doctag">@link</span> ThreadGroup&#125;. If there is a &#123;<span class="hljs-doctag">@link</span></span></span><br><span class="line"><span class="hljs-comment">     * java.lang.SecurityManager&#125;, it uses the group of &#123;<span class="hljs-doctag">@link</span></span></span><br><span class="line"><span class="hljs-comment">     * System#getSecurityManager&#125;, else the group of the thread</span></span><br><span class="line"><span class="hljs-comment">     * invoking this &#123;<span class="hljs-doctag">@code</span> defaultThreadFactory&#125; method. Each new</span></span><br><span class="line"><span class="hljs-comment">     * thread is created as a non-daemon thread with priority set to</span></span><br><span class="line"><span class="hljs-comment">     * the smaller of &#123;<span class="hljs-doctag">@code</span> Thread.NORM_PRIORITY&#125; and the maximum</span></span><br><span class="line"><span class="hljs-comment">     * priority permitted in the thread group.  New threads have names</span></span><br><span class="line"><span class="hljs-comment">     * accessible via &#123;<span class="hljs-doctag">@link</span> Thread#getName&#125; of</span></span><br><span class="line"><span class="hljs-comment">     * &lt;em&gt;pool-N-thread-M&lt;/em&gt;, where &lt;em&gt;N&lt;/em&gt; is the sequence</span></span><br><span class="line"><span class="hljs-comment">     * number of this factory, and &lt;em&gt;M&lt;/em&gt; is the sequence number</span></span><br><span class="line"><span class="hljs-comment">     * of the thread created by this factory.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name     the (metrics) name for this executor service, see &#123;<span class="hljs-doctag">@link</span> MetricRegistry#name(String, String...)&#125;.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> a thread factory</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#defaultThreadFactory()</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedThreadFactory <span class="hljs-title">defaultThreadFactory</span><span class="hljs-params">(MetricRegistry registry, String name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedThreadFactory(Executors.defaultThreadFactory(), registry, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns an instrumented default thread factory used to create new threads.</span></span><br><span class="line"><span class="hljs-comment">     * This factory creates all new threads used by an Executor in the</span></span><br><span class="line"><span class="hljs-comment">     * same &#123;<span class="hljs-doctag">@link</span> ThreadGroup&#125;. If there is a &#123;<span class="hljs-doctag">@link</span></span></span><br><span class="line"><span class="hljs-comment">     * java.lang.SecurityManager&#125;, it uses the group of &#123;<span class="hljs-doctag">@link</span></span></span><br><span class="line"><span class="hljs-comment">     * System#getSecurityManager&#125;, else the group of the thread</span></span><br><span class="line"><span class="hljs-comment">     * invoking this &#123;<span class="hljs-doctag">@code</span> defaultThreadFactory&#125; method. Each new</span></span><br><span class="line"><span class="hljs-comment">     * thread is created as a non-daemon thread with priority set to</span></span><br><span class="line"><span class="hljs-comment">     * the smaller of &#123;<span class="hljs-doctag">@code</span> Thread.NORM_PRIORITY&#125; and the maximum</span></span><br><span class="line"><span class="hljs-comment">     * priority permitted in the thread group.  New threads have names</span></span><br><span class="line"><span class="hljs-comment">     * accessible via &#123;<span class="hljs-doctag">@link</span> Thread#getName&#125; of</span></span><br><span class="line"><span class="hljs-comment">     * &lt;em&gt;pool-N-thread-M&lt;/em&gt;, where &lt;em&gt;N&lt;/em&gt; is the sequence</span></span><br><span class="line"><span class="hljs-comment">     * number of this factory, and &lt;em&gt;M&lt;/em&gt; is the sequence number</span></span><br><span class="line"><span class="hljs-comment">     * of the thread created by this factory.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> a thread factory</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#defaultThreadFactory()</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedThreadFactory <span class="hljs-title">defaultThreadFactory</span><span class="hljs-params">(MetricRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedThreadFactory(Executors.defaultThreadFactory(), registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns an instrumented thread factory used to create new threads that</span></span><br><span class="line"><span class="hljs-comment">     * have the same permissions as the current thread.</span></span><br><span class="line"><span class="hljs-comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="hljs-comment">     * This factory creates threads with the same settings as &#123;<span class="hljs-doctag">@link</span></span></span><br><span class="line"><span class="hljs-comment">     * Executors#defaultThreadFactory&#125;, additionally setting the</span></span><br><span class="line"><span class="hljs-comment">     * AccessControlContext and contextClassLoader of new threads to</span></span><br><span class="line"><span class="hljs-comment">     * be the same as the thread invoking this</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@code</span> privilegedThreadFactory&#125; method.  A new</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@code</span> privilegedThreadFactory&#125; can be created within an</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@link</span> java.security.AccessController#doPrivileged AccessController.doPrivileged&#125;</span></span><br><span class="line"><span class="hljs-comment">     * action setting the current thread's access control context to</span></span><br><span class="line"><span class="hljs-comment">     * create threads with the selected permission settings holding</span></span><br><span class="line"><span class="hljs-comment">     * within that action.</span></span><br><span class="line"><span class="hljs-comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="hljs-comment">     * &lt;p&gt;Note that while tasks running within such threads will have</span></span><br><span class="line"><span class="hljs-comment">     * the same access control and class loader settings as the</span></span><br><span class="line"><span class="hljs-comment">     * current thread, they need not have the same &#123;<span class="hljs-doctag">@link</span></span></span><br><span class="line"><span class="hljs-comment">     * java.lang.ThreadLocal&#125; or &#123;<span class="hljs-doctag">@link</span></span></span><br><span class="line"><span class="hljs-comment">     * java.lang.InheritableThreadLocal&#125; values. If necessary,</span></span><br><span class="line"><span class="hljs-comment">     * particular values of thread locals can be set or reset before</span></span><br><span class="line"><span class="hljs-comment">     * any task runs in &#123;<span class="hljs-doctag">@link</span> ThreadPoolExecutor&#125; subclasses using</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@link</span> ThreadPoolExecutor#beforeExecute(Thread, Runnable)&#125;.</span></span><br><span class="line"><span class="hljs-comment">     * Also, if it is necessary to initialize worker threads to have</span></span><br><span class="line"><span class="hljs-comment">     * the same InheritableThreadLocal settings as some other</span></span><br><span class="line"><span class="hljs-comment">     * designated thread, you can create a custom ThreadFactory in</span></span><br><span class="line"><span class="hljs-comment">     * which that thread waits for and services requests to create</span></span><br><span class="line"><span class="hljs-comment">     * others that will inherit its values.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name     the (metrics) name for this executor service, see &#123;<span class="hljs-doctag">@link</span> MetricRegistry#name(String, String...)&#125;.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> a thread factory</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> java.security.AccessControlException if the current access control</span></span><br><span class="line"><span class="hljs-comment">     *                                              context does not have permission to both get and set context</span></span><br><span class="line"><span class="hljs-comment">     *                                              class loader</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#privilegedThreadFactory()</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedThreadFactory <span class="hljs-title">privilegedThreadFactory</span><span class="hljs-params">(MetricRegistry registry, String name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedThreadFactory(Executors.privilegedThreadFactory(), registry, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns an instrumented thread factory used to create new threads that</span></span><br><span class="line"><span class="hljs-comment">     * have the same permissions as the current thread.</span></span><br><span class="line"><span class="hljs-comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="hljs-comment">     * This factory creates threads with the same settings as &#123;<span class="hljs-doctag">@link</span></span></span><br><span class="line"><span class="hljs-comment">     * Executors#defaultThreadFactory&#125;, additionally setting the</span></span><br><span class="line"><span class="hljs-comment">     * AccessControlContext and contextClassLoader of new threads to</span></span><br><span class="line"><span class="hljs-comment">     * be the same as the thread invoking this</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@code</span> privilegedThreadFactory&#125; method.  A new</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@code</span> privilegedThreadFactory&#125; can be created within an</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@link</span> java.security.AccessController#doPrivileged AccessController.doPrivileged&#125;</span></span><br><span class="line"><span class="hljs-comment">     * action setting the current thread's access control context to</span></span><br><span class="line"><span class="hljs-comment">     * create threads with the selected permission settings holding</span></span><br><span class="line"><span class="hljs-comment">     * within that action.</span></span><br><span class="line"><span class="hljs-comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="hljs-comment">     * &lt;p&gt;Note that while tasks running within such threads will have</span></span><br><span class="line"><span class="hljs-comment">     * the same access control and class loader settings as the</span></span><br><span class="line"><span class="hljs-comment">     * current thread, they need not have the same &#123;<span class="hljs-doctag">@link</span></span></span><br><span class="line"><span class="hljs-comment">     * java.lang.ThreadLocal&#125; or &#123;<span class="hljs-doctag">@link</span></span></span><br><span class="line"><span class="hljs-comment">     * java.lang.InheritableThreadLocal&#125; values. If necessary,</span></span><br><span class="line"><span class="hljs-comment">     * particular values of thread locals can be set or reset before</span></span><br><span class="line"><span class="hljs-comment">     * any task runs in &#123;<span class="hljs-doctag">@link</span> ThreadPoolExecutor&#125; subclasses using</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@link</span> ThreadPoolExecutor#beforeExecute(Thread, Runnable)&#125;.</span></span><br><span class="line"><span class="hljs-comment">     * Also, if it is necessary to initialize worker threads to have</span></span><br><span class="line"><span class="hljs-comment">     * the same InheritableThreadLocal settings as some other</span></span><br><span class="line"><span class="hljs-comment">     * designated thread, you can create a custom ThreadFactory in</span></span><br><span class="line"><span class="hljs-comment">     * which that thread waits for and services requests to create</span></span><br><span class="line"><span class="hljs-comment">     * others that will inherit its values.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> a thread factory</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> java.security.AccessControlException if the current access control</span></span><br><span class="line"><span class="hljs-comment">     *                                              context does not have permission to both get and set context</span></span><br><span class="line"><span class="hljs-comment">     *                                              class loader</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> Executors#privilegedThreadFactory()</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InstrumentedThreadFactory <span class="hljs-title">privilegedThreadFactory</span><span class="hljs-params">(MetricRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstrumentedThreadFactory(Executors.privilegedThreadFactory(), registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Cannot instantiate.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">InstrumentedExecutors</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="InstrumentedThreadFactory-java"><a href="#InstrumentedThreadFactory-java" class="headerlink" title="InstrumentedThreadFactory.java"></a>InstrumentedThreadFactory.java</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.ThreadFactory;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * A &#123;<span class="hljs-doctag">@link</span> ThreadFactory&#125; that monitors the number of threads created, running and terminated.</span></span><br><span class="line"><span class="hljs-comment"> * &lt;p/&gt;</span></span><br><span class="line"><span class="hljs-comment"> * It will register the metrics using the given (or auto-generated) name as classifier, e.g:</span></span><br><span class="line"><span class="hljs-comment"> * "your-thread-delegate.created", "your-thread-delegate.running", etc.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-comment">//包装ThreadFactory</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InstrumentedThreadFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ThreadFactory</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> AtomicLong nameCounter = <span class="hljs-keyword">new</span> AtomicLong();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ThreadFactory delegate;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 记录创建时数据</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Meter created;</span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 记录运行时数据</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Counter running;</span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 记录中断时数据</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Meter terminated;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Wraps a &#123;<span class="hljs-doctag">@link</span> ThreadFactory&#125;, uses a default auto-generated name.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> delegate &#123;<span class="hljs-doctag">@link</span> ThreadFactory&#125; to wrap.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InstrumentedThreadFactory</span><span class="hljs-params">(ThreadFactory delegate, MetricRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>(delegate, registry, <span class="hljs-string">"instrumented-thread-delegate-"</span> + nameCounter.incrementAndGet());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Wraps a &#123;<span class="hljs-doctag">@link</span> ThreadFactory&#125; with an explicit name.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> delegate &#123;<span class="hljs-doctag">@link</span> ThreadFactory&#125; to wrap.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name     name for this delegate.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InstrumentedThreadFactory</span><span class="hljs-params">(ThreadFactory delegate, MetricRegistry registry, String name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.delegate = delegate;</span><br><span class="line">        <span class="hljs-keyword">this</span>.created = registry.meter(MetricRegistry.name(name, <span class="hljs-string">"created"</span>));</span><br><span class="line">        <span class="hljs-keyword">this</span>.running = registry.counter(MetricRegistry.name(name, <span class="hljs-string">"running"</span>));</span><br><span class="line">        <span class="hljs-keyword">this</span>.terminated = registry.meter(MetricRegistry.name(name, <span class="hljs-string">"terminated"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     *  新建线程</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> Thread <span class="hljs-title">newThread</span><span class="hljs-params">(Runnable runnable)</span> </span>&#123;</span><br><span class="line">        Runnable wrappedRunnable = <span class="hljs-keyword">new</span> InstrumentedRunnable(runnable);</span><br><span class="line">        Thread thread = delegate.newThread(wrappedRunnable);</span><br><span class="line">        created.mark();</span><br><span class="line">        <span class="hljs-keyword">return</span> thread;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">//包装runnable</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InstrumentedRunnable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Runnable task;</span><br><span class="line"></span><br><span class="line">        InstrumentedRunnable(Runnable task) &#123;</span><br><span class="line">            <span class="hljs-keyword">this</span>.task = task;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-meta">@Override</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            running.inc();</span><br><span class="line">            <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                task.run();</span><br><span class="line">            &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">                running.dec();</span><br><span class="line">                terminated.mark();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="InstrumentedExecutorService-java"><a href="#InstrumentedExecutorService-java" class="headerlink" title="InstrumentedExecutorService.java"></a>InstrumentedExecutorService.java</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.List;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * An &#123;<span class="hljs-doctag">@link</span> ExecutorService&#125; that monitors the number of tasks submitted, running,</span></span><br><span class="line"><span class="hljs-comment"> * completed and also keeps a &#123;<span class="hljs-doctag">@link</span> Timer&#125; for the task duration.</span></span><br><span class="line"><span class="hljs-comment"> * &lt;p/&gt;</span></span><br><span class="line"><span class="hljs-comment"> * It will register the metrics using the given (or auto-generated) name as classifier, e.g:</span></span><br><span class="line"><span class="hljs-comment"> * "your-executor-service.submitted", "your-executor-service.running", etc.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-comment">//包装executorService，写入监控对象</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InstrumentedExecutorService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ExecutorService</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">//计数</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> AtomicLong nameCounter = <span class="hljs-keyword">new</span> AtomicLong();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ExecutorService delegate;</span><br><span class="line">    <span class="hljs-comment">//检测类型的对象</span></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     *  任务执行次数</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Meter submitted;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Counter running;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Meter completed;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Timer duration;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Meter rejected;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Wraps an &#123;<span class="hljs-doctag">@link</span> ExecutorService&#125; uses an auto-generated default name.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> delegate &#123;<span class="hljs-doctag">@link</span> ExecutorService&#125; to wrap.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InstrumentedExecutorService</span><span class="hljs-params">(ExecutorService delegate, MetricRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>(delegate, registry, <span class="hljs-string">"instrumented-delegate-"</span> + nameCounter.incrementAndGet());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Wraps an &#123;<span class="hljs-doctag">@link</span> ExecutorService&#125; with an explicit name.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> delegate &#123;<span class="hljs-doctag">@link</span> ExecutorService&#125; to wrap.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name     name for this executor service.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InstrumentedExecutorService</span><span class="hljs-params">(ExecutorService delegate, MetricRegistry registry, String name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.delegate = delegate;</span><br><span class="line">        <span class="hljs-keyword">this</span>.submitted = registry.meter(MetricRegistry.name(name, <span class="hljs-string">"submitted"</span>));</span><br><span class="line">        <span class="hljs-keyword">this</span>.running = registry.counter(MetricRegistry.name(name, <span class="hljs-string">"running"</span>));</span><br><span class="line">        <span class="hljs-keyword">this</span>.completed = registry.meter(MetricRegistry.name(name, <span class="hljs-string">"completed"</span>));</span><br><span class="line">        <span class="hljs-keyword">this</span>.duration = registry.timer(MetricRegistry.name(name, <span class="hljs-string">"duration"</span>));</span><br><span class="line">        <span class="hljs-keyword">this</span>.rejected = registry.meter(MetricRegistry.name(name, <span class="hljs-string">"rejected"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">execute</span><span class="hljs-params">(Runnable runnable)</span> </span>&#123;</span><br><span class="line">        submitted.mark();</span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            <span class="hljs-comment">//执行包装任务</span></span><br><span class="line">            delegate.execute(<span class="hljs-keyword">new</span> InstrumentedRunnable(runnable));</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (RejectedExecutionException e) &#123;</span><br><span class="line">            rejected.mark();</span><br><span class="line">            <span class="hljs-keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> Future&lt;?&gt; submit(Runnable runnable) &#123;</span><br><span class="line">        submitted.mark();</span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> delegate.submit(<span class="hljs-keyword">new</span> InstrumentedRunnable(runnable));</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (RejectedExecutionException e) &#123;</span><br><span class="line">            rejected.mark();</span><br><span class="line">            <span class="hljs-keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">Future&lt;T&gt; <span class="hljs-title">submit</span><span class="hljs-params">(Runnable runnable, T result)</span> </span>&#123;</span><br><span class="line">        submitted.mark();</span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> delegate.submit(<span class="hljs-keyword">new</span> InstrumentedRunnable(runnable), result);</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (RejectedExecutionException e) &#123;</span><br><span class="line">            rejected.mark();</span><br><span class="line">            <span class="hljs-keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">Future&lt;T&gt; <span class="hljs-title">submit</span><span class="hljs-params">(Callable&lt;T&gt; task)</span> </span>&#123;</span><br><span class="line">        submitted.mark();</span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> delegate.submit(<span class="hljs-keyword">new</span> InstrumentedCallable&lt;T&gt;(task));</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (RejectedExecutionException e) &#123;</span><br><span class="line">            rejected.mark();</span><br><span class="line">            <span class="hljs-keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     * 执行所有任务</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks) <span class="hljs-keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        submitted.mark(tasks.size());</span><br><span class="line">        Collection&lt;? extends Callable&lt;T&gt;&gt; instrumented = instrument(tasks);</span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> delegate.invokeAll(instrumented);</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (RejectedExecutionException e) &#123;</span><br><span class="line">            rejected.mark();</span><br><span class="line">            <span class="hljs-keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, <span class="hljs-keyword">long</span> timeout, TimeUnit unit) <span class="hljs-keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        submitted.mark(tasks.size());</span><br><span class="line">        Collection&lt;? extends Callable&lt;T&gt;&gt; instrumented = instrument(tasks);</span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> delegate.invokeAll(instrumented, timeout, unit);</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (RejectedExecutionException e) &#123;</span><br><span class="line">            rejected.mark();</span><br><span class="line">            <span class="hljs-keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">invokeAny</span><span class="hljs-params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        submitted.mark(tasks.size());</span><br><span class="line">        Collection&lt;? extends Callable&lt;T&gt;&gt; instrumented = instrument(tasks);</span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> delegate.invokeAny(instrumented);</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (RejectedExecutionException e) &#123;</span><br><span class="line">            rejected.mark();</span><br><span class="line">            <span class="hljs-keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">invokeAny</span><span class="hljs-params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, <span class="hljs-keyword">long</span> timeout, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException, TimeoutException </span>&#123;</span><br><span class="line">        submitted.mark(tasks.size());</span><br><span class="line">        <span class="hljs-comment">//包装后的callable的列表</span></span><br><span class="line">        Collection&lt;? extends Callable&lt;T&gt;&gt; instrumented = instrument(tasks);</span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> delegate.invokeAny(instrumented, timeout, unit);</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (RejectedExecutionException e) &#123;</span><br><span class="line">            rejected.mark();</span><br><span class="line">            <span class="hljs-keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 包装任务callable列表</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> tasks</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> &lt;T&gt; Collection&lt;? extends Callable&lt;T&gt;&gt; instrument(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks) &#123;</span><br><span class="line">        <span class="hljs-comment">//好习惯。默认初始化大小</span></span><br><span class="line">        <span class="hljs-keyword">final</span> List&lt;InstrumentedCallable&lt;T&gt;&gt; instrumented = <span class="hljs-keyword">new</span> ArrayList&lt;InstrumentedCallable&lt;T&gt;&gt;(tasks.size());</span><br><span class="line">        <span class="hljs-keyword">for</span> (Callable&lt;T&gt; task : tasks) &#123;</span><br><span class="line">            instrumented.add(<span class="hljs-keyword">new</span> InstrumentedCallable&lt;T&gt;(task));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> instrumented;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">shutdown</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        delegate.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Runnable&gt; <span class="hljs-title">shutdownNow</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> delegate.shutdownNow();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isShutdown</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> delegate.isShutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isTerminated</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> delegate.isTerminated();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">awaitTermination</span><span class="hljs-params">(<span class="hljs-keyword">long</span> l, TimeUnit timeUnit)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> delegate.awaitTermination(l, timeUnit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">//runnble</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InstrumentedRunnable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Runnable task;</span><br><span class="line"></span><br><span class="line">        InstrumentedRunnable(Runnable task) &#123;</span><br><span class="line">            <span class="hljs-keyword">this</span>.task = task;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-meta">@Override</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            running.inc();</span><br><span class="line">            <span class="hljs-keyword">final</span> Timer.Context context = duration.time();</span><br><span class="line">            <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                task.run();</span><br><span class="line">            &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">                context.stop();</span><br><span class="line">                running.dec();</span><br><span class="line">                completed.mark();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">//覆写callable方法</span></span><br><span class="line">    <span class="hljs-comment">//加入检测</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InstrumentedCallable</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">Callable</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Callable&lt;T&gt; callable;</span><br><span class="line"></span><br><span class="line">        InstrumentedCallable(Callable&lt;T&gt; callable) &#123;</span><br><span class="line">            <span class="hljs-keyword">this</span>.callable = callable;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-meta">@Override</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            running.inc();</span><br><span class="line">            <span class="hljs-keyword">final</span> Timer.Context context = duration.time();</span><br><span class="line">            <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> callable.call();</span><br><span class="line">            &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">                context.stop();</span><br><span class="line">                running.dec();</span><br><span class="line">                completed.mark();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="InstrumentedScheduledExecutorService-java"><a href="#InstrumentedScheduledExecutorService-java" class="headerlink" title="InstrumentedScheduledExecutorService.java"></a>InstrumentedScheduledExecutorService.java</h3><p>包装ScheduledExecutorService类，嵌入监控对象<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.List;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * An &#123;<span class="hljs-doctag">@link</span> ScheduledExecutorService&#125; that monitors the number of tasks submitted, running,</span></span><br><span class="line"><span class="hljs-comment"> * completed and also keeps a &#123;<span class="hljs-doctag">@link</span> Timer&#125; for the task duration.</span></span><br><span class="line"><span class="hljs-comment"> * &lt;p/&gt;</span></span><br><span class="line"><span class="hljs-comment"> * It will register the metrics using the given (or auto-generated) name as classifier, e.g:</span></span><br><span class="line"><span class="hljs-comment"> * "your-executor-service.submitted", "your-executor-service.running", etc.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InstrumentedScheduledExecutorService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ScheduledExecutorService</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> AtomicLong nameCounter = <span class="hljs-keyword">new</span> AtomicLong();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ScheduledExecutorService delegate;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Meter submitted;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Counter running;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Meter completed;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Timer duration;</span><br><span class="line">    <span class="hljs-comment">//1次</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Meter scheduledOnce;</span><br><span class="line">    <span class="hljs-comment">//重复</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Meter scheduledRepetitively;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Counter scheduledOverrun;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Histogram percentOfPeriod;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Wraps an &#123;<span class="hljs-doctag">@link</span> ScheduledExecutorService&#125; uses an auto-generated default name.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> delegate &#123;<span class="hljs-doctag">@link</span> ScheduledExecutorService&#125; to wrap.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InstrumentedScheduledExecutorService</span><span class="hljs-params">(ScheduledExecutorService delegate, MetricRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>(delegate, registry, <span class="hljs-string">"instrumented-scheduled-executor-service-"</span> + nameCounter.incrementAndGet());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Wraps an &#123;<span class="hljs-doctag">@link</span> ScheduledExecutorService&#125; with an explicit name.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> delegate &#123;<span class="hljs-doctag">@link</span> ScheduledExecutorService&#125; to wrap.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; that will contain the metrics.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name     name for this executor service.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InstrumentedScheduledExecutorService</span><span class="hljs-params">(ScheduledExecutorService delegate, MetricRegistry registry, String name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.delegate = delegate;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">this</span>.submitted = registry.meter(MetricRegistry.name(name, <span class="hljs-string">"submitted"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">this</span>.running = registry.counter(MetricRegistry.name(name, <span class="hljs-string">"running"</span>));</span><br><span class="line">        <span class="hljs-keyword">this</span>.completed = registry.meter(MetricRegistry.name(name, <span class="hljs-string">"completed"</span>));</span><br><span class="line">        <span class="hljs-keyword">this</span>.duration = registry.timer(MetricRegistry.name(name, <span class="hljs-string">"duration"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">this</span>.scheduledOnce = registry.meter(MetricRegistry.name(name, <span class="hljs-string">"scheduled.once"</span>));</span><br><span class="line">        <span class="hljs-keyword">this</span>.scheduledRepetitively = registry.meter(MetricRegistry.name(name, <span class="hljs-string">"scheduled.repetitively"</span>));</span><br><span class="line">        <span class="hljs-keyword">this</span>.scheduledOverrun = registry.counter(MetricRegistry.name(name, <span class="hljs-string">"scheduled.overrun"</span>));</span><br><span class="line">        <span class="hljs-keyword">this</span>.percentOfPeriod = registry.histogram(MetricRegistry.name(name, <span class="hljs-string">"scheduled.percent-of-period"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> ScheduledFuture&lt;?&gt; schedule(Runnable command, <span class="hljs-keyword">long</span> delay, TimeUnit unit) &#123;</span><br><span class="line">        scheduledOnce.mark();</span><br><span class="line">        <span class="hljs-keyword">return</span> delegate.schedule(<span class="hljs-keyword">new</span> InstrumentedRunnable(command), delay, unit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> &lt;V&gt; <span class="hljs-function">ScheduledFuture&lt;V&gt; <span class="hljs-title">schedule</span><span class="hljs-params">(Callable&lt;V&gt; callable, <span class="hljs-keyword">long</span> delay, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        scheduledOnce.mark();</span><br><span class="line">        <span class="hljs-keyword">return</span> delegate.schedule(<span class="hljs-keyword">new</span> InstrumentedCallable&lt;V&gt;(callable), delay, unit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> ScheduledFuture&lt;?&gt; scheduleAtFixedRate(Runnable command, <span class="hljs-keyword">long</span> initialDelay, <span class="hljs-keyword">long</span> period, TimeUnit unit) &#123;</span><br><span class="line">        scheduledRepetitively.mark();</span><br><span class="line">        <span class="hljs-keyword">return</span> delegate.scheduleAtFixedRate(<span class="hljs-keyword">new</span> InstrumentedPeriodicRunnable(command, period, unit), initialDelay, period, unit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> ScheduledFuture&lt;?&gt; scheduleWithFixedDelay(Runnable command, <span class="hljs-keyword">long</span> initialDelay, <span class="hljs-keyword">long</span> delay, TimeUnit unit) &#123;</span><br><span class="line">        scheduledRepetitively.mark();</span><br><span class="line">        <span class="hljs-keyword">return</span> delegate.scheduleAtFixedRate(<span class="hljs-keyword">new</span> InstrumentedRunnable(command), initialDelay, delay, unit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">shutdown</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        delegate.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Runnable&gt; <span class="hljs-title">shutdownNow</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> delegate.shutdownNow();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isShutdown</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> delegate.isShutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isTerminated</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> delegate.isTerminated();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">awaitTermination</span><span class="hljs-params">(<span class="hljs-keyword">long</span> timeout, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> delegate.awaitTermination(timeout, unit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">Future&lt;T&gt; <span class="hljs-title">submit</span><span class="hljs-params">(Callable&lt;T&gt; task)</span> </span>&#123;</span><br><span class="line">        submitted.mark();</span><br><span class="line">        <span class="hljs-keyword">return</span> delegate.submit(<span class="hljs-keyword">new</span> InstrumentedCallable&lt;T&gt;(task));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">Future&lt;T&gt; <span class="hljs-title">submit</span><span class="hljs-params">(Runnable task, T result)</span> </span>&#123;</span><br><span class="line">        submitted.mark();</span><br><span class="line">        <span class="hljs-keyword">return</span> delegate.submit(<span class="hljs-keyword">new</span> InstrumentedRunnable(task), result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> Future&lt;?&gt; submit(Runnable task) &#123;</span><br><span class="line">        submitted.mark();</span><br><span class="line">        <span class="hljs-keyword">return</span> delegate.submit(<span class="hljs-keyword">new</span> InstrumentedRunnable(task));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks) <span class="hljs-keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        submitted.mark(tasks.size());</span><br><span class="line">        Collection&lt;? extends Callable&lt;T&gt;&gt; instrumented = instrument(tasks);</span><br><span class="line">        <span class="hljs-keyword">return</span> delegate.invokeAll(instrumented);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, <span class="hljs-keyword">long</span> timeout, TimeUnit unit) <span class="hljs-keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        submitted.mark(tasks.size());</span><br><span class="line">        Collection&lt;? extends Callable&lt;T&gt;&gt; instrumented = instrument(tasks);</span><br><span class="line">        <span class="hljs-keyword">return</span> delegate.invokeAll(instrumented, timeout, unit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">invokeAny</span><span class="hljs-params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span> <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</span><br><span class="line">        submitted.mark(tasks.size());</span><br><span class="line">        Collection&lt;? extends Callable&lt;T&gt;&gt; instrumented = instrument(tasks);</span><br><span class="line">        <span class="hljs-keyword">return</span> delegate.invokeAny(instrumented);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">invokeAny</span><span class="hljs-params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, <span class="hljs-keyword">long</span> timeout, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException, TimeoutException </span>&#123;</span><br><span class="line">        submitted.mark(tasks.size());</span><br><span class="line">        Collection&lt;? extends Callable&lt;T&gt;&gt; instrumented = instrument(tasks);</span><br><span class="line">        <span class="hljs-keyword">return</span> delegate.invokeAny(instrumented, timeout, unit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> &lt;T&gt; Collection&lt;? extends Callable&lt;T&gt;&gt; instrument(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks) &#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> List&lt;InstrumentedCallable&lt;T&gt;&gt; instrumented = <span class="hljs-keyword">new</span> ArrayList&lt;InstrumentedCallable&lt;T&gt;&gt;(tasks.size());</span><br><span class="line">        <span class="hljs-keyword">for</span> (Callable&lt;T&gt; task : tasks) &#123;</span><br><span class="line">            instrumented.add(<span class="hljs-keyword">new</span> InstrumentedCallable(task));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> instrumented;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">execute</span><span class="hljs-params">(Runnable command)</span> </span>&#123;</span><br><span class="line">        submitted.mark();</span><br><span class="line">        delegate.execute(<span class="hljs-keyword">new</span> InstrumentedRunnable(command));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">//-----------------内部类</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InstrumentedRunnable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Runnable command;</span><br><span class="line"></span><br><span class="line">        InstrumentedRunnable(Runnable command) &#123;</span><br><span class="line">            <span class="hljs-keyword">this</span>.command = command;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-meta">@Override</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            running.inc();</span><br><span class="line">            <span class="hljs-keyword">final</span> Timer.Context context = duration.time();</span><br><span class="line">            <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                command.run();</span><br><span class="line">            &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">                context.stop();</span><br><span class="line">                running.dec();</span><br><span class="line">                completed.mark();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InstrumentedPeriodicRunnable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Runnable command;</span><br><span class="line">        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> periodInNanos;</span><br><span class="line"></span><br><span class="line">        InstrumentedPeriodicRunnable(Runnable command, <span class="hljs-keyword">long</span> period, TimeUnit unit) &#123;</span><br><span class="line">            <span class="hljs-keyword">this</span>.command = command;</span><br><span class="line">            <span class="hljs-keyword">this</span>.periodInNanos = unit.toNanos(period);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-meta">@Override</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            running.inc();</span><br><span class="line">            <span class="hljs-keyword">final</span> Timer.Context context = duration.time();</span><br><span class="line">            <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                command.run();</span><br><span class="line">            &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">                <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> elapsed = context.stop();</span><br><span class="line">                running.dec();</span><br><span class="line">                completed.mark();</span><br><span class="line">                <span class="hljs-keyword">if</span> (elapsed &gt; periodInNanos) &#123;</span><br><span class="line">                    scheduledOverrun.inc();</span><br><span class="line">                &#125;</span><br><span class="line">                percentOfPeriod.update((<span class="hljs-number">100L</span> * elapsed) / periodInNanos);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InstrumentedCallable</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">Callable</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Callable&lt;T&gt; task;</span><br><span class="line"></span><br><span class="line">        InstrumentedCallable(Callable&lt;T&gt; task) &#123;</span><br><span class="line">            <span class="hljs-keyword">this</span>.task = task;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-meta">@Override</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            running.inc();</span><br><span class="line">            <span class="hljs-keyword">final</span> Timer.Context context = duration.time();</span><br><span class="line">            <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> task.call();</span><br><span class="line">            &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">                context.stop();</span><br><span class="line">                running.dec();</span><br><span class="line">                completed.mark();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="metrics-healthchecks"><a href="#metrics-healthchecks" class="headerlink" title="metrics-healthchecks"></a>metrics-healthchecks</h2><h3 id="HealthCheck-java"><a href="#HealthCheck-java" class="headerlink" title="HealthCheck.java"></a>HealthCheck.java</h3><p>健康监测抽象类<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.health;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * A health check for a component of your application.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * 应用健康监测抽象类</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HealthCheck</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * The result of a &#123;<span class="hljs-doctag">@link</span> HealthCheck&#125; being run. It can be healthy (with an optional message)</span></span><br><span class="line"><span class="hljs-comment">     * or unhealthy (with either an error message or a thrown exception).</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * 检测结果类：健康，非健康</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Result</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Result HEALTHY = <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);</span><br><span class="line">        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> PRIME = <span class="hljs-number">31</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">         * Returns a healthy &#123;<span class="hljs-doctag">@link</span> Result&#125; with no additional message.</span></span><br><span class="line"><span class="hljs-comment">         *</span></span><br><span class="line"><span class="hljs-comment">         * <span class="hljs-doctag">@return</span> a healthy &#123;<span class="hljs-doctag">@link</span> Result&#125; with no additional message</span></span><br><span class="line"><span class="hljs-comment">         */</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Result <span class="hljs-title">healthy</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> HEALTHY;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">         * Returns a healthy &#123;<span class="hljs-doctag">@link</span> Result&#125; with an additional message.</span></span><br><span class="line"><span class="hljs-comment">         *</span></span><br><span class="line"><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> message an informative message</span></span><br><span class="line"><span class="hljs-comment">         * <span class="hljs-doctag">@return</span> a healthy &#123;<span class="hljs-doctag">@link</span> Result&#125; with an additional message</span></span><br><span class="line"><span class="hljs-comment">         */</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Result <span class="hljs-title">healthy</span><span class="hljs-params">(String message)</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>, message, <span class="hljs-keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">         * Returns a healthy &#123;<span class="hljs-doctag">@link</span> Result&#125; with a formatted message.</span></span><br><span class="line"><span class="hljs-comment">         * &lt;p/&gt;</span></span><br><span class="line"><span class="hljs-comment">         * Message formatting follows the same rules as &#123;<span class="hljs-doctag">@link</span> String#format(String, Object...)&#125;.</span></span><br><span class="line"><span class="hljs-comment">         *</span></span><br><span class="line"><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> message a message format</span></span><br><span class="line"><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> args    the arguments apply to the message format</span></span><br><span class="line"><span class="hljs-comment">         * <span class="hljs-doctag">@return</span> a healthy &#123;<span class="hljs-doctag">@link</span> Result&#125; with an additional message</span></span><br><span class="line"><span class="hljs-comment">         * <span class="hljs-doctag">@see</span> String#format(String, Object...)</span></span><br><span class="line"><span class="hljs-comment">         */</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Result <span class="hljs-title">healthy</span><span class="hljs-params">(String message, Object... args)</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> healthy(String.format(message, args));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">         * Returns an unhealthy &#123;<span class="hljs-doctag">@link</span> Result&#125; with the given message.</span></span><br><span class="line"><span class="hljs-comment">         *</span></span><br><span class="line"><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> message an informative message describing how the health check failed</span></span><br><span class="line"><span class="hljs-comment">         * <span class="hljs-doctag">@return</span> an unhealthy &#123;<span class="hljs-doctag">@link</span> Result&#125; with the given message</span></span><br><span class="line"><span class="hljs-comment">         */</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Result <span class="hljs-title">unhealthy</span><span class="hljs-params">(String message)</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">false</span>, message, <span class="hljs-keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">         * Returns an unhealthy &#123;<span class="hljs-doctag">@link</span> Result&#125; with a formatted message.</span></span><br><span class="line"><span class="hljs-comment">         * &lt;p/&gt;</span></span><br><span class="line"><span class="hljs-comment">         * Message formatting follows the same rules as &#123;<span class="hljs-doctag">@link</span> String#format(String, Object...)&#125;.</span></span><br><span class="line"><span class="hljs-comment">         *</span></span><br><span class="line"><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> message a message format</span></span><br><span class="line"><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> args    the arguments apply to the message format</span></span><br><span class="line"><span class="hljs-comment">         * <span class="hljs-doctag">@return</span> an unhealthy &#123;<span class="hljs-doctag">@link</span> Result&#125; with an additional message</span></span><br><span class="line"><span class="hljs-comment">         * <span class="hljs-doctag">@see</span> String#format(String, Object...)</span></span><br><span class="line"><span class="hljs-comment">         */</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Result <span class="hljs-title">unhealthy</span><span class="hljs-params">(String message, Object... args)</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> unhealthy(String.format(message, args));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">         * Returns an unhealthy &#123;<span class="hljs-doctag">@link</span> Result&#125; with the given error.</span></span><br><span class="line"><span class="hljs-comment">         *</span></span><br><span class="line"><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> error an exception thrown during the health check</span></span><br><span class="line"><span class="hljs-comment">         * <span class="hljs-doctag">@return</span> an unhealthy &#123;<span class="hljs-doctag">@link</span> Result&#125; with the given error</span></span><br><span class="line"><span class="hljs-comment">         */</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Result <span class="hljs-title">unhealthy</span><span class="hljs-params">(Throwable error)</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">false</span>, error.getMessage(), error);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">//是否健康</span></span><br><span class="line">        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> healthy;</span><br><span class="line">        <span class="hljs-comment">//内容</span></span><br><span class="line">        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String message;</span><br><span class="line">        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Throwable error;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">Result</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isHealthy, String message, Throwable error)</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">this</span>.healthy = isHealthy;</span><br><span class="line">            <span class="hljs-keyword">this</span>.message = message;</span><br><span class="line">            <span class="hljs-keyword">this</span>.error = error;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">         * Returns &#123;<span class="hljs-doctag">@code</span> true&#125; if the result indicates the component is healthy; &#123;<span class="hljs-doctag">@code</span> false&#125;</span></span><br><span class="line"><span class="hljs-comment">         * otherwise.</span></span><br><span class="line"><span class="hljs-comment">         *</span></span><br><span class="line"><span class="hljs-comment">         * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@code</span> true&#125; if the result indicates the component is healthy</span></span><br><span class="line"><span class="hljs-comment">         */</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isHealthy</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> healthy;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">         * Returns any additional message for the result, or &#123;<span class="hljs-doctag">@code</span> null&#125; if the result has no</span></span><br><span class="line"><span class="hljs-comment">         * message.</span></span><br><span class="line"><span class="hljs-comment">         *</span></span><br><span class="line"><span class="hljs-comment">         * <span class="hljs-doctag">@return</span> any additional message for the result, or &#123;<span class="hljs-doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="hljs-comment">         */</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> message;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">         * Returns any exception for the result, or &#123;<span class="hljs-doctag">@code</span> null&#125; if the result has no exception.</span></span><br><span class="line"><span class="hljs-comment">         *</span></span><br><span class="line"><span class="hljs-comment">         * <span class="hljs-doctag">@return</span> any exception for the result, or &#123;<span class="hljs-doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="hljs-comment">         */</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> Throwable <span class="hljs-title">getError</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> error;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-meta">@Override</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">equals</span><span class="hljs-params">(Object o)</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> == o) &#123; <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>; &#125;</span><br><span class="line">            <span class="hljs-keyword">if</span> (o == <span class="hljs-keyword">null</span> || getClass() != o.getClass()) &#123; <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>; &#125;</span><br><span class="line">            <span class="hljs-keyword">final</span> Result result = (Result) o;</span><br><span class="line">            <span class="hljs-keyword">return</span> healthy == result.healthy &amp;&amp;</span><br><span class="line">                    !(error != <span class="hljs-keyword">null</span> ? !error.equals(result.error) : result.error != <span class="hljs-keyword">null</span>) &amp;&amp;</span><br><span class="line">                    !(message != <span class="hljs-keyword">null</span> ? !message.equals(result.message) : result.message != <span class="hljs-keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-meta">@Override</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">int</span> result = (healthy ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>);</span><br><span class="line">            result = PRIME * result + (message != <span class="hljs-keyword">null</span> ? message.hashCode() : <span class="hljs-number">0</span>);</span><br><span class="line">            result = PRIME * result + (error != <span class="hljs-keyword">null</span> ? error.hashCode() : <span class="hljs-number">0</span>);</span><br><span class="line">            <span class="hljs-keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-meta">@Override</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">final</span> StringBuilder builder = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"Result&#123;isHealthy="</span>);</span><br><span class="line">            builder.append(healthy);</span><br><span class="line">            <span class="hljs-keyword">if</span> (message != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">                builder.append(<span class="hljs-string">", message="</span>).append(message);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">if</span> (error != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">                builder.append(<span class="hljs-string">", error="</span>).append(error);</span><br><span class="line">            &#125;</span><br><span class="line">            builder.append(<span class="hljs-string">'&#125;'</span>);</span><br><span class="line">            <span class="hljs-keyword">return</span> builder.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Perform a check of the application component.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * 检测health</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> if the component is healthy, a healthy &#123;<span class="hljs-doctag">@link</span> Result&#125;; otherwise, an unhealthy &#123;<span class="hljs-doctag">@link</span></span></span><br><span class="line"><span class="hljs-comment">     *         Result&#125; with a descriptive error message or exception</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception if there is an unhandled error during the health check; this will result in</span></span><br><span class="line"><span class="hljs-comment">     *                   a failed health check</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> Result <span class="hljs-title">check</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Executes the health check, catching and handling any exceptions raised by &#123;<span class="hljs-doctag">@link</span> #check()&#125;.</span></span><br><span class="line"><span class="hljs-comment">     * 线程执行 health check</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> if the component is healthy, a healthy &#123;<span class="hljs-doctag">@link</span> Result&#125;; otherwise, an unhealthy &#123;<span class="hljs-doctag">@link</span></span></span><br><span class="line"><span class="hljs-comment">     *         Result&#125; with a descriptive error message or exception</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">execute</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> check();</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> Result.unhealthy(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="HealthCheckRegistry-java"><a href="#HealthCheckRegistry-java" class="headerlink" title="HealthCheckRegistry.java"></a>HealthCheckRegistry.java</h3><p>healthCheck的注册类<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.health;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> io.dropwizard.metrics.health.HealthCheck.Result;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.util.*;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * A registry for health checks.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * healthCheck的注册类</span></span><br><span class="line"><span class="hljs-comment"> * 把HealthCheck注册到Map中</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HealthCheckRegistry</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(HealthCheckRegistry.class);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">//health 的map</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentMap&lt;String, HealthCheck&gt; healthChecks;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a new &#123;<span class="hljs-doctag">@link</span> HealthCheckRegistry&#125;.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HealthCheckRegistry</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.healthChecks = <span class="hljs-keyword">new</span> ConcurrentHashMap&lt;String, HealthCheck&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Registers an application &#123;<span class="hljs-doctag">@link</span> HealthCheck&#125;.</span></span><br><span class="line"><span class="hljs-comment">     * 存储到map</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name        the name of the health check</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> healthCheck the &#123;<span class="hljs-doctag">@link</span> HealthCheck&#125; instance</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">register</span><span class="hljs-params">(String name, HealthCheck healthCheck)</span> </span>&#123;</span><br><span class="line">        healthChecks.putIfAbsent(name, healthCheck);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Unregisters the application &#123;<span class="hljs-doctag">@link</span> HealthCheck&#125; with the given name.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name the name of the &#123;<span class="hljs-doctag">@link</span> HealthCheck&#125; instance</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unregister</span><span class="hljs-params">(String name)</span> </span>&#123;</span><br><span class="line">        healthChecks.remove(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns a set of the names of all registered health checks.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * 返回注册healthCheck的name</span></span><br><span class="line"><span class="hljs-comment">     * 且是不可修改的set</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the names of all registered health checks</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> SortedSet&lt;String&gt; <span class="hljs-title">getNames</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> Collections.unmodifiableSortedSet(<span class="hljs-keyword">new</span> TreeSet&lt;String&gt;(healthChecks.keySet()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Runs the health check with the given name.</span></span><br><span class="line"><span class="hljs-comment">     * 根据名字执行healthCheck 检测</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name    the health check's name</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the result of the health check</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NoSuchElementException if there is no health check with the given name</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> HealthCheck.<span class="hljs-function">Result <span class="hljs-title">runHealthCheck</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> NoSuchElementException </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> HealthCheck healthCheck = healthChecks.get(name);</span><br><span class="line">        <span class="hljs-keyword">if</span> (healthCheck == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NoSuchElementException(<span class="hljs-string">"No health check named "</span> + name + <span class="hljs-string">" exists"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> healthCheck.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Runs the registered health checks and returns a map of the results.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * 运行health 检测 ，返回执行结果</span></span><br><span class="line"><span class="hljs-comment">     * 返回不可修改的map</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> a map of the health check results</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> SortedMap&lt;String, HealthCheck.Result&gt; runHealthChecks() &#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> SortedMap&lt;String, HealthCheck.Result&gt; results = <span class="hljs-keyword">new</span> TreeMap&lt;String, HealthCheck.Result&gt;();</span><br><span class="line">        <span class="hljs-comment">//检测结果</span></span><br><span class="line">        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, HealthCheck&gt; entry : healthChecks.entrySet()) &#123;</span><br><span class="line">            <span class="hljs-comment">//执行任务</span></span><br><span class="line">            <span class="hljs-keyword">final</span> Result result = entry.getValue().execute();</span><br><span class="line">            results.put(entry.getKey(), result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-comment">//返回不可修改的执行结果</span></span><br><span class="line">        <span class="hljs-keyword">return</span> Collections.unmodifiableSortedMap(results);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * 线程池执行健康监测</span></span><br><span class="line"><span class="hljs-comment">     * 阻塞（Callable）的返回执行结果</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * Runs the registered health checks in parallel and returns a map of the results.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span>   executor object to launch and track health checks progress</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> a map of the health check results</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> SortedMap&lt;String, HealthCheck.Result&gt; runHealthChecks(ExecutorService executor) &#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> Map&lt;String, Future&lt;HealthCheck.Result&gt;&gt; futures = <span class="hljs-keyword">new</span> HashMap&lt;String, Future&lt;Result&gt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> Map.Entry&lt;String, HealthCheck&gt; entry : healthChecks.entrySet()) &#123;</span><br><span class="line">            <span class="hljs-comment">//线程池中执行任务</span></span><br><span class="line">            futures.put(entry.getKey(), executor.submit(<span class="hljs-keyword">new</span> Callable&lt;Result&gt;() &#123;</span><br><span class="line">                <span class="hljs-meta">@Override</span></span><br><span class="line">                <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    <span class="hljs-keyword">return</span> entry.getValue().execute();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">final</span> SortedMap&lt;String, HealthCheck.Result&gt; results = <span class="hljs-keyword">new</span> TreeMap&lt;String, HealthCheck.Result&gt;();</span><br><span class="line">        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Future&lt;Result&gt;&gt; entry : futures.entrySet()) &#123;</span><br><span class="line">            <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                results.put(entry.getKey(), entry.getValue().get());</span><br><span class="line">            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                LOGGER.warn(<span class="hljs-string">"Error executing health check &#123;&#125;"</span>, entry.getKey(), e);</span><br><span class="line">                results.put(entry.getKey(), HealthCheck.Result.unhealthy(e));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> Collections.unmodifiableSortedMap(results);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="SharedHealthCheckRegistries-java"><a href="#SharedHealthCheckRegistries-java" class="headerlink" title="SharedHealthCheckRegistries.java"></a>SharedHealthCheckRegistries.java</h3><p>HealthCheckRegistry的全局Map<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.health;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Set;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentMap;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * A map of shared, named health registries.</span></span><br><span class="line"><span class="hljs-comment"> * HealthCheckRegistry的全局Map</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SharedHealthCheckRegistries</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 全局</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ConcurrentMap&lt;String, HealthCheckRegistry&gt; REGISTRIES =  <span class="hljs-keyword">new</span> ConcurrentHashMap&lt;String, HealthCheckRegistry&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">SharedHealthCheckRegistries</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-comment">/* singleton */</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        REGISTRIES.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Set&lt;String&gt; <span class="hljs-title">names</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> REGISTRIES.keySet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">remove</span><span class="hljs-params">(String key)</span> </span>&#123;</span><br><span class="line">        REGISTRIES.remove(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 根据名字新增HealthCheckRegistry对象</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HealthCheckRegistry <span class="hljs-title">add</span><span class="hljs-params">(String name, HealthCheckRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> REGISTRIES.putIfAbsent(name, registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 从缓存中获取HealthCheckRegistry对象，如果不存在，则新增HealthCheckRegistry对象</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HealthCheckRegistry <span class="hljs-title">getOrCreate</span><span class="hljs-params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> HealthCheckRegistry existing = REGISTRIES.get(name);</span><br><span class="line">        <span class="hljs-keyword">if</span> (existing == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            <span class="hljs-keyword">final</span> HealthCheckRegistry created = <span class="hljs-keyword">new</span> HealthCheckRegistry();</span><br><span class="line">            <span class="hljs-keyword">final</span> HealthCheckRegistry raced = add(name, created);</span><br><span class="line">            <span class="hljs-keyword">if</span> (raced == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> created;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">return</span> raced;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> existing;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="ThreadDeadlockHealthCheck-java"><a href="#ThreadDeadlockHealthCheck-java" class="headerlink" title="ThreadDeadlockHealthCheck.java"></a>ThreadDeadlockHealthCheck.java</h3><p>健康线程死锁检测<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.health.jvm;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.jvm.ThreadDeadlockDetector;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.health.HealthCheck;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * A health check which returns healthy if no threads are deadlocked.</span></span><br><span class="line"><span class="hljs-comment"> * 健康线程死锁检测</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadDeadlockHealthCheck</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HealthCheck</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ThreadDeadlockDetector detector;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a new health check.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ThreadDeadlockHealthCheck</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>(<span class="hljs-keyword">new</span> ThreadDeadlockDetector());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a new health check with the given detector.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> detector a thread deadlock detector</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ThreadDeadlockHealthCheck</span><span class="hljs-params">(ThreadDeadlockDetector detector)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.detector = detector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">protected</span> Result <span class="hljs-title">check</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> Set&lt;String&gt; threads = detector.getDeadlockedThreads();</span><br><span class="line">        <span class="hljs-keyword">if</span> (threads.isEmpty()) &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> Result.healthy();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> Result.unhealthy(threads.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="metrics-httpclient"><a href="#metrics-httpclient" class="headerlink" title="metrics-httpclient"></a>metrics-httpclient</h2><h3 id="HttpClientMetricNameStrategies-java"><a href="#HttpClientMetricNameStrategies-java" class="headerlink" title="HttpClientMetricNameStrategies.java"></a>HttpClientMetricNameStrategies.java</h3><p>创建HttpClientMetricNameStrategy对象<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.httpclient;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> io.dropwizard.metrics.MetricRegistry.name;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.HttpRequest;</span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.client.HttpClient;</span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.client.methods.HttpRequestWrapper;</span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.client.methods.HttpUriRequest;</span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.client.utils.URIBuilder;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.MetricName;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.net.URI;</span><br><span class="line"><span class="hljs-keyword">import</span> java.net.URISyntaxException;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * httpclient名字策略组成</span></span><br><span class="line"><span class="hljs-comment"> * 创建HttpClientMetricNameStrategy对象</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HttpClientMetricNameStrategies</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * method</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> HttpClientMetricNameStrategy METHOD_ONLY =</span><br><span class="line">            <span class="hljs-keyword">new</span> HttpClientMetricNameStrategy() &#123;</span><br><span class="line">                <span class="hljs-meta">@Override</span></span><br><span class="line">                <span class="hljs-function"><span class="hljs-keyword">public</span> MetricName <span class="hljs-title">getNameFor</span><span class="hljs-params">(String name, HttpRequest request)</span> </span>&#123;</span><br><span class="line">                    <span class="hljs-keyword">return</span> name(HttpClient.class,</span><br><span class="line">                            name,</span><br><span class="line">                            methodNameString(request));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * host_and_method</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> HttpClientMetricNameStrategy HOST_AND_METHOD =</span><br><span class="line">            <span class="hljs-keyword">new</span> HttpClientMetricNameStrategy() &#123;</span><br><span class="line">                <span class="hljs-meta">@Override</span></span><br><span class="line">                <span class="hljs-function"><span class="hljs-keyword">public</span> MetricName <span class="hljs-title">getNameFor</span><span class="hljs-params">(String name, HttpRequest request)</span> </span>&#123;</span><br><span class="line">                    <span class="hljs-keyword">return</span> name(HttpClient.class,</span><br><span class="line">                            name,</span><br><span class="line">                            requestURI(request).getHost(),</span><br><span class="line">                            methodNameString(request));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * queryless_url_and_method</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> HttpClientMetricNameStrategy QUERYLESS_URL_AND_METHOD =</span><br><span class="line">            <span class="hljs-keyword">new</span> HttpClientMetricNameStrategy() &#123;</span><br><span class="line">                <span class="hljs-meta">@Override</span></span><br><span class="line">                <span class="hljs-function"><span class="hljs-keyword">public</span> MetricName <span class="hljs-title">getNameFor</span><span class="hljs-params">(String name, HttpRequest request)</span> </span>&#123;</span><br><span class="line">                    <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                        <span class="hljs-keyword">final</span> URIBuilder url = <span class="hljs-keyword">new</span> URIBuilder(requestURI(request));</span><br><span class="line">                        <span class="hljs-keyword">return</span> name(HttpClient.class,</span><br><span class="line">                                name,</span><br><span class="line">                                url.removeQuery().build().toString(),</span><br><span class="line">                                methodNameString(request));</span><br><span class="line">                    &#125; <span class="hljs-keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">methodNameString</span><span class="hljs-params">(HttpRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> request.getRequestLine().getMethod().toLowerCase() + <span class="hljs-string">"-requests"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> URI <span class="hljs-title">requestURI</span><span class="hljs-params">(HttpRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (request <span class="hljs-keyword">instanceof</span> HttpRequestWrapper)</span><br><span class="line">            <span class="hljs-keyword">return</span> requestURI(((HttpRequestWrapper) request).getOriginal());</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> (request <span class="hljs-keyword">instanceof</span> HttpUriRequest) ?</span><br><span class="line">                ((HttpUriRequest) request).getURI() :</span><br><span class="line">                URI.create(request.getRequestLine().getUri());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="HttpClientMetricNameStrategy-java"><a href="#HttpClientMetricNameStrategy-java" class="headerlink" title="HttpClientMetricNameStrategy.java"></a>HttpClientMetricNameStrategy.java</h3><p>接口：创建httpclient的MetricName<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.httpclient;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> io.dropwizard.metrics.MetricRegistry.name;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.HttpRequest;</span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.client.HttpClient;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.MetricName;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * 监测，名字策略</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">HttpClientMetricNameStrategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function">MetricName <span class="hljs-title">getNameFor</span><span class="hljs-params">(String name, HttpRequest request)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">//name + exception组成名字</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">default</span> MetricName <span class="hljs-title">getNameFor</span><span class="hljs-params">(String name, Exception exception)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> name(HttpClient.class,</span><br><span class="line">            name,</span><br><span class="line">            exception.getClass().getSimpleName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="InstrumentedHttpClientConnectionManager-java"><a href="#InstrumentedHttpClientConnectionManager-java" class="headerlink" title="InstrumentedHttpClientConnectionManager.java"></a>InstrumentedHttpClientConnectionManager.java</h3><p>监控http 连接工具，继承http 连接池<br>创建Gauge的4种连接监控注册对象：available-connections，leased-connections,max-connections，pending-connections<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.httpclient;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> io.dropwizard.metrics.MetricRegistry.name;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.config.Registry;</span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.config.RegistryBuilder;</span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.conn.*;</span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.conn.routing.HttpRoute;</span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.conn.socket.ConnectionSocketFactory;</span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.conn.socket.PlainConnectionSocketFactory;</span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.conn.ssl.SSLConnectionSocketFactory;</span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.impl.conn.PoolingHttpClientConnectionManager;</span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.impl.conn.SystemDefaultDnsResolver;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.Gauge;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.MetricRegistry;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * A &#123;<span class="hljs-doctag">@link</span> HttpClientConnectionManager&#125; which monitors the number of open connections.</span></span><br><span class="line"><span class="hljs-comment"> * 监控http 连接工具，继承http 连接池</span></span><br><span class="line"><span class="hljs-comment"> * 创建Gauge的4种连接监控注册对象：available-connections，leased-connections,max-connections，pending-connections</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InstrumentedHttpClientConnectionManager</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">PoolingHttpClientConnectionManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 获取http默认策略</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> Registry&lt;ConnectionSocketFactory&gt; <span class="hljs-title">getDefaultRegistry</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> RegistryBuilder.&lt;ConnectionSocketFactory&gt;create()</span><br><span class="line">                .register(<span class="hljs-string">"http"</span>, PlainConnectionSocketFactory.getSocketFactory())</span><br><span class="line">                .register(<span class="hljs-string">"https"</span>, SSLConnectionSocketFactory.getSocketFactory())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 监测注册对象</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MetricRegistry metricsRegistry;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 构造方法</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> metricRegistry</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InstrumentedHttpClientConnectionManager</span><span class="hljs-params">(MetricRegistry metricRegistry)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>(metricRegistry, getDefaultRegistry());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 构造方法</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> metricsRegistry</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> socketFactoryRegistry</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InstrumentedHttpClientConnectionManager</span><span class="hljs-params">(MetricRegistry metricsRegistry,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                                   Registry&lt;ConnectionSocketFactory&gt; socketFactoryRegistry)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>(metricsRegistry, socketFactoryRegistry, -<span class="hljs-number">1</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 构造方法</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> metricsRegistry</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> socketFactoryRegistry</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> connTTL</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> connTTLTimeUnit</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InstrumentedHttpClientConnectionManager</span><span class="hljs-params">(MetricRegistry metricsRegistry,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                                   Registry&lt;ConnectionSocketFactory&gt; socketFactoryRegistry,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                                   <span class="hljs-keyword">long</span> connTTL,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                                   TimeUnit connTTLTimeUnit)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>(metricsRegistry, socketFactoryRegistry, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, SystemDefaultDnsResolver.INSTANCE, connTTL, connTTLTimeUnit, <span class="hljs-keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 构造方法，注册http，4种连接监控注册对象：available-connections，leased-connections,max-connections，pending-connections</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> metricsRegistry</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> socketFactoryRegistry</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> connFactory</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> schemePortResolver</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dnsResolver</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> connTTL</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> connTTLTimeUnit</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InstrumentedHttpClientConnectionManager</span><span class="hljs-params">(MetricRegistry metricsRegistry,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                                   Registry&lt;ConnectionSocketFactory&gt; socketFactoryRegistry,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                                   HttpConnectionFactory&lt;HttpRoute,ManagedHttpClientConnection&gt; connFactory,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                                   SchemePortResolver schemePortResolver,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                                   DnsResolver dnsResolver,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                                   <span class="hljs-keyword">long</span> connTTL,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                                   TimeUnit connTTLTimeUnit,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                                   String name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-comment">//调用http里的方法</span></span><br><span class="line">        <span class="hljs-keyword">super</span>(socketFactoryRegistry, connFactory, schemePortResolver, dnsResolver, connTTL, connTTLTimeUnit);</span><br><span class="line">        <span class="hljs-comment">//监测注册对象</span></span><br><span class="line">        <span class="hljs-keyword">this</span>.metricsRegistry = metricsRegistry;</span><br><span class="line">        <span class="hljs-keyword">this</span>.name = name;</span><br><span class="line">        <span class="hljs-comment">//可以获得连接</span></span><br><span class="line">        metricsRegistry.register(name(HttpClientConnectionManager.class, name, <span class="hljs-string">"available-connections"</span>),</span><br><span class="line">                                 <span class="hljs-keyword">new</span> Gauge&lt;Integer&gt;() &#123;</span><br><span class="line">                                     <span class="hljs-meta">@Override</span></span><br><span class="line">                                     <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                                         <span class="hljs-comment">// this acquires a lock on the connection pool; remove if contention sucks</span></span><br><span class="line">                                         <span class="hljs-keyword">return</span> getTotalStats().getAvailable();</span><br><span class="line">                                     &#125;</span><br><span class="line">                                 &#125;);</span><br><span class="line">        <span class="hljs-comment">//专线</span></span><br><span class="line">        metricsRegistry.register(name(HttpClientConnectionManager.class, name, <span class="hljs-string">"leased-connections"</span>),</span><br><span class="line">                                 <span class="hljs-keyword">new</span> Gauge&lt;Integer&gt;() &#123;</span><br><span class="line">                                     <span class="hljs-meta">@Override</span></span><br><span class="line">                                     <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                                         <span class="hljs-comment">// this acquires a lock on the connection pool; remove if contention sucks</span></span><br><span class="line">                                         <span class="hljs-keyword">return</span> getTotalStats().getLeased();</span><br><span class="line">                                     &#125;</span><br><span class="line">                                 &#125;);</span><br><span class="line">        <span class="hljs-comment">//最大连接</span></span><br><span class="line">        metricsRegistry.register(name(HttpClientConnectionManager.class, name, <span class="hljs-string">"max-connections"</span>),</span><br><span class="line">                                 <span class="hljs-keyword">new</span> Gauge&lt;Integer&gt;() &#123;</span><br><span class="line">                                     <span class="hljs-meta">@Override</span></span><br><span class="line">                                     <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                                         <span class="hljs-comment">// this acquires a lock on the connection pool; remove if contention sucks</span></span><br><span class="line">                                         <span class="hljs-keyword">return</span> getTotalStats().getMax();</span><br><span class="line">                                     &#125;</span><br><span class="line">                                 &#125;);</span><br><span class="line">        <span class="hljs-comment">//待定</span></span><br><span class="line">        metricsRegistry.register(name(HttpClientConnectionManager.class, name, <span class="hljs-string">"pending-connections"</span>),</span><br><span class="line">                                 <span class="hljs-keyword">new</span> Gauge&lt;Integer&gt;() &#123;</span><br><span class="line">                                     <span class="hljs-meta">@Override</span></span><br><span class="line">                                     <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                                         <span class="hljs-comment">// this acquires a lock on the connection pool; remove if contention sucks</span></span><br><span class="line">                                         <span class="hljs-keyword">return</span> getTotalStats().getPending();</span><br><span class="line">                                     &#125;</span><br><span class="line">                                 &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 删除所有连接</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">shutdown</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">super</span>.shutdown();</span><br><span class="line">        metricsRegistry.remove(name(HttpClientConnectionManager.class, name, <span class="hljs-string">"available-connections"</span>));</span><br><span class="line">        metricsRegistry.remove(name(HttpClientConnectionManager.class, name, <span class="hljs-string">"leased-connections"</span>));</span><br><span class="line">        metricsRegistry.remove(name(HttpClientConnectionManager.class, name, <span class="hljs-string">"max-connections"</span>));</span><br><span class="line">        metricsRegistry.remove(name(HttpClientConnectionManager.class, name, <span class="hljs-string">"pending-connections"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="InstrumentedHttpRequestExecutor-java"><a href="#InstrumentedHttpRequestExecutor-java" class="headerlink" title="InstrumentedHttpRequestExecutor.java"></a>InstrumentedHttpRequestExecutor.java</h3><p>httpRequest执行类<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.httpclient;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.HttpClientConnection;</span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.HttpException;</span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.HttpRequest;</span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.HttpResponse;</span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.protocol.HttpContext;</span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.protocol.HttpRequestExecutor;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.Meter;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.MetricRegistry;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.Timer;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * httpRequest执行类</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InstrumentedHttpRequestExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpRequestExecutor</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     *     监测注册对象</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MetricRegistry registry;</span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 监测名字策略</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HttpClientMetricNameStrategy metricNameStrategy;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InstrumentedHttpRequestExecutor</span><span class="hljs-params">(MetricRegistry registry,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                           HttpClientMetricNameStrategy metricNameStrategy)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>(registry, metricNameStrategy, <span class="hljs-keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InstrumentedHttpRequestExecutor</span><span class="hljs-params">(MetricRegistry registry,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                           HttpClientMetricNameStrategy metricNameStrategy,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                           String name)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>(registry, metricNameStrategy, name, HttpRequestExecutor.DEFAULT_WAIT_FOR_CONTINUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InstrumentedHttpRequestExecutor</span><span class="hljs-params">(MetricRegistry registry,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                           HttpClientMetricNameStrategy metricNameStrategy,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                           String name,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                           <span class="hljs-keyword">int</span> waitForContinue)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">super</span>(waitForContinue);</span><br><span class="line">        <span class="hljs-keyword">this</span>.registry = registry;</span><br><span class="line">        <span class="hljs-keyword">this</span>.name = name;</span><br><span class="line">        <span class="hljs-keyword">this</span>.metricNameStrategy = metricNameStrategy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 覆写父类的方法，新增：timer对象。</span></span><br><span class="line"><span class="hljs-comment">     * 对执行方法进行时间监控。</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> conn</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> context</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> HttpException</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> HttpResponse <span class="hljs-title">execute</span><span class="hljs-params">(HttpRequest request, HttpClientConnection conn, HttpContext context)</span> <span class="hljs-keyword">throws</span> HttpException, IOException </span>&#123;</span><br><span class="line">        <span class="hljs-comment">//时间上下文</span></span><br><span class="line">        <span class="hljs-keyword">final</span> Timer.Context timerContext = timer(request).time();</span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            <span class="hljs-comment">//调用httpclient的执行请求</span></span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.execute(request, conn, context);</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (HttpException | IOException e) &#123;</span><br><span class="line">            meter(e).mark();</span><br><span class="line">            <span class="hljs-keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">            <span class="hljs-comment">//时间停止</span></span><br><span class="line">            timerContext.stop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 注册execute执行时间</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> Timer <span class="hljs-title">timer</span><span class="hljs-params">(HttpRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> registry.timer(metricNameStrategy.getNameFor(name, request));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 统计异常处理次数</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> e</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> Meter <span class="hljs-title">meter</span><span class="hljs-params">(Exception e)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> registry.meter(metricNameStrategy.getNameFor(name, e));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="InstrumentedHttpClients-java"><a href="#InstrumentedHttpClients-java" class="headerlink" title="InstrumentedHttpClients.java"></a>InstrumentedHttpClients.java</h3><p>httpClient监测工具，创建监测的HttpClientBuilder对象<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.httpclient;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> io.dropwizard.metrics.httpclient.HttpClientMetricNameStrategies.METHOD_ONLY;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.impl.client.CloseableHttpClient;</span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.http.impl.client.HttpClientBuilder;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.MetricRegistry;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> *  httpClient监测工具</span></span><br><span class="line"><span class="hljs-comment"> *  创建监测的HttpClientBuilder对象</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InstrumentedHttpClients</span> </span>&#123;</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">InstrumentedHttpClients</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CloseableHttpClient <span class="hljs-title">createDefault</span><span class="hljs-params">(MetricRegistry metricRegistry)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> createDefault(metricRegistry, METHOD_ONLY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CloseableHttpClient <span class="hljs-title">createDefault</span><span class="hljs-params">(MetricRegistry metricRegistry,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                                    HttpClientMetricNameStrategy metricNameStrategy)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> custom(metricRegistry, metricNameStrategy).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HttpClientBuilder <span class="hljs-title">custom</span><span class="hljs-params">(MetricRegistry metricRegistry)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> custom(metricRegistry, METHOD_ONLY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 继承HttpRequestExecutor的监测工具类：InstrumentedHttpRequestExecutor</span></span><br><span class="line"><span class="hljs-comment">     * 继承PoolingHttpClientConnectionManager的连接池工具类，InstrumentedHttpClientConnectionManager</span></span><br><span class="line"><span class="hljs-comment">     * 创建HttpClientBuilder对象</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> metricRegistry</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> metricNameStrategy</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HttpClientBuilder <span class="hljs-title">custom</span><span class="hljs-params">(MetricRegistry metricRegistry,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                           HttpClientMetricNameStrategy metricNameStrategy)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> HttpClientBuilder.create()</span><br><span class="line">                .setRequestExecutor(<span class="hljs-keyword">new</span> InstrumentedHttpRequestExecutor(metricRegistry, metricNameStrategy))</span><br><span class="line">                .setConnectionManager(<span class="hljs-keyword">new</span> InstrumentedHttpClientConnectionManager(metricRegistry));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="metrics-jvm"><a href="#metrics-jvm" class="headerlink" title="metrics-jvm"></a>metrics-jvm</h2><h3 id="BufferPoolMetricSet-java"><a href="#BufferPoolMetricSet-java" class="headerlink" title="BufferPoolMetricSet.java"></a>BufferPoolMetricSet.java</h3><p>通过：MBeanServer，JVM指标统计，映射内存图<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.jvm;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> io.dropwizard.metrics.MetricRegistry.name;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.JmxAttributeGauge;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.Metric;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.MetricName;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.MetricSet;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> javax.management.JMException;</span><br><span class="line"><span class="hljs-keyword">import</span> javax.management.MBeanServer;</span><br><span class="line"><span class="hljs-keyword">import</span> javax.management.ObjectName;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * A set of gauges for the count, usage, and capacity of the JVM's direct and mapped buffer pools.</span></span><br><span class="line"><span class="hljs-comment"> * 通过：MBeanServer，JVM指标统计，映射内存图</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="hljs-comment"> * These JMX objects are only available on Java 7 and above.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BufferPoolMetricSet</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MetricSet</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(BufferPoolMetricSet.class);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] ATTRIBUTES = &#123;<span class="hljs-string">"Count"</span>, <span class="hljs-string">"MemoryUsed"</span>, <span class="hljs-string">"TotalCapacity"</span>&#125;;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] NAMES = &#123;<span class="hljs-string">"count"</span>, <span class="hljs-string">"used"</span>, <span class="hljs-string">"capacity"</span>&#125;;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] POOLS = &#123;<span class="hljs-string">"direct"</span>, <span class="hljs-string">"mapped"</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MBeanServer mBeanServer;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BufferPoolMetricSet</span><span class="hljs-params">(MBeanServer mBeanServer)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.mBeanServer = mBeanServer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 通过MBeanServer获取JVM缓存池数据，设置gauges，存入不可变的Map</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;MetricName, Metric&gt; <span class="hljs-title">getMetrics</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> Map&lt;MetricName, Metric&gt; gauges = <span class="hljs-keyword">new</span> HashMap&lt;MetricName, Metric&gt;();</span><br><span class="line">        <span class="hljs-keyword">for</span> (String pool : POOLS) &#123;</span><br><span class="line">            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; ATTRIBUTES.length; i++) &#123;</span><br><span class="line">                <span class="hljs-keyword">final</span> String attribute = ATTRIBUTES[i];</span><br><span class="line">                <span class="hljs-keyword">final</span> String name = NAMES[i];</span><br><span class="line">                <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                    <span class="hljs-keyword">final</span> ObjectName on = <span class="hljs-keyword">new</span> ObjectName(<span class="hljs-string">"java.nio:type=BufferPool,name="</span> + pool);</span><br><span class="line">                    mBeanServer.getMBeanInfo(on);</span><br><span class="line">                    gauges.put(name(pool, name),</span><br><span class="line">                            <span class="hljs-keyword">new</span> JmxAttributeGauge(mBeanServer, on, attribute));</span><br><span class="line">                &#125; <span class="hljs-keyword">catch</span> (JMException ignored) &#123;</span><br><span class="line">                    LOGGER.debug(<span class="hljs-string">"Unable to load buffer pool MBeans, possibly running on Java 6"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> Collections.unmodifiableMap(gauges);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="CachedThreadStatesGaugeSet-java"><a href="#CachedThreadStatesGaugeSet-java" class="headerlink" title="CachedThreadStatesGaugeSet.java"></a>CachedThreadStatesGaugeSet.java</h3><p>使用ThreadMXBean创建指定时间内的缓存信息，存入gauges中<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.jvm;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.ManagementFactory;</span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.ThreadInfo;</span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.ThreadMXBean;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.CachedGauge;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * A variation of ThreadStatesGaugeSet that caches the ThreadInfo[] objects for</span></span><br><span class="line"><span class="hljs-comment"> * a given interval.</span></span><br><span class="line"><span class="hljs-comment"> * 使用ThreadMXBean创建指定时间内的缓存信息，存入gauges中</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CachedThreadStatesGaugeSet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ThreadStatesGaugeSet</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">//缓存</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CachedGauge&lt;ThreadInfo[]&gt; threadInfo;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 使用ThreadMXBean创建指定时间内的缓存信息，存入gauges中</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * Creates a new set of gauges using the given MXBean and detector.</span></span><br><span class="line"><span class="hljs-comment">     * Caches the information for the given interval and time unit.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> threadMXBean     a thread MXBean</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> deadlockDetector a deadlock detector</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> interval         cache interval</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> unit             cache interval time unit</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CachedThreadStatesGaugeSet</span><span class="hljs-params">(<span class="hljs-keyword">final</span> ThreadMXBean threadMXBean, ThreadDeadlockDetector deadlockDetector,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                      <span class="hljs-keyword">long</span> interval, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">super</span>(threadMXBean, deadlockDetector);</span><br><span class="line">        <span class="hljs-comment">//所有线程信息对象</span></span><br><span class="line">        threadInfo = <span class="hljs-keyword">new</span> CachedGauge&lt;ThreadInfo[]&gt;(interval, unit) &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">           <span class="hljs-keyword">protected</span> ThreadInfo[] loadValue() &#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> CachedThreadStatesGaugeSet.<span class="hljs-keyword">super</span>.getThreadInfo();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a new set of gauges using the default MXBeans.</span></span><br><span class="line"><span class="hljs-comment">     * Caches the information for the given interval and time unit.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> interval         cache interval</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> unit             cache interval time unit</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CachedThreadStatesGaugeSet</span><span class="hljs-params">(<span class="hljs-keyword">long</span> interval, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>(ManagementFactory.getThreadMXBean(), <span class="hljs-keyword">new</span> ThreadDeadlockDetector(), interval, unit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 获取线程信息数组</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    ThreadInfo[] getThreadInfo() &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> threadInfo.getValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="ClassLoadingGaugeSet-java"><a href="#ClassLoadingGaugeSet-java" class="headerlink" title="ClassLoadingGaugeSet.java"></a>ClassLoadingGaugeSet.java</h3><p>JVM classloader 使用率，class load 数目和 unload 数目<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.jvm;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.Gauge;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.Metric;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.MetricName;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.MetricSet;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.ClassLoadingMXBean;</span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.ManagementFactory;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * A set of gauges for JVM classloader usage.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * JVM classloader 使用率</span></span><br><span class="line"><span class="hljs-comment"> * class load 数目和 unload 数目</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClassLoadingGaugeSet</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MetricSet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ClassLoadingMXBean mxBean;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ClassLoadingGaugeSet</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>(ManagementFactory.getClassLoadingMXBean());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ClassLoadingGaugeSet</span><span class="hljs-params">(ClassLoadingMXBean mxBean)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.mxBean = mxBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * class load 数目和 unload 数目</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;MetricName, Metric&gt; <span class="hljs-title">getMetrics</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> Map&lt;MetricName, Metric&gt; gauges = <span class="hljs-keyword">new</span> HashMap&lt;MetricName, Metric&gt;();</span><br><span class="line"></span><br><span class="line">        gauges.put(MetricName.build(<span class="hljs-string">"loaded"</span>), <span class="hljs-keyword">new</span> Gauge&lt;Long&gt;() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> mxBean.getTotalLoadedClassCount();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        gauges.put(MetricName.build(<span class="hljs-string">"unloaded"</span>), <span class="hljs-keyword">new</span> Gauge&lt;Long&gt;() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> mxBean.getUnloadedClassCount();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> gauges;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="FileDescriptorRatioGauge-java"><a href="#FileDescriptorRatioGauge-java" class="headerlink" title="FileDescriptorRatioGauge.java"></a>FileDescriptorRatioGauge.java</h3><p>通过OperatingSystemMXBean，文件描述使用比率<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.jvm;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.RatioGauge;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.ManagementFactory;</span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.OperatingSystemMXBean;</span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * A gauge for the ratio of used to total file descriptors.</span></span><br><span class="line"><span class="hljs-comment"> * 通过OperatingSystemMXBean，文件描述使用比率</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileDescriptorRatioGauge</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RatioGauge</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OperatingSystemMXBean os;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a new gauge using the platform OS bean.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FileDescriptorRatioGauge</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>(ManagementFactory.getOperatingSystemMXBean());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a new gauge using the given OS bean.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> os    an &#123;<span class="hljs-doctag">@link</span> OperatingSystemMXBean&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FileDescriptorRatioGauge</span><span class="hljs-params">(OperatingSystemMXBean os)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.os = os;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">protected</span> Ratio <span class="hljs-title">getRatio</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            <span class="hljs-comment">//打开文件数目，最大文件数目</span></span><br><span class="line">            <span class="hljs-keyword">return</span> Ratio.of(invoke(<span class="hljs-string">"getOpenFileDescriptorCount"</span>), invoke(<span class="hljs-string">"getMaxFileDescriptorCount"</span>));</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> Ratio.of(Double.NaN, Double.NaN);</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> Ratio.of(Double.NaN, Double.NaN);</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> Ratio.of(Double.NaN, Double.NaN);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> <span class="hljs-title">invoke</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> NoSuchMethodException, IllegalAccessException, InvocationTargetException </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> Method method = os.getClass().getDeclaredMethod(name);</span><br><span class="line">        method.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        <span class="hljs-keyword">return</span> (Long) method.invoke(os);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="GarbageCollectorMetricSet-java"><a href="#GarbageCollectorMetricSet-java" class="headerlink" title="GarbageCollectorMetricSet.java"></a>GarbageCollectorMetricSet.java</h3><p>通过GarbageCollectorMXBean实现运行时垃圾收集:收集数目,收集时间<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.jvm;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> io.dropwizard.metrics.MetricRegistry.name;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.Gauge;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.Metric;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.MetricName;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.MetricSet;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.GarbageCollectorMXBean;</span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.ManagementFactory;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.*;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * A set of gauges for the counts and elapsed times of garbage collections.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * 通过GarbageCollectorMXBean实现运行时垃圾收集:收集数目,收集时间</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GarbageCollectorMetricSet</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MetricSet</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">//空格</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Pattern WHITESPACE = Pattern.compile(<span class="hljs-string">"[\\s]+"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;GarbageCollectorMXBean&gt; garbageCollectors;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a new set of gauges for all discoverable garbage collectors.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">GarbageCollectorMetricSet</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>(ManagementFactory.getGarbageCollectorMXBeans());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a new set of gauges for the given collection of garbage collectors.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> garbageCollectors    the garbage collectors</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">GarbageCollectorMetricSet</span><span class="hljs-params">(Collection&lt;GarbageCollectorMXBean&gt; garbageCollectors)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.garbageCollectors = <span class="hljs-keyword">new</span> ArrayList&lt;GarbageCollectorMXBean&gt;(garbageCollectors);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;MetricName, Metric&gt; <span class="hljs-title">getMetrics</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> Map&lt;MetricName, Metric&gt; gauges = <span class="hljs-keyword">new</span> HashMap&lt;MetricName, Metric&gt;();</span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> GarbageCollectorMXBean gc : garbageCollectors) &#123;</span><br><span class="line">            <span class="hljs-keyword">final</span> String name = WHITESPACE.matcher(gc.getName()).replaceAll(<span class="hljs-string">"-"</span>);</span><br><span class="line">            <span class="hljs-comment">//收集数目</span></span><br><span class="line">            gauges.put(name(name, <span class="hljs-string">"count"</span>), <span class="hljs-keyword">new</span> Gauge&lt;Long&gt;() &#123;</span><br><span class="line">                <span class="hljs-meta">@Override</span></span><br><span class="line">                <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                    <span class="hljs-keyword">return</span> gc.getCollectionCount();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="hljs-comment">//收集时间</span></span><br><span class="line">            gauges.put(name(name, <span class="hljs-string">"time"</span>), <span class="hljs-keyword">new</span> Gauge&lt;Long&gt;() &#123;</span><br><span class="line">                <span class="hljs-meta">@Override</span></span><br><span class="line">                <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                    <span class="hljs-keyword">return</span> gc.getCollectionTime();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> Collections.unmodifiableMap(gauges);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="MemoryUsageGaugeSet-java"><a href="#MemoryUsageGaugeSet-java" class="headerlink" title="MemoryUsageGaugeSet.java"></a>MemoryUsageGaugeSet.java</h3><p>通过MemoryMXBean实现JVM 内存使用，堆状态，GC特殊内存池<br>包括：堆内存，非堆内存，内存池<br>获取监测的数据：总初始化数目，总被使用数目，最大数目，堆初始化，堆使用，堆最大值，非堆内存-初始化，非堆内存-使用，内存池数据的获取，使用比率，最大使用，初始化<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.jvm;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> io.dropwizard.metrics.MetricRegistry.name;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.Gauge;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.Metric;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.MetricName;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.MetricSet;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.RatioGauge;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.ManagementFactory;</span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.MemoryMXBean;</span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.MemoryPoolMXBean;</span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.MemoryUsage;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.List;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Map;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * A set of gauges for JVM memory usage, including stats on heap vs. non-heap memory, plus</span></span><br><span class="line"><span class="hljs-comment"> * GC-specific memory pools.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * 通过MemoryMXBean实现JVM 内存使用，堆状态，GC特殊内存池</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * 包括：堆内存，非堆内存，内存池</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * 获取监测的数据：总初始化数目，总被使用数目，最大数目，堆初始化，堆使用，堆最大值，非堆内存-初始化，非堆内存-使用</span></span><br><span class="line"><span class="hljs-comment"> * 内存池数据的获取，使用比率，最大使用，初始化</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MemoryUsageGaugeSet</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MetricSet</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Pattern WHITESPACE = Pattern.compile(<span class="hljs-string">"[\\s]+"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 内存MXbean</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MemoryMXBean mxBean;</span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 内存池MXBean对象</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;MemoryPoolMXBean&gt; memoryPools;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MemoryUsageGaugeSet</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>(ManagementFactory.getMemoryMXBean(),</span><br><span class="line">             ManagementFactory.getMemoryPoolMXBeans());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MemoryUsageGaugeSet</span><span class="hljs-params">(MemoryMXBean mxBean,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                               Collection&lt;MemoryPoolMXBean&gt; memoryPools)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.mxBean = mxBean;</span><br><span class="line">        <span class="hljs-keyword">this</span>.memoryPools = <span class="hljs-keyword">new</span> ArrayList&lt;MemoryPoolMXBean&gt;(memoryPools);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;MetricName, Metric&gt; <span class="hljs-title">getMetrics</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> Map&lt;MetricName, Metric&gt; gauges = <span class="hljs-keyword">new</span> HashMap&lt;MetricName, Metric&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">//总初始化数目：</span></span><br><span class="line">        gauges.put(MetricName.build(<span class="hljs-string">"total.init"</span>), <span class="hljs-keyword">new</span> Gauge&lt;Long&gt;() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> mxBean.getHeapMemoryUsage().getInit() +</span><br><span class="line">                        mxBean.getNonHeapMemoryUsage().getInit();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">//总被使用数目：</span></span><br><span class="line">        gauges.put(MetricName.build(<span class="hljs-string">"total.used"</span>), <span class="hljs-keyword">new</span> Gauge&lt;Long&gt;() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> mxBean.getHeapMemoryUsage().getUsed() +</span><br><span class="line">                        mxBean.getNonHeapMemoryUsage().getUsed();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="hljs-comment">//最大数目</span></span><br><span class="line">        gauges.put(MetricName.build(<span class="hljs-string">"total.max"</span>), <span class="hljs-keyword">new</span> Gauge&lt;Long&gt;() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> mxBean.getHeapMemoryUsage().getMax() +</span><br><span class="line">                        mxBean.getNonHeapMemoryUsage().getMax();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        gauges.put(MetricName.build(<span class="hljs-string">"total.committed"</span>), <span class="hljs-keyword">new</span> Gauge&lt;Long&gt;() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> mxBean.getHeapMemoryUsage().getCommitted() +</span><br><span class="line">                        mxBean.getNonHeapMemoryUsage().getCommitted();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">//堆初始化</span></span><br><span class="line">        gauges.put(MetricName.build(<span class="hljs-string">"heap.init"</span>), <span class="hljs-keyword">new</span> Gauge&lt;Long&gt;() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> mxBean.getHeapMemoryUsage().getInit();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">//堆使用</span></span><br><span class="line">        gauges.put(MetricName.build(<span class="hljs-string">"heap.used"</span>), <span class="hljs-keyword">new</span> Gauge&lt;Long&gt;() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> mxBean.getHeapMemoryUsage().getUsed();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">//最大值</span></span><br><span class="line">        gauges.put(MetricName.build(<span class="hljs-string">"heap.max"</span>), <span class="hljs-keyword">new</span> Gauge&lt;Long&gt;() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> mxBean.getHeapMemoryUsage().getMax();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        gauges.put(MetricName.build(<span class="hljs-string">"heap.committed"</span>), <span class="hljs-keyword">new</span> Gauge&lt;Long&gt;() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> mxBean.getHeapMemoryUsage().getCommitted();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">//堆使用</span></span><br><span class="line">        gauges.put(MetricName.build(<span class="hljs-string">"heap.usage"</span>), <span class="hljs-keyword">new</span> RatioGauge() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">protected</span> Ratio <span class="hljs-title">getRatio</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">final</span> MemoryUsage usage = mxBean.getHeapMemoryUsage();</span><br><span class="line">                <span class="hljs-keyword">return</span> Ratio.of(usage.getUsed(), usage.getMax());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">//非堆内存-初始化</span></span><br><span class="line">        gauges.put(MetricName.build(<span class="hljs-string">"non-heap.init"</span>), <span class="hljs-keyword">new</span> Gauge&lt;Long&gt;() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> mxBean.getNonHeapMemoryUsage().getInit();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">//非堆内存-使用</span></span><br><span class="line">        gauges.put(MetricName.build(<span class="hljs-string">"non-heap.used"</span>), <span class="hljs-keyword">new</span> Gauge&lt;Long&gt;() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> mxBean.getNonHeapMemoryUsage().getUsed();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">//</span></span><br><span class="line">        gauges.put(MetricName.build(<span class="hljs-string">"non-heap.max"</span>), <span class="hljs-keyword">new</span> Gauge&lt;Long&gt;() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> mxBean.getNonHeapMemoryUsage().getMax();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        gauges.put(MetricName.build(<span class="hljs-string">"non-heap.committed"</span>), <span class="hljs-keyword">new</span> Gauge&lt;Long&gt;() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> mxBean.getNonHeapMemoryUsage().getCommitted();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        gauges.put(MetricName.build(<span class="hljs-string">"non-heap.usage"</span>), <span class="hljs-keyword">new</span> RatioGauge() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">protected</span> Ratio <span class="hljs-title">getRatio</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">final</span> MemoryUsage usage = mxBean.getNonHeapMemoryUsage();</span><br><span class="line">                <span class="hljs-keyword">return</span> Ratio.of(usage.getUsed(), usage.getMax());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">//内存池数据的获取，使用比率，最大使用，初始化</span></span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> MemoryPoolMXBean pool : memoryPools) &#123;</span><br><span class="line">            <span class="hljs-keyword">final</span> MetricName poolName = name(<span class="hljs-string">"pools"</span>, WHITESPACE.matcher(pool.getName()).replaceAll(<span class="hljs-string">"-"</span>));</span><br><span class="line">            <span class="hljs-comment">//使用比率</span></span><br><span class="line">            gauges.put(poolName.resolve(<span class="hljs-string">"usage"</span>),</span><br><span class="line">                    <span class="hljs-keyword">new</span> RatioGauge() &#123;</span><br><span class="line">                           <span class="hljs-meta">@Override</span></span><br><span class="line">                           <span class="hljs-function"><span class="hljs-keyword">protected</span> Ratio <span class="hljs-title">getRatio</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                               MemoryUsage usage = pool.getUsage();</span><br><span class="line">                               <span class="hljs-keyword">return</span> Ratio.of(usage.getUsed(),</span><br><span class="line">                                       usage.getMax() == -<span class="hljs-number">1</span> ? usage.getCommitted() : usage.getMax());</span><br><span class="line">                           &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="hljs-comment">//内存池最大使用</span></span><br><span class="line">            gauges.put(poolName.resolve(<span class="hljs-string">"max"</span>),<span class="hljs-keyword">new</span> Gauge&lt;Long&gt;() &#123;</span><br><span class="line">                <span class="hljs-meta">@Override</span></span><br><span class="line">                <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                    <span class="hljs-keyword">return</span> pool.getUsage().getMax();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="hljs-comment">//使用</span></span><br><span class="line">            gauges.put(poolName.resolve(<span class="hljs-string">"used"</span>),<span class="hljs-keyword">new</span> Gauge&lt;Long&gt;() &#123;</span><br><span class="line">                <span class="hljs-meta">@Override</span></span><br><span class="line">                <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                    <span class="hljs-keyword">return</span> pool.getUsage().getUsed();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="hljs-comment">//提交</span></span><br><span class="line">            gauges.put(poolName.resolve(<span class="hljs-string">"committed"</span>),<span class="hljs-keyword">new</span> Gauge&lt;Long&gt;() &#123;</span><br><span class="line">                <span class="hljs-meta">@Override</span></span><br><span class="line">                <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                    <span class="hljs-keyword">return</span> pool.getUsage().getCommitted();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="hljs-comment">// Only register GC usage metrics if the memory pool supports usage statistics.</span></span><br><span class="line">            <span class="hljs-keyword">if</span> (pool.getCollectionUsage() != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            	gauges.put(poolName.resolve(<span class="hljs-string">"used-after-gc"</span>),<span class="hljs-keyword">new</span> Gauge&lt;Long&gt;() &#123;</span><br><span class="line">                    <span class="hljs-meta">@Override</span></span><br><span class="line">                    <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                        <span class="hljs-keyword">return</span> pool.getCollectionUsage().getUsed();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="hljs-comment">//初始化</span></span><br><span class="line">            gauges.put(poolName.resolve(<span class="hljs-string">"init"</span>),<span class="hljs-keyword">new</span> Gauge&lt;Long&gt;() &#123;</span><br><span class="line">                <span class="hljs-meta">@Override</span></span><br><span class="line">                <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                    <span class="hljs-keyword">return</span> pool.getUsage().getInit();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> Collections.unmodifiableMap(gauges);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="ThreadDeadlockDetector-java"><a href="#ThreadDeadlockDetector-java" class="headerlink" title="ThreadDeadlockDetector.java"></a>ThreadDeadlockDetector.java</h3><p>通过ThreadMXBean，检测线程死锁<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.jvm;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.ManagementFactory;</span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.ThreadInfo;</span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.ThreadMXBean;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * A utility class for detecting deadlocked threads.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * 通过ThreadMXBean，检测线程死锁</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadDeadlockDetector</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> MAX_STACK_TRACE_DEPTH = <span class="hljs-number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ThreadMXBean threads;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a new detector.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ThreadDeadlockDetector</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>(ManagementFactory.getThreadMXBean());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a new detector using the given &#123;<span class="hljs-doctag">@link</span> ThreadMXBean&#125;.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> threads    a &#123;<span class="hljs-doctag">@link</span> ThreadMXBean&#125;</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ThreadDeadlockDetector</span><span class="hljs-params">(ThreadMXBean threads)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.threads = threads;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns a set of diagnostic stack traces for any deadlocked threads. If no threads are</span></span><br><span class="line"><span class="hljs-comment">     * deadlocked, returns an empty set.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * 返回线程死锁信息</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> stack traces for deadlocked threads or an empty set</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> Set&lt;String&gt; <span class="hljs-title">getDeadlockedThreads</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-comment">//死锁线程id</span></span><br><span class="line">        <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span>[] ids = threads.findDeadlockedThreads();</span><br><span class="line">        <span class="hljs-keyword">if</span> (ids != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            <span class="hljs-keyword">final</span> Set&lt;String&gt; deadlocks = <span class="hljs-keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">            <span class="hljs-comment">//死锁线程信息</span></span><br><span class="line">            <span class="hljs-keyword">for</span> (ThreadInfo info : threads.getThreadInfo(ids, MAX_STACK_TRACE_DEPTH)) &#123;</span><br><span class="line">                <span class="hljs-keyword">final</span> StringBuilder stackTrace = <span class="hljs-keyword">new</span> StringBuilder();</span><br><span class="line">                <span class="hljs-comment">//线程堆栈信息</span></span><br><span class="line">                <span class="hljs-keyword">for</span> (StackTraceElement element : info.getStackTrace()) &#123;</span><br><span class="line">                    stackTrace.append(<span class="hljs-string">"\t at "</span>)</span><br><span class="line">                              .append(element.toString())</span><br><span class="line">                              .append(String.format(<span class="hljs-string">"%n"</span>));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                deadlocks.add(</span><br><span class="line">                        String.format(<span class="hljs-string">"%s locked on %s (owned by %s):%n%s"</span>,</span><br><span class="line">                                      info.getThreadName(),</span><br><span class="line">                                      info.getLockName(),</span><br><span class="line">                                      info.getLockOwnerName(),</span><br><span class="line">                                      stackTrace.toString()</span><br><span class="line">                        )</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">return</span> Collections.unmodifiableSet(deadlocks);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> Collections.emptySet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="ThreadDump-java"><a href="#ThreadDump-java" class="headerlink" title="ThreadDump.java"></a>ThreadDump.java</h3><p>通过ThreadMXBean，获取线程快照<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.jvm;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="hljs-keyword">import</span> java.io.OutputStreamWriter;</span><br><span class="line"><span class="hljs-keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.LockInfo;</span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.MonitorInfo;</span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.ThreadInfo;</span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.ThreadMXBean;</span><br><span class="line"><span class="hljs-keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * A convenience class for getting a thread dump.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * 通过ThreadMXBean，获取线程快照</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadDump</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Charset UTF_8 = Charset.forName(<span class="hljs-string">"UTF-8"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ThreadMXBean threadMXBean;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ThreadDump</span><span class="hljs-params">(ThreadMXBean threadMXBean)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.threadMXBean = threadMXBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Dumps all of the threads' current information to an output stream.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> out an output stream</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">dump</span><span class="hljs-params">(OutputStream out)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-comment">//Returns the thread info for all live threads with stack trace</span></span><br><span class="line">        <span class="hljs-keyword">final</span> ThreadInfo[] threads = <span class="hljs-keyword">this</span>.threadMXBean.dumpAllThreads(<span class="hljs-keyword">true</span>, <span class="hljs-keyword">true</span>);</span><br><span class="line">        <span class="hljs-keyword">final</span> PrintWriter writer = <span class="hljs-keyword">new</span> PrintWriter(<span class="hljs-keyword">new</span> OutputStreamWriter(out, UTF_8));</span><br><span class="line">        <span class="hljs-comment">//线程信息</span></span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> ti = threads.length - <span class="hljs-number">1</span>; ti &gt;= <span class="hljs-number">0</span>; ti--) &#123;</span><br><span class="line">            <span class="hljs-keyword">final</span> ThreadInfo t = threads[ti];</span><br><span class="line">            writer.printf(<span class="hljs-string">"\"%s\" id=%d state=%s"</span>,</span><br><span class="line">                          t.getThreadName(),</span><br><span class="line">                          t.getThreadId(),</span><br><span class="line">                          t.getThreadState());</span><br><span class="line">            <span class="hljs-comment">//锁信息</span></span><br><span class="line">            <span class="hljs-comment">//锁状态：sync,block，wait</span></span><br><span class="line">            <span class="hljs-keyword">final</span> LockInfo lock = t.getLockInfo();</span><br><span class="line">            <span class="hljs-comment">//非锁</span></span><br><span class="line">            <span class="hljs-keyword">if</span> (lock != <span class="hljs-keyword">null</span> &amp;&amp; t.getThreadState() != Thread.State.BLOCKED) &#123;</span><br><span class="line">                writer.printf(<span class="hljs-string">"%n    - waiting on &lt;0x%08x&gt; (a %s)"</span>,</span><br><span class="line">                              lock.getIdentityHashCode(),</span><br><span class="line">                              lock.getClassName());</span><br><span class="line">                writer.printf(<span class="hljs-string">"%n    - locked &lt;0x%08x&gt; (a %s)"</span>,</span><br><span class="line">                              lock.getIdentityHashCode(),</span><br><span class="line">                              lock.getClassName());</span><br><span class="line">            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (lock != <span class="hljs-keyword">null</span> &amp;&amp; t.getThreadState() == Thread.State.BLOCKED) &#123;<span class="hljs-comment">//锁</span></span><br><span class="line">                writer.printf(<span class="hljs-string">"%n    - waiting to lock &lt;0x%08x&gt; (a %s)"</span>,</span><br><span class="line">                              lock.getIdentityHashCode(),</span><br><span class="line">                              lock.getClassName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">if</span> (t.isSuspended()) &#123;</span><br><span class="line">                writer.print(<span class="hljs-string">" (suspended)"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">if</span> (t.isInNative()) &#123;</span><br><span class="line">                writer.print(<span class="hljs-string">" (running in native)"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            writer.println();</span><br><span class="line">            <span class="hljs-keyword">if</span> (t.getLockOwnerName() != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">                writer.printf(<span class="hljs-string">"     owned by %s id=%d%n"</span>, t.getLockOwnerName(), t.getLockOwnerId());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="hljs-comment">//线程堆栈信息</span></span><br><span class="line">            <span class="hljs-keyword">final</span> StackTraceElement[] elements = t.getStackTrace();</span><br><span class="line">            <span class="hljs-comment">//锁监控信息</span></span><br><span class="line">            <span class="hljs-keyword">final</span> MonitorInfo[] monitors = t.getLockedMonitors();</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; elements.length; i++) &#123;</span><br><span class="line">                <span class="hljs-keyword">final</span> StackTraceElement element = elements[i];</span><br><span class="line">                writer.printf(<span class="hljs-string">"    at %s%n"</span>, element);</span><br><span class="line">                <span class="hljs-comment">//监控</span></span><br><span class="line">                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">1</span>; j &lt; monitors.length; j++) &#123;</span><br><span class="line">                    <span class="hljs-keyword">final</span> MonitorInfo monitor = monitors[j];</span><br><span class="line">                    <span class="hljs-keyword">if</span> (monitor.getLockedStackDepth() == i) &#123;</span><br><span class="line">                        writer.printf(<span class="hljs-string">"      - locked %s%n"</span>, monitor);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            writer.println();</span><br><span class="line"></span><br><span class="line">            <span class="hljs-comment">//sync的lock</span></span><br><span class="line">            <span class="hljs-keyword">final</span> LockInfo[] locks = t.getLockedSynchronizers();</span><br><span class="line">            <span class="hljs-keyword">if</span> (locks.length &gt; <span class="hljs-number">0</span>) &#123;</span><br><span class="line">                writer.printf(<span class="hljs-string">"    Locked synchronizers: count = %d%n"</span>, locks.length);</span><br><span class="line">                <span class="hljs-keyword">for</span> (LockInfo l : locks) &#123;</span><br><span class="line">                    writer.printf(<span class="hljs-string">"      - %s%n"</span>, l);</span><br><span class="line">                &#125;</span><br><span class="line">                writer.println();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        writer.println();</span><br><span class="line">        writer.flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="ThreadStatesGaugeSet-java"><a href="#ThreadStatesGaugeSet-java" class="headerlink" title="ThreadStatesGaugeSet.java"></a>ThreadStatesGaugeSet.java</h3><p>通过ThreadMXBean，ThreadDeadlockDetector检测状态、死锁<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.jvm;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> io.dropwizard.metrics.MetricRegistry.name;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.Gauge;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.Metric;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.MetricName;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.MetricSet;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.ManagementFactory;</span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.ThreadInfo;</span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.management.ThreadMXBean;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Map;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * A set of gauges for the number of threads in their various states and deadlock detection.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * 通过ThreadMXBean，ThreadDeadlockDetector检测状态、死锁</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadStatesGaugeSet</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MetricSet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// do not compute stack traces.</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> STACK_TRACE_DEPTH = <span class="hljs-number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ThreadMXBean threads;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ThreadDeadlockDetector deadlockDetector;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a new set of gauges using the default MXBeans.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ThreadStatesGaugeSet</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>(ManagementFactory.getThreadMXBean(), <span class="hljs-keyword">new</span> ThreadDeadlockDetector());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a new set of gauges using the given MXBean and detector.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> threads          a thread MXBean</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> deadlockDetector a deadlock detector</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ThreadStatesGaugeSet</span><span class="hljs-params">(ThreadMXBean threads,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                ThreadDeadlockDetector deadlockDetector)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.threads = threads;</span><br><span class="line">        <span class="hljs-keyword">this</span>.deadlockDetector = deadlockDetector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 获取监控线程的数据：线程的数目，守护线程的数目，死锁线程的数目，死锁线程</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;MetricName, Metric&gt; <span class="hljs-title">getMetrics</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> Map&lt;MetricName, Metric&gt; gauges = <span class="hljs-keyword">new</span> HashMap&lt;MetricName, Metric&gt;();</span><br><span class="line">        <span class="hljs-comment">//线程状态的数目</span></span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> Thread.State state : Thread.State.values()) &#123;</span><br><span class="line">            gauges.put(name(state.toString().toLowerCase(), <span class="hljs-string">"count"</span>),</span><br><span class="line">                       <span class="hljs-keyword">new</span> Gauge&lt;Integer&gt;() &#123;</span><br><span class="line">                           <span class="hljs-meta">@Override</span></span><br><span class="line">                           <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                               <span class="hljs-keyword">return</span> getThreadCount(state);</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">//所有线程的数目</span></span><br><span class="line">        gauges.put(MetricName.build(<span class="hljs-string">"count"</span>), <span class="hljs-keyword">new</span> Gauge&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> threads.getThreadCount();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">//守护线程的数目</span></span><br><span class="line">        gauges.put(MetricName.build(<span class="hljs-string">"daemon.count"</span>), <span class="hljs-keyword">new</span> Gauge&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> threads.getDaemonThreadCount();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">//死锁线程的数目</span></span><br><span class="line">        gauges.put(MetricName.build(<span class="hljs-string">"deadlock.count"</span>), <span class="hljs-keyword">new</span> Gauge&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> deadlockDetector.getDeadlockedThreads().size();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">//死锁线程</span></span><br><span class="line">        gauges.put(MetricName.build(<span class="hljs-string">"deadlocks"</span>), <span class="hljs-keyword">new</span> Gauge&lt;Set&lt;String&gt;&gt;() &#123;</span><br><span class="line">            <span class="hljs-meta">@Override</span></span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">public</span> Set&lt;String&gt; <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> deadlockDetector.getDeadlockedThreads();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> Collections.unmodifiableMap(gauges);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 线程数目</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> state</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getThreadCount</span><span class="hljs-params">(Thread.State state)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-comment">//所有线程</span></span><br><span class="line">        <span class="hljs-keyword">final</span> ThreadInfo[] allThreads = getThreadInfo();</span><br><span class="line">        <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;</span><br><span class="line">        <span class="hljs-keyword">for</span> (ThreadInfo info : allThreads) &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (info != <span class="hljs-keyword">null</span> &amp;&amp; info.getThreadState() == state) &#123;</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 获取所有线程信息对象</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    ThreadInfo[] getThreadInfo() &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> threads.getThreadInfo(threads.getAllThreadIds(), STACK_TRACE_DEPTH);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="metrics-servlet"><a href="#metrics-servlet" class="headerlink" title="metrics-servlet"></a>metrics-servlet</h2><h3 id="AbstractInstrumentedFilter-java"><a href="#AbstractInstrumentedFilter-java" class="headerlink" title="AbstractInstrumentedFilter.java"></a>AbstractInstrumentedFilter.java</h3><p>实现Filter覆写：init，destroy，doFilter，嵌入监控对象。实现AsyncListener,覆写方法，嵌入监控对象<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.servlet;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> io.dropwizard.metrics.MetricRegistry.name;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.Counter;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.Meter;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.MetricRegistry;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.Timer;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponseWrapper;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Map;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Map.Entry;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentMap;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> Filter&#125; implementation which captures request information and a breakdown of the response</span></span><br><span class="line"><span class="hljs-comment"> * codes being returned.</span></span><br><span class="line"><span class="hljs-comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="hljs-comment"> * 拦截请求，返回计数信息</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * 实现Filter覆写：init，destroy，doFilter，嵌入监控对象</span></span><br><span class="line"><span class="hljs-comment"> * 实现AsyncListener,覆写方法，嵌入监控对象</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractInstrumentedFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String METRIC_PREFIX = <span class="hljs-string">"name-prefix"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String otherMetricName;</span><br><span class="line">    <span class="hljs-comment">//状态码</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Integer, String&gt; meterNamesByStatusCode;</span><br><span class="line">    <span class="hljs-comment">//注册属性</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String registryAttribute;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// initialized after call of init method</span></span><br><span class="line">    <span class="hljs-comment">//状态码的meter</span></span><br><span class="line">    <span class="hljs-keyword">private</span> ConcurrentMap&lt;Integer, Meter&gt; metersByStatusCode;</span><br><span class="line">    <span class="hljs-keyword">private</span> Meter otherMeter;</span><br><span class="line">    <span class="hljs-comment">//超时</span></span><br><span class="line">    <span class="hljs-keyword">private</span> Meter timeoutsMeter;</span><br><span class="line">    <span class="hljs-comment">//错误</span></span><br><span class="line">    <span class="hljs-keyword">private</span> Meter errorsMeter;</span><br><span class="line">    <span class="hljs-comment">//有效请求</span></span><br><span class="line">    <span class="hljs-keyword">private</span> Counter activeRequests;</span><br><span class="line">    <span class="hljs-comment">//</span></span><br><span class="line">    <span class="hljs-keyword">private</span> Timer requestTimer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a new instance of the filter.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registryAttribute      the attribute used to look up the metrics registry in the</span></span><br><span class="line"><span class="hljs-comment">     *                               servlet context</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> meterNamesByStatusCode A map, keyed by status code, of meter names that we are</span></span><br><span class="line"><span class="hljs-comment">     *                               interested in.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> otherMetricName        The name used for the catch-all meter.  其他metric名字</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">AbstractInstrumentedFilter</span><span class="hljs-params">(String registryAttribute,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                         Map&lt;Integer, String&gt; meterNamesByStatusCode,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                                         String otherMetricName)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.registryAttribute = registryAttribute;</span><br><span class="line">        <span class="hljs-keyword">this</span>.meterNamesByStatusCode = meterNamesByStatusCode;</span><br><span class="line">        <span class="hljs-keyword">this</span>.otherMetricName = otherMetricName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 初始化</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> filterConfig</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> ServletException</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        <span class="hljs-comment">//</span></span><br><span class="line">        <span class="hljs-keyword">final</span> MetricRegistry metricsRegistry = getMetricsFactory(filterConfig);</span><br><span class="line"></span><br><span class="line">        String metricName = filterConfig.getInitParameter(METRIC_PREFIX);</span><br><span class="line">        <span class="hljs-comment">//重新赋值metricName</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (metricName == <span class="hljs-keyword">null</span> || metricName.isEmpty()) &#123;</span><br><span class="line">            metricName = getClass().getName();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">//状态码</span></span><br><span class="line">        <span class="hljs-keyword">this</span>.metersByStatusCode = <span class="hljs-keyword">new</span> ConcurrentHashMap&lt;Integer, Meter&gt;(meterNamesByStatusCode</span><br><span class="line">                .size());</span><br><span class="line">        <span class="hljs-comment">//初始化状态的meter</span></span><br><span class="line">        <span class="hljs-keyword">for</span> (Entry&lt;Integer, String&gt; entry : meterNamesByStatusCode.entrySet()) &#123;</span><br><span class="line">            metersByStatusCode.put(entry.getKey(),</span><br><span class="line">                    metricsRegistry.meter(name(metricName, entry.getValue())));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-comment">//-----初始化meter</span></span><br><span class="line">        <span class="hljs-keyword">this</span>.otherMeter = metricsRegistry.meter(name(metricName,</span><br><span class="line">                otherMetricName));</span><br><span class="line">        <span class="hljs-keyword">this</span>.timeoutsMeter = metricsRegistry.meter(name(metricName,</span><br><span class="line">                <span class="hljs-string">"timeouts"</span>));</span><br><span class="line">        <span class="hljs-keyword">this</span>.errorsMeter = metricsRegistry.meter(name(metricName,</span><br><span class="line">                <span class="hljs-string">"errors"</span>));</span><br><span class="line">        <span class="hljs-keyword">this</span>.activeRequests = metricsRegistry.counter(name(metricName,</span><br><span class="line">                <span class="hljs-string">"activeRequests"</span>));</span><br><span class="line">        <span class="hljs-keyword">this</span>.requestTimer = metricsRegistry.timer(name(metricName,</span><br><span class="line">                <span class="hljs-string">"requests"</span>));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 获取MetricRegistry对象</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> filterConfig</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> MetricRegistry <span class="hljs-title">getMetricsFactory</span><span class="hljs-params">(FilterConfig filterConfig)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> MetricRegistry metricsRegistry;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">final</span> Object o = filterConfig.getServletContext().getAttribute(<span class="hljs-keyword">this</span>.registryAttribute);</span><br><span class="line">        <span class="hljs-keyword">if</span> (o <span class="hljs-keyword">instanceof</span> MetricRegistry) &#123;</span><br><span class="line">            metricsRegistry = (MetricRegistry) o;</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            metricsRegistry = <span class="hljs-keyword">new</span> MetricRegistry();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> metricsRegistry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 销毁</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">destroy</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doFilter</span><span class="hljs-params">(ServletRequest request,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                         ServletResponse response,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                         FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> StatusExposingServletResponse wrappedResponse =  <span class="hljs-keyword">new</span> StatusExposingServletResponse((HttpServletResponse) response);</span><br><span class="line">        <span class="hljs-comment">//+1</span></span><br><span class="line">        activeRequests.inc();</span><br><span class="line">        <span class="hljs-comment">//计时</span></span><br><span class="line">        <span class="hljs-keyword">final</span> Timer.Context context = requestTimer.time();</span><br><span class="line">        <span class="hljs-comment">//错误：true，正确：false</span></span><br><span class="line">        <span class="hljs-keyword">boolean</span> error = <span class="hljs-keyword">false</span>;</span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            chain.doFilter(request, wrappedResponse);</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            error = <span class="hljs-keyword">true</span>;</span><br><span class="line">            <span class="hljs-keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (ServletException e) &#123;</span><br><span class="line">            error = <span class="hljs-keyword">true</span>;</span><br><span class="line">            <span class="hljs-keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            error = <span class="hljs-keyword">true</span>;</span><br><span class="line">            <span class="hljs-keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">            <span class="hljs-comment">//非错误，请求是sync</span></span><br><span class="line">            <span class="hljs-keyword">if</span> (!error &amp;&amp; request.isAsyncStarted()) &#123;</span><br><span class="line">                <span class="hljs-comment">//执行sync listener</span></span><br><span class="line">                request.getAsyncContext().addListener(<span class="hljs-keyword">new</span> AsyncResultListener(context));</span><br><span class="line">            &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//非，sync</span></span><br><span class="line">                <span class="hljs-comment">//时间停止</span></span><br><span class="line">                context.stop();</span><br><span class="line">                activeRequests.dec();</span><br><span class="line">                <span class="hljs-comment">//错误</span></span><br><span class="line">                <span class="hljs-keyword">if</span> (error) &#123;</span><br><span class="line">                    <span class="hljs-comment">//Meters用来度量某个时间段的平均处理次数</span></span><br><span class="line">                    errorsMeter.mark();</span><br><span class="line">                &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                    markMeterForStatusCode(wrappedResponse.getStatus());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 根据status code 获取对应的meter</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> status</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">markMeterForStatusCode</span><span class="hljs-params">(<span class="hljs-keyword">int</span> status)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> Meter metric = metersByStatusCode.get(status);</span><br><span class="line">        <span class="hljs-keyword">if</span> (metric != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            metric.mark();</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            otherMeter.mark();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">//status wrapp response</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StatusExposingServletResponse</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpServletResponseWrapper</span> </span>&#123;</span><br><span class="line">        <span class="hljs-comment">// The Servlet spec says: calling setStatus is optional, if no status is set, the default is 200.</span></span><br><span class="line">        <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> httpStatus = <span class="hljs-number">200</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">StatusExposingServletResponse</span><span class="hljs-params">(HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">super</span>(response);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-meta">@Override</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendError</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sc)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            httpStatus = sc;</span><br><span class="line">            <span class="hljs-keyword">super</span>.sendError(sc);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-meta">@Override</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendError</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sc, String msg)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            httpStatus = sc;</span><br><span class="line">            <span class="hljs-keyword">super</span>.sendError(sc, msg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-meta">@Override</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setStatus</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sc)</span> </span>&#123;</span><br><span class="line">            httpStatus = sc;</span><br><span class="line">            <span class="hljs-keyword">super</span>.setStatus(sc);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-meta">@Override</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setStatus</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sc, String sm)</span> </span>&#123;</span><br><span class="line">            httpStatus = sc;</span><br><span class="line">            <span class="hljs-keyword">super</span>.setStatus(sc, sm);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getStatus</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> httpStatus;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     *  Servlet 3.0 为异步处理提供了一个监听器，使用 AsyncListener 接口表示。它可以监控如下四种事件：</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">     异步线程开始时，调用 AsyncListener 的 onStartAsync(AsyncEvent event) 方法；</span></span><br><span class="line"><span class="hljs-comment">     异步线程出错时，调用 AsyncListener 的 onError(AsyncEvent event) 方法；</span></span><br><span class="line"><span class="hljs-comment">     异步线程执行超时，则调用 AsyncListener 的 onTimeout(AsyncEvent event) 方法；</span></span><br><span class="line"><span class="hljs-comment">     异步执行完毕时，调用 AsyncListener 的 onComplete(AsyncEvent event) 方法；</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">     要注册一个 AsyncListener，只需将准备好的 AsyncListener 对象传递给 AsyncContext 对象的 addListener() 方法即可</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AsyncResultListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AsyncListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">private</span> Timer.Context context;</span><br><span class="line">        <span class="hljs-comment">//非异常：false。异常：true</span></span><br><span class="line">        <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> done = <span class="hljs-keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AsyncResultListener</span><span class="hljs-params">(Timer.Context context)</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">this</span>.context = context;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-meta">@Override</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onComplete</span><span class="hljs-params">(AsyncEvent event)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            <span class="hljs-comment">//正常流程</span></span><br><span class="line">            <span class="hljs-keyword">if</span> (!done) &#123;</span><br><span class="line">                HttpServletResponse suppliedResponse = (HttpServletResponse) event.getSuppliedResponse();</span><br><span class="line">                <span class="hljs-comment">//时间停止</span></span><br><span class="line">                context.stop();</span><br><span class="line">                <span class="hljs-comment">//请求-1</span></span><br><span class="line">                activeRequests.dec();</span><br><span class="line">                markMeterForStatusCode(suppliedResponse.getStatus());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-meta">@Override</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onTimeout</span><span class="hljs-params">(AsyncEvent event)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            context.stop();</span><br><span class="line">            activeRequests.dec();</span><br><span class="line">            <span class="hljs-comment">//timeout meter</span></span><br><span class="line">            timeoutsMeter.mark();</span><br><span class="line">            done = <span class="hljs-keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-meta">@Override</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(AsyncEvent event)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            context.stop();</span><br><span class="line">            activeRequests.dec();</span><br><span class="line">            <span class="hljs-comment">//errors</span></span><br><span class="line">            errorsMeter.mark();</span><br><span class="line">            done = <span class="hljs-keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-meta">@Override</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onStartAsync</span><span class="hljs-params">(AsyncEvent event)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="InstrumentedFilter-java"><a href="#InstrumentedFilter-java" class="headerlink" title="InstrumentedFilter.java"></a>InstrumentedFilter.java</h3><p>继承AbstractInstrumentedFilter，状态码前缀<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.servlet;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * Implementation of the &#123;<span class="hljs-doctag">@link</span> AbstractInstrumentedFilter&#125; which provides a default set of response codes</span></span><br><span class="line"><span class="hljs-comment"> * to capture information about. &lt;p&gt;Use it in your servlet.xml like this:&lt;/p&gt;</span></span><br><span class="line"><span class="hljs-comment"> * &lt;pre&gt;&#123;<span class="hljs-doctag">@code</span></span></span><br><span class="line"><span class="hljs-comment"> * &lt;filter&gt;</span></span><br><span class="line"><span class="hljs-comment"> *     &lt;filter-name&gt;instrumentedFilter&lt;/filter-name&gt;</span></span><br><span class="line"><span class="hljs-comment"> *     &lt;filter-class&gt;io.dropwizard.metrics.servlet.InstrumentedFilter&lt;/filter-class&gt;</span></span><br><span class="line"><span class="hljs-comment"> * &lt;/filter&gt;</span></span><br><span class="line"><span class="hljs-comment"> * &lt;filter-mapping&gt;</span></span><br><span class="line"><span class="hljs-comment"> *     &lt;filter-name&gt;instrumentedFilter&lt;/filter-name&gt;</span></span><br><span class="line"><span class="hljs-comment"> *     &lt;url-pattern&gt;/*&lt;/url-pattern&gt;</span></span><br><span class="line"><span class="hljs-comment"> * &lt;/filter-mapping&gt;</span></span><br><span class="line"><span class="hljs-comment"> * &#125;&lt;/pre&gt;</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InstrumentedFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractInstrumentedFilter</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">//注册属性 = InstrumentedFilter.registry</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String REGISTRY_ATTRIBUTE = InstrumentedFilter.class.getName() + <span class="hljs-string">".registry"</span>;</span><br><span class="line">    <span class="hljs-comment">//状态码-前缀</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String NAME_PREFIX = <span class="hljs-string">"responseCodes."</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> OK = <span class="hljs-number">200</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> CREATED = <span class="hljs-number">201</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> NO_CONTENT = <span class="hljs-number">204</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> BAD_REQUEST = <span class="hljs-number">400</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> NOT_FOUND = <span class="hljs-number">404</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> SERVER_ERROR = <span class="hljs-number">500</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Creates a new instance of the filter.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InstrumentedFilter</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">super</span>(REGISTRY_ATTRIBUTE, createMeterNamesByStatusCode(), NAME_PREFIX + <span class="hljs-string">"other"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">//状态码 - 名字</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;Integer, String&gt; <span class="hljs-title">createMeterNamesByStatusCode</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> Map&lt;Integer, String&gt; meterNamesByStatusCode = <span class="hljs-keyword">new</span> HashMap&lt;Integer, String&gt;(<span class="hljs-number">6</span>);</span><br><span class="line">        meterNamesByStatusCode.put(OK, NAME_PREFIX + <span class="hljs-string">"ok"</span>);</span><br><span class="line">        meterNamesByStatusCode.put(CREATED, NAME_PREFIX + <span class="hljs-string">"created"</span>);</span><br><span class="line">        meterNamesByStatusCode.put(NO_CONTENT, NAME_PREFIX + <span class="hljs-string">"noContent"</span>);</span><br><span class="line">        meterNamesByStatusCode.put(BAD_REQUEST, NAME_PREFIX + <span class="hljs-string">"badRequest"</span>);</span><br><span class="line">        meterNamesByStatusCode.put(NOT_FOUND, NAME_PREFIX + <span class="hljs-string">"notFound"</span>);</span><br><span class="line">        meterNamesByStatusCode.put(SERVER_ERROR, NAME_PREFIX + <span class="hljs-string">"serverError"</span>);</span><br><span class="line">        <span class="hljs-keyword">return</span> meterNamesByStatusCode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="InstrumentedFilterContextListener-java"><a href="#InstrumentedFilterContextListener-java" class="headerlink" title="InstrumentedFilterContextListener.java"></a>InstrumentedFilterContextListener.java</h3><p>实现ServletContextListener监听器，嵌入监控对象<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.servlet;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.MetricRegistry;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> javax.servlet.ServletContextEvent;</span><br><span class="line"><span class="hljs-keyword">import</span> javax.servlet.ServletContextListener;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * A listener implementation which injects a &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; instance into the servlet</span></span><br><span class="line"><span class="hljs-comment"> * context. Implement &#123;<span class="hljs-doctag">@link</span> #getMetricRegistry()&#125; to return the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; for your</span></span><br><span class="line"><span class="hljs-comment"> * application.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * 实现ServletContextListener监听器，嵌入监控对象</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InstrumentedFilterContextListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ServletContextListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the &#123;<span class="hljs-doctag">@link</span> MetricRegistry&#125; to inject into the servlet context.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * 获取注册的metric</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> MetricRegistry <span class="hljs-title">getMetricRegistry</span><span class="hljs-params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">contextInitialized</span><span class="hljs-params">(ServletContextEvent sce)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-comment">//设request值attribute：metric</span></span><br><span class="line">        <span class="hljs-comment">//arrribute属性 - 值</span></span><br><span class="line">        sce.getServletContext().setAttribute(InstrumentedFilter.REGISTRY_ATTRIBUTE, getMetricRegistry());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">contextDestroyed</span><span class="hljs-params">(ServletContextEvent sce)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="metrics-servlets"><a href="#metrics-servlets" class="headerlink" title="metrics-servlets"></a>metrics-servlets</h2><h3 id="AdminServlet-java"><a href="#AdminServlet-java" class="headerlink" title="AdminServlet.java"></a>AdminServlet.java</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.servlets;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> javax.servlet.ServletConfig;</span><br><span class="line"><span class="hljs-keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="hljs-keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="hljs-keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="hljs-keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="hljs-keyword">import</span> java.text.MessageFormat;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * 不同类型的servlet监测</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdminServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DEFAULT_HEALTHCHECK_URI = <span class="hljs-string">"/healthcheck"</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DEFAULT_METRICS_URI = <span class="hljs-string">"/metrics"</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DEFAULT_PING_URI = <span class="hljs-string">"/ping"</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DEFAULT_THREADS_URI = <span class="hljs-string">"/threads"</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DEFAULT_CPU_PROFILE_URI = <span class="hljs-string">"/pprof"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String METRICS_URI_PARAM_KEY = <span class="hljs-string">"metrics-uri"</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PING_URI_PARAM_KEY = <span class="hljs-string">"ping-uri"</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String THREADS_URI_PARAM_KEY = <span class="hljs-string">"threads-uri"</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String HEALTHCHECK_URI_PARAM_KEY = <span class="hljs-string">"healthcheck-uri"</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SERVICE_NAME_PARAM_KEY= <span class="hljs-string">"service-name"</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CPU_PROFILE_URI_PARAM_KEY = <span class="hljs-string">"cpu-profile-uri"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String TEMPLATE = String.format(</span><br><span class="line">            <span class="hljs-string">"&lt;!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\"%n"</span> +</span><br><span class="line">                    <span class="hljs-string">"        \"http://www.w3.org/TR/html4/loose.dtd\"&gt;%n"</span> +</span><br><span class="line">                    <span class="hljs-string">"&lt;html&gt;%n"</span> +</span><br><span class="line">                    <span class="hljs-string">"&lt;head&gt;%n"</span> +</span><br><span class="line">                    <span class="hljs-string">"  &lt;title&gt;Metrics&#123;10&#125;&lt;/title&gt;%n"</span> +</span><br><span class="line">                    <span class="hljs-string">"&lt;/head&gt;%n"</span> +</span><br><span class="line">                    <span class="hljs-string">"&lt;body&gt;%n"</span> +</span><br><span class="line">                    <span class="hljs-string">"  &lt;h1&gt;Operational Menu&#123;10&#125;&lt;/h1&gt;%n"</span> +</span><br><span class="line">                    <span class="hljs-string">"  &lt;ul&gt;%n"</span> +</span><br><span class="line">                    <span class="hljs-string">"    &lt;li&gt;&lt;a href=\"&#123;0&#125;&#123;1&#125;?pretty=true\"&gt;Metrics&lt;/a&gt;&lt;/li&gt;%n"</span> +</span><br><span class="line">                    <span class="hljs-string">"    &lt;li&gt;&lt;a href=\"&#123;2&#125;&#123;3&#125;\"&gt;Ping&lt;/a&gt;&lt;/li&gt;%n"</span> +</span><br><span class="line">                    <span class="hljs-string">"    &lt;li&gt;&lt;a href=\"&#123;4&#125;&#123;5&#125;\"&gt;Threads&lt;/a&gt;&lt;/li&gt;%n"</span> +</span><br><span class="line">                    <span class="hljs-string">"    &lt;li&gt;&lt;a href=\"&#123;6&#125;&#123;7&#125;?pretty=true\"&gt;Healthcheck&lt;/a&gt;&lt;/li&gt;%n"</span> +</span><br><span class="line">                    <span class="hljs-string">"    &lt;li&gt;&lt;a href=\"&#123;8&#125;&#123;9&#125;\"&gt;CPU Profile&lt;/a&gt;&lt;/li&gt;%n"</span> +</span><br><span class="line">                    <span class="hljs-string">"    &lt;li&gt;&lt;a href=\"&#123;8&#125;&#123;9&#125;?state=blocked\"&gt;CPU Contention&lt;/a&gt;&lt;/li&gt;%n"</span> +</span><br><span class="line">                    <span class="hljs-string">"  &lt;/ul&gt;%n"</span> +</span><br><span class="line">                    <span class="hljs-string">"&lt;/body&gt;%n"</span> +</span><br><span class="line">                    <span class="hljs-string">"&lt;/html&gt;"</span></span><br><span class="line">    );</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CONTENT_TYPE = <span class="hljs-string">"text/html"</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = -<span class="hljs-number">2850794040708785318L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> HealthCheckServlet healthCheckServlet;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> MetricsServlet metricsServlet;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> PingServlet pingServlet;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> ThreadDumpServlet threadDumpServlet;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> CpuProfileServlet cpuProfileServlet;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> String metricsUri;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> String pingUri;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> String threadsUri;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> String healthcheckUri;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> String cpuprofileUri;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> String serviceName;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 初始化不同的servlet数据</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> config</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> ServletException</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">(ServletConfig config)</span> <span class="hljs-keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">super</span>.init(config);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">this</span>.healthCheckServlet = <span class="hljs-keyword">new</span> HealthCheckServlet();</span><br><span class="line">        healthCheckServlet.init(config);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">this</span>.metricsServlet = <span class="hljs-keyword">new</span> MetricsServlet();</span><br><span class="line">        metricsServlet.init(config);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">this</span>.pingServlet = <span class="hljs-keyword">new</span> PingServlet();</span><br><span class="line">        pingServlet.init(config);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">this</span>.threadDumpServlet = <span class="hljs-keyword">new</span> ThreadDumpServlet();</span><br><span class="line">        threadDumpServlet.init(config);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">this</span>.cpuProfileServlet = <span class="hljs-keyword">new</span> CpuProfileServlet();</span><br><span class="line">        cpuProfileServlet.init(config);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">this</span>.metricsUri = getParam(config.getInitParameter(METRICS_URI_PARAM_KEY), DEFAULT_METRICS_URI);</span><br><span class="line">        <span class="hljs-keyword">this</span>.pingUri = getParam(config.getInitParameter(PING_URI_PARAM_KEY), DEFAULT_PING_URI);</span><br><span class="line">        <span class="hljs-keyword">this</span>.threadsUri = getParam(config.getInitParameter(THREADS_URI_PARAM_KEY), DEFAULT_THREADS_URI);</span><br><span class="line">        <span class="hljs-keyword">this</span>.healthcheckUri = getParam(config.getInitParameter(HEALTHCHECK_URI_PARAM_KEY), DEFAULT_HEALTHCHECK_URI);</span><br><span class="line">        <span class="hljs-keyword">this</span>.cpuprofileUri = getParam(config.getInitParameter(CPU_PROFILE_URI_PARAM_KEY), DEFAULT_CPU_PROFILE_URI);</span><br><span class="line">        <span class="hljs-keyword">this</span>.serviceName = getParam(config.getInitParameter(SERVICE_NAME_PARAM_KEY), <span class="hljs-keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> String path = req.getContextPath() + req.getServletPath();</span><br><span class="line"></span><br><span class="line">        resp.setStatus(HttpServletResponse.SC_OK);</span><br><span class="line">        resp.setHeader(<span class="hljs-string">"Cache-Control"</span>, <span class="hljs-string">"must-revalidate,no-cache,no-store"</span>);</span><br><span class="line">        resp.setContentType(CONTENT_TYPE);</span><br><span class="line">        <span class="hljs-keyword">final</span> PrintWriter writer = resp.getWriter();</span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            writer.println(MessageFormat.format(TEMPLATE, path, metricsUri, path, pingUri, path,</span><br><span class="line">                                                threadsUri, path, healthcheckUri, path, cpuprofileUri,</span><br><span class="line">                                                serviceName == <span class="hljs-keyword">null</span> ? <span class="hljs-string">""</span> : <span class="hljs-string">" ("</span> + serviceName + <span class="hljs-string">")"</span>));</span><br><span class="line">        &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">            writer.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * 执行不同metric的servlet的service</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">service</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> String uri = req.getPathInfo();</span><br><span class="line">        <span class="hljs-keyword">if</span> (uri == <span class="hljs-keyword">null</span> || uri.equals(<span class="hljs-string">"/"</span>)) &#123;</span><br><span class="line">            <span class="hljs-keyword">super</span>.service(req, resp);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (uri.equals(healthcheckUri)) &#123;</span><br><span class="line">            healthCheckServlet.service(req, resp);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (uri.startsWith(metricsUri)) &#123;</span><br><span class="line">            metricsServlet.service(req, resp);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (uri.equals(pingUri)) &#123;</span><br><span class="line">            pingServlet.service(req, resp);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (uri.equals(threadsUri)) &#123;</span><br><span class="line">            threadDumpServlet.service(req, resp);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (uri.equals(cpuprofileUri)) &#123;</span><br><span class="line">            cpuProfileServlet.service(req, resp);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            resp.sendError(HttpServletResponse.SC_NOT_FOUND);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getParam</span><span class="hljs-params">(String initParam, String defaultValue)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> initParam == <span class="hljs-keyword">null</span> ? defaultValue : initParam;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="CpuProfileServlet-java"><a href="#CpuProfileServlet-java" class="headerlink" title="CpuProfileServlet.java"></a>CpuProfileServlet.java</h3><p>cpu概况的servlet，快照时候需要加锁<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.servlets;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="hljs-keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"><span class="hljs-keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="hljs-keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="hljs-keyword">import</span> org.joda.time.Duration;</span><br><span class="line"><span class="hljs-keyword">import</span> com.papertrail.profiler.CpuProfile;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * An HTTP servlets which outputs a &lt;a href="https://github.com/gperftools/gperftools"&gt;pprof&lt;/a&gt; parseable response.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * cpu 概况</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CpuProfileServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = -<span class="hljs-number">668666696530287501L</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CONTENT_TYPE = <span class="hljs-string">"pprof/raw"</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CACHE_CONTROL = <span class="hljs-string">"Cache-Control"</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String NO_CACHE = <span class="hljs-string">"must-revalidate,no-cache,no-store"</span>;</span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 处理线程安全</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Lock lock = <span class="hljs-keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doGet</span><span class="hljs-params">(HttpServletRequest req,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                         HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="hljs-comment">//持续</span></span><br><span class="line">        <span class="hljs-keyword">int</span> duration = <span class="hljs-number">10</span>;</span><br><span class="line">        <span class="hljs-keyword">if</span> (req.getParameter(<span class="hljs-string">"duration"</span>) != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                duration = Integer.parseInt(req.getParameter(<span class="hljs-string">"duration"</span>));</span><br><span class="line">            &#125; <span class="hljs-keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                duration = <span class="hljs-number">10</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-comment">//频率</span></span><br><span class="line">        <span class="hljs-keyword">int</span> frequency = <span class="hljs-number">100</span>;</span><br><span class="line">        <span class="hljs-keyword">if</span> (req.getParameter(<span class="hljs-string">"frequency"</span>) != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                frequency = Integer.parseInt(req.getParameter(<span class="hljs-string">"frequency"</span>));</span><br><span class="line">            &#125; <span class="hljs-keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                frequency = <span class="hljs-number">100</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">//线程状态</span></span><br><span class="line">        <span class="hljs-keyword">final</span> Thread.State state;</span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-string">"blocked"</span>.equalsIgnoreCase(req.getParameter(<span class="hljs-string">"state"</span>))) &#123;</span><br><span class="line">            state = Thread.State.BLOCKED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            state = Thread.State.RUNNABLE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        resp.setStatus(HttpServletResponse.SC_OK);</span><br><span class="line">        resp.setHeader(CACHE_CONTROL, NO_CACHE);</span><br><span class="line">        resp.setContentType(CONTENT_TYPE);</span><br><span class="line">        <span class="hljs-keyword">final</span> OutputStream output = resp.getOutputStream();</span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            doProfile(output, duration, frequency, state);</span><br><span class="line">        &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">            output.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">//获取cpu快照</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doProfile</span><span class="hljs-params">(OutputStream out, <span class="hljs-keyword">int</span> duration, <span class="hljs-keyword">int</span> frequency, Thread.State state)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (lock.tryLock()) &#123;</span><br><span class="line">            <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                <span class="hljs-comment">//单进程的获取cpu信息</span></span><br><span class="line">                CpuProfile profile = CpuProfile.record(Duration.standardSeconds(duration), frequency, state);</span><br><span class="line">                <span class="hljs-keyword">if</span> (profile == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"could not create CpuProfile"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                profile.writeGoogleProfile(out);</span><br><span class="line">                <span class="hljs-keyword">return</span>;</span><br><span class="line">            &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"Only one profile request may be active at a time"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="HealthCheckServlet-java"><a href="#HealthCheckServlet-java" class="headerlink" title="HealthCheckServlet.java"></a>HealthCheckServlet.java</h3><p>健康监测，通过对象或者线程服务<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> io.dropwizard.metrics.servlets;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectWriter;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.json.HealthCheckModule;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.health.HealthCheck;</span><br><span class="line"><span class="hljs-keyword">import</span> io.dropwizard.metrics.health.HealthCheckRegistry;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="hljs-keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="hljs-keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Map;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.SortedMap;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * 健康监测，通过对象或者线程服务</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HealthCheckServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpServlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 自定义此servlet监听器</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ContextListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ServletContextListener</span> </span>&#123;</span><br><span class="line">        <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">         * <span class="hljs-doctag">@return</span> the &#123;<span class="hljs-doctag">@link</span> HealthCheckRegistry&#125; to inject into the servlet context.</span></span><br><span class="line"><span class="hljs-comment">         *</span></span><br><span class="line"><span class="hljs-comment">         * 获取对象</span></span><br><span class="line"><span class="hljs-comment">         *</span></span><br><span class="line"><span class="hljs-comment">         */</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> HealthCheckRegistry <span class="hljs-title">getHealthCheckRegistry</span><span class="hljs-params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">         * <span class="hljs-doctag">@return</span> the &#123;<span class="hljs-doctag">@link</span> ExecutorService&#125; to inject into the servlet context, or &#123;<span class="hljs-doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="hljs-comment">         * if the health checks should be run in the servlet worker thread.</span></span><br><span class="line"><span class="hljs-comment">         *</span></span><br><span class="line"><span class="hljs-comment">         *</span></span><br><span class="line"><span class="hljs-comment">         */</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">protected</span> ExecutorService <span class="hljs-title">getExecutorService</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            <span class="hljs-comment">// don't use a thread pool by default</span></span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-meta">@Override</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">contextInitialized</span><span class="hljs-params">(ServletContextEvent event)</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">final</span> ServletContext context = event.getServletContext();</span><br><span class="line">            context.setAttribute(HEALTH_CHECK_REGISTRY, getHealthCheckRegistry());</span><br><span class="line">            context.setAttribute(HEALTH_CHECK_EXECUTOR, getExecutorService());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-meta">@Override</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">contextDestroyed</span><span class="hljs-params">(ServletContextEvent event)</span> </span>&#123;</span><br><span class="line">            <span class="hljs-comment">// no-op</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String HEALTH_CHECK_REGISTRY = HealthCheckServlet.class.getCanonicalName() + <span class="hljs-string">".registry"</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String HEALTH_CHECK_EXECUTOR = HealthCheckServlet.class.getCanonicalName() + <span class="hljs-string">".executor"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = -<span class="hljs-number">8432996484889177321L</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CONTENT_TYPE = <span class="hljs-string">"application/json"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 健康监测注册对象</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> HealthCheckRegistry registry;</span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 线程执行服务</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> ExecutorService executorService;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> ObjectMapper mapper;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HealthCheckServlet</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HealthCheckServlet</span><span class="hljs-params">(HealthCheckRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.registry = registry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">(ServletConfig config)</span> <span class="hljs-keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">super</span>.init(config);</span><br><span class="line">        <span class="hljs-comment">//初始化 HealthCheckRegistry 对象</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> == registry) &#123;</span><br><span class="line">            <span class="hljs-keyword">final</span> Object registryAttr = config.getServletContext().getAttribute(HEALTH_CHECK_REGISTRY);</span><br><span class="line">            <span class="hljs-comment">//初始化注册对象</span></span><br><span class="line">            <span class="hljs-keyword">if</span> (registryAttr <span class="hljs-keyword">instanceof</span> HealthCheckRegistry) &#123;</span><br><span class="line">                <span class="hljs-keyword">this</span>.registry = (HealthCheckRegistry) registryAttr;</span><br><span class="line">            &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ServletException(<span class="hljs-string">"Couldn't find a HealthCheckRegistry instance."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">//初始化线程池</span></span><br><span class="line">        <span class="hljs-keyword">final</span> Object executorAttr = config.getServletContext().getAttribute(HEALTH_CHECK_EXECUTOR);</span><br><span class="line">        <span class="hljs-keyword">if</span> (executorAttr <span class="hljs-keyword">instanceof</span> ExecutorService) &#123;</span><br><span class="line">            <span class="hljs-keyword">this</span>.executorService = (ExecutorService) executorAttr;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-comment">//json对象</span></span><br><span class="line">        <span class="hljs-keyword">this</span>.mapper = <span class="hljs-keyword">new</span> ObjectMapper().registerModule(<span class="hljs-keyword">new</span> HealthCheckModule());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="hljs-comment">//检测 health 返回结果</span></span><br><span class="line">        <span class="hljs-keyword">final</span> SortedMap&lt;String, HealthCheck.Result&gt; results = runHealthChecks();</span><br><span class="line">        resp.setContentType(CONTENT_TYPE);</span><br><span class="line">        resp.setHeader(<span class="hljs-string">"Cache-Control"</span>, <span class="hljs-string">"must-revalidate,no-cache,no-store"</span>);</span><br><span class="line">        <span class="hljs-comment">//检测结果</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (results.isEmpty()) &#123;</span><br><span class="line">            resp.setStatus(HttpServletResponse.SC_NOT_IMPLEMENTED);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            <span class="hljs-comment">//是否健康</span></span><br><span class="line">            <span class="hljs-keyword">if</span> (isAllHealthy(results)) &#123;</span><br><span class="line">                resp.setStatus(HttpServletResponse.SC_OK);</span><br><span class="line">            &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//错误</span></span><br><span class="line">                resp.setStatus(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">final</span> OutputStream output = resp.getOutputStream();</span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            getWriter(req).writeValue(output, results);</span><br><span class="line">        &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">            output.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> ObjectWriter <span class="hljs-title">getWriter</span><span class="hljs-params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> prettyPrint = Boolean.parseBoolean(request.getParameter(<span class="hljs-string">"pretty"</span>));</span><br><span class="line">        <span class="hljs-keyword">if</span> (prettyPrint) &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> mapper.writerWithDefaultPrettyPrinter();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> mapper.writer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 运行健康监测</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> SortedMap&lt;String, HealthCheck.Result&gt; runHealthChecks() &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (executorService == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> registry.runHealthChecks();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> registry.runHealthChecks(executorService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 检测当前结果是否健康</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> results</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isAllHealthy</span><span class="hljs-params">(Map&lt;String, HealthCheck.Result&gt; results)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">for</span> (HealthCheck.Result result : results.values()) &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (!result.isHealthy()) &#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

        </div>
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link" href="/tags/开源项目/">开源项目</a>, <a class="has-link-grey -link" href="/tags/源码/">源码</a>
                </div>
            </div>
        </div>
        
        
        
        <div class="social-share"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css">
<script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3>
        <div class="buttons is-centered">
            
                
<a class="button is-info donate">
    <span class="icon is-small">
        <i class="fab fa-alipay"></i>
    </span>
    <span>支付宝</span>
    <div class="qrcode"><img src="/images/alipaycode.jpg" alt="支付宝"></div>
</a>

                
                
<a class="button is-success donate">
    <span class="icon is-small">
        <i class="fab fa-weixin"></i>
    </span>
    <span>微信</span>
    <div class="qrcode"><img src="/images/wxcode.png" alt="微信"></div>
</a>

                
        </div>
    </div>
</div>



<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/Recommended-Algorithm-Preliminary-Learning/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">推荐算法初步学习</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/JDK1.7-FutureTask/">
                <span class="level-item">JDK1.7 FutureTask</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="title is-5 has-text-weight-normal">评论</h3>
        
<div id="comment-container"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.4.1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.4.1/dist/gitalk.min.js"></script>
<script>
    var gitalk = new Gitalk({
        clientID: 'a70be08270bc7c083f83',
        clientSecret: '1b08252e3cf4b0c29b5f52f431ad9a54eef0a74a',
        id: '1b9896b573857c940e1fdbc16c559b4c',
        repo: 'joeskye1701.github.io',
        owner: 'joeskye1701',
        admin: "joeskye1701"
    })
    gitalk.render('comment-container')
</script>

    </div>
</div>
</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered">
                <div>
                    
                        <img class="image is-128x128 has-mb-6" src="/images/thank-you-kobe.jpg" alt="Joe">
                    
                    
                    <p class="is-size-4 is-block">
                        Joe
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        Developer &amp; Designer
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>Shenzhen, China</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <p class="title has-text-weight-normal">
                        129
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <p class="title has-text-weight-normal">
                        26
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <p class="title has-text-weight-normal">
                        54
                    </p>
                </div>
            </div>
        </nav>
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/joeskye1701">
                关注我</a>
        </div>
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank" title="Github" href="https://github.com/joeskye1701">
                
                <i class="fab fa-github"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        

<div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            链接
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="http://wss.xxyseo.cn/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">西乡大佬</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">wss.xxyseo.cn</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>


    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分类
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Android/">
            <span class="level-start">
                <span class="level-item">Android</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/JDK6-源码/">
            <span class="level-start">
                <span class="level-item">JDK6 源码</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">18</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/JDK7-源码/">
            <span class="level-start">
                <span class="level-item">JDK7 源码</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">6</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/JDK8-源码/">
            <span class="level-start">
                <span class="level-item">JDK8 源码</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/JMM/">
            <span class="level-start">
                <span class="level-item">JMM</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">6</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/JVM/">
            <span class="level-start">
                <span class="level-item">JVM</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">10</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Java/">
            <span class="level-start">
                <span class="level-item">Java</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">20</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Linux/">
            <span class="level-start">
                <span class="level-item">Linux</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/MyBatis/">
            <span class="level-start">
                <span class="level-item">MyBatis</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/MySQL/">
            <span class="level-start">
                <span class="level-item">MySQL</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Redis/">
            <span class="level-start">
                <span class="level-item">Redis</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Spring/">
            <span class="level-start">
                <span class="level-item">Spring</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Tomcat/">
            <span class="level-start">
                <span class="level-item">Tomcat</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">7</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/书/">
            <span class="level-start">
                <span class="level-item">书</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/多线程/">
            <span class="level-start">
                <span class="level-item">多线程</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/并发/">
            <span class="level-start">
                <span class="level-item">并发</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/开源项目/">
            <span class="level-start">
                <span class="level-item">开源项目</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/数学/">
            <span class="level-start">
                <span class="level-item">数学</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/数据库/">
            <span class="level-start">
                <span class="level-item">数据库</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/数据结构/">
            <span class="level-start">
                <span class="level-item">数据结构</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">5</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/日语/">
            <span class="level-start">
                <span class="level-item">日语</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/机器学习/">
            <span class="level-start">
                <span class="level-item">机器学习</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/算法/">
            <span class="level-start">
                <span class="level-item">算法</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">23</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/计算机基础/">
            <span class="level-start">
                <span class="level-item">计算机基础</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/设计模式/">
            <span class="level-start">
                <span class="level-item">设计模式</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/面试/">
            <span class="level-start">
                <span class="level-item">面试</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/Android/" style="font-size: 10px;">Android</a> <a href="/tags/Centos/" style="font-size: 11.82px;">Centos</a> <a href="/tags/Effect-Java/" style="font-size: 10.91px;">Effect Java</a> <a href="/tags/JDK6-源码/" style="font-size: 18.18px;">JDK6 源码</a> <a href="/tags/JDK7-源码/" style="font-size: 14.55px;">JDK7 源码</a> <a href="/tags/JDK8-源码/" style="font-size: 10px;">JDK8 源码</a> <a href="/tags/JMM/" style="font-size: 15.45px;">JMM</a> <a href="/tags/JVM/" style="font-size: 16.36px;">JVM</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/Linux/" style="font-size: 12.73px;">Linux</a> <a href="/tags/MongoDB/" style="font-size: 10px;">MongoDB</a> <a href="/tags/Mongodb/" style="font-size: 10px;">Mongodb</a> <a href="/tags/MyBatis/" style="font-size: 11.82px;">MyBatis</a> <a href="/tags/MySQL/" style="font-size: 10.91px;">MySQL</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/Spring/" style="font-size: 12.73px;">Spring</a> <a href="/tags/Think-In-Java/" style="font-size: 10px;">Think In Java</a> <a href="/tags/Tomcat/" style="font-size: 15.45px;">Tomcat</a> <a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a> <a href="/tags/一致性哈希算法/" style="font-size: 10px;">一致性哈希算法</a> <a href="/tags/书/" style="font-size: 11.82px;">书</a> <a href="/tags/倒排索引/" style="font-size: 10px;">倒排索引</a> <a href="/tags/内存泄漏/" style="font-size: 10px;">内存泄漏</a> <a href="/tags/分支限界算法/" style="font-size: 10.91px;">分支限界算法</a> <a href="/tags/分治法/" style="font-size: 10px;">分治法</a> <a href="/tags/分治算法/" style="font-size: 10px;">分治算法</a> <a href="/tags/分词算法/" style="font-size: 10.91px;">分词算法</a> <a href="/tags/动态规划/" style="font-size: 10px;">动态规划</a> <a href="/tags/动态规划算法/" style="font-size: 10.91px;">动态规划算法</a> <a href="/tags/华为/" style="font-size: 10px;">华为</a> <a href="/tags/回溯算法/" style="font-size: 12.73px;">回溯算法</a> <a href="/tags/多线程/" style="font-size: 10.91px;">多线程</a> <a href="/tags/工具/" style="font-size: 10px;">工具</a> <a href="/tags/并发/" style="font-size: 13.64px;">并发</a> <a href="/tags/开源项目/" style="font-size: 17.27px;">开源项目</a> <a href="/tags/手机游戏/" style="font-size: 10px;">手机游戏</a> <a href="/tags/排序算法/" style="font-size: 10px;">排序算法</a> <a href="/tags/推荐/" style="font-size: 10px;">推荐</a> <a href="/tags/散列表/" style="font-size: 10px;">散列表</a> <a href="/tags/数学/" style="font-size: 10px;">数学</a> <a href="/tags/数据库/" style="font-size: 10.91px;">数据库</a> <a href="/tags/数据结构/" style="font-size: 13.64px;">数据结构</a> <a href="/tags/日语/" style="font-size: 10px;">日语</a> <a href="/tags/最优路径算法/" style="font-size: 10px;">最优路径算法</a> <a href="/tags/机器学习/" style="font-size: 10px;">机器学习</a> <a href="/tags/源码/" style="font-size: 11.82px;">源码</a> <a href="/tags/算法/" style="font-size: 19.09px;">算法</a> <a href="/tags/线程安全/" style="font-size: 10.91px;">线程安全</a> <a href="/tags/编程珠玑/" style="font-size: 11.82px;">编程珠玑</a> <a href="/tags/计算机基础/" style="font-size: 10px;">计算机基础</a> <a href="/tags/设计模式/" style="font-size: 12.73px;">设计模式</a> <a href="/tags/贪心算法/" style="font-size: 11.82px;">贪心算法</a> <a href="/tags/跳表/" style="font-size: 10px;">跳表</a> <a href="/tags/面试/" style="font-size: 10px;">面试</a>
    </div>
</div>

    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
            
        
            
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            <!-- 
            <a href="/VIM-Command/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="VIM 命令">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-12-10T02:31:22.000Z">2018-12-10</time></div>
                    <a href="/VIM-Command/" class="has-link-black-ter is-size-6">VIM 命令</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/Lock-Control/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="锁粒度的控制">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-04T04:37:22.000Z">2018-11-04</time></div>
                    <a href="/Lock-Control/" class="has-link-black-ter is-size-6">锁粒度的控制</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/Temporary-Menory-Table/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="临时表和内存表">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-04T04:37:22.000Z">2018-11-04</time></div>
                    <a href="/Temporary-Menory-Table/" class="has-link-black-ter is-size-6">临时表和内存表</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/MySQL/">MySQL</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/MySQL-Command/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="MySQL基本命令">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-03T04:37:22.000Z">2018-11-03</time></div>
                    <a href="/MySQL-Command/" class="has-link-black-ter is-size-6">MySQL基本命令</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/MySQL/">MySQL</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/Python2ToPython3/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Python2切换Python3">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-03T04:37:22.000Z">2018-11-03</time></div>
                    <a href="/Python2ToPython3/" class="has-link-black-ter is-size-6">Python2切换Python3</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2018/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/01/">
                <span class="level-start">
                    <span class="level-item">一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/01/">
                <span class="level-start">
                    <span class="level-item">一月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/10/">
                <span class="level-start">
                    <span class="level-item">十月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">9</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/09/">
                <span class="level-start">
                    <span class="level-item">九月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/08/">
                <span class="level-start">
                    <span class="level-item">八月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/07/">
                <span class="level-start">
                    <span class="level-item">七月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/06/">
                <span class="level-start">
                    <span class="level-item">六月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/05/">
                <span class="level-start">
                    <span class="level-item">五月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/04/">
                <span class="level-start">
                    <span class="level-item">四月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/03/">
                <span class="level-start">
                    <span class="level-item">三月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/02/">
                <span class="level-start">
                    <span class="level-item">二月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/10/">
                <span class="level-start">
                    <span class="level-item">十月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">13</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/09/">
                <span class="level-start">
                    <span class="level-item">九月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/08/">
                <span class="level-start">
                    <span class="level-item">八月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/07/">
                <span class="level-start">
                    <span class="level-item">七月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/06/">
                <span class="level-start">
                    <span class="level-item">六月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/05/">
                <span class="level-start">
                    <span class="level-item">五月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/04/">
                <span class="level-start">
                    <span class="level-item">四月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/03/">
                <span class="level-start">
                    <span class="level-item">三月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/02/">
                <span class="level-start">
                    <span class="level-item">二月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/01/">
                <span class="level-start">
                    <span class="level-item">一月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/09/">
                <span class="level-start">
                    <span class="level-item">九月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/03/">
                <span class="level-start">
                    <span class="level-item">三月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/10/">
                <span class="level-start">
                    <span class="level-item">十月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/08/">
                <span class="level-start">
                    <span class="level-item">八月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/07/">
                <span class="level-start">
                    <span class="level-item">七月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/06/">
                <span class="level-start">
                    <span class="level-item">六月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/04/">
                <span class="level-start">
                    <span class="level-item">四月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/03/">
                <span class="level-start">
                    <span class="level-item">三月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/02/">
                <span class="level-start">
                    <span class="level-item">二月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/01/">
                <span class="level-start">
                    <span class="level-item">一月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Android/">
                        <span class="tag">Android</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Centos/">
                        <span class="tag">Centos</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Effect-Java/">
                        <span class="tag">Effect Java</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JDK6-源码/">
                        <span class="tag">JDK6 源码</span>
                        <span class="tag is-grey">18</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JDK7-源码/">
                        <span class="tag">JDK7 源码</span>
                        <span class="tag is-grey">6</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JDK8-源码/">
                        <span class="tag">JDK8 源码</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JMM/">
                        <span class="tag">JMM</span>
                        <span class="tag is-grey">7</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JVM/">
                        <span class="tag">JVM</span>
                        <span class="tag is-grey">10</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Java/">
                        <span class="tag">Java</span>
                        <span class="tag is-grey">40</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Linux/">
                        <span class="tag">Linux</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MongoDB/">
                        <span class="tag">MongoDB</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Mongodb/">
                        <span class="tag">Mongodb</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MyBatis/">
                        <span class="tag">MyBatis</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MySQL/">
                        <span class="tag">MySQL</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Redis/">
                        <span class="tag">Redis</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Spring/">
                        <span class="tag">Spring</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Think-In-Java/">
                        <span class="tag">Think In Java</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Tomcat/">
                        <span class="tag">Tomcat</span>
                        <span class="tag is-grey">7</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Ubuntu/">
                        <span class="tag">Ubuntu</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/一致性哈希算法/">
                        <span class="tag">一致性哈希算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/书/">
                        <span class="tag">书</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/倒排索引/">
                        <span class="tag">倒排索引</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/内存泄漏/">
                        <span class="tag">内存泄漏</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分支限界算法/">
                        <span class="tag">分支限界算法</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分治法/">
                        <span class="tag">分治法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分治算法/">
                        <span class="tag">分治算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分词算法/">
                        <span class="tag">分词算法</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/动态规划/">
                        <span class="tag">动态规划</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/动态规划算法/">
                        <span class="tag">动态规划算法</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/华为/">
                        <span class="tag">华为</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/回溯算法/">
                        <span class="tag">回溯算法</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/多线程/">
                        <span class="tag">多线程</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/工具/">
                        <span class="tag">工具</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/并发/">
                        <span class="tag">并发</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/开源项目/">
                        <span class="tag">开源项目</span>
                        <span class="tag is-grey">17</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/手机游戏/">
                        <span class="tag">手机游戏</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/排序算法/">
                        <span class="tag">排序算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/推荐/">
                        <span class="tag">推荐</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/散列表/">
                        <span class="tag">散列表</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数学/">
                        <span class="tag">数学</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数据库/">
                        <span class="tag">数据库</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数据结构/">
                        <span class="tag">数据结构</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/日语/">
                        <span class="tag">日语</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/最优路径算法/">
                        <span class="tag">最优路径算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/机器学习/">
                        <span class="tag">机器学习</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/源码/">
                        <span class="tag">源码</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/算法/">
                        <span class="tag">算法</span>
                        <span class="tag is-grey">26</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/线程安全/">
                        <span class="tag">线程安全</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/编程珠玑/">
                        <span class="tag">编程珠玑</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/计算机基础/">
                        <span class="tag">计算机基础</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/设计模式/">
                        <span class="tag">设计模式</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/贪心算法/">
                        <span class="tag">贪心算法</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/跳表/">
                        <span class="tag">跳表</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/面试/">
                        <span class="tag">面试</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
        
        </div>
    
</div>

                




<div class="column is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only has-order-3 column-right ">
    
        
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            <!-- 
            <a href="/VIM-Command/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="VIM 命令">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-12-10T02:31:22.000Z">2018-12-10</time></div>
                    <a href="/VIM-Command/" class="has-link-black-ter is-size-6">VIM 命令</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/Lock-Control/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="锁粒度的控制">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-04T04:37:22.000Z">2018-11-04</time></div>
                    <a href="/Lock-Control/" class="has-link-black-ter is-size-6">锁粒度的控制</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/Temporary-Menory-Table/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="临时表和内存表">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-04T04:37:22.000Z">2018-11-04</time></div>
                    <a href="/Temporary-Menory-Table/" class="has-link-black-ter is-size-6">临时表和内存表</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/MySQL/">MySQL</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/MySQL-Command/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="MySQL基本命令">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-03T04:37:22.000Z">2018-11-03</time></div>
                    <a href="/MySQL-Command/" class="has-link-black-ter is-size-6">MySQL基本命令</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/MySQL/">MySQL</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/Python2ToPython3/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Python2切换Python3">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-03T04:37:22.000Z">2018-11-03</time></div>
                    <a href="/Python2ToPython3/" class="has-link-black-ter is-size-6">Python2切换Python3</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2018/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/01/">
                <span class="level-start">
                    <span class="level-item">一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/01/">
                <span class="level-start">
                    <span class="level-item">一月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/10/">
                <span class="level-start">
                    <span class="level-item">十月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">9</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/09/">
                <span class="level-start">
                    <span class="level-item">九月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/08/">
                <span class="level-start">
                    <span class="level-item">八月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/07/">
                <span class="level-start">
                    <span class="level-item">七月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/06/">
                <span class="level-start">
                    <span class="level-item">六月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/05/">
                <span class="level-start">
                    <span class="level-item">五月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/04/">
                <span class="level-start">
                    <span class="level-item">四月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/03/">
                <span class="level-start">
                    <span class="level-item">三月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/02/">
                <span class="level-start">
                    <span class="level-item">二月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/10/">
                <span class="level-start">
                    <span class="level-item">十月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">13</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/09/">
                <span class="level-start">
                    <span class="level-item">九月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/08/">
                <span class="level-start">
                    <span class="level-item">八月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/07/">
                <span class="level-start">
                    <span class="level-item">七月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/06/">
                <span class="level-start">
                    <span class="level-item">六月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/05/">
                <span class="level-start">
                    <span class="level-item">五月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/04/">
                <span class="level-start">
                    <span class="level-item">四月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/03/">
                <span class="level-start">
                    <span class="level-item">三月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/02/">
                <span class="level-start">
                    <span class="level-item">二月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/01/">
                <span class="level-start">
                    <span class="level-item">一月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/09/">
                <span class="level-start">
                    <span class="level-item">九月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/03/">
                <span class="level-start">
                    <span class="level-item">三月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/10/">
                <span class="level-start">
                    <span class="level-item">十月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/08/">
                <span class="level-start">
                    <span class="level-item">八月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/07/">
                <span class="level-start">
                    <span class="level-item">七月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/06/">
                <span class="level-start">
                    <span class="level-item">六月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/04/">
                <span class="level-start">
                    <span class="level-item">四月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/03/">
                <span class="level-start">
                    <span class="level-item">三月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/02/">
                <span class="level-start">
                    <span class="level-item">二月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/01/">
                <span class="level-start">
                    <span class="level-item">一月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Android/">
                        <span class="tag">Android</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Centos/">
                        <span class="tag">Centos</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Effect-Java/">
                        <span class="tag">Effect Java</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JDK6-源码/">
                        <span class="tag">JDK6 源码</span>
                        <span class="tag is-grey">18</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JDK7-源码/">
                        <span class="tag">JDK7 源码</span>
                        <span class="tag is-grey">6</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JDK8-源码/">
                        <span class="tag">JDK8 源码</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JMM/">
                        <span class="tag">JMM</span>
                        <span class="tag is-grey">7</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JVM/">
                        <span class="tag">JVM</span>
                        <span class="tag is-grey">10</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Java/">
                        <span class="tag">Java</span>
                        <span class="tag is-grey">40</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Linux/">
                        <span class="tag">Linux</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MongoDB/">
                        <span class="tag">MongoDB</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Mongodb/">
                        <span class="tag">Mongodb</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MyBatis/">
                        <span class="tag">MyBatis</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MySQL/">
                        <span class="tag">MySQL</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Redis/">
                        <span class="tag">Redis</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Spring/">
                        <span class="tag">Spring</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Think-In-Java/">
                        <span class="tag">Think In Java</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Tomcat/">
                        <span class="tag">Tomcat</span>
                        <span class="tag is-grey">7</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Ubuntu/">
                        <span class="tag">Ubuntu</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/一致性哈希算法/">
                        <span class="tag">一致性哈希算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/书/">
                        <span class="tag">书</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/倒排索引/">
                        <span class="tag">倒排索引</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/内存泄漏/">
                        <span class="tag">内存泄漏</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分支限界算法/">
                        <span class="tag">分支限界算法</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分治法/">
                        <span class="tag">分治法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分治算法/">
                        <span class="tag">分治算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分词算法/">
                        <span class="tag">分词算法</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/动态规划/">
                        <span class="tag">动态规划</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/动态规划算法/">
                        <span class="tag">动态规划算法</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/华为/">
                        <span class="tag">华为</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/回溯算法/">
                        <span class="tag">回溯算法</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/多线程/">
                        <span class="tag">多线程</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/工具/">
                        <span class="tag">工具</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/并发/">
                        <span class="tag">并发</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/开源项目/">
                        <span class="tag">开源项目</span>
                        <span class="tag is-grey">17</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/手机游戏/">
                        <span class="tag">手机游戏</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/排序算法/">
                        <span class="tag">排序算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/推荐/">
                        <span class="tag">推荐</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/散列表/">
                        <span class="tag">散列表</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数学/">
                        <span class="tag">数学</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数据库/">
                        <span class="tag">数据库</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数据结构/">
                        <span class="tag">数据结构</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/日语/">
                        <span class="tag">日语</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/最优路径算法/">
                        <span class="tag">最优路径算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/机器学习/">
                        <span class="tag">机器学习</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/源码/">
                        <span class="tag">源码</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/算法/">
                        <span class="tag">算法</span>
                        <span class="tag is-grey">26</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/线程安全/">
                        <span class="tag">线程安全</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/编程珠玑/">
                        <span class="tag">编程珠玑</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/计算机基础/">
                        <span class="tag">计算机基础</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/设计模式/">
                        <span class="tag">设计模式</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/贪心算法/">
                        <span class="tag">贪心算法</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/跳表/">
                        <span class="tag">跳表</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/面试/">
                        <span class="tag">面试</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
    
    
</div>

            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    Joe|博客
                
                </a>
                <p class="is-size-7">
                &copy; 2019 Joe&nbsp;
                <!-- Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        href="http://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a> -->
                
                </p>
            </div>
            <div class="level-end">
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么...">
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>