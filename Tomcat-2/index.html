<!DOCTYPE html>
<html lang="zh">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
<title>Tomcat（二）启动过程 - Joe|博客</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



    <meta name="description" content="1 Tomcat组件生命周期管理 2 Tomcat启动的总过程 BootStrap#init() BootStrap#load()   3 Tomcat启动过程关键步骤分析 Connector#init() Connector#start() StandardEngine#start()     1 Tomcat组件生命周期管理Tomcat中Server，Service，Connector，E">
<meta name="keywords" content="开源项目,Tomcat">
<meta property="og:type" content="article">
<meta property="og:title" content="Tomcat（二）启动过程">
<meta property="og:url" content="https://joeskye1701.github.io/Tomcat-2/index.html">
<meta property="og:site_name" content="Joe|博客">
<meta property="og:description" content="1 Tomcat组件生命周期管理 2 Tomcat启动的总过程 BootStrap#init() BootStrap#load()   3 Tomcat启动过程关键步骤分析 Connector#init() Connector#start() StandardEngine#start()     1 Tomcat组件生命周期管理Tomcat中Server，Service，Connector，E">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://joeskye1701.github.io/Tomcat-2/tomcat-2-1.jpg">
<meta property="og:image" content="https://joeskye1701.github.io/Tomcat-2/tomcat-2-2.jpg">
<meta property="og:image" content="https://joeskye1701.github.io/Tomcat-2/tomcat-2-3.jpg">
<meta property="og:image" content="https://joeskye1701.github.io/Tomcat-2/tomcat-2-4.jpg">
<meta property="og:image" content="https://joeskye1701.github.io/Tomcat-2/tomcat-2-5.jpg">
<meta property="og:image" content="https://joeskye1701.github.io/Tomcat-2/tomcat-2-6.jpg">
<meta property="og:image" content="https://joeskye1701.github.io/Tomcat-2/tomcat-2-7.jpg">
<meta property="og:image" content="https://joeskye1701.github.io/Tomcat-2/tomcat-2-8.jpg">
<meta property="og:updated_time" content="2019-03-06T19:44:33.558Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tomcat（二）启动过程">
<meta name="twitter:description" content="1 Tomcat组件生命周期管理 2 Tomcat启动的总过程 BootStrap#init() BootStrap#load()   3 Tomcat启动过程关键步骤分析 Connector#init() Connector#start() StandardEngine#start()     1 Tomcat组件生命周期管理Tomcat中Server，Service，Connector，E">
<meta name="twitter:image" content="https://joeskye1701.github.io/Tomcat-2/tomcat-2-1.jpg">





<link rel="icon" href="/images/thank-you-kobe.jpg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/xcode.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    

    
    
<script>
var _hmt = _hmt || [];
(function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?c422b171d3bdb7dbfae47ff3f70f9d30";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();
</script>

    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    
    
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                Joe|博客
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item" href="/">主页</a>
                
                <a class="navbar-item" href="/archives">归档</a>
                
                <a class="navbar-item" href="/categories">分类</a>
                
                <a class="navbar-item" href="/tags">标签</a>
                
                <a class="navbar-item" href="/about">关于</a>
                
            </div>
            
            <div class="navbar-end">
                
                
                <a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;">
                    <i class="fas fa-list-ul"></i>
                </a>
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-6-widescreen has-order-2 column-main"><div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2016-10-02T04:37:22.000Z">2016-10-02</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Tomcat/">Tomcat</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 9284 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                Tomcat（二）启动过程
            
        </h1>
        <div class="content">
            <!-- TOC -->
<ul>
<li><a href="#1-tomcat%E7%BB%84%E4%BB%B6%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86">1 Tomcat组件生命周期管理</a></li>
<li><a href="#2-tomcat%E5%90%AF%E5%8A%A8%E7%9A%84%E6%80%BB%E8%BF%87%E7%A8%8B">2 Tomcat启动的总过程</a><ul>
<li><a href="#bootstrapinit">BootStrap#init()</a></li>
<li><a href="#bootstrapload">BootStrap#load()</a></li>
</ul>
</li>
<li><a href="#3-tomcat%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%85%B3%E9%94%AE%E6%AD%A5%E9%AA%A4%E5%88%86%E6%9E%90">3 Tomcat启动过程关键步骤分析</a><ul>
<li><a href="#connectorinit">Connector#init()</a></li>
<li><a href="#connectorstart">Connector#start()</a></li>
<li><a href="#standardenginestart">StandardEngine#start()</a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h1 id="1-Tomcat组件生命周期管理"><a href="#1-Tomcat组件生命周期管理" class="headerlink" title="1 Tomcat组件生命周期管理"></a>1 Tomcat组件生命周期管理</h1><p>Tomcat中<code>Server</code>，<code>Service</code>，<code>Connector</code>，<code>Engine</code>，<code>Host</code>，<code>Context</code>的继承关系图，你会发现它们都实现<code>org.apache.catalina.Lifecycle</code>接口，而<code>org.apache.catalina.util.LifecycleBase</code>采用模板方法模式来对所有支持生命周期管理的组件的生命周期各个阶段进行总体管理，每个需要生命周期管理的组件只需要继承这个基类，然后覆盖对应的钩子方法即可完成相应的生命周期阶段性的管理工作。<br>下面我们首先来看看<code>org.apache.catalina.Lifecycle</code>接口的定义，它的类图如下图所示。<br><img src="./tomcat-2-1.jpg" alt><br>从上图我们可以清楚的看到<code>LifeCycle</code>中主要有四个生命周期阶段，它们分别是<strong>init()初始化</strong>，<strong>start()启动</strong>，<strong>stop()停止</strong>，<strong>destory()销毁</strong>。知道这四个生命周期阶段以后，看看<code>org.apache.catalina.util.LifecycleBase</code>是如何实现模板方法模式的。<br>那接下来我们就来看看<code>org.apache.catalina.util.LifecycleBase</code>类的定义，它的类图如下所示。<br><img src="./tomcat-2-2.jpg" alt><br>上图中用红色标注的四个方法就是模板方法模式中的钩子方法，子类可以通过实现钩子方法来纳入到基类已经流程化好的生命周期管理中。<br>上面我们对<code>LifeCycle</code>和<code>LifeCycleBase</code>有一个总体的认识，接下来，我们通过查看<code>org.apache.catalina.util.LifecycleBase</code>的源代码来具体的分析一下。<br><a id="more"></a><br><strong>org.apache.catalina.util.LifecycleBase#init</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Override</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">    <span class="hljs-comment">// 1</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (!state.equals(LifecycleState.NEW)) &#123;</span><br><span class="line">        invalidTransition(Lifecycle.BEFORE_INIT_EVENT);</span><br><span class="line">    &#125;</span><br><span class="line">    setStateInternal(LifecycleState.INITIALIZING, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>);</span><br><span class="line">    <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">        <span class="hljs-comment">// 2</span></span><br><span class="line">        initInternal();</span><br><span class="line">    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        ExceptionUtils.handleThrowable(t);</span><br><span class="line">        setStateInternal(LifecycleState.FAILED, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>);</span><br><span class="line">        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> LifecycleException(</span><br><span class="line">            sm.getString(<span class="hljs-string">"lifecycleBase.initFail"</span>,toString()), t);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">// 3 </span></span><br><span class="line">    setStateInternal(LifecycleState.INITIALIZED, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面我们逐一来分析一下上述代码中标注数字的地方。</p>
<ul>
<li>标注1的代码：首先检测当前组件的状态是不是<code>LifecycleState.NEW</code>(新建)，如果不是就调用 <code>org.apache.catalina.util.LifecycleBase#invalidTransition()</code>来将当前的状态转换过程终止，而<code>invalidTransition</code>的实现是抛出<code>org.apache.catalina.LifecycleException</code>异常。接着调用<code>setStateInternal()</code>将状态设置为<code>INITIALIZING</code>（正在初始化）</li>
<li>标注2的代码：就是<code>init()</code>模板方法的钩子，子类可以通过实现<code>protected abstract void initInternal() throws LifecycleException;</code>来纳入初始化的流程。</li>
<li>标注3的代码：将组件的状态改为<code>LifecycleState.INITIALIZED</code>(已初始化)。</li>
</ul>
<p>上面我们分析<code>init()</code>模板方法，接下来我们再看看<code>start()</code>具体做什么事情。<br><strong>org.apache.catalina.util.LifecycleBase#start()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-meta">@Override</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">start</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">    <span class="hljs-comment">// 1</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (LifecycleState.STARTING_PREP.equals(state) ||</span><br><span class="line">            LifecycleState.STARTING.equals(state) ||</span><br><span class="line">            LifecycleState.STARTED.equals(state)) &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            Exception e = <span class="hljs-keyword">new</span> LifecycleException();</span><br><span class="line">            log.debug(sm.getString(<span class="hljs-string">"lifecycleBase.alreadyStarted"</span>,</span><br><span class="line">                    toString()), e);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(sm.getString(<span class="hljs-string">"lifecycleBase.alreadyStarted"</span>,</span><br><span class="line">                    toString()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">// 2</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (state.equals(LifecycleState.NEW)) &#123;</span><br><span class="line">        init();</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state.equals(LifecycleState.FAILED))&#123;</span><br><span class="line">        stop();</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!state.equals(LifecycleState.INITIALIZED) &amp;&amp;</span><br><span class="line">            !state.equals(LifecycleState.STOPPED)) &#123;</span><br><span class="line">        invalidTransition(Lifecycle.BEFORE_START_EVENT);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">// 3</span></span><br><span class="line">    setStateInternal(LifecycleState.STARTING_PREP, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>);</span><br><span class="line">    <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">        <span class="hljs-comment">// 4</span></span><br><span class="line">        startInternal();</span><br><span class="line">    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        ExceptionUtils.handleThrowable(t);</span><br><span class="line">        setStateInternal(LifecycleState.FAILED, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>);</span><br><span class="line">        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> LifecycleException(</span><br><span class="line">            sm.getString(<span class="hljs-string">"lifecycleBase.startFail"</span>,toString()), t);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">// 5</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (state.equals(LifecycleState.FAILED) ||</span><br><span class="line">        state.equals(LifecycleState.MUST_STOP)) &#123;</span><br><span class="line">            stop();</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            <span class="hljs-comment">// Shouldn't be necessary but acts as a check that sub-classes are</span></span><br><span class="line">            <span class="hljs-comment">// doing what they are supposed to.</span></span><br><span class="line">            <span class="hljs-keyword">if</span> (!state.equals(LifecycleState.STARTING)) &#123;</span><br><span class="line">                invalidTransition(Lifecycle.AFTER_START_EVENT);</span><br><span class="line">            &#125;</span><br><span class="line">            setStateInternal(LifecycleState.STARTED, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面我们逐一来分析一下上述代码中标注数字的地方：</p>
<ul>
<li>标注1的代码：检测当前组件的状态是不是<code>LifecycleState.STARTING_PREP</code>(准备启动)，<code>LifecycleState.STARTING</code>（正在启动），<code>LifecycleState.STARTED</code>（已启动）。如果是这三个状态中的任何一个，则抛出<code>LifecycleException</code>。</li>
<li>标注2的代码：检查其实主要是为保证组件状态的完整性，在正常启动的流程中，应该是不会出现没有初始化就启动，或者还没启动就已经失败的情况。</li>
<li>标注3的代码：设置组件的状态为<code>LifecycleState.STARTING_PREP</code>（准备启动状态）。</li>
<li>标注4的代码：<code>start()</code>模板方法的钩子方法，子类通过实现 <code>org.apache.catalina.util.LifecycleBase#startInternal()</code>这个方法来纳入到组件启动的流程中来。</li>
<li>标注5的代码：做一些状态检查，然后最终将组件的状态设置为<code>LifecycleState.STARTED</code>（已启动）。</li>
</ul>
<p>上面我们分析<code>init()</code>和<code>start()</code>的流程，对于<code>stop()</code>和<code>destroy()</code>的总体过程是类似的，通过上面的分析，我们可以得出生命周期方法的总体的骨架，如果用伪代码来表示可以简化为如下。<br><strong>org.apache.catalina.util.LifecycleBase#lifeCycleMethod()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">lfieCycleMethod</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">        stateCheck();<span class="hljs-comment">//状态检查</span></span><br><span class="line">        <span class="hljs-comment">//设置为进入相应的生命周期之前的状态</span></span><br><span class="line">        setStateInternal(LifecycleState.BEFORE_STATE, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>);</span><br><span class="line">        lfieCycleMethodInternal();<span class="hljs-comment">//钩子方法</span></span><br><span class="line">        <span class="hljs-comment">//进入相应的生命周期之后的状态</span></span><br><span class="line">        setStateInternal(LifecycleState.AFTER_STATE, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="2-Tomcat启动的总过程"><a href="#2-Tomcat启动的总过程" class="headerlink" title="2 Tomcat启动的总过程"></a>2 Tomcat启动的总过程</h1><p>通过上面的介绍，清楚各个组件的生命周期的各个阶段具体都是如何运作的。接下来我们就来看看，Tomcat具体是如何一步步启动起来的。我们都知道任何Java程序都有一个<code>main()</code>入口，Tomcat中的<code>main()</code>入口是 <code>org.apache.catalina.startup.Bootstrap#main()</code>,下面我们就来分析一下它的代码。<br><strong>org.apache.catalina.startup.Bootstrap#main()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Main method and entry point when starting Tomcat via the provided</span></span><br><span class="line"><span class="hljs-comment">  * scripts.</span></span><br><span class="line"><span class="hljs-comment">  *</span></span><br><span class="line"><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> args Command line arguments to be processed</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String args[])</span> </span>&#123;</span><br><span class="line">     <span class="hljs-keyword">if</span> (daemon == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">         <span class="hljs-comment">// Don't set daemon until init() has completed</span></span><br><span class="line">         <span class="hljs-comment">// 1 </span></span><br><span class="line">         Bootstrap bootstrap = <span class="hljs-keyword">new</span> Bootstrap();</span><br><span class="line">         <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">             <span class="hljs-comment">// 2</span></span><br><span class="line">             bootstrap.init();</span><br><span class="line">         &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">             handleThrowable(t);</span><br><span class="line">             t.printStackTrace();</span><br><span class="line">             <span class="hljs-keyword">return</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="hljs-comment">// 3</span></span><br><span class="line">         daemon = bootstrap;</span><br><span class="line">     &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">         <span class="hljs-comment">// When running as a service the call to stop will be on a new</span></span><br><span class="line">         <span class="hljs-comment">// thread so make sure the correct class loader is used to prevent</span></span><br><span class="line">         <span class="hljs-comment">// a range of class not found exceptions.</span></span><br><span class="line">         Thread.currentThread().setContextClassLoader(daemon.catalinaLoader);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">         String command = <span class="hljs-string">"start"</span>;</span><br><span class="line">         <span class="hljs-keyword">if</span> (args.length &gt; <span class="hljs-number">0</span>) &#123;</span><br><span class="line">             command = args[args.length - <span class="hljs-number">1</span>];</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="hljs-keyword">if</span> (command.equals(<span class="hljs-string">"startd"</span>)) &#123;</span><br><span class="line">             args[args.length - <span class="hljs-number">1</span>] = <span class="hljs-string">"start"</span>;</span><br><span class="line">             daemon.load(args);</span><br><span class="line">             daemon.start();</span><br><span class="line">         &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (command.equals(<span class="hljs-string">"stopd"</span>)) &#123;</span><br><span class="line">             args[args.length - <span class="hljs-number">1</span>] = <span class="hljs-string">"stop"</span>;</span><br><span class="line">             daemon.stop();</span><br><span class="line">         &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (command.equals(<span class="hljs-string">"start"</span>)) &#123;</span><br><span class="line">             <span class="hljs-comment">// 4</span></span><br><span class="line">             daemon.setAwait(<span class="hljs-keyword">true</span>);</span><br><span class="line">             daemon.load(args);</span><br><span class="line">             daemon.start();</span><br><span class="line">         &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (command.equals(<span class="hljs-string">"stop"</span>)) &#123;</span><br><span class="line">             daemon.stopServer(args);</span><br><span class="line">         &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (command.equals(<span class="hljs-string">"configtest"</span>)) &#123;</span><br><span class="line">             daemon.load(args);</span><br><span class="line">             <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span>==daemon.getServer()) &#123;</span><br><span class="line">                 System.exit(<span class="hljs-number">1</span>);</span><br><span class="line">             &#125;</span><br><span class="line">             System.exit(<span class="hljs-number">0</span>);</span><br><span class="line">         &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">             log.warn(<span class="hljs-string">"Bootstrap: command \""</span> + command + <span class="hljs-string">"\" does not exist."</span>);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">         <span class="hljs-comment">// Unwrap the Exception for clearer error reporting</span></span><br><span class="line">         <span class="hljs-keyword">if</span> (t <span class="hljs-keyword">instanceof</span> InvocationTargetException &amp;&amp;</span><br><span class="line">                 t.getCause() != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">             t = t.getCause();</span><br><span class="line">         &#125;</span><br><span class="line">         handleThrowable(t);</span><br><span class="line">         t.printStackTrace();</span><br><span class="line">         System.exit(<span class="hljs-number">1</span>);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>下面我们逐一来分析一下上述代码中标注数字的地方：</p>
<ul>
<li>标注1的代码：初始化自举类的实例。</li>
<li>标注2的代码：对BootStrap实例进行初始化。</li>
<li>标注3的代码：将实例赋值给<code>daemon</code>。</li>
<li>标注4的代码：首先调用<code>BootStrap#load()</code>，然后调用<code>start()</code>。</li>
</ul>
<p>分别分析一下BootStrap的<code>init()</code>，<code>load()</code>，<code>start()</code>具体做哪些工作。</p>
<h2 id="BootStrap-init"><a href="#BootStrap-init" class="headerlink" title="BootStrap#init()"></a>BootStrap#init()</h2><p><strong>org.apache.catalina.startup.Bootstrap#init()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Initialize daemon.</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception</span></span><br><span class="line"><span class="hljs-function"> </span>&#123;</span><br><span class="line">     <span class="hljs-comment">// Set Catalina path</span></span><br><span class="line">     setCatalinaHome();</span><br><span class="line">     setCatalinaBase();</span><br><span class="line">     initClassLoaders();</span><br><span class="line">     Thread.currentThread().setContextClassLoader(catalinaLoader);</span><br><span class="line">     SecurityClassLoad.securityClassLoad(catalinaLoader);</span><br><span class="line">     <span class="hljs-comment">// Load our startup class and call its process() method</span></span><br><span class="line">     <span class="hljs-keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">         log.debug(<span class="hljs-string">"Loading startup class"</span>);</span><br><span class="line">     <span class="hljs-comment">// 1</span></span><br><span class="line">     Class&lt;?&gt; startupClass = catalinaLoader.loadClass</span><br><span class="line">         (<span class="hljs-string">"org.apache.catalina.startup.Catalina"</span>);</span><br><span class="line">     Object startupInstance = startupClass.newInstance();</span><br><span class="line">     <span class="hljs-comment">// Set the shared extensions class loader</span></span><br><span class="line">     <span class="hljs-keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">         log.debug(<span class="hljs-string">"Setting startup class properties"</span>);</span><br><span class="line">     String methodName = <span class="hljs-string">"setParentClassLoader"</span>;</span><br><span class="line">     Class&lt;?&gt; paramTypes[] = <span class="hljs-keyword">new</span> Class[<span class="hljs-number">1</span>];</span><br><span class="line">     paramTypes[<span class="hljs-number">0</span>] = Class.forName(<span class="hljs-string">"java.lang.ClassLoader"</span>);</span><br><span class="line">     Object paramValues[] = <span class="hljs-keyword">new</span> Object[<span class="hljs-number">1</span>];</span><br><span class="line">     paramValues[<span class="hljs-number">0</span>] = sharedLoader;</span><br><span class="line">     Method method = startupInstance.getClass().getMethod(methodName, paramTypes);</span><br><span class="line">     <span class="hljs-comment">// 2  </span></span><br><span class="line">     method.invoke(startupInstance, paramValues);</span><br><span class="line">     <span class="hljs-comment">// 3</span></span><br><span class="line">     catalinaDaemon = startupInstance;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>下面我们重点逐一来分析一下上述代码中标注数字的地方：</p>
<ul>
<li>标注1的代码：通过反射实例化<code>org.apache.catalina.startup.Catalina</code>类的实例;</li>
<li>标注2的代码：调用Catalina实例的<code>setParentClassLoader()</code>设置父亲ClassLoader，对于ClassLoader方面的内容，在本系列的后续文章再来看看。</li>
<li>标注3的代码：将Catalina实例赋值给Bootstrap实例的<code>catalinaDaemon</code>。</li>
</ul>
<h2 id="BootStrap-load"><a href="#BootStrap-load" class="headerlink" title="BootStrap#load()"></a>BootStrap#load()</h2><p>接下来我们再来看看<code>org.apache.catalina.startup.Bootstrap#load()</code><br><strong>org.apache.catalina.startup.Bootstrap#load()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Load daemon.</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">load</span><span class="hljs-params">(String[] arguments)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;</span><br><span class="line">     <span class="hljs-comment">// Call the load() method</span></span><br><span class="line">     String methodName = <span class="hljs-string">"load"</span>;</span><br><span class="line">     Object param[];</span><br><span class="line">     Class&lt;?&gt; paramTypes[];</span><br><span class="line">     <span class="hljs-keyword">if</span> (arguments==<span class="hljs-keyword">null</span> || arguments.length==<span class="hljs-number">0</span>) &#123;</span><br><span class="line">         paramTypes = <span class="hljs-keyword">null</span>;</span><br><span class="line">         param = <span class="hljs-keyword">null</span>;</span><br><span class="line">     &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">         paramTypes = <span class="hljs-keyword">new</span> Class[<span class="hljs-number">1</span>];</span><br><span class="line">         paramTypes[<span class="hljs-number">0</span>] = arguments.getClass();</span><br><span class="line">         param = <span class="hljs-keyword">new</span> Object[<span class="hljs-number">1</span>];</span><br><span class="line">         param[<span class="hljs-number">0</span>] = arguments;</span><br><span class="line">     &#125;</span><br><span class="line">     Method method = catalinaDaemon.getClass().getMethod(methodName, paramTypes);</span><br><span class="line">     <span class="hljs-keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">         log.debug(<span class="hljs-string">"Calling startup class "</span> + method);</span><br><span class="line">     method.invoke(catalinaDaemon, param);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>通过查看源代码，知道此方法通过反射调用<code>org.apache.catalina.startup.Catalina#load()</code>，那我们就来看看<code>Catalina#load()</code>，<code>Catalina#load()</code>代码如下。<br><strong>org.apache.catalina.startup.Catalina#load()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Start a new server instance.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">load</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">long</span> t1 = System.nanoTime();</span><br><span class="line">        initDirs();</span><br><span class="line">        <span class="hljs-comment">// Before digester - it may be needed</span></span><br><span class="line">        initNaming();</span><br><span class="line">        <span class="hljs-comment">// 1 </span></span><br><span class="line">        <span class="hljs-comment">// Create and execute our Digester</span></span><br><span class="line">        Digester digester = createStartDigester();</span><br><span class="line">        InputSource inputSource = <span class="hljs-keyword">null</span>;</span><br><span class="line">        InputStream inputStream = <span class="hljs-keyword">null</span>;</span><br><span class="line">        File file = <span class="hljs-keyword">null</span>;</span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            file = configFile();</span><br><span class="line">            inputStream = <span class="hljs-keyword">new</span> FileInputStream(file);</span><br><span class="line">            inputSource = <span class="hljs-keyword">new</span> InputSource(file.toURI().toURL().toString());</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(sm.getString(<span class="hljs-string">"catalina.configFail"</span>, file), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">if</span> (inputStream == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                inputStream = getClass().getClassLoader().getResourceAsStream(getConfigFile());</span><br><span class="line">                inputSource = <span class="hljs-keyword">new</span> InputSource(getClass().getClassLoader().getResource(getConfigFile()).toString());</span><br><span class="line">            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                    log.debug(sm.getString(<span class="hljs-string">"catalina.configFail"</span>,getConfigFile()), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-comment">// This should be included in catalina.jar</span></span><br><span class="line">        <span class="hljs-comment">// Alternative: don't bother with xml, just create it manually.</span></span><br><span class="line">        <span class="hljs-keyword">if</span>( inputStream==<span class="hljs-keyword">null</span> ) &#123;</span><br><span class="line">            <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                inputStream = getClass().getClassLoader().getResourceAsStream(<span class="hljs-string">"server-embed.xml"</span>);</span><br><span class="line">                inputSource = <span class="hljs-keyword">new</span> InputSource(getClass().getClassLoader().getResource(<span class="hljs-string">"server-embed.xml"</span>).toString());</span><br><span class="line">            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                    log.debug(sm.getString(<span class="hljs-string">"catalina.configFail"</span>,</span><br><span class="line">                            <span class="hljs-string">"server-embed.xml"</span>), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">if</span> (inputStream == <span class="hljs-keyword">null</span> || inputSource == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span>  (file == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">                log.warn(sm.getString(<span class="hljs-string">"catalina.configFail"</span>,</span><br><span class="line">                    getConfigFile() + <span class="hljs-string">"] or [server-embed.xml]"</span>));</span><br><span class="line">            &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                log.warn(sm.getString(<span class="hljs-string">"catalina.configFail"</span>,</span><br><span class="line">                        file.getAbsolutePath()));</span><br><span class="line">                <span class="hljs-keyword">if</span> (file.exists() &amp;&amp; !file.canRead()) &#123;</span><br><span class="line">                    log.warn(<span class="hljs-string">"Permissions incorrect, read permission is not allowed on the file."</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            inputSource.setByteStream(inputStream);</span><br><span class="line">            digester.push(<span class="hljs-keyword">this</span>);</span><br><span class="line">            digester.parse(inputSource);</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (SAXParseException spe) &#123;</span><br><span class="line">            log.warn(<span class="hljs-string">"Catalina.start using "</span> + getConfigFile() + <span class="hljs-string">": "</span> +</span><br><span class="line">                spe.getMessage());</span><br><span class="line">            <span class="hljs-keyword">return</span>;</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.warn(<span class="hljs-string">"Catalina.start using "</span> + getConfigFile() + <span class="hljs-string">": "</span> , e);</span><br><span class="line">            <span class="hljs-keyword">return</span>;</span><br><span class="line">        &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">            <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                inputStream.close();</span><br><span class="line">            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="hljs-comment">// Ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        getServer().setCatalina(<span class="hljs-keyword">this</span>);</span><br><span class="line">        <span class="hljs-comment">// Stream redirection</span></span><br><span class="line">        initStreams();</span><br><span class="line">        <span class="hljs-comment">// Start the new server</span></span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            <span class="hljs-comment">// 2</span></span><br><span class="line">            getServer().init();</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (Boolean.getBoolean(<span class="hljs-string">"org.apache.catalina.startup.EXIT_ON_INIT_FAILURE"</span>)) &#123;</span><br><span class="line">                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> java.lang.Error(e);</span><br><span class="line">            &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                log.error(<span class="hljs-string">"Catalina.start"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">long</span> t2 = System.nanoTime();</span><br><span class="line">        <span class="hljs-keyword">if</span>(log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(<span class="hljs-string">"Initialization processed in "</span> + ((t2 - t1) / <span class="hljs-number">1000000</span>) + <span class="hljs-string">" ms"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>下面重点逐一来分析一下上述代码中标注数字的地方：</p>
<ul>
<li>标注1的代码：创建<code>Digester</code>实例解析<code>conf/server.xml</code>文件。</li>
<li>标注2的代码：最终调用<code>StandardServer#init()</code>。<br>自行查看下源代码，我们会发现如下的一个调用流程：<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">org.apache.catalina.core.StandardServer#init</span><br><span class="line">-&gt;org.apache.catalina.core.StandardService#init</span><br><span class="line">--&gt;org.apache.catalina.connector.Connector#init</span><br><span class="line">--&gt;org.apache.catalina.core.StandardEngine#init</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>因为<code>StandardService</code>，<code>Connector</code>，<code>StandardEngine</code>实现<code>LifeCycle</code>接口，因此符合我们上文所获的生命周期的管理，最终都是通过他们自己实现的<code>initInternal()</code>进行初始化。<br>以为<code>StandardEngine#init()</code>会调用<code>StandardHost#init()</code>，但是当查看<code>StandardEngine#init()</code>的时候，发现并没有进行<code>StandardHost</code>的初始化，它到底做什么呢？来具体分析一下，首先拿<code>StandardEngine</code>的继承关系图来看下。<br><img src="./tomcat-2-3.jpg" alt><br>通过上图以及前面说的LifeCyecle的模板方法模式，知道<code>StandardEngine</code>的初始化钩子方法<code>initInternal()</code>最终调用<code>ContainerBase#initInternal()</code>，那我们拿<code>ContainerBase#initInternal()</code>的代码看看。<br><strong>org.apache.catalina.core.ContainerBase#initInternal()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Override</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initInternal</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">    BlockingQueue&lt;Runnable&gt; startStopQueue = <span class="hljs-keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;();</span><br><span class="line">    startStopExecutor = <span class="hljs-keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">            getStartStopThreadsInternal(),</span><br><span class="line">            getStartStopThreadsInternal(), <span class="hljs-number">10</span>, TimeUnit.SECONDS,</span><br><span class="line">            startStopQueue,</span><br><span class="line">            <span class="hljs-keyword">new</span> StartStopThreadFactory(getName() + <span class="hljs-string">"-startStop-"</span>));</span><br><span class="line">    startStopExecutor.allowCoreThreadTimeOut(<span class="hljs-keyword">true</span>);</span><br><span class="line">    <span class="hljs-keyword">super</span>.initInternal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们可以看到<code>StandardEngine</code>的初始化仅仅是创建一个<code>ThreadPoolExecutor</code>，<code>StandardEngine#init()</code>竟然没有调用<code>StandardHost#init()</code>，那么<code>StandardHost#init()</code>是什么时候被调用的呢？遇到这种不知道到底方法怎么调用的时候怎么办呢？现在需要知道<code>StandardHost#init()</code>何时被调用的，知道<code>init()</code>最终会调用钩子的<code>initInternal()</code>，因此这个时候，可以在<code>StandardHost</code>中<code>override initInternal()</code>，增加实现方法以后，有两种方法可以用，一种就是设置个断点debug一下就可以看出线程调用栈，另外一种就是在新增的方法中打印出调用栈。<br>这里采用第二种方法，增加如下的<code>initInternal()</code>到<code>StandardHost</code>中。<br><strong>org.apache.catalina.core.StandardHost#initInternal()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initInternal</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">    Throwable ex = <span class="hljs-keyword">new</span> Throwable();</span><br><span class="line">    StackTraceElement[] stackElements = ex.getStackTrace();</span><br><span class="line">    <span class="hljs-keyword">if</span> (stackElements != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = stackElements.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) &#123;</span><br><span class="line">            System.out.print(stackElements[i].getClassName() + <span class="hljs-string">"\t"</span>);</span><br><span class="line">            System.out.print(stackElements[i].getMethodName() + <span class="hljs-string">"\t"</span>);</span><br><span class="line">            System.out.print(stackElements[i].getFileName() + <span class="hljs-string">"\t"</span>);</span><br><span class="line">            System.out.println(stackElements[i].getLineNumber());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">super</span>.initInternal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面的代码将会打印出方法调用堆栈，对于调试非常有用，上面的方法运行以后在控制台打印出如下的堆栈信息。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">java.lang.Thread    run  Thread.java   680</span><br><span class="line">java.util.concurrent.ThreadPoolExecutor$Worker run  ThreadPoolExecutor.java   918</span><br><span class="line">java.util.concurrent.ThreadPoolExecutor$Worker runTask  ThreadPoolExecutor.java   895</span><br><span class="line">java.util.concurrent.FutureTask   run  FutureTask.java   138</span><br><span class="line">java.util.concurrent.FutureTask$Sync   innerRun FutureTask.java   303</span><br><span class="line">org.apache.catalina.core.ContainerBase$StartChild   call ContainerBase.java    1549</span><br><span class="line">org.apache.catalina.core.ContainerBase$StartChild   call ContainerBase.java    1559</span><br><span class="line">org.apache.catalina.util.LifecycleBase start    LifecycleBase.java    139</span><br><span class="line">org.apache.catalina.util.LifecycleBase init LifecycleBase.java    102</span><br><span class="line">org.apache.catalina.core.StandardHost  initInternal StandardHost.java 794</span><br></pre></td></tr></table></figure></p>
<p>通过控制台的信息，我们看到是<code>StartChild#call()</code>调用的，而我们查看<code>StartChild#call()</code>其实是在<code>StandardEngine#startInternal()</code>中通过异步线程池去初始化子容器。<br><strong>org.apache.catalina.core. StandardEngine#startInternal()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Start this component and implement the requirements</span></span><br><span class="line"><span class="hljs-comment">  * of &#123;<span class="hljs-doctag">@link</span> org.apache.catalina.util.LifecycleBase#startInternal()&#125;.</span></span><br><span class="line"><span class="hljs-comment">  *</span></span><br><span class="line"><span class="hljs-comment">  * <span class="hljs-doctag">@exception</span> LifecycleException if this component detects a fatal error</span></span><br><span class="line"><span class="hljs-comment">  *  that prevents this component from being used</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-meta">@Override</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startInternal</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">     <span class="hljs-comment">// Log our server identification information</span></span><br><span class="line">     <span class="hljs-keyword">if</span>(log.isInfoEnabled())</span><br><span class="line">         log.info( <span class="hljs-string">"Starting Servlet Engine: "</span> + ServerInfo.getServerInfo());</span><br><span class="line">     <span class="hljs-comment">// Standard container startup</span></span><br><span class="line">     <span class="hljs-keyword">super</span>.startInternal();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里<code>StandardEngine#startInternal()</code>调用父类的<code>startInternal()</code>。<br><strong>org.apache.catalina.core.ContainerBase#startInternal()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Start this component and implement the requirements</span></span><br><span class="line"><span class="hljs-comment">  * of &#123;<span class="hljs-doctag">@link</span> org.apache.catalina.util.LifecycleBase#startInternal()&#125;.</span></span><br><span class="line"><span class="hljs-comment">  *</span></span><br><span class="line"><span class="hljs-comment">  * <span class="hljs-doctag">@exception</span> LifecycleException if this component detects a fatal error</span></span><br><span class="line"><span class="hljs-comment">  *  that prevents this component from being used</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-meta">@Override</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startInternal</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">     <span class="hljs-comment">// Start our subordinate components, if any</span></span><br><span class="line">     <span class="hljs-keyword">if</span> ((loader != <span class="hljs-keyword">null</span>) &amp;&amp; (loader <span class="hljs-keyword">instanceof</span> Lifecycle))</span><br><span class="line">         ((Lifecycle) loader).start();</span><br><span class="line">     logger = <span class="hljs-keyword">null</span>;</span><br><span class="line">     getLogger();</span><br><span class="line">     <span class="hljs-keyword">if</span> ((manager != <span class="hljs-keyword">null</span>) &amp;&amp; (manager <span class="hljs-keyword">instanceof</span> Lifecycle))</span><br><span class="line">         ((Lifecycle) manager).start();</span><br><span class="line">     <span class="hljs-keyword">if</span> ((cluster != <span class="hljs-keyword">null</span>) &amp;&amp; (cluster <span class="hljs-keyword">instanceof</span> Lifecycle))</span><br><span class="line">         ((Lifecycle) cluster).start();</span><br><span class="line">     Realm realm = getRealmInternal();</span><br><span class="line">     <span class="hljs-keyword">if</span> ((realm != <span class="hljs-keyword">null</span>) &amp;&amp; (realm <span class="hljs-keyword">instanceof</span> Lifecycle))</span><br><span class="line">         ((Lifecycle) realm).start();</span><br><span class="line">     <span class="hljs-keyword">if</span> ((resources != <span class="hljs-keyword">null</span>) &amp;&amp; (resources <span class="hljs-keyword">instanceof</span> Lifecycle))</span><br><span class="line">         ((Lifecycle) resources).start();</span><br><span class="line">     <span class="hljs-comment">// Start our child containers, if any</span></span><br><span class="line">     Container children[] = findChildren();</span><br><span class="line">     List&lt;Future&lt;Void&gt;&gt; results = <span class="hljs-keyword">new</span> ArrayList&lt;Future&lt;Void&gt;&gt;();</span><br><span class="line">     <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">         results.add(startStopExecutor.submit(<span class="hljs-keyword">new</span> StartChild(children[i])));</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="hljs-keyword">boolean</span> fail = <span class="hljs-keyword">false</span>;</span><br><span class="line">     <span class="hljs-keyword">for</span> (Future&lt;Void&gt; result : results) &#123;</span><br><span class="line">         <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">             result.get();</span><br><span class="line">         &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;</span><br><span class="line">             log.error(sm.getString(<span class="hljs-string">"containerBase.threadedStartFailed"</span>), e);</span><br><span class="line">             fail = <span class="hljs-keyword">true</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="hljs-keyword">if</span> (fail) &#123;</span><br><span class="line">         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> LifecycleException(</span><br><span class="line">                 sm.getString(<span class="hljs-string">"containerBase.threadedStartFailed"</span>));</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="hljs-comment">// Start the Valves in our pipeline (including the basic), if any</span></span><br><span class="line">     <span class="hljs-keyword">if</span> (pipeline <span class="hljs-keyword">instanceof</span> Lifecycle)</span><br><span class="line">         ((Lifecycle) pipeline).start();</span><br><span class="line">     setState(LifecycleState.STARTING);</span><br><span class="line">     <span class="hljs-comment">// Start our thread</span></span><br><span class="line">     threadStart();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>因此到这里我们就理清楚，<code>StarndardHost#init()</code>是在调用<code>start()</code>的时候被初始化。那么接下来我们就来看看，<code>start()</code>的整体调用流程。<br><strong>BootStrap#start()</strong><br>采用分析<code>load()</code>一样的方法，经过对<code>BootStrap#start()</code>的分析，最终可以得到得到如下的调用链。<br>org.apache.catalina.startup.Bootstrap#start call stack<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">org.apache.catalina.startup.Bootstrap#start</span><br><span class="line">-&gt;org.apache.catalina.startup.Catalina#start   通过反射调用</span><br><span class="line">--&gt;org.apache.catalina.core.StandardServer#start</span><br><span class="line">---&gt;org.apache.catalina.core.StandardService#start</span><br><span class="line">----&gt;org.apache.catalina.core.StandardEngine#start</span><br><span class="line">----&gt;org.apache.catalina.Executor#start</span><br><span class="line">----&gt;org.apache.catalina.connector.Connector#start</span><br></pre></td></tr></table></figure></p>
<p>综合上文的描述总体得到如下的调用链。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.apache.catalina.startup.Bootstrap#main call stack</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">org.apache.catalina.startup.Bootstrap#main</span><br><span class="line">-&gt;org.apache.catalina.startup.Bootstrap#init</span><br><span class="line">-&gt;org.apache.catalina.startup.Bootstrap#load</span><br><span class="line">--&gt;org.apache.catalina.startup.Catalina#load</span><br><span class="line">---&gt;org.apache.catalina.core.StandardServer#init</span><br><span class="line">----&gt;org.apache.catalina.core.StandardService#init</span><br><span class="line">-----&gt;org.apache.catalina.connector.Connector#init</span><br><span class="line">-----&gt;org.apache.catalina.core.StandardEngine#init</span><br><span class="line">-&gt;org.apache.catalina.startup.Bootstrap#start</span><br><span class="line">--&gt;org.apache.catalina.startup.Catalina#start 通过反射调用</span><br><span class="line">---&gt;org.apache.catalina.core.StandardServer#start</span><br><span class="line">----&gt;org.apache.catalina.core.StandardService#start</span><br><span class="line">-----&gt;org.apache.catalina.core.StandardEngine#start</span><br><span class="line">-----&gt;org.apache.catalina.Executor#start</span><br><span class="line">-----&gt;org.apache.catalina.connector.Connector#start</span><br></pre></td></tr></table></figure>
<h1 id="3-Tomcat启动过程关键步骤分析"><a href="#3-Tomcat启动过程关键步骤分析" class="headerlink" title="3 Tomcat启动过程关键步骤分析"></a>3 Tomcat启动过程关键步骤分析</h1><h2 id="Connector-init"><a href="#Connector-init" class="headerlink" title="Connector#init()"></a>Connector#init()</h2><p>首先来看一下<code>org.apache.catalina.connector.Connector#init()</code>，知道<code>Connector</code>的生命周期也是通过<code>LifeCycle</code>的模板方法模式来管理的，那么只需要查看一下它的<code>initInternal()</code>即可知道它是如何初始化的。<br>接下来就来看一下<code>initInternal()</code>，代码如下。<br><strong>org.apache.catalina.connector.Connector#initInternal()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Override</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initInternal</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">super</span>.initInternal();</span><br><span class="line">    <span class="hljs-comment">// Initialize adapter</span></span><br><span class="line">    adapter = <span class="hljs-keyword">new</span> CoyoteAdapter(<span class="hljs-keyword">this</span>);</span><br><span class="line">    protocolHandler.setAdapter(adapter);</span><br><span class="line">    <span class="hljs-comment">// Make sure parseBodyMethodsSet has a default</span></span><br><span class="line">    <span class="hljs-keyword">if</span>( <span class="hljs-keyword">null</span> == parseBodyMethodsSet ) &#123;</span><br><span class="line">        setParseBodyMethods(getParseBodyMethods());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">if</span> (protocolHandler.isAprRequired() &amp;&amp;</span><br><span class="line">            !AprLifecycleListener.isAprAvailable()) &#123;</span><br><span class="line">        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> LifecycleException(</span><br><span class="line">            sm.getString(<span class="hljs-string">"coyoteConnector.protocolHandlerNoApr"</span>,</span><br><span class="line">                        getProtocolHandlerClassName()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">        <span class="hljs-comment">// 1 </span></span><br><span class="line">        protocolHandler.init();</span><br><span class="line">    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> LifecycleException</span><br><span class="line">            (sm.getString(<span class="hljs-string">"coyoteConnector.protocolHandlerInitializationFailed"</span>), e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">// Initialize mapper listener</span></span><br><span class="line">    mapperListener.init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面代码中，本文最关心的是标注1的地方，这个地方调用<code>org.apache.coyote.ProtocolHandler#init()</code>，而<code>ProtocolHandler</code>是在<code>Connector</code>的构造函数中初始化，而<code>Connector</code>的构造函数又是<code>Digester</code>类解析<code>conf/server.xml</code>的时候调用的，在来具体看看<code>Connector</code>构造函数中调用的一个核心的方法<code>setProtocol()</code>，下面是其代码。<br><strong>org.apache.catalina.connector.Connector#Connector()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Connector</span><span class="hljs-params">(String protocol)</span> </span>&#123;</span><br><span class="line">       setProtocol(protocol);</span><br><span class="line">       <span class="hljs-comment">// Instantiate protocol handler</span></span><br><span class="line">       <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">           Class&lt;?&gt; clazz = Class.forName(protocolHandlerClassName);</span><br><span class="line">           <span class="hljs-keyword">this</span>.protocolHandler = (ProtocolHandler) clazz.newInstance();</span><br><span class="line">       &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           log.error(sm.getString(</span><br><span class="line">                   <span class="hljs-string">"coyoteConnector.protocolHandlerInstantiationFailed"</span>), e);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>org.apache.catalina.connector.Connector#setProtocol()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Set the Coyote protocol which will be used by the connector.</span></span><br><span class="line"><span class="hljs-comment">  *</span></span><br><span class="line"><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> protocol The Coyote protocol name</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setProtocol</span><span class="hljs-params">(String protocol)</span> </span>&#123;</span><br><span class="line">     <span class="hljs-keyword">if</span> (AprLifecycleListener.isAprAvailable()) &#123;</span><br><span class="line">         <span class="hljs-keyword">if</span> (<span class="hljs-string">"HTTP/1.1"</span>.equals(protocol)) &#123;</span><br><span class="line">             setProtocolHandlerClassName(<span class="hljs-string">"org.apache.coyote.http11.Http11AprProtocol"</span>);</span><br><span class="line">         &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"AJP/1.3"</span>.equals(protocol)) &#123;</span><br><span class="line">             setProtocolHandlerClassName(<span class="hljs-string">"org.apache.coyote.ajp.AjpAprProtocol"</span>);</span><br><span class="line">         &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (protocol != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">             setProtocolHandlerClassName(protocol);</span><br><span class="line">         &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">             setProtocolHandlerClassName(<span class="hljs-string">"org.apache.coyote.http11.Http11AprProtocol"</span>);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">         <span class="hljs-comment">// 1 </span></span><br><span class="line">         <span class="hljs-keyword">if</span> (<span class="hljs-string">"HTTP/1.1"</span>.equals(protocol)) &#123;</span><br><span class="line">             setProtocolHandlerClassName(<span class="hljs-string">"org.apache.coyote.http11.Http11Protocol"</span>);</span><br><span class="line">         &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"AJP/1.3"</span>.equals(protocol)) &#123;</span><br><span class="line">             setProtocolHandlerClassName(<span class="hljs-string">"org.apache.coyote.ajp.AjpProtocol"</span>);</span><br><span class="line">         &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (protocol != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">             setProtocolHandlerClassName(protocol);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>AJP方式：通过AJP协议进行通讯，AJP主要用于Apache的HTTP服务器和Servlet Web容器之间通讯，它是Packet_Oriented的，换句话说，它发送给浏览器（其他Web Server）的数据是Packet(s)，得到Servlet容器的响应也是Packet(s)，这里有特殊情况，如果Servlet 容器发送的数据是二进制的，则直接发送给浏览器。此外，AJP还可以重用和Servlet容器之间的Socket连接（Socket Connection），降低创建开销。<br>从setProtocol的代码中，可以看出主要逻辑分为两块，一种情况是使用APR(Apache Portable Runtime)，另外一种是不使用APR的情况。缺省情况下不采用APR库，这样的话，代码会走到标注1的代码分支，这里通过协议的不同，最终初始化不同的类。如果是http1.1协议就采用<code>org.apache.coyote.http11.Http11Protocol</code>，如果是AJP(Apache Jserv Protocol)协议，就采用<code>org.apache.coyote.ajp.AjpProtocol</code>类，下面来看一下Http11Protocol和AjpProtocol的继承关系图如下。<br><img src="./tomcat-2-4.jpg" alt><br><img src="./tomcat-2-5.jpg" alt><br>通过上图可以看到它们都继承公共的基类<code>org.apache.coyote.AbstractProtocol</code>，而它们自己的<code>init()</code>最终其实都是调用<code>AbstractProtocol#init()</code>，通过查看<code>AbstractProtocol#init()</code>代码，我们可以看到最终是调用<code>org.apache.tomcat.util.net.AbstractEndpoint#init()</code>。<br><strong>org.apache.coyote.AbstractProtocol#init()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">NOTE:</span> There is no maintenance of state or checking for valid transitions</span></span><br><span class="line"><span class="hljs-comment"> * within this class. It is expected that the connector will maintain state</span></span><br><span class="line"><span class="hljs-comment"> * and prevent invalid state transitions.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-meta">@Override</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (getLog().isInfoEnabled())</span><br><span class="line">        getLog().info(sm.getString(<span class="hljs-string">"abstractProtocolHandler.init"</span>,</span><br><span class="line">                getName()));</span><br><span class="line">    <span class="hljs-keyword">if</span> (oname == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">        <span class="hljs-comment">// Component not pre-registered so register it</span></span><br><span class="line">        oname = createObjectName();</span><br><span class="line">        <span class="hljs-keyword">if</span> (oname != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            Registry.getRegistry(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>).registerComponent(<span class="hljs-keyword">this</span>, oname,</span><br><span class="line">                <span class="hljs-keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.domain != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            tpOname = <span class="hljs-keyword">new</span> ObjectName(domain + <span class="hljs-string">":"</span> +</span><br><span class="line">                    <span class="hljs-string">"type=ThreadPool,name="</span> + getName());</span><br><span class="line">            Registry.getRegistry(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>).registerComponent(endpoint,</span><br><span class="line">                    tpOname, <span class="hljs-keyword">null</span>);</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            getLog().error(sm.getString(</span><br><span class="line">                    <span class="hljs-string">"abstractProtocolHandler.mbeanRegistrationFailed"</span>,</span><br><span class="line">                    tpOname, getName()), e);</span><br><span class="line">        &#125;</span><br><span class="line">        rgOname=<span class="hljs-keyword">new</span> ObjectName(domain +<span class="hljs-string">":type=GlobalRequestProcessor,name="</span> + getName());</span><br><span class="line">        Registry.getRegistry(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>).registerComponent(</span><br><span class="line">                getHandler().getGlobal(), rgOname, <span class="hljs-keyword">null</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    String endpointName = getName();</span><br><span class="line">    endpoint.setName(endpointName.substring(<span class="hljs-number">1</span>, endpointName.length()-<span class="hljs-number">1</span>));</span><br><span class="line">    <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">        endpoint.init();</span><br><span class="line">    &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        getLog().error(sm.getString(<span class="hljs-string">"abstractProtocolHandler.initError"</span>,</span><br><span class="line">                getName()), ex);</span><br><span class="line">        <span class="hljs-keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>org.apache.tomcat.util.net.AbstractEndpoint#init<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (bindOnInit) &#123;</span><br><span class="line">            bind();</span><br><span class="line">            bindState = BindState.BOUND_ON_INIT;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>而<code>AbstractEndpoint</code>的实例化操作是在实例化<code>AjpProtocol</code>和<code>Http11Protocol</code>的时候在其构造函数中实例化的，而<code>AjpProtocol</code>和<code>Http11Protocol</code>构造函数中，其实都是初始化<code>org.apache.tomcat.util.net.JIoEndpoint</code>类，只不过根据是http协议还是AJP协议，它们具有不同的连接处理类。<br><strong>org.apache.coyote.ajp.AjpProtocol()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AjpProtocol</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        endpoint = <span class="hljs-keyword">new</span> JIoEndpoint();</span><br><span class="line">        cHandler = <span class="hljs-keyword">new</span> AjpConnectionHandler(<span class="hljs-keyword">this</span>);</span><br><span class="line">        ((JIoEndpoint) endpoint).setHandler(cHandler);</span><br><span class="line">        setSoLinger(Constants.DEFAULT_CONNECTION_LINGER);</span><br><span class="line">        setSoTimeout(Constants.DEFAULT_CONNECTION_TIMEOUT);</span><br><span class="line">        setTcpNoDelay(Constants.DEFAULT_TCP_NO_DELAY);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>org.apache.coyote.http11.Http11Protocol<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Http11Protocol</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        endpoint = <span class="hljs-keyword">new</span> JIoEndpoint();</span><br><span class="line">        cHandler = <span class="hljs-keyword">new</span> Http11ConnectionHandler(<span class="hljs-keyword">this</span>);</span><br><span class="line">        ((JIoEndpoint) endpoint).setHandler(cHandler);</span><br><span class="line">        setSoLinger(Constants.DEFAULT_CONNECTION_LINGER);</span><br><span class="line">        setSoTimeout(Constants.DEFAULT_CONNECTION_TIMEOUT);</span><br><span class="line">        setTcpNoDelay(Constants.DEFAULT_TCP_NO_DELAY);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>其中Http11Protocol的连接处理类为<code>org.apache.coyote.http11.Http11Protocol.Http11ConnectionHandler</code>，而连接处理类为<code>org.apache.coyote.ajp.AjpProtocol.AjpConnectionHandler</code>，因此到这里我们基本清楚<code>Connector</code>的初始化流程，总结如下。<br>Connect init采用APR的情况<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//1 HTTP/1.1协议连接器</span><br><span class="line">org.apache.catalina.connector.Connector#init</span><br><span class="line">-&gt;org.apache.coyote.http11.Http11AprProtocol#init</span><br><span class="line">--&gt;org.apache.tomcat.util.net.AprEndpoint#init</span><br><span class="line">(org.apache.coyote.http11.Http11AprProtocol.Http11ConnectionHandler)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 2 AJP/1.3协议连接器</span><br><span class="line">org.apache.catalina.connector.Connector#init</span><br><span class="line">-&gt;org.apache.coyote.ajp.AjpAprProtocol#init</span><br><span class="line">--&gt;org.apache.tomcat.util.net.AprEndpoint#init</span><br><span class="line">(org.apache.coyote.ajp.AjpAprProtocol.AjpConnectionHandler)</span><br></pre></td></tr></table></figure></p>
<p>Connector init 不采用APR的情况<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// 1 HTTP/1.1协议连接器</span><br><span class="line">org.apache.catalina.connector.Connector#init</span><br><span class="line">-&gt;org.apache.coyote.http11.Http11Protocol#init</span><br><span class="line">--&gt;org.apache.tomcat.util.net.JIoEndpoint#init</span><br><span class="line">(org.apache.coyote.http11.Http11Protocol.Http11ConnectionHandler)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 2 AJP/1.3协议连接器</span><br><span class="line">org.apache.catalina.connector.Connector#init</span><br><span class="line">-&gt;org.apache.coyote.ajp.AjpProtocol#init</span><br><span class="line">--&gt;org.apache.tomcat.util.net.JIoEndpoint#init</span><br><span class="line">(org.apache.coyote.ajp.AjpProtocol.AjpConnectionHandler)</span><br></pre></td></tr></table></figure></p>
<p>这里需要注意，除<code>JIoEndpoint</code>外，还有<code>NIoEndpoint</code>，对于Tomcat7.0.24的代码，并没有采用<code>NIOEndPoint</code>，<code>NIOEndpoint</code>采用NIO的方式进行Socket的处理。<br>最后，再来看看<code>org.apache.tomcat.util.net.JIoEndpoint#init()</code>的初始化过程，首先来看一下<code>JIoEndpoint</code>的继承关系图如下。<br><img src="./tomcat-2-6.jpg" alt><br>通过上图知道<code>JIoEndpoint</code>继承<code>AbstractEndpoint</code>，而通过查看源码可知，<code>JIoEndpoint</code>没有实现自己的<code>init()</code>，它默认采用父类的<code>init()</code>，那么我们就来看看<code>AbstractEndpoint#init()</code>，它的代码如下。<br><strong>org.apache.tomcat.util.net.AbstractEndpoint#init()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (bindOnInit) &#123;</span><br><span class="line">            bind();</span><br><span class="line">            bindState = BindState.BOUND_ON_INIT;</span><br><span class="line">        &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>通过查看上面的代码可知，因为<code>bindOnInit</code>默认是true，所以<code>init()</code>调用<code>bind()</code>，而<code>bind()</code>是抽象方法，最终由<code>JIoEndpoint</code>来实现，代码如下。<br><strong>org.apache.tomcat.util.net.JIoEndpoint#bind()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Override</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">bind</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="hljs-comment">// Initialize thread count defaults for acceptor</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (acceptorThreadCount == <span class="hljs-number">0</span>) &#123;</span><br><span class="line">        acceptorThreadCount = <span class="hljs-number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">// Initialize maxConnections</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (getMaxConnections() == <span class="hljs-number">0</span>) &#123;</span><br><span class="line">        <span class="hljs-comment">// User hasn't set a value - use the default</span></span><br><span class="line">        setMaxConnections(getMaxThreadsExecutor(<span class="hljs-keyword">true</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">if</span> (serverSocketFactory == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (isSSLEnabled()) &#123;</span><br><span class="line">            serverSocketFactory =</span><br><span class="line">                handler.getSslImplementation().getServerSocketFactory(<span class="hljs-keyword">this</span>);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            serverSocketFactory = <span class="hljs-keyword">new</span> DefaultServerSocketFactory(<span class="hljs-keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">if</span> (serverSocket == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (getAddress() == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">                serverSocket = serverSocketFactory.createSocket(getPort(),</span><br><span class="line">                        getBacklog());</span><br><span class="line">            &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                serverSocket = serverSocketFactory.createSocket(getPort(),</span><br><span class="line">                        getBacklog(), getAddress());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (BindException orig) &#123;</span><br><span class="line">            String msg;</span><br><span class="line">            <span class="hljs-keyword">if</span> (getAddress() == <span class="hljs-keyword">null</span>)</span><br><span class="line">                msg = orig.getMessage() + <span class="hljs-string">" &lt;null&gt;:"</span> + getPort();</span><br><span class="line">            <span class="hljs-keyword">else</span></span><br><span class="line">                msg = orig.getMessage() + <span class="hljs-string">" "</span> +</span><br><span class="line">                        getAddress().toString() + <span class="hljs-string">":"</span> + getPort();</span><br><span class="line">            BindException be = <span class="hljs-keyword">new</span> BindException(msg);</span><br><span class="line">            be.initCause(orig);</span><br><span class="line">            <span class="hljs-keyword">throw</span> be;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过上面代码可以看出，最终是调用<code>org.apache.tomcat.util.net.ServerSocketFactory#createSocket()</code>创建一个<code>java.net.ServerSocket</code>，并绑定在<code>conf/server.xml</code>中Connector中配置的端口。<br>结论：<code>Connector#init()</code>的时候，无论是AJP还是HTTP最终其实是调用JioEndpoint的初始化，默认情况在初始化的时候就会创建<code>java.net.ServerSocket</code>绑到到配置的端口上。</p>
<h2 id="Connector-start"><a href="#Connector-start" class="headerlink" title="Connector#start()"></a>Connector#start()</h2><p>接着再来分析一下<code>Connector#start</code>，因为Connector符合<code>LifeCycle</code>模板方法生命周期管理的机制，因此它的start最终会调用<code>startInternal()</code>，<code>org.apache.catalina.connector.Connector#startInternal()</code>代码如下。<br><strong>org.apache.catalina.connector. Connector#startInternal()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Begin processing requests via this Connector.</span></span><br><span class="line"><span class="hljs-comment">  *</span></span><br><span class="line"><span class="hljs-comment">  * <span class="hljs-doctag">@exception</span> LifecycleException if a fatal startup error occurs</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-meta">@Override</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startInternal</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">     <span class="hljs-comment">// Validate settings before starting</span></span><br><span class="line">     <span class="hljs-keyword">if</span> (getPort() &lt; <span class="hljs-number">0</span>) &#123;</span><br><span class="line">         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> LifecycleException(sm.getString(</span><br><span class="line">                 <span class="hljs-string">"coyoteConnector.invalidPort"</span>, Integer.valueOf(getPort())));</span><br><span class="line">     &#125;</span><br><span class="line">     setState(LifecycleState.STARTING);</span><br><span class="line">     <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">         protocolHandler.start();</span><br><span class="line">     &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;</span><br><span class="line">         String errPrefix = <span class="hljs-string">""</span>;</span><br><span class="line">         <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.service != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">             errPrefix += <span class="hljs-string">"service.getName(): \""</span> + <span class="hljs-keyword">this</span>.service.getName() + <span class="hljs-string">"\"; "</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> LifecycleException</span><br><span class="line">             (errPrefix + <span class="hljs-string">" "</span> + sm.getString</span><br><span class="line">              (<span class="hljs-string">"coyoteConnector.protocolHandlerStartFailed"</span>), e);</span><br><span class="line">     &#125;</span><br><span class="line">     mapperListener.start();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>通过上面的代码，可以清晰的看到最终调用<code>protocolHandler#start()</code>，而根据<code>Connector#init()</code>流程的分析，这里会分是否采用APR，默认是不采用APR的，这里会根据不同的协议（AJP，HTTP）来调用对应的<code>org.apache.coyote.ProtocolHandler#start()</code>。 其中AJP会采用<code>org.apache.coyote.ajp.AjpProtocol</code>，HTTP协议采用<code>org.apache.coyote.http11.Http11Protocol</code>，而无论是<code>AjpProtocol</code>还是Http11Protocol都会调用<code>JIoEndpoint</code>的方法，那么接下来我们就来看看<code>JioEndpoint#start()</code>，<code>JioEndpoint</code>没有实现<code>start()</code>，调用它父类的方法。它的代码如下。<br><strong>org.apache.tomcat.util.net.AbstractEndpoint#start()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">start</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (bindState == BindState.UNBOUND) &#123;</span><br><span class="line">            bind();</span><br><span class="line">            bindState = BindState.BOUND_ON_START;</span><br><span class="line">        &#125;</span><br><span class="line">        startInternal();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p><code>startInternal()</code>在<code>JioEndpoint</code>中实现。<br><strong>org.apache.tomcat.util.net.JioEndpoint#startInternal()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Override</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startInternal</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (!running) &#123;</span><br><span class="line">        running = <span class="hljs-keyword">true</span>;</span><br><span class="line">        paused = <span class="hljs-keyword">false</span>;</span><br><span class="line">        <span class="hljs-comment">// Create worker collection</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (getExecutor() == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            createExecutor();</span><br><span class="line">        &#125;</span><br><span class="line">        initializeConnectionLatch();</span><br><span class="line">        startAcceptorThreads();</span><br><span class="line">        <span class="hljs-comment">// Start async timeout thread</span></span><br><span class="line">        Thread timeoutThread = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> AsyncTimeout(),</span><br><span class="line">                getName() + <span class="hljs-string">"-AsyncTimeout"</span>);</span><br><span class="line">        timeoutThread.setPriority(threadPriority);</span><br><span class="line">        timeoutThread.setDaemon(<span class="hljs-keyword">true</span>);</span><br><span class="line">        timeoutThread.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从上面的代码可以看出，启动<code>Acceptor</code>线程和<code>AsyncTimeout</code>线程，首先来看看<code>Acceptor</code>线程，我们再来看看<code>startAcceptorThreads()</code>，代码如下。<br><strong>org.apache.tomcat.util.net.AbstractEndpoint#startAcceptorThreads()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startAcceptorThreads</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">int</span> count = getAcceptorThreadCount();</span><br><span class="line">        acceptors = <span class="hljs-keyword">new</span> Acceptor[count];</span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            acceptors[i] = createAcceptor();</span><br><span class="line">            String threadName = getName() + <span class="hljs-string">"-Acceptor-"</span> + i;</span><br><span class="line">            acceptors[i].setThreadName(threadName);</span><br><span class="line">            Thread t = <span class="hljs-keyword">new</span> Thread(acceptors[i], threadName);</span><br><span class="line">            t.setPriority(getAcceptorThreadPriority());</span><br><span class="line">            t.setDaemon(getDaemon());</span><br><span class="line">            t.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>通过上面的代码，可以看出其实是通过<code>org.apache.tomcat.util.net.AbstractEndpoint.Acceptor</code>这个Runable接口的实现类来启动线程，接下来就来看看<code>Acceptor#run()</code>，通过查看<code>run()</code>，它里面其实就是调用<code>java.net.ServerSocket#accept()</code>来接受一个Socket连接。<br><strong>org.apache.tomcat.util.net.JioEndpoint#Acceptor()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">protected</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Acceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractEndpoint</span>.<span class="hljs-title">Acceptor</span> </span>&#123;</span><br><span class="line">        <span class="hljs-meta">@Override</span></span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">int</span> errorDelay = <span class="hljs-number">0</span>;</span><br><span class="line">            <span class="hljs-comment">// Loop until we receive a shutdown command</span></span><br><span class="line">            <span class="hljs-keyword">while</span> (running) &#123;</span><br><span class="line">                <span class="hljs-comment">// Loop if endpoint is paused</span></span><br><span class="line">                <span class="hljs-keyword">while</span> (paused &amp;&amp; running) &#123;</span><br><span class="line">                    state = AcceptorState.PAUSED;</span><br><span class="line">                    <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="hljs-number">50</span>);</span><br><span class="line">                    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="hljs-comment">// Ignore</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="hljs-keyword">if</span> (!running) &#123;</span><br><span class="line">                    <span class="hljs-keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                state = AcceptorState.RUNNING;</span><br><span class="line">                <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                    <span class="hljs-comment">//if we have reached max connections, wait</span></span><br><span class="line">                    countUpOrAwaitConnection();</span><br><span class="line">                    Socket socket = <span class="hljs-keyword">null</span>;</span><br><span class="line">                    <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                        <span class="hljs-comment">// Accept the next incoming connection from the server</span></span><br><span class="line">                        <span class="hljs-comment">// socket</span></span><br><span class="line">                        socket = serverSocketFactory.acceptSocket(serverSocket);</span><br><span class="line">                    &#125; <span class="hljs-keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">                        countDownConnection();</span><br><span class="line">                        <span class="hljs-comment">// Introduce delay if necessary</span></span><br><span class="line">                        errorDelay = handleExceptionWithDelay(errorDelay);</span><br><span class="line">                        <span class="hljs-comment">// re-throw</span></span><br><span class="line">                        <span class="hljs-keyword">throw</span> ioe;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="hljs-comment">// Successful accept, reset the error delay</span></span><br><span class="line">                    errorDelay = <span class="hljs-number">0</span>;</span><br><span class="line">                    <span class="hljs-comment">// Configure the socket</span></span><br><span class="line">                    <span class="hljs-keyword">if</span> (running &amp;&amp; !paused &amp;&amp; setSocketOptions(socket)) &#123;</span><br><span class="line">                        <span class="hljs-comment">// Hand this socket off to an appropriate processor</span></span><br><span class="line">                        <span class="hljs-keyword">if</span> (!processSocket(socket)) &#123;</span><br><span class="line">                            countDownConnection();</span><br><span class="line">                            <span class="hljs-comment">// Close socket right away</span></span><br><span class="line">                            closeSocket(socket);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                        countDownConnection();</span><br><span class="line">                        <span class="hljs-comment">// Close socket right away</span></span><br><span class="line">                        closeSocket(socket);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="hljs-keyword">catch</span> (IOException x) &#123;</span><br><span class="line">                    <span class="hljs-keyword">if</span> (running) &#123;</span><br><span class="line">                        log.error(sm.getString(<span class="hljs-string">"endpoint.accept.fail"</span>), x);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="hljs-keyword">catch</span> (NullPointerException npe) &#123;</span><br><span class="line">                    <span class="hljs-keyword">if</span> (running) &#123;</span><br><span class="line">                        log.error(sm.getString(<span class="hljs-string">"endpoint.accept.fail"</span>), npe);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    ExceptionUtils.handleThrowable(t);</span><br><span class="line">                    log.error(sm.getString(<span class="hljs-string">"endpoint.accept.fail"</span>), t);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            state = AcceptorState.ENDED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>启动完<code>Acceptor</code>线程以后，接着就会启动<code>AsyncTimeout</code>线程，而这里面需要注意的时候，无论是<code>Acceptor</code>还是<code>AsyncTimeout</code>线程，它们都是Daemon线程，而设置为Daemon的原因，会在下篇Tomcat的关闭中进行说明。</p>
<h2 id="StandardEngine-start"><a href="#StandardEngine-start" class="headerlink" title="StandardEngine#start()"></a>StandardEngine#start()</h2><p>从本文上面的分析中，得知<code>StandardEngine</code>继承<code>ContainerBase</code>，而<code>StandardEngine#startInternal()</code>钩子方法也仅仅是调用父类<code>ContainerBase#startInternal()</code>，那接下来分析一下<code>ContainerBase#startInternal()</code>，代码如下。<br><strong>org.apache.catalina.core.ContainerBase#startInternal()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Start this component and implement the requirements</span></span><br><span class="line"><span class="hljs-comment">  * of &#123;<span class="hljs-doctag">@link</span> org.apache.catalina.util.LifecycleBase#startInternal()&#125;.</span></span><br><span class="line"><span class="hljs-comment">  *</span></span><br><span class="line"><span class="hljs-comment">  * <span class="hljs-doctag">@exception</span> LifecycleException if this component detects a fatal error</span></span><br><span class="line"><span class="hljs-comment">  *  that prevents this component from being used</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-meta">@Override</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startInternal</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">     <span class="hljs-comment">// Start our subordinate components, if any</span></span><br><span class="line">     <span class="hljs-keyword">if</span> ((loader != <span class="hljs-keyword">null</span>) &amp;&amp; (loader <span class="hljs-keyword">instanceof</span> Lifecycle))</span><br><span class="line">         ((Lifecycle) loader).start();</span><br><span class="line">     logger = <span class="hljs-keyword">null</span>;</span><br><span class="line">     getLogger();</span><br><span class="line">     <span class="hljs-keyword">if</span> ((manager != <span class="hljs-keyword">null</span>) &amp;&amp; (manager <span class="hljs-keyword">instanceof</span> Lifecycle))</span><br><span class="line">         ((Lifecycle) manager).start();</span><br><span class="line">     <span class="hljs-keyword">if</span> ((cluster != <span class="hljs-keyword">null</span>) &amp;&amp; (cluster <span class="hljs-keyword">instanceof</span> Lifecycle))</span><br><span class="line">         ((Lifecycle) cluster).start();</span><br><span class="line">     Realm realm = getRealmInternal();</span><br><span class="line">     <span class="hljs-keyword">if</span> ((realm != <span class="hljs-keyword">null</span>) &amp;&amp; (realm <span class="hljs-keyword">instanceof</span> Lifecycle))</span><br><span class="line">         ((Lifecycle) realm).start();</span><br><span class="line">     <span class="hljs-keyword">if</span> ((resources != <span class="hljs-keyword">null</span>) &amp;&amp; (resources <span class="hljs-keyword">instanceof</span> Lifecycle))</span><br><span class="line">         ((Lifecycle) resources).start();</span><br><span class="line">     <span class="hljs-comment">// Start our child containers, if any</span></span><br><span class="line">     Container children[] = findChildren();</span><br><span class="line">     List&lt;Future&lt;Void&gt;&gt; results = <span class="hljs-keyword">new</span> ArrayList&lt;Future&lt;Void&gt;&gt;();</span><br><span class="line">     <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">         results.add(startStopExecutor.submit(<span class="hljs-keyword">new</span> StartChild(children[i])));</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="hljs-keyword">boolean</span> fail = <span class="hljs-keyword">false</span>;</span><br><span class="line">     <span class="hljs-keyword">for</span> (Future&lt;Void&gt; result : results) &#123;</span><br><span class="line">         <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">             result.get();</span><br><span class="line">         &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;</span><br><span class="line">             log.error(sm.getString(<span class="hljs-string">"containerBase.threadedStartFailed"</span>), e);</span><br><span class="line">             fail = <span class="hljs-keyword">true</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="hljs-keyword">if</span> (fail) &#123;</span><br><span class="line">         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> LifecycleException(</span><br><span class="line">                 sm.getString(<span class="hljs-string">"containerBase.threadedStartFailed"</span>));</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="hljs-comment">// Start the Valves in our pipeline (including the basic), if any</span></span><br><span class="line">     <span class="hljs-keyword">if</span> (pipeline <span class="hljs-keyword">instanceof</span> Lifecycle)</span><br><span class="line">         ((Lifecycle) pipeline).start();</span><br><span class="line">     setState(LifecycleState.STARTING);</span><br><span class="line">     <span class="hljs-comment">// Start our thread</span></span><br><span class="line">     threadStart();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到通过<code>startStopExecutor</code>异步的对子容器进行启动，然后设置状态为<code>LifecycleState.STARTING</code>的状态。而<code>startStopExecutor</code>是在容器的<code>initInternal()</code>中进行初始化好的。<br><strong>org.apache.catalina.core.ContainerBase#initInternal()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initInternal</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">        BlockingQueue&lt;Runnable&gt; startStopQueue =</span><br><span class="line">            <span class="hljs-keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;();</span><br><span class="line">        startStopExecutor = <span class="hljs-keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">                getStartStopThreadsInternal(),</span><br><span class="line">                getStartStopThreadsInternal(), <span class="hljs-number">10</span>, TimeUnit.SECONDS,</span><br><span class="line">                startStopQueue,</span><br><span class="line">                <span class="hljs-keyword">new</span> StartStopThreadFactory(getName() + <span class="hljs-string">"-startStop-"</span>));</span><br><span class="line">        startStopExecutor.allowCoreThreadTimeOut(<span class="hljs-keyword">true</span>);</span><br><span class="line">        <span class="hljs-keyword">super</span>.initInternal();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来我们就来看看StartChild，StardChild的代码如下。<br><strong>org.apache.catalina.core.ContainerBase.StartChild</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StartChild</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Callable</span>&lt;<span class="hljs-title">Void</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="hljs-keyword">private</span> Container child;</span><br><span class="line">      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">StartChild</span><span class="hljs-params">(Container child)</span> </span>&#123;</span><br><span class="line">          <span class="hljs-keyword">this</span>.child = child;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="hljs-meta">@Override</span></span><br><span class="line">      <span class="hljs-function"><span class="hljs-keyword">public</span> Void <span class="hljs-title">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">          child.start();</span><br><span class="line">          <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>通过上面的代码，可以看到<code>StartChild</code>实现Callable接口，实现这个接口的类可以将其放到对应的executor中执行，<code>StartChild</code>在运行的时候就会调用到子容器的<code>start()</code>，而此时的父容器是<code>StandardEngine</code>，子容器就是<code>StandardHost</code>，接下来就来看看<code>StandardHost</code>的启动过程。<br>通过前面对于<code>init()</code>流程的分析，知道<code>StandardHost</code>不是在<code>StandardEngine#init</code>的时候初始化，因此在执行<code>StandardHost#start()</code>的时候，要首先进行<code>init()</code>的调用，<code>init()</code>调用在<code>LifecycleBase#start()</code>里。具体的代码如下。<br><strong>org.apache.catalina.util.LifecycleBase#start()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-meta">@Override</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">start</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="hljs-keyword">if</span> (LifecycleState.STARTING_PREP.equals(state) ||</span><br><span class="line">             LifecycleState.STARTING.equals(state) ||</span><br><span class="line">             LifecycleState.STARTED.equals(state)) &#123;</span><br><span class="line">         <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">             Exception e = <span class="hljs-keyword">new</span> LifecycleException();</span><br><span class="line">             log.debug(sm.getString(<span class="hljs-string">"lifecycleBase.alreadyStarted"</span>,</span><br><span class="line">                     toString()), e);</span><br><span class="line">         &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">             log.info(sm.getString(<span class="hljs-string">"lifecycleBase.alreadyStarted"</span>,</span><br><span class="line">                     toString()));</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="hljs-keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="hljs-comment">//因为此时的StandardHost还没有初始化，因此会走到这一步代码</span></span><br><span class="line">     <span class="hljs-keyword">if</span> (state.equals(LifecycleState.NEW)) &#123;</span><br><span class="line">         init();</span><br><span class="line">     &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state.equals(LifecycleState.FAILED))&#123;</span><br><span class="line">         stop();</span><br><span class="line">     &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!state.equals(LifecycleState.INITIALIZED) &amp;&amp;</span><br><span class="line">             !state.equals(LifecycleState.STOPPED)) &#123;</span><br><span class="line">         invalidTransition(Lifecycle.BEFORE_START_EVENT);</span><br><span class="line">     &#125;</span><br><span class="line">     setStateInternal(LifecycleState.STARTING_PREP, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>);</span><br><span class="line">     <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">         startInternal();</span><br><span class="line">     &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">         ExceptionUtils.handleThrowable(t);</span><br><span class="line">         setStateInternal(LifecycleState.FAILED, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>);</span><br><span class="line">         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> LifecycleException(</span><br><span class="line">                 sm.getString(<span class="hljs-string">"lifecycleBase.startFail"</span>,toString()), t);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="hljs-keyword">if</span> (state.equals(LifecycleState.FAILED) ||</span><br><span class="line">             state.equals(LifecycleState.MUST_STOP)) &#123;</span><br><span class="line">         stop();</span><br><span class="line">     &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">         <span class="hljs-comment">// Shouldn't be necessary but acts as a check that sub-classes are</span></span><br><span class="line">         <span class="hljs-comment">// doing what they are supposed to.</span></span><br><span class="line">         <span class="hljs-keyword">if</span> (!state.equals(LifecycleState.STARTING)) &#123;</span><br><span class="line">             invalidTransition(Lifecycle.AFTER_START_EVENT);</span><br><span class="line">         &#125;</span><br><span class="line">         setStateInternal(LifecycleState.STARTED, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>对于<code>StandardHost</code>的初始化，是在<code>start()</code>的时候进行的。那接下来看一下<code>StandardHost#init()</code>，通过查看代码，<code>StandardHost</code>本身没有实现<code>initInternal()</code>的钩子方法，也就意味着最终初始化会调用<code>ContainerBase#initInternal()</code>，而通过上文的描述，已经清楚<code>ContainerBase#initInternal()</code>主要是初始化一个<code>startStopExecutor</code>，这个线程池主要是为异步的初始化子容器来用的。<br>知道<code>StandardEngine</code>初始化的时候，也是初始化一个线程池，而<code>StandardHost</code>也初始化一个线程池，它们的不同点在与创建线程的工厂方法不同，在采用缺省配置的情况下，<code>StandardEngine</code>的线程池中的线程是以Catalina-startStop的形式命名的，而<code>StandardHost</code>是以localhost-startStop的方式进行命名的。<br><code>StandardHost#start()</code>调用<code>init()</code>初始化完<code>StandardHost</code>以后，会调用钩子的<code>startInternal()</code>，而<code>startInternal()</code>又是调用<code>ContainerBased#startInternal()</code>，而<code>ContainerBase#startInternal()</code>最终又会去启动子容器的，对于<code>StandardHost</code>来说，子容器就是<code>StandardContext</code>。 因此分析到这里可以得出如下结论。<br>对于<code>StandardEngine</code>，<code>StandardHost</code>的启动，父容器在<code>init()</code>的时候创建一个启动和停止子容器的线程池，然后父容器启动的时候首先通过异步的方式将子容器的启动通过<code>org.apache.catalina.core.ContainerBase.StartChild</code>提交到父容器中对应的线程池中进行启动，而子容器启动的时候首先会初始化，然后再启动。（子容器的初始化时执行<code>init()</code>，这里子容器调用<code>star()</code>，未初始化，先执行<code>init()</code>）<br>另外这里还需要注意一点就是，<code>StandEngine#start()</code>的时候，最终调用<code>ContainerBase#startInternal()</code>（StandEngine没有实现<code>start()</code>，调用<code>LifecycleBase#start()</code>，<code>start()</code>里调用<code>startInternal()</code>，这个方法被ContainerBase覆写），而<code>ContainerBase#startInternal()</code>的最后，调用<code>threadStart()</code>，我们来看看它的代码如下。<br><strong>org.apache.catalina.core.ContainerBase#threadStart()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Start the background thread that will periodically check for</span></span><br><span class="line"><span class="hljs-comment">  * session timeouts.</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">threadStart</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">     <span class="hljs-keyword">if</span> (thread != <span class="hljs-keyword">null</span>)</span><br><span class="line">         <span class="hljs-keyword">return</span>;</span><br><span class="line">     <span class="hljs-keyword">if</span> (backgroundProcessorDelay &lt;= <span class="hljs-number">0</span>)</span><br><span class="line">         <span class="hljs-keyword">return</span>;</span><br><span class="line">     threadDone = <span class="hljs-keyword">false</span>;</span><br><span class="line">     String threadName = <span class="hljs-string">"ContainerBackgroundProcessor["</span> + toString() + <span class="hljs-string">"]"</span>;</span><br><span class="line">     thread = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> ContainerBackgroundProcessor(), threadName);</span><br><span class="line">     thread.setDaemon(<span class="hljs-keyword">true</span>);</span><br><span class="line">     thread.start();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>上面的代码，首先会判断<code>backgroundProcessorDelay</code>是否小于0，而这个值默认情况下是-1，也就意味这后面的代码不会运行，而对于<code>StandardEngine</code>来说，它将<code>backgroundProcessorDelay</code>的值在构造函数中赋值为10，这样的话，当StandardEngine启动的时候，就会启动名称为<code>ContainerBackgroundProcessor[StandardEngine[Catalina]]</code>的线程。<br>经过上面的分析，我们已经清楚<code>StandardEngine</code>启动的过程，但是我们还有一个地方需要进一步的分析。<br>因为上面的分析仅仅只是分析容器通过<code>conf/server.xml</code>配置文件的配置结构进行的启动，而都知道<code>CATALINA-HOME/webapps/</code>中的应用也是需要启动的，那么webapps目录的应用又是如何启动的呢？下面来分析一下，通过Tomcat总体结构的描述，已经知道，webapps目录下面的应用其实是属于Context的，而Context对应Tomcat中的<code>StandardContext</code>类，因此就知道应该对谁下手，知道目标以后，还是采用之前的那种方式，打印调用栈，这里还是通过打印调用栈的方式进行，在<code>org.apache.catalina.core.StandardContext#initInternal()</code>中增加打印调用栈的方法，具体代码如下。<br><strong>org.apache.catalina.core.StandardContext#initInternal()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initInternal</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">super</span>.initInternal();</span><br><span class="line">        Throwable ex = <span class="hljs-keyword">new</span> Throwable();</span><br><span class="line">        StackTraceElement[] stackElements = ex.getStackTrace();</span><br><span class="line">        <span class="hljs-keyword">if</span> (stackElements != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = stackElements.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) &#123;</span><br><span class="line">                System.out.print(stackElements[i].getClassName() + <span class="hljs-string">"\t"</span>);</span><br><span class="line">                System.out.print(stackElements[i].getMethodName() + <span class="hljs-string">"\t"</span>);</span><br><span class="line">                System.out.print(stackElements[i].getFileName() + <span class="hljs-string">"\t"</span>);</span><br><span class="line">                System.out.println(stackElements[i].getLineNumber());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (processTlds) &#123;</span><br><span class="line">            <span class="hljs-keyword">this</span>.addLifecycleListener(<span class="hljs-keyword">new</span> TldConfig());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// Register the naming resources</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (namingResources != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            namingResources.init();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// Send j2ee.object.created notification </span></span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.getObjectName() != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            Notification notification = <span class="hljs-keyword">new</span> Notification(<span class="hljs-string">"j2ee.object.created"</span>,</span><br><span class="line">                    <span class="hljs-keyword">this</span>.getObjectName(), sequenceNumber.getAndIncrement());</span><br><span class="line">            broadcaster.sendNotification(notification);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>运行代码，可以看到控制台有如下的输出。<br><figure class="highlight console hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">java.util.concurrent.ThreadPoolExecutor$Worker    run  ThreadPoolExecutor.java   918</span><br><span class="line">java.util.concurrent.ThreadPoolExecutor$Worker runTask  ThreadPoolExecutor.java   895</span><br><span class="line">java.util.concurrent.FutureTask   run  FutureTask.java   138</span><br><span class="line">java.util.concurrent.FutureTask$Sync   innerRun FutureTask.java   303</span><br><span class="line">java.util.concurrent.Executors$RunnableAdapter call Executors.java    439</span><br><span class="line">org.apache.catalina.startup.HostConfig$DeployDirectory  run  HostConfig.java   1671</span><br><span class="line">org.apache.catalina.startup.HostConfig deployDirectory  HostConfig.java   1113</span><br><span class="line">org.apache.catalina.core.StandardHost  addChild StandardHost.java 622</span><br><span class="line">org.apache.catalina.core.ContainerBase addChild ContainerBase.java    877</span><br><span class="line">org.apache.catalina.core.ContainerBase addChildInternal ContainerBase.java    901</span><br><span class="line">org.apache.catalina.util.LifecycleBase start    LifecycleBase.java    139</span><br><span class="line">org.apache.catalina.util.LifecycleBase init LifecycleBase.java    102</span><br><span class="line">org.apache.catalina.core.StandardContext   initInternal StandardContext.java  6449</span><br></pre></td></tr></table></figure></p>
<p>通过查看控制台的输出，可以看到有一个<code>org.apache.catalina.startup.HostConfig$DeployDirectory</code>类，于是乎找到这个类去看看呗。打开一看它是一个Runable接口的实现类。<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeployDirectory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>&#123;</span><br><span class="line">       <span class="hljs-keyword">private</span> HostConfig config;</span><br><span class="line">       <span class="hljs-keyword">private</span> ContextName cn;</span><br><span class="line">       <span class="hljs-keyword">private</span> File dir;</span><br><span class="line"></span><br><span class="line">       <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DeployDirectory</span><span class="hljs-params">(HostConfig config, ContextName cn, File dir)</span> </span>&#123;</span><br><span class="line">           <span class="hljs-keyword">this</span>.config = config;</span><br><span class="line">           <span class="hljs-keyword">this</span>.cn = cn;</span><br><span class="line">           <span class="hljs-keyword">this</span>.dir = dir;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="hljs-meta">@Override</span></span><br><span class="line">       <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">           config.deployDirectory(cn, dir);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>因此推断它也是放到某个线程池中进行异步运行的，最终通过IntellIJ IDEA提供的类调用栈分析工具（ctrl+alt+h）得到<code>DeployDirectory</code>构造器方法的调用栈如下图所示<br><img src="./tomcat-2-7.jpg" alt><br>通过上图可以清楚的看到，最终的调用方是<code>org.apache.catalina.startup.HostConfig#lifecycleEvent()</code>，到这里就知道Context的启动是通过某个组件的生命周期事件的监听器来启动的，而<code>HostConfig</code>到底是谁的监听器呢？通过名称应该可以猜测出它是<code>StandardHost</code>的监听器，那么它到底监听哪个事件呢？查看下<code>org.apache.catalina.startup.HostConfig#lifecycleEvent()</code>的代码如下。<br><strong>org.apache.catalina.startup.HostConfig#lifecycleEvent()</strong><br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Process the START event for an associated Host.</span></span><br><span class="line"><span class="hljs-comment">  *</span></span><br><span class="line"><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> event The lifecycle event that has occurred</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-meta">@Override</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">lifecycleEvent</span><span class="hljs-params">(LifecycleEvent event)</span> </span>&#123;</span><br><span class="line">     <span class="hljs-comment">// Identify the host we are associated with</span></span><br><span class="line">     <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">         host = (Host) event.getLifecycle();</span><br><span class="line">         <span class="hljs-keyword">if</span> (host <span class="hljs-keyword">instanceof</span> StandardHost) &#123;</span><br><span class="line">             setCopyXML(((StandardHost) host).isCopyXML());</span><br><span class="line">             setDeployXML(((StandardHost) host).isDeployXML());</span><br><span class="line">             setUnpackWARs(((StandardHost) host).isUnpackWARs());</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="hljs-keyword">catch</span> (ClassCastException e) &#123;</span><br><span class="line">         log.error(sm.getString(<span class="hljs-string">"hostConfig.cce"</span>, event.getLifecycle()), e);</span><br><span class="line">         <span class="hljs-keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="hljs-comment">// Process the event that has occurred</span></span><br><span class="line">     <span class="hljs-keyword">if</span> (event.getType().equals(Lifecycle.PERIODIC_EVENT)) &#123;</span><br><span class="line">         check();</span><br><span class="line">     &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event.getType().equals(Lifecycle.START_EVENT)) &#123;</span><br><span class="line">         start();</span><br><span class="line">     &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event.getType().equals(Lifecycle.STOP_EVENT)) &#123;</span><br><span class="line">         stop();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>通过上面的代码，可以看出监听的事件是<code>Lifecycle.START_EVENT</code>，而通过查看<code>org.apache.catalina.LifecycleState</code>的代码<code>STARTING(true,Lifecycle.START_EVENT)</code>就可以得知，此时生命周期状态应该是<code>LifecycleState.STARTING</code>，到这里应该已经猜到，<code>HostConfig</code>是在<code>StandardHost#start()</code>的时候通过监听器调用，为验证的猜测，debug一下代码，可以在<code>HostConfig#start()</code>中打个断点，运行以后得到如下内存结构。<br><img src="./tomcat-2-8.jpg" alt><br>通过上面的分析清楚webapps目录中context的启动，总结如下。<br>webapps目录中应用的启动在<code>StandardHost#start()</code>的时候，通过<code>Lifecycle.START_EVENT</code>这个事件的监听器<code>HostConfig</code>进行进一步的启动。<br>综合上面的文章所述，最后再来一下总结，知道Java程序启动以后，最终会以进程的形式存在，而Java进程中又会有很多条线程存在，因此最后就来看看Tomcat启动以后，到底启动哪些线程，通过这些可以反过来验证对源代码的理解是否正确。接下来启动Tomcat，然后运行<code>jstack -l &lt;pid&gt;</code>来看看，jstack的输入如下所示。<br><figure class="highlight console hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">Full thread dump Java HotSpot(TM) 64-Bit Server VM (20.51-b01-457 mixed mode):</span><br><span class="line"></span><br><span class="line">"ajp-bio-8009-AsyncTimeout" daemon prio=5 tid=7f8738afe000 nid=0x115ad6000 waiting on condition [115ad5000]</span><br><span class="line">   java.lang.Thread.State: TIMED_WAITING (sleeping)</span><br><span class="line">        at java.lang.Thread.sleep(Native Method)</span><br><span class="line">        at org.apache.tomcat.util.net.JIoEndpoint$AsyncTimeout.run(JIoEndpoint.java:148)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:680)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">        - None</span><br><span class="line"></span><br><span class="line">"ajp-bio-8009-Acceptor-0" daemon prio=5 tid=7f8738b05800 nid=0x1159d3000 runnable [1159d2000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">        at java.net.PlainSocketImpl.socketAccept(Native Method)</span><br><span class="line">        at java.net.PlainSocketImpl.accept(PlainSocketImpl.java:439)</span><br><span class="line">        - locked &lt;7f46a8710&gt; (a java.net.SocksSocketImpl)</span><br><span class="line">        at java.net.ServerSocket.implAccept(ServerSocket.java:468)</span><br><span class="line">        at java.net.ServerSocket.accept(ServerSocket.java:436)</span><br><span class="line">        at </span><br><span class="line">org.apache.tomcat.util.net.DefaultServerSocketFactory.acceptSocket(DefaultServerSocketFactory.java:60)</span><br><span class="line">        at org.apache.tomcat.util.net.JIoEndpoint$Acceptor.run(JIoEndpoint.java:216)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:680)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">        - None</span><br><span class="line"></span><br><span class="line">"http-bio-8080-AsyncTimeout" daemon prio=5 tid=7f8735acb800 nid=0x1158d0000 waiting on condition [1158cf000]</span><br><span class="line">   java.lang.Thread.State: TIMED_WAITING (sleeping)</span><br><span class="line">        at java.lang.Thread.sleep(Native Method)</span><br><span class="line">        at org.apache.tomcat.util.net.JIoEndpoint$AsyncTimeout.run(JIoEndpoint.java:148)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:680)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">        - None</span><br><span class="line"></span><br><span class="line">"http-bio-8080-Acceptor-0" daemon prio=5 tid=7f8735acd000 nid=0x1157cd000 runnable [1157cc000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">        at java.net.PlainSocketImpl.socketAccept(Native Method)</span><br><span class="line">        at java.net.PlainSocketImpl.accept(PlainSocketImpl.java:439)</span><br><span class="line">        - locked &lt;7f46a8690&gt; (a java.net.SocksSocketImpl)</span><br><span class="line">        at java.net.ServerSocket.implAccept(ServerSocket.java:468)</span><br><span class="line">        at java.net.ServerSocket.accept(ServerSocket.java:436)</span><br><span class="line">        at </span><br><span class="line">org.apache.tomcat.util.net.DefaultServerSocketFactory.acceptSocket(DefaultServerSocketFactory.java:60)</span><br><span class="line">        at org.apache.tomcat.util.net.JIoEndpoint$Acceptor.run(JIoEndpoint.java:216)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:680)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">        - None</span><br><span class="line"></span><br><span class="line">"ContainerBackgroundProcessor[StandardEngine[Catalina]]" daemon prio=5 tid=7f8732850800 nid=0x111203000 waiting on condition [111202000]</span><br><span class="line">   java.lang.Thread.State: TIMED_WAITING (sleeping)</span><br><span class="line">        at java.lang.Thread.sleep(Native Method)</span><br><span class="line">        at </span><br><span class="line">org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.run(ContainerBase.java:1508)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:680)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">        - None</span><br><span class="line"></span><br><span class="line">"main" prio=5 tid=7f8735000800 nid=0x10843e000 runnable [10843c000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">        at java.net.PlainSocketImpl.socketAccept(Native Method)</span><br><span class="line">        at java.net.PlainSocketImpl.accept(PlainSocketImpl.java:439)</span><br><span class="line">        - locked &lt;7f32ea7c8&gt; (a java.net.SocksSocketImpl)</span><br><span class="line">        at java.net.ServerSocket.implAccept(ServerSocket.java:468)</span><br><span class="line">        at java.net.ServerSocket.accept(ServerSocket.java:436)</span><br><span class="line">        at org.apache.catalina.core.StandardServer.await(StandardServer.java:452)</span><br><span class="line">        at org.apache.catalina.startup.Catalina.await(Catalina.java:779)</span><br><span class="line">        at org.apache.catalina.startup.Catalina.start(Catalina.java:725)</span><br><span class="line">        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)</span><br><span class="line">        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)</span><br><span class="line">        at java.lang.reflect.Method.invoke(Method.java:597)</span><br><span class="line">        at org.apache.catalina.startup.Bootstrap.start(Bootstrap.java:322)</span><br><span class="line">        at org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:456)</span><br><span class="line">        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)</span><br><span class="line">        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)</span><br><span class="line">        at java.lang.reflect.Method.invoke(Method.java:597)</span><br><span class="line">        at com.intellij.rt.execution.application.AppMain.main(AppMain.java:120)</span><br></pre></td></tr></table></figure></p>
<p>从上图中可以清楚的看到，有6条线程，其中<code>ajp-bio-8009-AsyncTimeout</code>和<code>ajp-bio-8009-Acceptor-0</code>是在Ajp的<code>Connector</code>启动的时候启动的，<code>http-bio-8080-AsyncTimeout</code>和<code>http-bio-8080-Acceptor-0</code>是http的<code>Connector</code>启动的时候启动的，<code>ContainerBackgroundProcessor[StandardEngine[Catalina]]</code>是在<code>StandardEngine</code>启动的时候启动的，而<code>main()</code>线程就是主线程。这里还需要注意一点就是除main线程以外，其它的线程都是Dameon线程，相关的内容在下篇Tomcat的关闭再来详细说明。</p>

        </div>
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link" href="/tags/Tomcat/">Tomcat</a>, <a class="has-link-grey -link" href="/tags/开源项目/">开源项目</a>
                </div>
            </div>
        </div>
        
        
        
        <div class="social-share"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css">
<script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3>
        <div class="buttons is-centered">
            
                
<a class="button is-info donate">
    <span class="icon is-small">
        <i class="fab fa-alipay"></i>
    </span>
    <span>支付宝</span>
    <div class="qrcode"><img src="/images/alipaycode.jpg" alt="支付宝"></div>
</a>

                
                
<a class="button is-success donate">
    <span class="icon is-small">
        <i class="fab fa-weixin"></i>
    </span>
    <span>微信</span>
    <div class="qrcode"><img src="/images/wxcode.png" alt="微信"></div>
</a>

                
        </div>
    </div>
</div>



<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/Tomcat-3/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">Tomcat（三）关闭过程</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/Tomcat-1/">
                <span class="level-item">Tomcat（一）总体结构</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="title is-5 has-text-weight-normal">评论</h3>
        
<div id="comment-container"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.4.1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.4.1/dist/gitalk.min.js"></script>
<script>
    var gitalk = new Gitalk({
        clientID: 'a70be08270bc7c083f83',
        clientSecret: '1b08252e3cf4b0c29b5f52f431ad9a54eef0a74a',
        id: 'a056a55a608dda868d0a239e3cc568e8',
        repo: 'joeskye1701.github.io',
        owner: 'joeskye1701',
        admin: "joeskye1701"
    })
    gitalk.render('comment-container')
</script>

    </div>
</div>
</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered">
                <div>
                    
                        <img class="image is-128x128 has-mb-6" src="/images/thank-you-kobe.jpg" alt="Joe">
                    
                    
                    <p class="is-size-4 is-block">
                        Joe
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        Developer &amp; Designer
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>Shenzhen, China</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <p class="title has-text-weight-normal">
                        129
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <p class="title has-text-weight-normal">
                        26
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <p class="title has-text-weight-normal">
                        54
                    </p>
                </div>
            </div>
        </nav>
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/joeskye1701">
                关注我</a>
        </div>
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank" title="Github" href="https://github.com/joeskye1701">
                
                <i class="fab fa-github"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        

<div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            链接
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="http://wss.xxyseo.cn/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">西乡大佬</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">wss.xxyseo.cn</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>


    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分类
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Android/">
            <span class="level-start">
                <span class="level-item">Android</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/JDK6-源码/">
            <span class="level-start">
                <span class="level-item">JDK6 源码</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">18</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/JDK7-源码/">
            <span class="level-start">
                <span class="level-item">JDK7 源码</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">6</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/JDK8-源码/">
            <span class="level-start">
                <span class="level-item">JDK8 源码</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/JMM/">
            <span class="level-start">
                <span class="level-item">JMM</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">6</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/JVM/">
            <span class="level-start">
                <span class="level-item">JVM</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">10</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Java/">
            <span class="level-start">
                <span class="level-item">Java</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">20</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Linux/">
            <span class="level-start">
                <span class="level-item">Linux</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/MyBatis/">
            <span class="level-start">
                <span class="level-item">MyBatis</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/MySQL/">
            <span class="level-start">
                <span class="level-item">MySQL</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Redis/">
            <span class="level-start">
                <span class="level-item">Redis</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Spring/">
            <span class="level-start">
                <span class="level-item">Spring</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Tomcat/">
            <span class="level-start">
                <span class="level-item">Tomcat</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">7</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/书/">
            <span class="level-start">
                <span class="level-item">书</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/多线程/">
            <span class="level-start">
                <span class="level-item">多线程</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/并发/">
            <span class="level-start">
                <span class="level-item">并发</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/开源项目/">
            <span class="level-start">
                <span class="level-item">开源项目</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/数学/">
            <span class="level-start">
                <span class="level-item">数学</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/数据库/">
            <span class="level-start">
                <span class="level-item">数据库</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/数据结构/">
            <span class="level-start">
                <span class="level-item">数据结构</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">5</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/日语/">
            <span class="level-start">
                <span class="level-item">日语</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/机器学习/">
            <span class="level-start">
                <span class="level-item">机器学习</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/算法/">
            <span class="level-start">
                <span class="level-item">算法</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">23</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/计算机基础/">
            <span class="level-start">
                <span class="level-item">计算机基础</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/设计模式/">
            <span class="level-start">
                <span class="level-item">设计模式</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/面试/">
            <span class="level-start">
                <span class="level-item">面试</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/Android/" style="font-size: 10px;">Android</a> <a href="/tags/Centos/" style="font-size: 11.82px;">Centos</a> <a href="/tags/Effect-Java/" style="font-size: 10.91px;">Effect Java</a> <a href="/tags/JDK6-源码/" style="font-size: 18.18px;">JDK6 源码</a> <a href="/tags/JDK7-源码/" style="font-size: 14.55px;">JDK7 源码</a> <a href="/tags/JDK8-源码/" style="font-size: 10px;">JDK8 源码</a> <a href="/tags/JMM/" style="font-size: 15.45px;">JMM</a> <a href="/tags/JVM/" style="font-size: 16.36px;">JVM</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/Linux/" style="font-size: 12.73px;">Linux</a> <a href="/tags/MongoDB/" style="font-size: 10px;">MongoDB</a> <a href="/tags/Mongodb/" style="font-size: 10px;">Mongodb</a> <a href="/tags/MyBatis/" style="font-size: 11.82px;">MyBatis</a> <a href="/tags/MySQL/" style="font-size: 10.91px;">MySQL</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/Spring/" style="font-size: 12.73px;">Spring</a> <a href="/tags/Think-In-Java/" style="font-size: 10px;">Think In Java</a> <a href="/tags/Tomcat/" style="font-size: 15.45px;">Tomcat</a> <a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a> <a href="/tags/一致性哈希算法/" style="font-size: 10px;">一致性哈希算法</a> <a href="/tags/书/" style="font-size: 11.82px;">书</a> <a href="/tags/倒排索引/" style="font-size: 10px;">倒排索引</a> <a href="/tags/内存泄漏/" style="font-size: 10px;">内存泄漏</a> <a href="/tags/分支限界算法/" style="font-size: 10.91px;">分支限界算法</a> <a href="/tags/分治法/" style="font-size: 10px;">分治法</a> <a href="/tags/分治算法/" style="font-size: 10px;">分治算法</a> <a href="/tags/分词算法/" style="font-size: 10.91px;">分词算法</a> <a href="/tags/动态规划/" style="font-size: 10px;">动态规划</a> <a href="/tags/动态规划算法/" style="font-size: 10.91px;">动态规划算法</a> <a href="/tags/华为/" style="font-size: 10px;">华为</a> <a href="/tags/回溯算法/" style="font-size: 12.73px;">回溯算法</a> <a href="/tags/多线程/" style="font-size: 10.91px;">多线程</a> <a href="/tags/工具/" style="font-size: 10px;">工具</a> <a href="/tags/并发/" style="font-size: 13.64px;">并发</a> <a href="/tags/开源项目/" style="font-size: 17.27px;">开源项目</a> <a href="/tags/手机游戏/" style="font-size: 10px;">手机游戏</a> <a href="/tags/排序算法/" style="font-size: 10px;">排序算法</a> <a href="/tags/推荐/" style="font-size: 10px;">推荐</a> <a href="/tags/散列表/" style="font-size: 10px;">散列表</a> <a href="/tags/数学/" style="font-size: 10px;">数学</a> <a href="/tags/数据库/" style="font-size: 10.91px;">数据库</a> <a href="/tags/数据结构/" style="font-size: 13.64px;">数据结构</a> <a href="/tags/日语/" style="font-size: 10px;">日语</a> <a href="/tags/最优路径算法/" style="font-size: 10px;">最优路径算法</a> <a href="/tags/机器学习/" style="font-size: 10px;">机器学习</a> <a href="/tags/源码/" style="font-size: 11.82px;">源码</a> <a href="/tags/算法/" style="font-size: 19.09px;">算法</a> <a href="/tags/线程安全/" style="font-size: 10.91px;">线程安全</a> <a href="/tags/编程珠玑/" style="font-size: 11.82px;">编程珠玑</a> <a href="/tags/计算机基础/" style="font-size: 10px;">计算机基础</a> <a href="/tags/设计模式/" style="font-size: 12.73px;">设计模式</a> <a href="/tags/贪心算法/" style="font-size: 11.82px;">贪心算法</a> <a href="/tags/跳表/" style="font-size: 10px;">跳表</a> <a href="/tags/面试/" style="font-size: 10px;">面试</a>
    </div>
</div>

    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
            
<div class="card widget" id="toc">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                目录
            </h3>
            <ul class="menu-list"><li>
        <a class="is-flex" href="#1-Tomcat组件生命周期管理">
        <span class="has-mr-6">1</span>
        <span>1 Tomcat组件生命周期管理</span>
        </a></li><li>
        <a class="is-flex" href="#2-Tomcat启动的总过程">
        <span class="has-mr-6">2</span>
        <span>2 Tomcat启动的总过程</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#BootStrap-init">
        <span class="has-mr-6">2.1</span>
        <span>BootStrap#init()</span>
        </a></li><li>
        <a class="is-flex" href="#BootStrap-load">
        <span class="has-mr-6">2.2</span>
        <span>BootStrap#load()</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#3-Tomcat启动过程关键步骤分析">
        <span class="has-mr-6">3</span>
        <span>3 Tomcat启动过程关键步骤分析</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#Connector-init">
        <span class="has-mr-6">3.1</span>
        <span>Connector#init()</span>
        </a></li><li>
        <a class="is-flex" href="#Connector-start">
        <span class="has-mr-6">3.2</span>
        <span>Connector#start()</span>
        </a></li><li>
        <a class="is-flex" href="#StandardEngine-start">
        <span class="has-mr-6">3.3</span>
        <span>StandardEngine#start()</span>
        </a></li></ul></li></ul>
        </div>
    </div>
</div>

        
            
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            <!-- 
            <a href="/VIM-Command/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="VIM 命令">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-12-10T02:31:22.000Z">2018-12-10</time></div>
                    <a href="/VIM-Command/" class="has-link-black-ter is-size-6">VIM 命令</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/Lock-Control/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="锁粒度的控制">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-04T04:37:22.000Z">2018-11-04</time></div>
                    <a href="/Lock-Control/" class="has-link-black-ter is-size-6">锁粒度的控制</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/Temporary-Menory-Table/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="临时表和内存表">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-04T04:37:22.000Z">2018-11-04</time></div>
                    <a href="/Temporary-Menory-Table/" class="has-link-black-ter is-size-6">临时表和内存表</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/MySQL/">MySQL</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/MySQL-Command/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="MySQL基本命令">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-03T04:37:22.000Z">2018-11-03</time></div>
                    <a href="/MySQL-Command/" class="has-link-black-ter is-size-6">MySQL基本命令</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/MySQL/">MySQL</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/Centos-Line/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Centos命令行图形界面切换">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-03T04:37:22.000Z">2018-11-03</time></div>
                    <a href="/Centos-Line/" class="has-link-black-ter is-size-6">Centos命令行图形界面切换</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2018/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/01/">
                <span class="level-start">
                    <span class="level-item">一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/01/">
                <span class="level-start">
                    <span class="level-item">一月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/10/">
                <span class="level-start">
                    <span class="level-item">十月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">9</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/09/">
                <span class="level-start">
                    <span class="level-item">九月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/08/">
                <span class="level-start">
                    <span class="level-item">八月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/07/">
                <span class="level-start">
                    <span class="level-item">七月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/06/">
                <span class="level-start">
                    <span class="level-item">六月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/05/">
                <span class="level-start">
                    <span class="level-item">五月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/04/">
                <span class="level-start">
                    <span class="level-item">四月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/03/">
                <span class="level-start">
                    <span class="level-item">三月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/02/">
                <span class="level-start">
                    <span class="level-item">二月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/10/">
                <span class="level-start">
                    <span class="level-item">十月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">13</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/09/">
                <span class="level-start">
                    <span class="level-item">九月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/08/">
                <span class="level-start">
                    <span class="level-item">八月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/07/">
                <span class="level-start">
                    <span class="level-item">七月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/06/">
                <span class="level-start">
                    <span class="level-item">六月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/05/">
                <span class="level-start">
                    <span class="level-item">五月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/04/">
                <span class="level-start">
                    <span class="level-item">四月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/03/">
                <span class="level-start">
                    <span class="level-item">三月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/02/">
                <span class="level-start">
                    <span class="level-item">二月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/01/">
                <span class="level-start">
                    <span class="level-item">一月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/09/">
                <span class="level-start">
                    <span class="level-item">九月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/03/">
                <span class="level-start">
                    <span class="level-item">三月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/10/">
                <span class="level-start">
                    <span class="level-item">十月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/08/">
                <span class="level-start">
                    <span class="level-item">八月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/07/">
                <span class="level-start">
                    <span class="level-item">七月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/06/">
                <span class="level-start">
                    <span class="level-item">六月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/04/">
                <span class="level-start">
                    <span class="level-item">四月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/03/">
                <span class="level-start">
                    <span class="level-item">三月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/02/">
                <span class="level-start">
                    <span class="level-item">二月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/01/">
                <span class="level-start">
                    <span class="level-item">一月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Android/">
                        <span class="tag">Android</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Centos/">
                        <span class="tag">Centos</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Effect-Java/">
                        <span class="tag">Effect Java</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JDK6-源码/">
                        <span class="tag">JDK6 源码</span>
                        <span class="tag is-grey">18</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JDK7-源码/">
                        <span class="tag">JDK7 源码</span>
                        <span class="tag is-grey">6</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JDK8-源码/">
                        <span class="tag">JDK8 源码</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JMM/">
                        <span class="tag">JMM</span>
                        <span class="tag is-grey">7</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JVM/">
                        <span class="tag">JVM</span>
                        <span class="tag is-grey">10</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Java/">
                        <span class="tag">Java</span>
                        <span class="tag is-grey">40</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Linux/">
                        <span class="tag">Linux</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MongoDB/">
                        <span class="tag">MongoDB</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Mongodb/">
                        <span class="tag">Mongodb</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MyBatis/">
                        <span class="tag">MyBatis</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MySQL/">
                        <span class="tag">MySQL</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Redis/">
                        <span class="tag">Redis</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Spring/">
                        <span class="tag">Spring</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Think-In-Java/">
                        <span class="tag">Think In Java</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Tomcat/">
                        <span class="tag">Tomcat</span>
                        <span class="tag is-grey">7</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Ubuntu/">
                        <span class="tag">Ubuntu</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/一致性哈希算法/">
                        <span class="tag">一致性哈希算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/书/">
                        <span class="tag">书</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/倒排索引/">
                        <span class="tag">倒排索引</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/内存泄漏/">
                        <span class="tag">内存泄漏</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分支限界算法/">
                        <span class="tag">分支限界算法</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分治法/">
                        <span class="tag">分治法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分治算法/">
                        <span class="tag">分治算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分词算法/">
                        <span class="tag">分词算法</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/动态规划/">
                        <span class="tag">动态规划</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/动态规划算法/">
                        <span class="tag">动态规划算法</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/华为/">
                        <span class="tag">华为</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/回溯算法/">
                        <span class="tag">回溯算法</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/多线程/">
                        <span class="tag">多线程</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/工具/">
                        <span class="tag">工具</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/并发/">
                        <span class="tag">并发</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/开源项目/">
                        <span class="tag">开源项目</span>
                        <span class="tag is-grey">17</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/手机游戏/">
                        <span class="tag">手机游戏</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/排序算法/">
                        <span class="tag">排序算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/推荐/">
                        <span class="tag">推荐</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/散列表/">
                        <span class="tag">散列表</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数学/">
                        <span class="tag">数学</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数据库/">
                        <span class="tag">数据库</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数据结构/">
                        <span class="tag">数据结构</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/日语/">
                        <span class="tag">日语</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/最优路径算法/">
                        <span class="tag">最优路径算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/机器学习/">
                        <span class="tag">机器学习</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/源码/">
                        <span class="tag">源码</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/算法/">
                        <span class="tag">算法</span>
                        <span class="tag is-grey">26</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/线程安全/">
                        <span class="tag">线程安全</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/编程珠玑/">
                        <span class="tag">编程珠玑</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/计算机基础/">
                        <span class="tag">计算机基础</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/设计模式/">
                        <span class="tag">设计模式</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/贪心算法/">
                        <span class="tag">贪心算法</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/跳表/">
                        <span class="tag">跳表</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/面试/">
                        <span class="tag">面试</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
        
        </div>
    
</div>

                




<div class="column is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only has-order-3 column-right ">
    
        
<div class="card widget" id="toc">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                目录
            </h3>
            <ul class="menu-list"><li>
        <a class="is-flex" href="#1-Tomcat组件生命周期管理">
        <span class="has-mr-6">1</span>
        <span>1 Tomcat组件生命周期管理</span>
        </a></li><li>
        <a class="is-flex" href="#2-Tomcat启动的总过程">
        <span class="has-mr-6">2</span>
        <span>2 Tomcat启动的总过程</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#BootStrap-init">
        <span class="has-mr-6">2.1</span>
        <span>BootStrap#init()</span>
        </a></li><li>
        <a class="is-flex" href="#BootStrap-load">
        <span class="has-mr-6">2.2</span>
        <span>BootStrap#load()</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#3-Tomcat启动过程关键步骤分析">
        <span class="has-mr-6">3</span>
        <span>3 Tomcat启动过程关键步骤分析</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#Connector-init">
        <span class="has-mr-6">3.1</span>
        <span>Connector#init()</span>
        </a></li><li>
        <a class="is-flex" href="#Connector-start">
        <span class="has-mr-6">3.2</span>
        <span>Connector#start()</span>
        </a></li><li>
        <a class="is-flex" href="#StandardEngine-start">
        <span class="has-mr-6">3.3</span>
        <span>StandardEngine#start()</span>
        </a></li></ul></li></ul>
        </div>
    </div>
</div>

    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            <!-- 
            <a href="/VIM-Command/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="VIM 命令">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-12-10T02:31:22.000Z">2018-12-10</time></div>
                    <a href="/VIM-Command/" class="has-link-black-ter is-size-6">VIM 命令</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/Lock-Control/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="锁粒度的控制">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-04T04:37:22.000Z">2018-11-04</time></div>
                    <a href="/Lock-Control/" class="has-link-black-ter is-size-6">锁粒度的控制</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/Temporary-Menory-Table/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="临时表和内存表">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-04T04:37:22.000Z">2018-11-04</time></div>
                    <a href="/Temporary-Menory-Table/" class="has-link-black-ter is-size-6">临时表和内存表</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/MySQL/">MySQL</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/MySQL-Command/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="MySQL基本命令">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-03T04:37:22.000Z">2018-11-03</time></div>
                    <a href="/MySQL-Command/" class="has-link-black-ter is-size-6">MySQL基本命令</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/MySQL/">MySQL</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/Centos-Line/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Centos命令行图形界面切换">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-03T04:37:22.000Z">2018-11-03</time></div>
                    <a href="/Centos-Line/" class="has-link-black-ter is-size-6">Centos命令行图形界面切换</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2018/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/01/">
                <span class="level-start">
                    <span class="level-item">一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/01/">
                <span class="level-start">
                    <span class="level-item">一月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/10/">
                <span class="level-start">
                    <span class="level-item">十月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">9</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/09/">
                <span class="level-start">
                    <span class="level-item">九月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/08/">
                <span class="level-start">
                    <span class="level-item">八月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/07/">
                <span class="level-start">
                    <span class="level-item">七月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/06/">
                <span class="level-start">
                    <span class="level-item">六月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/05/">
                <span class="level-start">
                    <span class="level-item">五月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/04/">
                <span class="level-start">
                    <span class="level-item">四月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/03/">
                <span class="level-start">
                    <span class="level-item">三月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/02/">
                <span class="level-start">
                    <span class="level-item">二月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/10/">
                <span class="level-start">
                    <span class="level-item">十月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">13</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/09/">
                <span class="level-start">
                    <span class="level-item">九月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/08/">
                <span class="level-start">
                    <span class="level-item">八月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/07/">
                <span class="level-start">
                    <span class="level-item">七月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/06/">
                <span class="level-start">
                    <span class="level-item">六月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/05/">
                <span class="level-start">
                    <span class="level-item">五月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/04/">
                <span class="level-start">
                    <span class="level-item">四月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/03/">
                <span class="level-start">
                    <span class="level-item">三月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/02/">
                <span class="level-start">
                    <span class="level-item">二月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/01/">
                <span class="level-start">
                    <span class="level-item">一月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/09/">
                <span class="level-start">
                    <span class="level-item">九月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/03/">
                <span class="level-start">
                    <span class="level-item">三月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/10/">
                <span class="level-start">
                    <span class="level-item">十月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/08/">
                <span class="level-start">
                    <span class="level-item">八月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/07/">
                <span class="level-start">
                    <span class="level-item">七月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/06/">
                <span class="level-start">
                    <span class="level-item">六月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/04/">
                <span class="level-start">
                    <span class="level-item">四月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/03/">
                <span class="level-start">
                    <span class="level-item">三月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/02/">
                <span class="level-start">
                    <span class="level-item">二月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/01/">
                <span class="level-start">
                    <span class="level-item">一月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Android/">
                        <span class="tag">Android</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Centos/">
                        <span class="tag">Centos</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Effect-Java/">
                        <span class="tag">Effect Java</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JDK6-源码/">
                        <span class="tag">JDK6 源码</span>
                        <span class="tag is-grey">18</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JDK7-源码/">
                        <span class="tag">JDK7 源码</span>
                        <span class="tag is-grey">6</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JDK8-源码/">
                        <span class="tag">JDK8 源码</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JMM/">
                        <span class="tag">JMM</span>
                        <span class="tag is-grey">7</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JVM/">
                        <span class="tag">JVM</span>
                        <span class="tag is-grey">10</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Java/">
                        <span class="tag">Java</span>
                        <span class="tag is-grey">40</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Linux/">
                        <span class="tag">Linux</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MongoDB/">
                        <span class="tag">MongoDB</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Mongodb/">
                        <span class="tag">Mongodb</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MyBatis/">
                        <span class="tag">MyBatis</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MySQL/">
                        <span class="tag">MySQL</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Redis/">
                        <span class="tag">Redis</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Spring/">
                        <span class="tag">Spring</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Think-In-Java/">
                        <span class="tag">Think In Java</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Tomcat/">
                        <span class="tag">Tomcat</span>
                        <span class="tag is-grey">7</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Ubuntu/">
                        <span class="tag">Ubuntu</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/一致性哈希算法/">
                        <span class="tag">一致性哈希算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/书/">
                        <span class="tag">书</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/倒排索引/">
                        <span class="tag">倒排索引</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/内存泄漏/">
                        <span class="tag">内存泄漏</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分支限界算法/">
                        <span class="tag">分支限界算法</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分治法/">
                        <span class="tag">分治法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分治算法/">
                        <span class="tag">分治算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分词算法/">
                        <span class="tag">分词算法</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/动态规划/">
                        <span class="tag">动态规划</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/动态规划算法/">
                        <span class="tag">动态规划算法</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/华为/">
                        <span class="tag">华为</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/回溯算法/">
                        <span class="tag">回溯算法</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/多线程/">
                        <span class="tag">多线程</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/工具/">
                        <span class="tag">工具</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/并发/">
                        <span class="tag">并发</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/开源项目/">
                        <span class="tag">开源项目</span>
                        <span class="tag is-grey">17</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/手机游戏/">
                        <span class="tag">手机游戏</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/排序算法/">
                        <span class="tag">排序算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/推荐/">
                        <span class="tag">推荐</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/散列表/">
                        <span class="tag">散列表</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数学/">
                        <span class="tag">数学</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数据库/">
                        <span class="tag">数据库</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数据结构/">
                        <span class="tag">数据结构</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/日语/">
                        <span class="tag">日语</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/最优路径算法/">
                        <span class="tag">最优路径算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/机器学习/">
                        <span class="tag">机器学习</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/源码/">
                        <span class="tag">源码</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/算法/">
                        <span class="tag">算法</span>
                        <span class="tag is-grey">26</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/线程安全/">
                        <span class="tag">线程安全</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/编程珠玑/">
                        <span class="tag">编程珠玑</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/计算机基础/">
                        <span class="tag">计算机基础</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/设计模式/">
                        <span class="tag">设计模式</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/贪心算法/">
                        <span class="tag">贪心算法</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/跳表/">
                        <span class="tag">跳表</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/面试/">
                        <span class="tag">面试</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
    
    
</div>

            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    Joe|博客
                
                </a>
                <p class="is-size-7">
                &copy; 2019 Joe&nbsp;
                <!-- Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        href="http://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a> -->
                
                </p>
            </div>
            <div class="level-end">
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么...">
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>