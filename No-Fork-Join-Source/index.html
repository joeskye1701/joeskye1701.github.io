<!DOCTYPE html>
<html lang="zh">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
<title>非Fork/Join源码分析 - Joe|博客</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



    <meta name="description" content="1 ForkJoinPool属性 2 ForkJoinWorkerThread属性 3 ForkJoinTask属性 4 非ForkJoin任务的执行过程 4.1 例 4.2 ForkJoinPool ForkJoinPool ForkJoinPool默认的工作线程工厂 ForkJoinPool#submit() ForkJoinTask#adapt() ForkJoinTask#Adapte">
<meta name="keywords" content="Java,设计模式,JDK7 源码">
<meta property="og:type" content="article">
<meta property="og:title" content="非Fork&#x2F;Join源码分析">
<meta property="og:url" content="https://joeskye1701.github.io/No-Fork-Join-Source/index.html">
<meta property="og:site_name" content="Joe|博客">
<meta property="og:description" content="1 ForkJoinPool属性 2 ForkJoinWorkerThread属性 3 ForkJoinTask属性 4 非ForkJoin任务的执行过程 4.1 例 4.2 ForkJoinPool ForkJoinPool ForkJoinPool默认的工作线程工厂 ForkJoinPool#submit() ForkJoinTask#adapt() ForkJoinTask#Adapte">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-10-22T00:36:11.101Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="非Fork&#x2F;Join源码分析">
<meta name="twitter:description" content="1 ForkJoinPool属性 2 ForkJoinWorkerThread属性 3 ForkJoinTask属性 4 非ForkJoin任务的执行过程 4.1 例 4.2 ForkJoinPool ForkJoinPool ForkJoinPool默认的工作线程工厂 ForkJoinPool#submit() ForkJoinTask#adapt() ForkJoinTask#Adapte">





<link rel="icon" href="/images/thank-you-kobe.jpg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/xcode.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    

    
    
<script>
var _hmt = _hmt || [];
(function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?c422b171d3bdb7dbfae47ff3f70f9d30";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();
</script>

    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    
    
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                Joe|博客
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item" href="/">主页</a>
                
                <a class="navbar-item" href="/archives">归档</a>
                
                <a class="navbar-item" href="/categories">分类</a>
                
                <a class="navbar-item" href="/tags">标签</a>
                
                <a class="navbar-item" href="/about">关于</a>
                
            </div>
            
            <div class="navbar-end">
                
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-6-widescreen has-order-2 column-main"><div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2016-03-24T04:37:22.000Z">2016-03-24</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/JDK7-源码/">JDK7 源码</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    2 小时 读完 (大约 13529 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                非Fork/Join源码分析
            
        </h1>
        <div class="content">
            <!-- TOC -->
<ul>
<li><a href="#1-forkjoinpool属性">1 ForkJoinPool属性</a></li>
<li><a href="#2-forkjoinworkerthread属性">2 ForkJoinWorkerThread属性</a></li>
<li><a href="#3-forkjointask属性">3 ForkJoinTask属性</a></li>
<li><a href="#4-非forkjoin任务的执行过程">4 非ForkJoin任务的执行过程</a><ul>
<li><a href="#41-例">4.1 例</a></li>
<li><a href="#42-forkjoinpool">4.2 ForkJoinPool</a><ul>
<li><a href="#forkjoinpool">ForkJoinPool</a></li>
<li><a href="#forkjoinpool默认的工作线程工厂">ForkJoinPool默认的工作线程工厂</a></li>
<li><a href="#forkjoinpoolsubmit">ForkJoinPool#submit()</a></li>
<li><a href="#forkjointaskadapt">ForkJoinTask#adapt()</a></li>
<li><a href="#forkjointaskadaptedcallable">ForkJoinTask#AdaptedCallable()</a></li>
<li><a href="#forkjointaskadaptedrunnable">ForkJoinTask#AdaptedRunnable()</a></li>
<li><a href="#forkjoinpoolforkorsubmit">ForkJoinPool#forkOrSubmit()</a></li>
<li><a href="#forkjoinpooladdsubmission">ForkJoinPool#addSubmission()</a><ul>
<li><a href="#addsubmission">addSubmission()</a></li>
</ul>
</li>
<li><a href="#forkjoinpoolgrowsubmissionqueue">ForkJoinPool#growSubmissionQueue()</a></li>
<li><a href="#forkjoinpoolsignalwork">ForkJoinPool#signalWork()</a><ul>
<li><a href="#signalwork">signalWork</a><ul>
<li><a href="#标注0">标注0</a></li>
<li><a href="#e0前代码">e&gt;=0前代码</a></li>
<li><a href="#e0代码">e&gt;=0代码</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#forkjoinpooladdworker">ForkJoinPool#addWorker()</a></li>
<li><a href="#forkjoinpoolforkjoinworkerthreadfactorynewthread">ForkJoinPool#ForkJoinWorkerThreadFactory#newThread()</a></li>
<li><a href="#forkjoinpoolnextworkername">ForkJoinPool#nextWorkerName()</a></li>
<li><a href="#forkjoinpoolregisterworker">ForkJoinPool#registerWorker()</a><ul>
<li><a href="#registerworker">registerWorker()</a></li>
</ul>
</li>
<li><a href="#forkjoinworkerthreadrun">ForkJoinWorkerThread#run()</a></li>
<li><a href="#forkjoinworkerthreadonstart">ForkJoinWorkerThread#onStart()</a></li>
<li><a href="#forkjoinworkerthreadontermination">ForkJoinWorkerThread#onTermination()</a></li>
<li><a href="#forkjoinpoolwork">ForkJoinPool#work</a></li>
<li><a href="#forkjoinpoolscan">ForkJoinPool#scan()</a><ul>
<li><a href="#scan">scan()</a></li>
</ul>
</li>
<li><a href="#forkjoinworkerthreadexectask">ForkJoinWorkerThread#execTask()</a></li>
<li><a href="#forjointaskdoexec">ForJoinTask#doExec()</a></li>
<li><a href="#recursiveactionexec">RecursiveAction#exec()</a></li>
<li><a href="#recursiveactioncompute">RecursiveAction#compute()</a></li>
<li><a href="#recursivetaskexec">RecursiveTask#exec()</a></li>
<li><a href="#recursivetaskcompute">RecursiveTask#compute()</a></li>
<li><a href="#forkjointasksetcompletion">ForkJoinTask#setCompletion()</a></li>
<li><a href="#forkjointasksetexceptionalcompletion">ForkJoinTask#setExceptionalCompletion()</a><ul>
<li><a href="#这里为什么会有一个异常表呢">这里为什么会有一个异常表呢？</a></li>
<li><a href="#异常表的结构是怎么样的呢">异常表的结构是怎么样的呢？</a></li>
</ul>
</li>
<li><a href="#exception-table">Exception table</a></li>
<li><a href="#forkjoinpooltryawaitwork">ForkJoinPool#tryAwaitWork()</a></li>
<li><a href="#forkjoinpoolidleawaitwork">ForkJoinPool#idleAwaitWork()</a></li>
<li><a href="#forkjoinworkerthreadontermination">ForkJoinWorkerThread#onTermination()</a></li>
<li><a href="#forkjoinworkerthreadcanceltasks">ForkJoinWorkerThread#cancelTasks()</a></li>
<li><a href="#forkjointaskcancel">ForkJoinTask#cancel()</a></li>
<li><a href="#forkjoinpoolderegisterworker">ForkJoinPool#deregisterWorker()</a></li>
<li><a href="#forkjoinpooltryterminate">ForkJoinPool#tryTerminate()</a><ul>
<li><a href="#参数为false">参数为<code>false</code></a></li>
<li><a href="#参数为true">参数为<code>true</code></a></li>
</ul>
</li>
<li><a href="#forkjoinpoolstartterminating">ForkJoinPool#startTerminating()</a><ul>
<li><a href="#startterminating流程">startTerminating流程</a></li>
</ul>
</li>
<li><a href="#forkjoinpoolcancelsubmissions">ForkJoinPool#cancelSubmissions()</a></li>
<li><a href="#forkjoinpoolpollsubmission">ForkJoinPool#pollSubmission()</a></li>
<li><a href="#forkjoinpoolterminatewaiters">ForkJoinPool#terminateWaiters()</a></li>
<li><a href="#forkjoinpooltryreleasewaiter">ForkJoinPool#tryReleaseWaiter()</a></li>
<li><a href="#forkjoinworkerthreadexectask">ForkJoinWorkerThread#execTask()</a></li>
<li><a href="#forkjoinworkerthreadpoptask">ForkJoinWorkerThread#popTask()</a></li>
<li><a href="#forkjoinworkerthreadlocallydeqtask">ForkJoinWorkerThread#locallyDeqTask()</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#5-总结">5 总结</a></li>
</ul>
<!-- /TOC -->
<h1 id="1-ForkJoinPool属性"><a href="#1-ForkJoinPool属性" class="headerlink" title="1 ForkJoinPool属性"></a>1 ForkJoinPool属性</h1><p>部分参数<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Main pool control -- a long packed with:</span></span><br><span class="line"><span class="hljs-comment">     * AC: Number of active running workers minus target parallelism (16 bits)</span></span><br><span class="line"><span class="hljs-comment">     * TC: Number of total workers minus target parallelism (16bits)</span></span><br><span class="line"><span class="hljs-comment">     * ST: true if pool is terminating (1 bit)</span></span><br><span class="line"><span class="hljs-comment">     * EC: the wait count of top waiting thread (15 bits)</span></span><br><span class="line"><span class="hljs-comment">     * ID: ~poolIndex of top of Treiber stack of waiting threads (16 bits)</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * When convenient, we can extract the upper 32 bits of counts and</span></span><br><span class="line"><span class="hljs-comment">     * the lower 32 bits of queue state, u = (int)(ctl &gt;&gt;&gt; 32) and e =</span></span><br><span class="line"><span class="hljs-comment">     * (int)ctl.  The ec field is never accessed alone, but always</span></span><br><span class="line"><span class="hljs-comment">     * together with id and st. The offsets of counts by the target</span></span><br><span class="line"><span class="hljs-comment">     * parallelism and the positionings of fields makes it possible to</span></span><br><span class="line"><span class="hljs-comment">     * perform the most common checks via sign tests of fields: When</span></span><br><span class="line"><span class="hljs-comment">     * ac is negative, there are not enough active workers, when tc is</span></span><br><span class="line"><span class="hljs-comment">     * negative, there are not enough total workers, when id is</span></span><br><span class="line"><span class="hljs-comment">     * negative, there is at least one waiting worker, and when e is</span></span><br><span class="line"><span class="hljs-comment">     * negative, the pool is terminating.  To deal with these possibly</span></span><br><span class="line"><span class="hljs-comment">     * negative fields, we use casts in and out of "short" and/or</span></span><br><span class="line"><span class="hljs-comment">     * signed shifts to maintain signedness.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">long</span> ctl;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// bit positions/shifts for fields</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span>  AC_SHIFT   = <span class="hljs-number">48</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span>  TC_SHIFT   = <span class="hljs-number">32</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span>  ST_SHIFT   = <span class="hljs-number">31</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span>  EC_SHIFT   = <span class="hljs-number">16</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// bounds</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span>  MAX_ID     = <span class="hljs-number">0x7fff</span>;  <span class="hljs-comment">// max poolIndex</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span>  SMASK      = <span class="hljs-number">0xffff</span>;  <span class="hljs-comment">// mask short bits</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span>  SHORT_SIGN = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">15</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span>  INT_SIGN   = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">31</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// masks</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> STOP_BIT   = <span class="hljs-number">0x0001L</span> &lt;&lt; ST_SHIFT;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> AC_MASK    = ((<span class="hljs-keyword">long</span>)SMASK) &lt;&lt; AC_SHIFT;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> TC_MASK    = ((<span class="hljs-keyword">long</span>)SMASK) &lt;&lt; TC_SHIFT;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// units for incrementing and decrementing</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> TC_UNIT    = <span class="hljs-number">1L</span> &lt;&lt; TC_SHIFT;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> AC_UNIT    = <span class="hljs-number">1L</span> &lt;&lt; AC_SHIFT;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// masks and units for dealing with u = (int)(ctl &gt;&gt;&gt; 32)</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span>  UAC_SHIFT  = AC_SHIFT - <span class="hljs-number">32</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span>  UTC_SHIFT  = TC_SHIFT - <span class="hljs-number">32</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span>  UAC_MASK   = SMASK &lt;&lt; UAC_SHIFT;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span>  UTC_MASK   = SMASK &lt;&lt; UTC_SHIFT;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span>  UAC_UNIT   = <span class="hljs-number">1</span> &lt;&lt; UAC_SHIFT;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span>  UTC_UNIT   = <span class="hljs-number">1</span> &lt;&lt; UTC_SHIFT;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// masks and units for dealing with e = (int)ctl</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span>  E_MASK     = <span class="hljs-number">0x7fffffff</span>; <span class="hljs-comment">// no STOP_BIT</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span>  EC_UNIT    = <span class="hljs-number">1</span> &lt;&lt; EC_SHIFT;</span><br></pre></td></tr></table></figure></p>
<p><code>ForkJoinPool</code>的总控制信息，包含在一个<code>long(64bit)</code>里面。</p>
<ul>
<li>AC: 表示当前活动的工作线程的数量减去并行度得到的数值。(16 bits)</li>
<li>TC: 表示全部工作线程的数量减去并行度得到的数值。(16bits)</li>
<li>ST: 表示当前<code>ForkJoinPool</code>是否正在关闭。(1 bit)</li>
<li>EC: 表示<code>Treiber stack</code>顶端的等待工作线程的等待次数。(15 bits)</li>
<li>ID: <code>Treiber stack</code>顶端的等待工作线程的下标取反。(16 bits)</li>
</ul>
<table>
<thead>
<tr>
<th>1111111111111111</th>
<th>1111111111111111</th>
<th>1</th>
<th>111111111111111</th>
<th>1111111111111111</th>
</tr>
</thead>
<tbody>
<tr>
<td>AC</td>
<td>TC</td>
<td>ST</td>
<td>EC</td>
<td>ID</td>
</tr>
</tbody>
</table>
<ul>
<li>如果<code>AC</code>为负数，说明没有足够的活动工作线程。</li>
<li>如果<code>TC</code>为负数，说明工作线程数量没达到最大工作线程数量。</li>
<li>如果<code>ID</code>为负数，说明至少有一个等待的工作线程。</li>
<li>如果<code>(int)ctl</code>为负数，说明<code>ForkJoinPool</code>正在关闭。<a id="more"></a>
<code>ctl</code>是<code>ForkJoinPool</code>中最重要的，也是设计最精密的域，它是整个<code>ForkJoinPool</code>的总控信息。所有信息包含在一个<code>long(64bit)</code>中，这些信息包括：当前活动的工作线程数量、当前总的工作线程数量、<code>ForkJoinPool</code>的关闭标志、在<code>Treiber stack</code>(由全部等待工作线程组成的一个链)顶端等待的工作线程的等待次数、<code>Treiber stack</code>(由全部等待工作线程组成的一个链)顶端等待的工作线程的<code>ID</code>信息(工作线程的下标取反)。<br><code>ctl</code>还有一个相对不重要的作用就是，某些非<code>volatile</code>域会依赖<code>ctl</code>来保证可见性。  <figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * Array holding all worker threads in the pool.  Initialized upon</span></span><br><span class="line"><span class="hljs-comment"> * construction. Array size must be a power of two.  Updates and</span></span><br><span class="line"><span class="hljs-comment"> * replacements are protected by scanGuard, but the array is</span></span><br><span class="line"><span class="hljs-comment"> * always kept in a consistent enough state to be randomly</span></span><br><span class="line"><span class="hljs-comment"> * accessed without locking by workers performing work-stealing,</span></span><br><span class="line"><span class="hljs-comment"> * as well as other traversal-based methods in this class, so long</span></span><br><span class="line"><span class="hljs-comment"> * as reads memory-acquire by first reading ctl. All readers must</span></span><br><span class="line"><span class="hljs-comment"> * tolerate that some array slots may be null.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line">ForkJoinWorkerThread[] workers;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><code>workers</code>是<code>ForkJoinPool</code>中保存工作线程的数组，它的更新会由一个锁(<code>scanGuard</code>)来保护。<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * SeqLock and index masking for updates to workers array.  Locked</span></span><br><span class="line"><span class="hljs-comment"> * when SG_UNIT is set. Unlocking clears bit by adding</span></span><br><span class="line"><span class="hljs-comment"> * SG_UNIT. Staleness of read-only operations can be checked by</span></span><br><span class="line"><span class="hljs-comment"> * comparing scanGuard to value before the reads. The low 16 bits</span></span><br><span class="line"><span class="hljs-comment"> * (i.e, anding with SMASK) hold (the smallest power of two</span></span><br><span class="line"><span class="hljs-comment"> * covering all worker indices, minus one, and is used to avoid</span></span><br><span class="line"><span class="hljs-comment"> * dealing with large numbers of null slots when the workers array</span></span><br><span class="line"><span class="hljs-comment"> * is overallocated.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">volatile</span> <span class="hljs-keyword">int</span> scanGuard;</span><br></pre></td></tr></table></figure></p>
<p><code>scanGuard</code>是另外一个比较重要的域，它有两个作用。</p>
<ol>
<li>作为更新工作线程数组是使用的(顺序)锁。</li>
<li>作为扫描工作线程数组时使用的边界值来避免一些没用的扫描(当数组过大时)。<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Initial size for submission queue array. Must be a power of</span></span><br><span class="line"><span class="hljs-comment">     * two.  In many applications, these always stay small so we use a</span></span><br><span class="line"><span class="hljs-comment">     * small initial cap.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> INITIAL_QUEUE_CAPACITY = <span class="hljs-number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Maximum size for submission queue array. Must be a power of two</span></span><br><span class="line"><span class="hljs-comment">     * less than or equal to 1 &lt;&lt; (31 - width of array entry) to</span></span><br><span class="line"><span class="hljs-comment">     * ensure lack of index wraparound, but is capped at a lower</span></span><br><span class="line"><span class="hljs-comment">     * value to help users trap runaway computations.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> MAXIMUM_QUEUE_CAPACITY = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">24</span>; <span class="hljs-comment">// 16M</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Array serving as submission queue. Initialized upon construction.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> ForkJoinTask&lt;?&gt;[] submissionQueue;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Lock protecting submissions array for addSubmission</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ReentrantLock submissionLock;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><code>ForkJoinPool</code>中也有一个队列<code>submissionQueue</code>，这个队列里存放的是有外部(非ForkJoin工作线程)提交到<code>ForkJoinPool</code>中的任务。<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * Index (mod submission queue length) of next element to take</span></span><br><span class="line"><span class="hljs-comment"> * from submission queue. Usage is identical to that for</span></span><br><span class="line"><span class="hljs-comment"> * per-worker queues -- see ForkJoinWorkerThread internal</span></span><br><span class="line"><span class="hljs-comment"> * documentation.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">volatile</span> <span class="hljs-keyword">int</span> queueBase;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * Index (mod submission queue length) of next element to add</span></span><br><span class="line"><span class="hljs-comment"> * in submission queue. Usage is identical to that for</span></span><br><span class="line"><span class="hljs-comment"> * per-worker queues -- see ForkJoinWorkerThread internal</span></span><br><span class="line"><span class="hljs-comment"> * documentation.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">int</span> queueTop;</span><br></pre></td></tr></table></figure></p>
<p>这两个域分别表示<code>submissionQueue</code>的底部和顶部。<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * True if use local fifo, not default lifo, for local polling</span></span><br><span class="line"><span class="hljs-comment"> * Read by, and replicated by ForkJoinWorkerThreads</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> locallyFifo;</span><br></pre></td></tr></table></figure></p>
<p><code>locallyFifo</code>域也比较重要，它有<code>ForkJoinPool</code>的构造方法的参数<code>asyncMode</code>来指定。如果<code>locallyFifo</code>为true，表示内部将才用FIFO的方式来调度任务队列中的任务，而且这些任务可以分裂(fork)，但最好不要合并(join)，这种模式很适合来处理事件形式(<code>event-style</code>)的异步任务。默认<code>locallyFifo</code>为false。</p>
<h1 id="2-ForkJoinWorkerThread属性"><a href="#2-ForkJoinWorkerThread属性" class="headerlink" title="2 ForkJoinWorkerThread属性"></a>2 ForkJoinWorkerThread属性</h1><p><code>ForkJoinWorkerThread</code>是ForkJoin框架中负责执行具体任务的工作线程。<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">    * Capacity of work-stealing queue array upon initialization.</span></span><br><span class="line"><span class="hljs-comment">    * Must be a power of two. Initial size must be at least 4, but is</span></span><br><span class="line"><span class="hljs-comment">    * padded to minimize cache effects.</span></span><br><span class="line"><span class="hljs-comment">    */</span></span><br><span class="line">   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> INITIAL_QUEUE_CAPACITY = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">13</span>;</span><br><span class="line"></span><br><span class="line">   <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">    * Maximum size for queue array. Must be a power of two</span></span><br><span class="line"><span class="hljs-comment">    * less than or equal to 1 &lt;&lt; (31 - width of array entry) to</span></span><br><span class="line"><span class="hljs-comment">    * ensure lack of index wraparound, but is capped at a lower</span></span><br><span class="line"><span class="hljs-comment">    * value to help users trap runaway computations.</span></span><br><span class="line"><span class="hljs-comment">    */</span></span><br><span class="line">   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> MAXIMUM_QUEUE_CAPACITY = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">24</span>; <span class="hljs-comment">// 16M</span></span><br><span class="line"></span><br><span class="line">   <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">    * The work-stealing queue array. Size must be a power of two.</span></span><br><span class="line"><span class="hljs-comment">    * Initialized when started (as oposed to when constructed), to</span></span><br><span class="line"><span class="hljs-comment">    * improve memory locality.</span></span><br><span class="line"><span class="hljs-comment">    */</span></span><br><span class="line">   ForkJoinTask&lt;?&gt;[] queue;</span><br><span class="line"></span><br><span class="line">   <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">    * The pool this thread works in. Accessed directly by ForkJoinTask.</span></span><br><span class="line"><span class="hljs-comment">    */</span></span><br><span class="line">   <span class="hljs-keyword">final</span> ForkJoinPool pool;</span><br><span class="line"></span><br><span class="line">   <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">    * Index (mod queue.length) of next queue slot to push to or pop</span></span><br><span class="line"><span class="hljs-comment">    * from. It is written only by owner thread, and accessed by other</span></span><br><span class="line"><span class="hljs-comment">    * threads only after reading (volatile) queueBase.  Both queueTop</span></span><br><span class="line"><span class="hljs-comment">    * and queueBase are allowed to wrap around on overflow, but</span></span><br><span class="line"><span class="hljs-comment">    * (queueTop - queueBase) still estimates size.</span></span><br><span class="line"><span class="hljs-comment">    */</span></span><br><span class="line">   <span class="hljs-keyword">int</span> queueTop;</span><br><span class="line"></span><br><span class="line">   <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">    * Index (mod queue.length) of least valid queue slot, which is</span></span><br><span class="line"><span class="hljs-comment">    * always the next position to steal from if nonempty.</span></span><br><span class="line"><span class="hljs-comment">    */</span></span><br><span class="line">   <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">int</span> queueBase;</span><br></pre></td></tr></table></figure></p>
<p><code>queue</code>就是<code>ForkJoinWorkerThread</code>中的任务队列，当从其他工作线程中窃取任务时，就是从这个队列中进行窃取。<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * Index of this worker in pool array. Set once by pool before</span></span><br><span class="line"><span class="hljs-comment"> * running, and accessed directly by pool to locate this worker in</span></span><br><span class="line"><span class="hljs-comment"> * its workers array.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> poolIndex;</span><br></pre></td></tr></table></figure></p>
<p>工作线程在<code>ForkJoinPool</code>中工作线程数组中的下标。<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * The index of most recent stealer, used as a hint to avoid</span></span><br><span class="line"><span class="hljs-comment"> * traversal in method helpJoinTask. This is only a hint because a</span></span><br><span class="line"><span class="hljs-comment"> * worker might have had multiple steals and this only holds one</span></span><br><span class="line"><span class="hljs-comment"> * of them (usually the most current). Declared non-volatile,</span></span><br><span class="line"><span class="hljs-comment"> * relying on other prevailing sync to keep reasonably current.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">int</span> stealHint;</span><br></pre></td></tr></table></figure></p>
<p><code>stealHint</code>保存了最近的窃取者(来窃取任务的工作线程)的下标(<code>poolIndex</code>)。注意这个值不准确，因为可能同时有很多窃取者来窃取任务，这个值只能记录其中之一。<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Encoded record for pool task waits. Usages are always</span></span><br><span class="line"><span class="hljs-comment">  * surrounded by volatile reads/writes</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-keyword">int</span> nextWait;</span><br></pre></td></tr></table></figure></p>
<p><code>nextWait</code>算是比较难理解的一个域。首先所有的等待工作线程组成了一个隐式的单链(代码中也叫Treiber stack，由于行为类似于栈)，链顶端的等待工作线程的信息保存在<code>Pool</code>的<code>ctl</code>中，新来的等待工作线程会将<code>ctl</code>中之前的等待工作线程信息保存到<code>nextWait</code>上，然后将自己的信息设置到<code>ctl</code>上。<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * True if use local fifo, not default lifo, for local polling.</span></span><br><span class="line"><span class="hljs-comment"> * Shadows value from ForkJoinPool.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> locallyFifo;</span><br></pre></td></tr></table></figure></p>
<p>这个和<code>ForkJoinPool#locallyFifo</code>一致。<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * The task most recently stolen from another worker (or</span></span><br><span class="line"><span class="hljs-comment"> * submission queue).  All uses are surrounded by enough volatile</span></span><br><span class="line"><span class="hljs-comment"> * reads/writes to maintain as non-volatile.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line">ForkJoinTask&lt;?&gt; currentSteal;</span><br></pre></td></tr></table></figure></p>
<p>当前工作线程最新窃取的任务。注意可以从其他工作线程的任务队列或者从<code>Pool</code>中的提交任务队列(<code>submissionQueue</code>)中窃取任务。<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * The task currently being joined, set only when actively trying</span></span><br><span class="line"><span class="hljs-comment">  * to help other stealers in helpJoinTask. All uses are surrounded</span></span><br><span class="line"><span class="hljs-comment">  * by enough volatile reads/writes to maintain as non-volatile.</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> ForkJoinTask&lt;?&gt; currentJoin;</span><br></pre></td></tr></table></figure></p>
<p>当前工作线程正在合并的任务。</p>
<h1 id="3-ForkJoinTask属性"><a href="#3-ForkJoinTask属性" class="headerlink" title="3 ForkJoinTask属性"></a>3 ForkJoinTask属性</h1><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment"> * The status field holds run control status bits packed into a</span></span><br><span class="line"><span class="hljs-comment"> * single int to minimize footprint and to ensure atomicity (via</span></span><br><span class="line"><span class="hljs-comment"> * CAS).  Status is initially zero, and takes on nonnegative</span></span><br><span class="line"><span class="hljs-comment"> * values until completed, upon which status holds value</span></span><br><span class="line"><span class="hljs-comment"> * NORMAL, CANCELLED, or EXCEPTIONAL. Tasks undergoing blocking</span></span><br><span class="line"><span class="hljs-comment"> * waits by other threads have the SIGNAL bit set.  Completion of</span></span><br><span class="line"><span class="hljs-comment"> * a stolen task with SIGNAL set awakens any waiters via</span></span><br><span class="line"><span class="hljs-comment"> * notifyAll. Even though suboptimal for some purposes, we use</span></span><br><span class="line"><span class="hljs-comment"> * basic builtin wait/notify to take advantage of "monitor</span></span><br><span class="line"><span class="hljs-comment"> * inflation" in JVMs that we would otherwise need to emulate to</span></span><br><span class="line"><span class="hljs-comment"> * avoid adding further per-task bookkeeping overhead.  We want</span></span><br><span class="line"><span class="hljs-comment"> * these monitors to be "fat", i.e., not use biasing or thin-lock</span></span><br><span class="line"><span class="hljs-comment"> * techniques, so use some odd coding idioms that tend to avoid</span></span><br><span class="line"><span class="hljs-comment"> * them.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/** The run status of this task */</span></span><br><span class="line"><span class="hljs-keyword">volatile</span> <span class="hljs-keyword">int</span> status; <span class="hljs-comment">// accessed directly by pool and workers</span></span><br><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> NORMAL      = -<span class="hljs-number">1</span>;</span><br><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> CANCELLED   = -<span class="hljs-number">2</span>;</span><br><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> EXCEPTIONAL = -<span class="hljs-number">3</span>;</span><br><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> SIGNAL      =  <span class="hljs-number">1</span>;</span><br></pre></td></tr></table></figure>
<p><code>ForkJoinTask</code>中只有一个表示运行状态的域。初始为0；1表示在等待被唤醒；负数都表示执行完毕。   </p>
<ul>
<li>-1表示正常完成。</li>
<li>-2表示被取消。</li>
<li>-3表示异常结束。<h1 id="4-非ForkJoin任务的执行过程"><a href="#4-非ForkJoin任务的执行过程" class="headerlink" title="4 非ForkJoin任务的执行过程"></a>4 非ForkJoin任务的执行过程</h1>非ForkJoin(Runnable或者Callable)任务的执行过程来分析ForkJoin的相关代码，注意这里说的非ForkJoin任务实际上也是<code>ForkJoinTask</code>，只是没有分裂(fork)/合并(join)过程。<h2 id="4-1-例"><a href="#4-1-例" class="headerlink" title="4.1 例"></a>4.1 例</h2>非ForkJoin任务的代码<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;  </span><br><span class="line">    ForkJoinPool forkJoinPool = <span class="hljs-keyword">new</span> ForkJoinPool();  </span><br><span class="line">    ForkJoinTask&lt;?&gt; task = forkJoinPool.submit(<span class="hljs-keyword">new</span> Runnable() &#123;  </span><br><span class="line">        <span class="hljs-meta">@Override</span>  </span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;  </span><br><span class="line">            System.out.println(<span class="hljs-string">"AAA"</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;);  </span><br><span class="line">    <span class="hljs-keyword">try</span> &#123;  </span><br><span class="line">        task.get();  </span><br><span class="line">        forkJoinPool.shutdown();  </span><br><span class="line">    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">        e.printStackTrace();  </span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>代码中提交了一个<code>Runnable</code>的任务到<code>ForkJoinPool</code>，任务的执行就是打印一句话。<br>下面就从提交一个<code>Runnable</code>的任务到<code>ForkJoinPool</code>，直到任务被执行的过程来分析源码。  </p>
<h2 id="4-2-ForkJoinPool"><a href="#4-2-ForkJoinPool" class="headerlink" title="4.2 ForkJoinPool"></a>4.2 ForkJoinPool</h2><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">.....</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * Creates a &#123;<span class="hljs-doctag">@code</span> ForkJoinPool&#125; with the given parameters.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> parallelism the parallelism level. For default value,</span></span><br><span class="line"><span class="hljs-comment"> * use &#123;<span class="hljs-doctag">@link</span> java.lang.Runtime#availableProcessors&#125;.</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> factory the factory for creating new threads. For default value,</span></span><br><span class="line"><span class="hljs-comment"> * use &#123;<span class="hljs-doctag">@link</span> #defaultForkJoinWorkerThreadFactory&#125;.</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> handler the handler for internal worker threads that</span></span><br><span class="line"><span class="hljs-comment"> * terminate due to unrecoverable errors encountered while executing</span></span><br><span class="line"><span class="hljs-comment"> * tasks. For default value, use &#123;<span class="hljs-doctag">@code</span> null&#125;.</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> asyncMode if true,</span></span><br><span class="line"><span class="hljs-comment"> * establishes local first-in-first-out scheduling mode for forked</span></span><br><span class="line"><span class="hljs-comment"> * tasks that are never joined. This mode may be more appropriate</span></span><br><span class="line"><span class="hljs-comment"> * than default locally stack-based mode in applications in which</span></span><br><span class="line"><span class="hljs-comment"> * worker threads only process event-style asynchronous tasks.</span></span><br><span class="line"><span class="hljs-comment"> * For default value, use &#123;<span class="hljs-doctag">@code</span> false&#125;.</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> IllegalArgumentException if parallelism less than or</span></span><br><span class="line"><span class="hljs-comment"> *         equal to zero, or greater than implementation limit</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> NullPointerException if the factory is null</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> SecurityException if a security manager exists and</span></span><br><span class="line"><span class="hljs-comment"> *         the caller is not permitted to modify threads</span></span><br><span class="line"><span class="hljs-comment"> *         because it does not hold &#123;<span class="hljs-doctag">@link</span></span></span><br><span class="line"><span class="hljs-comment"> *         java.lang.RuntimePermission&#125;&#123;<span class="hljs-doctag">@code</span> ("modifyThread")&#125;</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ForkJoinPool</span><span class="hljs-params">(<span class="hljs-keyword">int</span> parallelism,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                    ForkJoinWorkerThreadFactory factory,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                    Thread.UncaughtExceptionHandler handler,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                    <span class="hljs-keyword">boolean</span> asyncMode)</span> </span>&#123;</span><br><span class="line">    checkPermission();</span><br><span class="line">    <span class="hljs-keyword">if</span> (factory == <span class="hljs-keyword">null</span>)</span><br><span class="line">        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="hljs-keyword">if</span> (parallelism &lt;= <span class="hljs-number">0</span> || parallelism &gt; MAX_ID)</span><br><span class="line">        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="hljs-comment">// 1</span></span><br><span class="line">    <span class="hljs-keyword">this</span>.parallelism = parallelism;</span><br><span class="line">    <span class="hljs-comment">// 2</span></span><br><span class="line">    <span class="hljs-keyword">this</span>.factory = factory;</span><br><span class="line">    <span class="hljs-comment">// 3</span></span><br><span class="line">    <span class="hljs-keyword">this</span>.ueh = handler;</span><br><span class="line">    <span class="hljs-comment">// 4</span></span><br><span class="line">    <span class="hljs-keyword">this</span>.locallyFifo = asyncMode;</span><br><span class="line">    <span class="hljs-comment">// 5</span></span><br><span class="line">    <span class="hljs-keyword">long</span> np = (<span class="hljs-keyword">long</span>)(-parallelism); <span class="hljs-comment">// offset ctl counts</span></span><br><span class="line">    <span class="hljs-keyword">this</span>.ctl = ((np &lt;&lt; AC_SHIFT) &amp; AC_MASK) | ((np &lt;&lt; TC_SHIFT) &amp; TC_MASK);</span><br><span class="line">    <span class="hljs-comment">// 6</span></span><br><span class="line">    <span class="hljs-keyword">this</span>.submissionQueue = <span class="hljs-keyword">new</span> ForkJoinTask&lt;?&gt;[INITIAL_QUEUE_CAPACITY];</span><br><span class="line">    <span class="hljs-comment">// initialize workers array with room for 2*parallelism if possible</span></span><br><span class="line">    <span class="hljs-comment">// 7</span></span><br><span class="line">    <span class="hljs-keyword">int</span> n = parallelism &lt;&lt; <span class="hljs-number">1</span>;</span><br><span class="line">    <span class="hljs-keyword">if</span> (n &gt;= MAX_ID)</span><br><span class="line">        n = MAX_ID;</span><br><span class="line">    <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// See Hackers Delight, sec 3.2, where n &lt; (1 &lt;&lt; 16)</span></span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="hljs-number">1</span>; n |= n &gt;&gt;&gt; <span class="hljs-number">2</span>; n |= n &gt;&gt;&gt; <span class="hljs-number">4</span>; n |= n &gt;&gt;&gt; <span class="hljs-number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">// 8</span></span><br><span class="line">    workers = <span class="hljs-keyword">new</span> ForkJoinWorkerThread[n + <span class="hljs-number">1</span>];</span><br><span class="line">    <span class="hljs-keyword">this</span>.submissionLock = <span class="hljs-keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="hljs-keyword">this</span>.termination = submissionLock.newCondition();</span><br><span class="line">    <span class="hljs-comment">// 9</span></span><br><span class="line">    StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"ForkJoinPool-"</span>);</span><br><span class="line">    sb.append(poolNumberGenerator.incrementAndGet());</span><br><span class="line">    sb.append(<span class="hljs-string">"-worker-"</span>);</span><br><span class="line">    <span class="hljs-keyword">this</span>.workerNamePrefix = sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>标注代码分析</p>
<ol>
<li>设置并行度。</li>
<li>设置工作线程工厂。</li>
<li>设置线程未捕获异常处理器。</li>
<li>设置是否为异步模式。</li>
<li>参考我们之前介绍的<code>ctl</code>的内容，由于<code>ctl</code>中的<code>AC</code>表示当前活动。工作线程数量减去并行度，所以这里要将这个信息加到<code>ctl</code>上。 </li>
<li>初始化提交任务队列。</li>
<li>这里需要根据并行度来算出工作线程数组的大小。由于数组大小必须的2的幂，这里的算法是算出比。<code>parallelism</code>的2倍大的最小的2的幂，但不能超过。<code>MAX_ID + 1(1 &lt;&lt; 16)</code>的数作为工作线程数组大小。</li>
<li>创建存放工作线程的数组。</li>
<li>生成工作线程名称前缀。<h3 id="ForkJoinPool"><a href="#ForkJoinPool" class="headerlink" title="ForkJoinPool"></a>ForkJoinPool</h3></li>
</ol>
<ul>
<li>并行度如果未提供，默认就是当前处理器核数。</li>
<li>初始化控制信息的部分，注意在<code>AC</code>和<code>TC</code>的信息上减掉了并行度，比如如果并行度为4，那么初始的<code>AC</code>和<code>TC</code>就都是-4，那么如果后续发现<code>AC</code>等于0，就说明当前活动的线程数正好等于处理器核心数量。</li>
<li>确定工作线程数组大小的过程是这样的，首先取一个数n，默认是并行度的2倍。然后会使用来自<code>HD</code>的一个位操作技巧，就是将n的位模式的前导1后面所有的位都变成1，其实就是一个比n大的2的幂减1的数。当然n最大不能超过<code>MAX_ID</code>，最终数组的大小是<code>n+1</code>，是一个2的幂，能简化后续的取模操作。<h3 id="ForkJoinPool默认的工作线程工厂"><a href="#ForkJoinPool默认的工作线程工厂" class="headerlink" title="ForkJoinPool默认的工作线程工厂"></a>ForkJoinPool默认的工作线程工厂</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">static</span> &#123;</span><br><span class="line">       poolNumberGenerator = <span class="hljs-keyword">new</span> AtomicInteger();</span><br><span class="line">       workerSeedGenerator = <span class="hljs-keyword">new</span> Random();</span><br><span class="line">       modifyThreadPermission = <span class="hljs-keyword">new</span> RuntimePermission(<span class="hljs-string">"modifyThread"</span>);</span><br><span class="line">       defaultForkJoinWorkerThreadFactory =</span><br><span class="line">           <span class="hljs-keyword">new</span> DefaultForkJoinWorkerThreadFactory();</span><br><span class="line">       <span class="hljs-keyword">int</span> s;</span><br><span class="line">       <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">           UNSAFE = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">           Class k = ForkJoinPool.class;</span><br><span class="line">           ctlOffset = UNSAFE.objectFieldOffset</span><br><span class="line">               (k.getDeclaredField(<span class="hljs-string">"ctl"</span>));</span><br><span class="line">           stealCountOffset = UNSAFE.objectFieldOffset</span><br><span class="line">               (k.getDeclaredField(<span class="hljs-string">"stealCount"</span>));</span><br><span class="line">           blockedCountOffset = UNSAFE.objectFieldOffset</span><br><span class="line">               (k.getDeclaredField(<span class="hljs-string">"blockedCount"</span>));</span><br><span class="line">           quiescerCountOffset = UNSAFE.objectFieldOffset</span><br><span class="line">               (k.getDeclaredField(<span class="hljs-string">"quiescerCount"</span>));</span><br><span class="line">           scanGuardOffset = UNSAFE.objectFieldOffset</span><br><span class="line">               (k.getDeclaredField(<span class="hljs-string">"scanGuard"</span>));</span><br><span class="line">           nextWorkerNumberOffset = UNSAFE.objectFieldOffset</span><br><span class="line">               (k.getDeclaredField(<span class="hljs-string">"nextWorkerNumber"</span>));</span><br><span class="line">           Class a = ForkJoinTask[].class;</span><br><span class="line">           ABASE = UNSAFE.arrayBaseOffset(a);</span><br><span class="line">           s = UNSAFE.arrayIndexScale(a);</span><br><span class="line">       &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(e);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="hljs-keyword">if</span> ((s &amp; (s-<span class="hljs-number">1</span>)) != <span class="hljs-number">0</span>)</span><br><span class="line">           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"data type scale not a power of two"</span>);</span><br><span class="line">       ASHIFT = <span class="hljs-number">31</span> - Integer.numberOfLeadingZeros(s);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * Default ForkJoinWorkerThreadFactory implementation; creates a</span></span><br><span class="line"><span class="hljs-comment"> * new ForkJoinWorkerThread.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefaultForkJoinWorkerThreadFactory</span></span></span><br><span class="line"><span class="hljs-class">    <span class="hljs-keyword">implements</span> <span class="hljs-title">ForkJoinWorkerThreadFactory</span> </span>&#123;</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> ForkJoinWorkerThread <span class="hljs-title">newThread</span><span class="hljs-params">(ForkJoinPool pool)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ForkJoinWorkerThread(pool);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * Factory for creating new &#123;<span class="hljs-doctag">@link</span> ForkJoinWorkerThread&#125;s.</span></span><br><span class="line"><span class="hljs-comment"> * A &#123;<span class="hljs-doctag">@code</span> ForkJoinWorkerThreadFactory&#125; must be defined and used</span></span><br><span class="line"><span class="hljs-comment"> * for &#123;<span class="hljs-doctag">@code</span> ForkJoinWorkerThread&#125; subclasses that extend base</span></span><br><span class="line"><span class="hljs-comment"> * functionality or initialize threads with different contexts.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ForkJoinWorkerThreadFactory</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Returns a new worker thread operating in the given pool.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pool the pool this thread works in</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException if the pool is null</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> ForkJoinWorkerThread <span class="hljs-title">newThread</span><span class="hljs-params">(ForkJoinPool pool)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ForkJoinPool-submit"><a href="#ForkJoinPool-submit" class="headerlink" title="ForkJoinPool#submit()"></a>ForkJoinPool#submit()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Submits a ForkJoinTask for execution.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> task the task to submit</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the task</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException if the task is null</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> RejectedExecutionException if the task cannot be</span></span><br><span class="line"><span class="hljs-comment">     *         scheduled for execution</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">ForkJoinTask&lt;T&gt; <span class="hljs-title">submit</span><span class="hljs-params">(ForkJoinTask&lt;T&gt; task)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (task == <span class="hljs-keyword">null</span>)</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException();</span><br><span class="line">        forkOrSubmit(task);</span><br><span class="line">        <span class="hljs-keyword">return</span> task;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException if the task is null</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> RejectedExecutionException if the task cannot be</span></span><br><span class="line"><span class="hljs-comment">     *         scheduled for execution</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">ForkJoinTask&lt;T&gt; <span class="hljs-title">submit</span><span class="hljs-params">(Callable&lt;T&gt; task)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (task == <span class="hljs-keyword">null</span>)</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException();</span><br><span class="line">        ForkJoinTask&lt;T&gt; job = ForkJoinTask.adapt(task);</span><br><span class="line">        forkOrSubmit(job);</span><br><span class="line">        <span class="hljs-keyword">return</span> job;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException if the task is null</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> RejectedExecutionException if the task cannot be</span></span><br><span class="line"><span class="hljs-comment">     *         scheduled for execution</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">ForkJoinTask&lt;T&gt; <span class="hljs-title">submit</span><span class="hljs-params">(Runnable task, T result)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (task == <span class="hljs-keyword">null</span>)</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException();</span><br><span class="line">        ForkJoinTask&lt;T&gt; job = ForkJoinTask.adapt(task, result);</span><br><span class="line">        forkOrSubmit(job);</span><br><span class="line">        <span class="hljs-keyword">return</span> job;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException if the task is null</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> RejectedExecutionException if the task cannot be</span></span><br><span class="line"><span class="hljs-comment">     *         scheduled for execution</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> ForkJoinTask&lt;?&gt; submit(Runnable task) &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (task == <span class="hljs-keyword">null</span>)</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException();</span><br><span class="line">        ForkJoinTask&lt;?&gt; job;</span><br><span class="line">        <span class="hljs-keyword">if</span> (task <span class="hljs-keyword">instanceof</span> ForkJoinTask&lt;?&gt;) <span class="hljs-comment">// avoid re-wrap</span></span><br><span class="line">            job = (ForkJoinTask&lt;?&gt;) task;</span><br><span class="line">        <span class="hljs-keyword">else</span></span><br><span class="line">            job = ForkJoinTask.adapt(task, <span class="hljs-keyword">null</span>);</span><br><span class="line">        forkOrSubmit(job);</span><br><span class="line">        <span class="hljs-keyword">return</span> job;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><code>ForkJoinPool</code>中定义了一些列重载的<code>submit()</code>，这些<code>submit()</code>在<code>ForkJoinTask</code>内部会先将<code>Callable</code>、<code>Runnable</code>包装(适配)成<code>ForkJoinTask</code>，然后再进行提交。</p>
<h3 id="ForkJoinTask-adapt"><a href="#ForkJoinTask-adapt" class="headerlink" title="ForkJoinTask#adapt()"></a>ForkJoinTask#adapt()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">    * Returns a new &#123;<span class="hljs-doctag">@code</span> ForkJoinTask&#125; that performs the &#123;<span class="hljs-doctag">@code</span> run&#125;</span></span><br><span class="line"><span class="hljs-comment">    * method of the given &#123;<span class="hljs-doctag">@code</span> Runnable&#125; as its action, and returns</span></span><br><span class="line"><span class="hljs-comment">    * a null result upon &#123;<span class="hljs-doctag">@link</span> #join&#125;.</span></span><br><span class="line"><span class="hljs-comment">    *</span></span><br><span class="line"><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> runnable the runnable action</span></span><br><span class="line"><span class="hljs-comment">    * <span class="hljs-doctag">@return</span> the task</span></span><br><span class="line"><span class="hljs-comment">    */</span></span><br><span class="line">   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ForkJoinTask&lt;?&gt; adapt(Runnable runnable) &#123;</span><br><span class="line">       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AdaptedRunnable&lt;Void&gt;(runnable, <span class="hljs-keyword">null</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">    * Returns a new &#123;<span class="hljs-doctag">@code</span> ForkJoinTask&#125; that performs the &#123;<span class="hljs-doctag">@code</span> run&#125;</span></span><br><span class="line"><span class="hljs-comment">    * method of the given &#123;<span class="hljs-doctag">@code</span> Runnable&#125; as its action, and returns</span></span><br><span class="line"><span class="hljs-comment">    * the given result upon &#123;<span class="hljs-doctag">@link</span> #join&#125;.</span></span><br><span class="line"><span class="hljs-comment">    *</span></span><br><span class="line"><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> runnable the runnable action</span></span><br><span class="line"><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> result the result upon completion</span></span><br><span class="line"><span class="hljs-comment">    * <span class="hljs-doctag">@return</span> the task</span></span><br><span class="line"><span class="hljs-comment">    */</span></span><br><span class="line">   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-function">ForkJoinTask&lt;T&gt; <span class="hljs-title">adapt</span><span class="hljs-params">(Runnable runnable, T result)</span> </span>&#123;</span><br><span class="line">       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AdaptedRunnable&lt;T&gt;(runnable, result);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">    * Returns a new &#123;<span class="hljs-doctag">@code</span> ForkJoinTask&#125; that performs the &#123;<span class="hljs-doctag">@code</span> call&#125;</span></span><br><span class="line"><span class="hljs-comment">    * method of the given &#123;<span class="hljs-doctag">@code</span> Callable&#125; as its action, and returns</span></span><br><span class="line"><span class="hljs-comment">    * its result upon &#123;<span class="hljs-doctag">@link</span> #join&#125;, translating any checked exceptions</span></span><br><span class="line"><span class="hljs-comment">    * encountered into &#123;<span class="hljs-doctag">@code</span> RuntimeException&#125;.</span></span><br><span class="line"><span class="hljs-comment">    *</span></span><br><span class="line"><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> callable the callable action</span></span><br><span class="line"><span class="hljs-comment">    * <span class="hljs-doctag">@return</span> the task</span></span><br><span class="line"><span class="hljs-comment">    */</span></span><br><span class="line">   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-function">ForkJoinTask&lt;T&gt; <span class="hljs-title">adapt</span><span class="hljs-params">(Callable&lt;? extends T&gt; callable)</span> </span>&#123;</span><br><span class="line">       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AdaptedCallable&lt;T&gt;(callable);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="ForkJoinTask-AdaptedCallable"><a href="#ForkJoinTask-AdaptedCallable" class="headerlink" title="ForkJoinTask#AdaptedCallable()"></a>ForkJoinTask#AdaptedCallable()</h3><p><code>Callable</code>会包装成一个<code>AdaptedCallable</code>。<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Adaptor for Callables</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdaptedCallable</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">ForkJoinTask</span>&lt;<span class="hljs-title">T</span>&gt;</span></span><br><span class="line"><span class="hljs-class">        <span class="hljs-keyword">implements</span> <span class="hljs-title">RunnableFuture</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> Callable&lt;? extends T&gt; callable;</span><br><span class="line">        T result;</span><br><span class="line">        AdaptedCallable(Callable&lt;? extends T&gt; callable) &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (callable == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException();</span><br><span class="line">            <span class="hljs-keyword">this</span>.callable = callable;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">getRawResult</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> result; &#125;</span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setRawResult</span><span class="hljs-params">(T v)</span> </span>&#123; result = v; &#125;</span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">exec</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                result = callable.call();</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line">            &#125; <span class="hljs-keyword">catch</span> (Error err) &#123;</span><br><span class="line">                <span class="hljs-keyword">throw</span> err;</span><br><span class="line">            &#125; <span class="hljs-keyword">catch</span> (RuntimeException rex) &#123;</span><br><span class="line">                <span class="hljs-keyword">throw</span> rex;</span><br><span class="line">            &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123; invoke(); &#125;</span><br><span class="line">        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = <span class="hljs-number">2838392045355241008L</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="ForkJoinTask-AdaptedRunnable"><a href="#ForkJoinTask-AdaptedRunnable" class="headerlink" title="ForkJoinTask#AdaptedRunnable()"></a>ForkJoinTask#AdaptedRunnable()</h3><p><code>Runnable</code>会包装成一个<code>AdaptedRunnable</code>。<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * Adaptor for Runnables. This implements RunnableFuture</span></span><br><span class="line"><span class="hljs-comment"> * to be compliant with AbstractExecutorService constraints</span></span><br><span class="line"><span class="hljs-comment"> * when used in ForkJoinPool.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdaptedRunnable</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">ForkJoinTask</span>&lt;<span class="hljs-title">T</span>&gt;</span></span><br><span class="line"><span class="hljs-class">    <span class="hljs-keyword">implements</span> <span class="hljs-title">RunnableFuture</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">final</span> Runnable runnable;</span><br><span class="line">    <span class="hljs-keyword">final</span> T resultOnCompletion;</span><br><span class="line">    T result;</span><br><span class="line">    AdaptedRunnable(Runnable runnable, T result) &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (runnable == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="hljs-keyword">this</span>.runnable = runnable;</span><br><span class="line">        <span class="hljs-keyword">this</span>.resultOnCompletion = result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">getRawResult</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> result; &#125;</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setRawResult</span><span class="hljs-params">(T v)</span> </span>&#123; result = v; &#125;</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">exec</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        runnable.run();</span><br><span class="line">        result = resultOnCompletion;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123; invoke(); &#125;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = <span class="hljs-number">5232453952276885070L</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="ForkJoinPool-forkOrSubmit"><a href="#ForkJoinPool-forkOrSubmit" class="headerlink" title="ForkJoinPool#forkOrSubmit()"></a>ForkJoinPool#forkOrSubmit()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Unless terminating, forks task if within an ongoing FJ</span></span><br><span class="line"><span class="hljs-comment">  * computation in the current pool, else submits as external task.</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-keyword">private</span> &lt;T&gt; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">forkOrSubmit</span><span class="hljs-params">(ForkJoinTask&lt;T&gt; task)</span> </span>&#123;</span><br><span class="line">     ForkJoinWorkerThread w;</span><br><span class="line">     Thread t = Thread.currentThread();</span><br><span class="line">     <span class="hljs-keyword">if</span> (shutdown)</span><br><span class="line">         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RejectedExecutionException();</span><br><span class="line">     <span class="hljs-keyword">if</span> ((t <span class="hljs-keyword">instanceof</span> ForkJoinWorkerThread) &amp;&amp;</span><br><span class="line">         (w = (ForkJoinWorkerThread)t).pool == <span class="hljs-keyword">this</span>)</span><br><span class="line">         w.pushTask(task);</span><br><span class="line">     <span class="hljs-keyword">else</span></span><br><span class="line">         addSubmission(task);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>如果当前线程是ForkJoin工作线程，说明是在<code>ForkJoinTask</code>内部提交的任务(比如分裂出子任务然后提交执行)，这种情况下会将任务添加到工作线程的任务队列中；如果当前线程不是ForkJoin工作线程，说明是初始提交ForkJoin任务(外部将<code>ForkJoinTask</code>初次提交给<code>ForkJoinPool</code>)，这种情况下会将任务添加到<code>ForkJoinPool</code>的任务队列中。</p>
<h3 id="ForkJoinPool-addSubmission"><a href="#ForkJoinPool-addSubmission" class="headerlink" title="ForkJoinPool#addSubmission()"></a>ForkJoinPool#addSubmission()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Enqueues the given task in the submissionQueue.  Same idea as</span></span><br><span class="line"><span class="hljs-comment">  * ForkJoinWorkerThread.pushTask except for use of submissionLock.</span></span><br><span class="line"><span class="hljs-comment">  *</span></span><br><span class="line"><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> t the task</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addSubmission</span><span class="hljs-params">(ForkJoinTask&lt;?&gt; t)</span> </span>&#123;</span><br><span class="line">     <span class="hljs-keyword">final</span> ReentrantLock lock = <span class="hljs-keyword">this</span>.submissionLock;</span><br><span class="line">     lock.lock();</span><br><span class="line">     <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">         ForkJoinTask&lt;?&gt;[] q; <span class="hljs-keyword">int</span> s, m;</span><br><span class="line">         <span class="hljs-keyword">if</span> ((q = submissionQueue) != <span class="hljs-keyword">null</span>) &#123;    <span class="hljs-comment">// ignore if queue removed</span></span><br><span class="line">             <span class="hljs-comment">// 1</span></span><br><span class="line">             <span class="hljs-keyword">long</span> u = (((s = queueTop) &amp; (m = q.length-<span class="hljs-number">1</span>)) &lt;&lt; ASHIFT)+ABASE;</span><br><span class="line">             <span class="hljs-comment">// 2</span></span><br><span class="line">             UNSAFE.putOrderedObject(q, u, t);</span><br><span class="line">             queueTop = s + <span class="hljs-number">1</span>;</span><br><span class="line">             <span class="hljs-keyword">if</span> (s - queueBase == m)</span><br><span class="line">                 <span class="hljs-comment">// 3</span></span><br><span class="line">                 growSubmissionQueue();</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">         lock.unlock();</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="hljs-comment">// 4</span></span><br><span class="line">     signalWork();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>标注代码分析</p>
<ol>
<li>这步计算内存偏移地址。</li>
<li>将t设置到q的对应位置。(LazySet) </li>
<li>如果队列满了，扩展队列。 </li>
<li>唤醒工作线程。  <h4 id="addSubmission"><a href="#addSubmission" class="headerlink" title="addSubmission()"></a>addSubmission()</h4>添加一个任务到提交任务队列(过程要加锁)，如果队列满了，扩展一下。然后唤醒工作线程。<br>这时候是非fork-join提交任务。在<code>forkOrSubmit()</code>中一定会走<code>addSubmission()</code>的分支。<br>代码可以看到通过<code>Unsafe</code>设置<code>Task</code>到数组的方式，之后所有的设置任务到数组都会采取这种方式，之所以这样做是为了提高性能：这种方式其实和数组原子量(<code>AtomicReferenceArray</code>)中一致，但减少了2方面的性能损耗。</li>
</ol>
<ul>
<li>不用像<code>AtomicReferenceArray</code>内部一样再做边界检测(由外部保证)。</li>
<li>由于队列最大容量的限制(工作线程中的任务队列也一样)，不用像<code>AtomicReferenceArray</code>一样在计算偏移量过程中不会进行从<code>int</code>到<code>long</code>的提升。<h3 id="ForkJoinPool-growSubmissionQueue"><a href="#ForkJoinPool-growSubmissionQueue" class="headerlink" title="ForkJoinPool#growSubmissionQueue()"></a>ForkJoinPool#growSubmissionQueue()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">    * Creates or doubles submissionQueue array.</span></span><br><span class="line"><span class="hljs-comment">    * Basically identical to ForkJoinWorkerThread version.</span></span><br><span class="line"><span class="hljs-comment">    */</span></span><br><span class="line">   <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">growSubmissionQueue</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">       ForkJoinTask&lt;?&gt;[] oldQ = submissionQueue;</span><br><span class="line">       <span class="hljs-keyword">int</span> size = oldQ != <span class="hljs-keyword">null</span> ? oldQ.length &lt;&lt; <span class="hljs-number">1</span> : INITIAL_QUEUE_CAPACITY;</span><br><span class="line">       <span class="hljs-keyword">if</span> (size &gt; MAXIMUM_QUEUE_CAPACITY)</span><br><span class="line">           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RejectedExecutionException(<span class="hljs-string">"Queue capacity exceeded"</span>);</span><br><span class="line">       <span class="hljs-keyword">if</span> (size &lt; INITIAL_QUEUE_CAPACITY)</span><br><span class="line">           size = INITIAL_QUEUE_CAPACITY;</span><br><span class="line">       ForkJoinTask&lt;?&gt;[] q = submissionQueue = <span class="hljs-keyword">new</span> ForkJoinTask&lt;?&gt;[size];</span><br><span class="line">       <span class="hljs-keyword">int</span> mask = size - <span class="hljs-number">1</span>;</span><br><span class="line">       <span class="hljs-keyword">int</span> top = queueTop;</span><br><span class="line">       <span class="hljs-keyword">int</span> oldMask;</span><br><span class="line">       <span class="hljs-keyword">if</span> (oldQ != <span class="hljs-keyword">null</span> &amp;&amp; (oldMask = oldQ.length - <span class="hljs-number">1</span>) &gt;= <span class="hljs-number">0</span>) &#123;</span><br><span class="line">           <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> b = queueBase; b != top; ++b) &#123;</span><br><span class="line">               <span class="hljs-keyword">long</span> u = ((b &amp; oldMask) &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">               Object x = UNSAFE.getObjectVolatile(oldQ, u);</span><br><span class="line">               <span class="hljs-keyword">if</span> (x != <span class="hljs-keyword">null</span> &amp;&amp; UNSAFE.compareAndSwapObject(oldQ, u, x, <span class="hljs-keyword">null</span>))</span><br><span class="line">                   UNSAFE.putObjectVolatile</span><br><span class="line">                       (q, ((b &amp; mask) &lt;&lt; ASHIFT) + ABASE, x);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>很容易看懂，最小容量为<code>INITIAL_QUEUE_CAPACITY = 8</code>，每次扩展为原来的2倍，最大不能超过<code>MAXIMUM_QUEUE_CAPACITY = 1 &lt;&lt; 24(16777216)</code>。<br>现在任务已经提交到<code>ForkJoinPool#submissionQueue()</code>。还会执行一个唤醒工作线程的动作，这样就会有工作线程来执行我们提交的任务了。</p>
<h3 id="ForkJoinPool-signalWork"><a href="#ForkJoinPool-signalWork" class="headerlink" title="ForkJoinPool#signalWork()"></a>ForkJoinPool#signalWork()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">    * Wakes up or creates a worker.</span></span><br><span class="line"><span class="hljs-comment">    */</span></span><br><span class="line">   <span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">signalWork</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">       <span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">        * The while condition is true if: (there is are too few total</span></span><br><span class="line"><span class="hljs-comment">        * workers OR there is at least one waiter) AND (there are too</span></span><br><span class="line"><span class="hljs-comment">        * few active workers OR the pool is terminating).  The value</span></span><br><span class="line"><span class="hljs-comment">        * of e distinguishes the remaining cases: zero (no waiters)</span></span><br><span class="line"><span class="hljs-comment">        * for create, negative if terminating (in which case do</span></span><br><span class="line"><span class="hljs-comment">        * nothing), else release a waiter. The secondary checks for</span></span><br><span class="line"><span class="hljs-comment">        * release (non-null array etc) can fail if the pool begins</span></span><br><span class="line"><span class="hljs-comment">        * terminating after the test, and don't impose any added cost</span></span><br><span class="line"><span class="hljs-comment">        * because JVMs must perform null and bounds checks anyway.</span></span><br><span class="line"><span class="hljs-comment">        */</span></span><br><span class="line">       <span class="hljs-keyword">long</span> c; <span class="hljs-keyword">int</span> e, u;</span><br><span class="line">       <span class="hljs-comment">// 0</span></span><br><span class="line">       <span class="hljs-keyword">while</span> ((((e = (<span class="hljs-keyword">int</span>)(c = ctl)) | (u = (<span class="hljs-keyword">int</span>)(c &gt;&gt;&gt; <span class="hljs-number">32</span>))) &amp;</span><br><span class="line">               (INT_SIGN|SHORT_SIGN)) == (INT_SIGN|SHORT_SIGN) &amp;&amp; e &gt;= <span class="hljs-number">0</span>) &#123;</span><br><span class="line">           <span class="hljs-keyword">if</span> (e &gt; <span class="hljs-number">0</span>) &#123;                         <span class="hljs-comment">// release a waiting worker</span></span><br><span class="line">               <span class="hljs-comment">// 1</span></span><br><span class="line">               <span class="hljs-keyword">int</span> i; ForkJoinWorkerThread w; ForkJoinWorkerThread[] ws;</span><br><span class="line">               <span class="hljs-comment">// 2</span></span><br><span class="line">               <span class="hljs-keyword">if</span> ((ws = workers) == <span class="hljs-keyword">null</span> ||</span><br><span class="line">                   (i = ~e &amp; SMASK) &gt;= ws.length ||</span><br><span class="line">                   (w = ws[i]) == <span class="hljs-keyword">null</span>)</span><br><span class="line">                   <span class="hljs-keyword">break</span>;</span><br><span class="line">               <span class="hljs-comment">// 3</span></span><br><span class="line">               <span class="hljs-keyword">long</span> nc = (((<span class="hljs-keyword">long</span>)(w.nextWait &amp; E_MASK)) |</span><br><span class="line">                          ((<span class="hljs-keyword">long</span>)(u + UAC_UNIT) &lt;&lt; <span class="hljs-number">32</span>));</span><br><span class="line">               <span class="hljs-keyword">if</span> (w.eventCount == e &amp;&amp;</span><br><span class="line">                   UNSAFE.compareAndSwapLong(<span class="hljs-keyword">this</span>, ctlOffset, c, nc)) &#123;</span><br><span class="line">                   <span class="hljs-comment">// 4</span></span><br><span class="line">                   w.eventCount = (e + EC_UNIT) &amp; E_MASK;</span><br><span class="line">                   <span class="hljs-keyword">if</span> (w.parked)</span><br><span class="line">                       <span class="hljs-comment">// 5</span></span><br><span class="line">                       UNSAFE.unpark(w);</span><br><span class="line">                   <span class="hljs-keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;<span class="hljs-comment">//6</span></span><br><span class="line">           <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (UNSAFE.compareAndSwapLong</span><br><span class="line">                    (<span class="hljs-keyword">this</span>, ctlOffset, c,</span><br><span class="line">                     (<span class="hljs-keyword">long</span>)(((u + UTC_UNIT) &amp; UTC_MASK) |</span><br><span class="line">                            ((u + UAC_UNIT) &amp; UAC_MASK)) &lt;&lt; <span class="hljs-number">32</span>)) &#123;</span><br><span class="line">               <span class="hljs-comment">// 8</span></span><br><span class="line">               addWorker();</span><br><span class="line">               <span class="hljs-keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>标注代码分析</p>
<ol>
<li>唤醒一个等待的工作线程。</li>
<li>等待工作线程的下标比<code>workers</code>的<code>size</code>大||获取不到等待线程。</li>
<li>将Treiber stack中下一个等待线程的信息(下标)放到控制信息上||控制信息上添加一个<code>AC</code>计数。</li>
<li>累加w的等待次数。</li>
<li>唤醒w。</li>
<li>添加一个工作线程。CAS操作累加控制信息上<code>AC</code>和<code>TC</code>。</li>
<li>添加工作线程。  <h4 id="signalWork"><a href="#signalWork" class="headerlink" title="signalWork"></a>signalWork</h4><h5 id="标注0"><a href="#标注0" class="headerlink" title="标注0"></a>标注0</h5>while循环内部由e来区分，当<code>e==0</code>，表示当前没有等待的工作线程，这种情况下要创建一个工作线程；当<code>e&gt;0</code>，说明当前有等待线程，这种情况下唤醒一下等待的工作线程。  <h5 id="e-gt-0前代码"><a href="#e-gt-0前代码" class="headerlink" title="e&gt;=0前代码"></a>e&gt;=0前代码</h5></li>
</ol>
<ul>
<li>当e的第32位<code>bit</code>为1或者u的第32位<code>bit</code>为1 并且 e的第16位<code>bit</code>为1或者u的第16位<code>bit</code>为1，结合上一篇我们了解到的<code>ForkJoinPool</code>中的控制信息可知。</li>
<li>e的第32位<code>bit</code>为1，说明<code>ST</code>为1，表示当前<code>ForkJoinPool</code>正在关闭。</li>
<li>u的第32位<code>bit</code>为1，说明<code>AC</code>为负数，表示没有足够多的活动的工作线程。</li>
<li>e的第16位<code>bit</code>为1，说明<code>ID</code>为负数，表示至少有一个等待线程。</li>
<li>u的第16位<code>bit</code>为1，说明<code>TC</code>为负数，表示没有足够多的(总的)工作线程。<h5 id="e-gt-0代码"><a href="#e-gt-0代码" class="headerlink" title="e&gt;=0代码"></a>e&gt;=0代码</h5></li>
<li>排除了当前<code>ForkJoinPool</code>正在关闭的情况。<h3 id="ForkJoinPool-addWorker"><a href="#ForkJoinPool-addWorker" class="headerlink" title="ForkJoinPool#addWorker()"></a>ForkJoinPool#addWorker()</h3>新创建的<code>Pool</code>，里面还没有工作线程，所以<code>signalWork()</code>中一定会走添加工作线程的流程。<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Tries to create and start a worker; minimally rolls back counts</span></span><br><span class="line"><span class="hljs-comment">  * on failure.</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addWorker</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">     Throwable ex = <span class="hljs-keyword">null</span>;</span><br><span class="line">     ForkJoinWorkerThread t = <span class="hljs-keyword">null</span>;</span><br><span class="line">     <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">         t = factory.newThread(<span class="hljs-keyword">this</span>);</span><br><span class="line">     &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">         ex = e;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="hljs-keyword">if</span> (t == <span class="hljs-keyword">null</span>) &#123;  <span class="hljs-comment">// null or exceptional factory return</span></span><br><span class="line">         <span class="hljs-comment">// 1</span></span><br><span class="line">         <span class="hljs-keyword">long</span> c;       <span class="hljs-comment">// adjust counts</span></span><br><span class="line">         <span class="hljs-keyword">do</span> &#123;&#125; <span class="hljs-keyword">while</span> (!UNSAFE.compareAndSwapLong</span><br><span class="line">                      (<span class="hljs-keyword">this</span>, ctlOffset, c = ctl,</span><br><span class="line">                       (((c - AC_UNIT) &amp; AC_MASK) |</span><br><span class="line">                        ((c - TC_UNIT) &amp; TC_MASK) |</span><br><span class="line">                        (c &amp; ~(AC_MASK|TC_MASK)))));</span><br><span class="line">         <span class="hljs-comment">// Propagate exception if originating from an external caller</span></span><br><span class="line">         <span class="hljs-comment">// 2</span></span><br><span class="line">         <span class="hljs-keyword">if</span> (!tryTerminate(<span class="hljs-keyword">false</span>) &amp;&amp; ex != <span class="hljs-keyword">null</span> &amp;&amp;</span><br><span class="line">             !(Thread.currentThread() <span class="hljs-keyword">instanceof</span> ForkJoinWorkerThread))</span><br><span class="line">             UNSAFE.throwException(ex);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="hljs-keyword">else</span> <span class="hljs-comment">// 3</span></span><br><span class="line">         t.start();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>标注代码分析</p>
<ol>
<li>如果发生了异常导致工作线程创建失败，需要把之前累加的到控制信息的<code>AC</code>和<code>TC</code>计数减回去。</li>
<li>如果调用来之外部，需要将异常传递出去。</li>
<li>创建成功的话，启动工作线程。<h3 id="ForkJoinPool-ForkJoinWorkerThreadFactory-newThread"><a href="#ForkJoinPool-ForkJoinWorkerThreadFactory-newThread" class="headerlink" title="ForkJoinPool#ForkJoinWorkerThreadFactory#newThread()"></a>ForkJoinPool#ForkJoinWorkerThreadFactory#newThread()</h3>工作线程的创建过程。调用<code>ForkJoinWorkerThread</code>的构造方法。<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">    * Factory for creating new &#123;<span class="hljs-doctag">@link</span> ForkJoinWorkerThread&#125;s.</span></span><br><span class="line"><span class="hljs-comment">    * A &#123;<span class="hljs-doctag">@code</span> ForkJoinWorkerThreadFactory&#125; must be defined and used</span></span><br><span class="line"><span class="hljs-comment">    * for &#123;<span class="hljs-doctag">@code</span> ForkJoinWorkerThread&#125; subclasses that extend base</span></span><br><span class="line"><span class="hljs-comment">    * functionality or initialize threads with different contexts.</span></span><br><span class="line"><span class="hljs-comment">    */</span></span><br><span class="line">   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ForkJoinWorkerThreadFactory</span> </span>&#123;</span><br><span class="line">       <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">        * Returns a new worker thread operating in the given pool.</span></span><br><span class="line"><span class="hljs-comment">        *</span></span><br><span class="line"><span class="hljs-comment">        * <span class="hljs-doctag">@param</span> pool the pool this thread works in</span></span><br><span class="line"><span class="hljs-comment">        * <span class="hljs-doctag">@throws</span> NullPointerException if the pool is null</span></span><br><span class="line"><span class="hljs-comment">        */</span></span><br><span class="line">       <span class="hljs-function"><span class="hljs-keyword">public</span> ForkJoinWorkerThread <span class="hljs-title">newThread</span><span class="hljs-params">(ForkJoinPool pool)</span></span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">    * Default ForkJoinWorkerThreadFactory implementation; creates a</span></span><br><span class="line"><span class="hljs-comment">    * new ForkJoinWorkerThread.</span></span><br><span class="line"><span class="hljs-comment">    */</span></span><br><span class="line">   <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefaultForkJoinWorkerThreadFactory</span></span></span><br><span class="line"><span class="hljs-class">       <span class="hljs-keyword">implements</span> <span class="hljs-title">ForkJoinWorkerThreadFactory</span> </span>&#123;</span><br><span class="line">       <span class="hljs-function"><span class="hljs-keyword">public</span> ForkJoinWorkerThread <span class="hljs-title">newThread</span><span class="hljs-params">(ForkJoinPool pool)</span> </span>&#123;</span><br><span class="line">           <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ForkJoinWorkerThread(pool);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="ForkJoinPool-nextWorkerName"><a href="#ForkJoinPool-nextWorkerName" class="headerlink" title="ForkJoinPool#nextWorkerName()"></a>ForkJoinPool#nextWorkerName()</h3><p>设置线程名称<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Counter for worker Thread names (unrelated to their poolIndex)</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">int</span> nextWorkerNumber; </span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Callback from ForkJoinWorkerThread constructor to assign a</span></span><br><span class="line"><span class="hljs-comment">  * public name</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">final</span> String <span class="hljs-title">nextWorkerName</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">     <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> n;;) &#123;</span><br><span class="line">         <span class="hljs-keyword">if</span> (UNSAFE.compareAndSwapInt(<span class="hljs-keyword">this</span>, nextWorkerNumberOffset,</span><br><span class="line">                                      n = nextWorkerNumber, ++n))</span><br><span class="line">             <span class="hljs-keyword">return</span> workerNamePrefix + n;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="ForkJoinPool-registerWorker"><a href="#ForkJoinPool-registerWorker" class="headerlink" title="ForkJoinPool#registerWorker()"></a>ForkJoinPool#registerWorker()</h3><p><code>ForkJoinWorkerThread</code>注册到<code>ForkJoinPool</code>。<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Callback from ForkJoinWorkerThread constructor to</span></span><br><span class="line"><span class="hljs-comment">     * determine its poolIndex and record in workers array.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> w the worker</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the worker's pool index</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">registerWorker</span><span class="hljs-params">(ForkJoinWorkerThread w)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">         * In the typical case, a new worker acquires the lock, uses</span></span><br><span class="line"><span class="hljs-comment">         * next available index and returns quickly.  Since we should</span></span><br><span class="line"><span class="hljs-comment">         * not block callers (ultimately from signalWork or</span></span><br><span class="line"><span class="hljs-comment">         * tryPreBlock) waiting for the lock needed to do this, we</span></span><br><span class="line"><span class="hljs-comment">         * instead help release other workers while waiting for the</span></span><br><span class="line"><span class="hljs-comment">         * lock.</span></span><br><span class="line"><span class="hljs-comment">         */</span></span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> g;;) &#123;</span><br><span class="line">            ForkJoinWorkerThread[] ws;</span><br><span class="line">            <span class="hljs-comment">// 1</span></span><br><span class="line">            <span class="hljs-keyword">if</span> (((g = scanGuard) &amp; SG_UNIT) == <span class="hljs-number">0</span> &amp;&amp;</span><br><span class="line">                UNSAFE.compareAndSwapInt(<span class="hljs-keyword">this</span>, scanGuardOffset,</span><br><span class="line">                                         g, g | SG_UNIT)) &#123;</span><br><span class="line">                <span class="hljs-keyword">int</span> k = nextWorkerIndex;</span><br><span class="line">                <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                    <span class="hljs-keyword">if</span> ((ws = workers) != <span class="hljs-keyword">null</span>) &#123; <span class="hljs-comment">// ignore on shutdown</span></span><br><span class="line">                        <span class="hljs-keyword">int</span> n = ws.length;</span><br><span class="line">                        <span class="hljs-keyword">if</span> (k &lt; <span class="hljs-number">0</span> || k &gt;= n || ws[k] != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">                            <span class="hljs-keyword">for</span> (k = <span class="hljs-number">0</span>; k &lt; n &amp;&amp; ws[k] != <span class="hljs-keyword">null</span>; ++k)</span><br><span class="line">                                ;</span><br><span class="line">                            <span class="hljs-keyword">if</span> (k == n)</span><br><span class="line">                                ws = workers = Arrays.copyOf(ws, n &lt;&lt; <span class="hljs-number">1</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        ws[k] = w;</span><br><span class="line">                        nextWorkerIndex = k + <span class="hljs-number">1</span>;</span><br><span class="line">                        <span class="hljs-keyword">int</span> m = g &amp; SMASK;</span><br><span class="line">                        g = (k &gt; m) ? ((m &lt;&lt; <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>) &amp; SMASK : g + (SG_UNIT&lt;&lt;<span class="hljs-number">1</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">                    scanGuard = g;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="hljs-keyword">return</span> k;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((ws = workers) != <span class="hljs-keyword">null</span>) &#123; <span class="hljs-comment">// help release others</span></span><br><span class="line">                <span class="hljs-keyword">for</span> (ForkJoinWorkerThread u : ws) &#123;</span><br><span class="line">                    <span class="hljs-keyword">if</span> (u != <span class="hljs-keyword">null</span> &amp;&amp; u.queueBase != u.queueTop) &#123;</span><br><span class="line">                        <span class="hljs-keyword">if</span> (tryReleaseWaiter())</span><br><span class="line">                            <span class="hljs-keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>标注代码分析</p>
<ol>
<li>如果当前<code>scanGuard</code>中没有<code>SG_UNIT</code>标记，尝试设置<code>SG_UNIT</code>标记。这是一个加锁的过程。<h4 id="registerWorker"><a href="#registerWorker" class="headerlink" title="registerWorker()"></a>registerWorker()</h4><code>registerWorker()</code>的主要逻辑就是要注册一个工作线程到<code>ForkJoinPool</code>，然后返回工作线程在<code>Pool</code>内部工作线程数组的下标。说明一下。</li>
</ol>
<ul>
<li>方法内部的主流程(无限循环)中，首先尝试获取一个顺序锁。如果获取失败，会遍历下所有的工作线程，如果发现有工作线程的任务队列里还有未处理的任务，就会尝试唤醒等待的工作线程，然后再尝试去获取顺序锁。</li>
<li>如果获取顺序锁成功，内部会将传入的工作线程设置到相应的位置(必要的时候工作线程数组需要扩容)，然后返回下标。过程中会调整<code>scanGuard</code>的低16比特。</li>
</ul>
<p>这里再次分析一下<code>scanGuard</code>这个神奇的域。</p>
<ul>
<li>它的高16位用来做顺序锁，我们看到在主流程中首先会查看<code>scanGuard</code>中是否含有<code>SG_UNIT</code>对应的<code>bit</code>信息，如果有说明已经有其他线程持有这个锁了；如果没有，就可以通过一个CAS操作来获取这个锁，获取动作就是给<code>scanGuard</code>上添加上<code>SG_UNIT</code>对应的<code>bit</code>信息，在内部完成逻辑后会清除<code>scanGuard</code>上的<code>SG_UNIT</code>信息。</li>
<li>它的低16位就像它的命名一样，表示扫描的边界。上面的代码中可以看到，在注册工作线程时候会调整这个边界值，规律是这样，边界值的大小=比当前工作线程最大下标大的最小的2的幂减1(有点绕，不要晕)，举几个栗子：<code>maxIndex=5，guard=7、maxIndex=10，guard=15</code>，看出规律了吧。这个值的作用是为了避免不必要的扫描，因为<code>Pool</code>内部的工作线程数组<code>size</code>可能比较大(初始化的时候就比并行度要大很多，回去看下<code>Pool</code>的构造方法。而且还有可能扩展)，但实际的工作线程数量可能比较小(比如可能数组<code>size</code>是16，但里面只有4个工作线程，14个空位)，如果扫描的时候扫描范围是全部数组，那一定会在空位上浪费很多时间，有了这个<code>guard</code>作为边界(而不是数组的<code>length-1</code>)，会避免这些时间的浪费。<h3 id="ForkJoinWorkerThread-run"><a href="#ForkJoinWorkerThread-run" class="headerlink" title="ForkJoinWorkerThread#run()"></a>ForkJoinWorkerThread#run()</h3><code>ForkJoinPool#addWorker()</code>的<code>t.start()</code>，实际上是执行<code>ForkJoinWorkerThread#run()</code>。<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * This method is required to be public, but should never be</span></span><br><span class="line"><span class="hljs-comment">  * called explicitly. It performs the main run loop to execute</span></span><br><span class="line"><span class="hljs-comment">  * &#123;<span class="hljs-doctag">@link</span> ForkJoinTask&#125;s.</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">     Throwable exception = <span class="hljs-keyword">null</span>;</span><br><span class="line">     <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">         onStart();</span><br><span class="line">         pool.work(<span class="hljs-keyword">this</span>);</span><br><span class="line">     &#125; <span class="hljs-keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">         exception = ex;</span><br><span class="line">     &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">         onTermination(exception);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>启动前回调下<code>onStart()</code>，然后是主流程(<code>pool#work</code>)，如果方法结束，还会回调下<code>onTermination()</code>。</p>
<h3 id="ForkJoinWorkerThread-onStart"><a href="#ForkJoinWorkerThread-onStart" class="headerlink" title="ForkJoinWorkerThread#onStart()"></a>ForkJoinWorkerThread#onStart()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">    * Initializes internal state after construction but before</span></span><br><span class="line"><span class="hljs-comment">    * processing any tasks. If you override this method, you must</span></span><br><span class="line"><span class="hljs-comment">    * invoke &#123;<span class="hljs-doctag">@code</span> super.onStart()&#125; at the beginning of the method.</span></span><br><span class="line"><span class="hljs-comment">    * Initialization requires care: Most fields must have legal</span></span><br><span class="line"><span class="hljs-comment">    * default values, to ensure that attempted accesses from other</span></span><br><span class="line"><span class="hljs-comment">    * threads work correctly even before this thread starts</span></span><br><span class="line"><span class="hljs-comment">    * processing tasks.</span></span><br><span class="line"><span class="hljs-comment">    */</span></span><br><span class="line">   <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onStart</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">       <span class="hljs-comment">// 1</span></span><br><span class="line">       queue = <span class="hljs-keyword">new</span> ForkJoinTask&lt;?&gt;[INITIAL_QUEUE_CAPACITY];</span><br><span class="line">       <span class="hljs-comment">// 2</span></span><br><span class="line">       <span class="hljs-keyword">int</span> r = pool.workerSeedGenerator.nextInt();</span><br><span class="line">       <span class="hljs-comment">// 3</span></span><br><span class="line">       seed = (r == <span class="hljs-number">0</span>) ? <span class="hljs-number">1</span> : r; <span class="hljs-comment">//  must be nonzero</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>标注代码分析</p>
<ol>
<li>初始化工作线程的任务队列。</li>
<li>生成工作线程的种子。 </li>
<li>确保种子不为0。<h3 id="ForkJoinWorkerThread-onTermination"><a href="#ForkJoinWorkerThread-onTermination" class="headerlink" title="ForkJoinWorkerThread#onTermination()"></a>ForkJoinWorkerThread#onTermination()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Performs cleanup associated with termination of this worker</span></span><br><span class="line"><span class="hljs-comment">  * thread.  If you override this method, you must invoke</span></span><br><span class="line"><span class="hljs-comment">  * &#123;<span class="hljs-doctag">@code</span> super.onTermination&#125; at the end of the overridden method.</span></span><br><span class="line"><span class="hljs-comment">  *</span></span><br><span class="line"><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> exception the exception causing this thread to abort due</span></span><br><span class="line"><span class="hljs-comment">  * to an unrecoverable error, or &#123;<span class="hljs-doctag">@code</span> null&#125; if completed normally</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onTermination</span><span class="hljs-params">(Throwable exception)</span> </span>&#123;</span><br><span class="line">     <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">         <span class="hljs-comment">// 1</span></span><br><span class="line">         terminate = <span class="hljs-keyword">true</span>;</span><br><span class="line">         <span class="hljs-comment">// 2</span></span><br><span class="line">         cancelTasks();</span><br><span class="line">         <span class="hljs-comment">// 3</span></span><br><span class="line">         pool.deregisterWorker(<span class="hljs-keyword">this</span>, exception);</span><br><span class="line">     &#125; <span class="hljs-keyword">catch</span> (Throwable ex) &#123;        <span class="hljs-comment">// Shouldn't ever happen</span></span><br><span class="line">         <span class="hljs-keyword">if</span> (exception == <span class="hljs-keyword">null</span>)      <span class="hljs-comment">// but if so, at least rethrown</span></span><br><span class="line">             exception = ex;</span><br><span class="line">     &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">         <span class="hljs-keyword">if</span> (exception != <span class="hljs-keyword">null</span>)</span><br><span class="line">             UNSAFE.throwException(exception);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>标注代码分析</p>
<ol>
<li>设置关闭标志。</li>
<li>取消任务。</li>
<li>从<code>ForkJoinPool</code>上注销当前工作线程。<h3 id="ForkJoinPool-work"><a href="#ForkJoinPool-work" class="headerlink" title="ForkJoinPool#work"></a>ForkJoinPool#work</h3><code>ForkJoinWorkerThread#run()</code>中<code>pool#work(this)</code><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Top-level loop for worker threads: On each step: if the</span></span><br><span class="line"><span class="hljs-comment">  * previous step swept through all queues and found no tasks, or</span></span><br><span class="line"><span class="hljs-comment">  * there are excess threads, then possibly blocks. Otherwise,</span></span><br><span class="line"><span class="hljs-comment">  * scans for and, if found, executes a task. Returns when pool</span></span><br><span class="line"><span class="hljs-comment">  * and/or worker terminate.</span></span><br><span class="line"><span class="hljs-comment">  *</span></span><br><span class="line"><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> w the worker</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">work</span><span class="hljs-params">(ForkJoinWorkerThread w)</span> </span>&#123;</span><br><span class="line">     <span class="hljs-keyword">boolean</span> swept = <span class="hljs-keyword">false</span>;                <span class="hljs-comment">// true on empty scans</span></span><br><span class="line">     <span class="hljs-keyword">long</span> c;</span><br><span class="line">     <span class="hljs-comment">// 1</span></span><br><span class="line">     <span class="hljs-keyword">while</span> (!w.terminate &amp;&amp; (<span class="hljs-keyword">int</span>)(c = ctl) &gt;= <span class="hljs-number">0</span>) &#123;</span><br><span class="line">         <span class="hljs-keyword">int</span> a;                            <span class="hljs-comment">// active count</span></span><br><span class="line">         <span class="hljs-comment">// 2</span></span><br><span class="line">         <span class="hljs-keyword">if</span> (!swept &amp;&amp; (a = (<span class="hljs-keyword">int</span>)(c &gt;&gt; AC_SHIFT)) &lt;= <span class="hljs-number">0</span>)</span><br><span class="line">             swept = scan(w, a);</span><br><span class="line">         <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tryAwaitWork(w, c))<span class="hljs-comment">// 3</span></span><br><span class="line">             swept = <span class="hljs-keyword">false</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>标注代码分析</p>
<ol>
<li>while条件就是当前工作线程未结束且<code>pool</code>未关闭。while循环中，会不断的扫描(<code>scan</code>)或等待(<code>tryAwaitWork</code>)。</li>
<li>如果扫描标志(起始为false)表示上一次扫描不是空扫描(false)，并且当前活动线程数量小于处理器核数(这里要注意下，返回去在看下控制信息中<code>AC</code>的定义)，那么执行<code>scan(w, a)</code>。</li>
<li>当前没有任务需要执行的任务 或者 当前活动的线程数量已经大于处理器核心数。进行等待<code>(tryAwaitWork(w, c))</code>。<h3 id="ForkJoinPool-scan"><a href="#ForkJoinPool-scan" class="headerlink" title="ForkJoinPool#scan()"></a>ForkJoinPool#scan()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">    * Scans for and, if found, executes one task. Scans start at a</span></span><br><span class="line"><span class="hljs-comment">    * random index of workers array, and randomly select the first</span></span><br><span class="line"><span class="hljs-comment">    * (2*#workers)-1 probes, and then, if all empty, resort to 2</span></span><br><span class="line"><span class="hljs-comment">    * circular sweeps, which is necessary to check quiescence. and</span></span><br><span class="line"><span class="hljs-comment">    * taking a submission only if no stealable tasks were found.  The</span></span><br><span class="line"><span class="hljs-comment">    * steal code inside the loop is a specialized form of</span></span><br><span class="line"><span class="hljs-comment">    * ForkJoinWorkerThread.deqTask, followed bookkeeping to support</span></span><br><span class="line"><span class="hljs-comment">    * helpJoinTask and signal propagation. The code for submission</span></span><br><span class="line"><span class="hljs-comment">    * queues is almost identical. On each steal, the worker completes</span></span><br><span class="line"><span class="hljs-comment">    * not only the task, but also all local tasks that this task may</span></span><br><span class="line"><span class="hljs-comment">    * have generated. On detecting staleness or contention when</span></span><br><span class="line"><span class="hljs-comment">    * trying to take a task, this method returns without finishing</span></span><br><span class="line"><span class="hljs-comment">    * sweep, which allows global state rechecks before retry.</span></span><br><span class="line"><span class="hljs-comment">    *</span></span><br><span class="line"><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> w the worker</span></span><br><span class="line"><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> a the number of active workers</span></span><br><span class="line"><span class="hljs-comment">    * <span class="hljs-doctag">@return</span> true if swept all queues without finding a task</span></span><br><span class="line"><span class="hljs-comment">    */</span></span><br><span class="line">   <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">scan</span><span class="hljs-params">(ForkJoinWorkerThread w, <span class="hljs-keyword">int</span> a)</span> </span>&#123;</span><br><span class="line">       <span class="hljs-keyword">int</span> g = scanGuard; <span class="hljs-comment">// mask 0 avoids useless scans if only one active</span></span><br><span class="line">       <span class="hljs-comment">// 1</span></span><br><span class="line">       <span class="hljs-keyword">int</span> m = (parallelism == <span class="hljs-number">1</span> - a &amp;&amp; blockedCount == <span class="hljs-number">0</span>) ? <span class="hljs-number">0</span> : g &amp; SMASK;</span><br><span class="line">       ForkJoinWorkerThread[] ws = workers;</span><br><span class="line">       <span class="hljs-keyword">if</span> (ws == <span class="hljs-keyword">null</span> || ws.length &lt;= m)         <span class="hljs-comment">// staleness check</span></span><br><span class="line">           <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">       <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> r = w.seed, k = r, j = -(m + m); j &lt;= m + m; ++j) &#123;</span><br><span class="line">           ForkJoinTask&lt;?&gt; t; ForkJoinTask&lt;?&gt;[] q; <span class="hljs-keyword">int</span> b, i;</span><br><span class="line">           <span class="hljs-comment">// 2</span></span><br><span class="line">           ForkJoinWorkerThread v = ws[k &amp; m];</span><br><span class="line">           <span class="hljs-keyword">if</span> (v != <span class="hljs-keyword">null</span> &amp;&amp; (b = v.queueBase) != v.queueTop &amp;&amp;</span><br><span class="line">               (q = v.queue) != <span class="hljs-keyword">null</span> &amp;&amp; (i = (q.length - <span class="hljs-number">1</span>) &amp; b) &gt;= <span class="hljs-number">0</span>) &#123;</span><br><span class="line">               <span class="hljs-comment">// 3</span></span><br><span class="line">               <span class="hljs-keyword">long</span> u = (i &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">               <span class="hljs-keyword">if</span> ((t = q[i]) != <span class="hljs-keyword">null</span> &amp;&amp; v.queueBase == b &amp;&amp;</span><br><span class="line">                   UNSAFE.compareAndSwapObject(q, u, t, <span class="hljs-keyword">null</span>)) &#123;</span><br><span class="line">                   <span class="hljs-comment">// 4</span></span><br><span class="line">                   <span class="hljs-keyword">int</span> d = (v.queueBase = b + <span class="hljs-number">1</span>) - v.queueTop;</span><br><span class="line">                   <span class="hljs-comment">// 5</span></span><br><span class="line">                   v.stealHint = w.poolIndex;</span><br><span class="line">                   <span class="hljs-keyword">if</span> (d != <span class="hljs-number">0</span>)</span><br><span class="line">                       <span class="hljs-comment">// 6</span></span><br><span class="line">                       signalWork();             <span class="hljs-comment">// propagate if nonempty</span></span><br><span class="line">                   w.execTask(t);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="hljs-comment">// 7</span></span><br><span class="line">               r ^= r &lt;&lt; <span class="hljs-number">13</span>; r ^= r &gt;&gt;&gt; <span class="hljs-number">17</span>; w.seed = r ^ (r &lt;&lt; <span class="hljs-number">5</span>);</span><br><span class="line">               <span class="hljs-comment">// 不是一个空扫描</span></span><br><span class="line">               <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;                     <span class="hljs-comment">// store next seed</span></span><br><span class="line">           &#125;</span><br><span class="line">           <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (j &lt; <span class="hljs-number">0</span>) &#123;                     <span class="hljs-comment">// xorshift</span></span><br><span class="line">               <span class="hljs-comment">// 8 </span></span><br><span class="line">               r ^= r &lt;&lt; <span class="hljs-number">13</span>; r ^= r &gt;&gt;&gt; <span class="hljs-number">17</span>; k = r ^= r &lt;&lt; <span class="hljs-number">5</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="hljs-keyword">else</span> <span class="hljs-comment">// 9</span></span><br><span class="line">               ++k;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="hljs-keyword">if</span> (scanGuard != g)                       <span class="hljs-comment">// staleness check</span></span><br><span class="line">           <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">       <span class="hljs-keyword">else</span> &#123;                                    <span class="hljs-comment">// try to take submission</span></span><br><span class="line">           <span class="hljs-comment">// 10</span></span><br><span class="line">           ForkJoinTask&lt;?&gt; t; ForkJoinTask&lt;?&gt;[] q; <span class="hljs-keyword">int</span> b, i;</span><br><span class="line">           <span class="hljs-keyword">if</span> ((b = queueBase) != queueTop &amp;&amp;</span><br><span class="line">               (q = submissionQueue) != <span class="hljs-keyword">null</span> &amp;&amp;</span><br><span class="line">               (i = (q.length - <span class="hljs-number">1</span>) &amp; b) &gt;= <span class="hljs-number">0</span>) &#123;</span><br><span class="line">               <span class="hljs-keyword">long</span> u = (i &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">               <span class="hljs-keyword">if</span> ((t = q[i]) != <span class="hljs-keyword">null</span> &amp;&amp; queueBase == b &amp;&amp;</span><br><span class="line">                   UNSAFE.compareAndSwapObject(q, u, t, <span class="hljs-keyword">null</span>)) &#123;</span><br><span class="line">                   queueBase = b + <span class="hljs-number">1</span>;</span><br><span class="line">                   w.execTask(t);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="hljs-comment">// 11</span></span><br><span class="line">           <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;                         <span class="hljs-comment">// all queues empty</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>标注代码分析</p>
<ol>
<li>如果当前只有一个工作线程，将m设置为0，避免没用的扫描。否则获取<code>guard</code>值。</li>
<li>随机选出一个牺牲者(工作线程)。</li>
<li>如果这个牺牲者的任务队列中还有任务，尝试窃取这个任务。</li>
<li>窃取成功后，调整<code>queueBase</code>。</li>
<li>将牺牲者的<code>stealHint</code>设置为当前工作线程在<code>pool</code>中的下标。</li>
<li>如果牺牲者的任务队列还有任务，继续唤醒(或创建)线程。</li>
<li>计算出下一个随机种子。</li>
<li>前<code>2*m</code>次，随机扫描。</li>
<li>后<code>2*m</code>次，顺序扫描。</li>
<li>如果扫描完毕后没找到可窃取的任务，那么从<code>Pool</code>的提交任务队列中取一个任务来执行。</li>
<li>如果所有的队列(工作线程的任务队列和<code>pool</code>的任务队列)都是空的，返回true。<h4 id="scan"><a href="#scan" class="headerlink" title="scan()"></a>scan()</h4></li>
<li>需要确定扫描边界值m，如果当前只有一个工作线程，那么m就为0，避免多余的扫描；如果当前有多个工作线程，那么m就是<code>scanGuard</code>的低16位表示的值(去前面看看<code>scanGuard</code>)。</li>
<li>确定m以后，开始一个for循环进行扫描。扫描的目的就是要通过工作线程的<code>seed</code>(这个域之前没提，使用来选择一个窃取牺牲者的)算出一个牺牲者(victim)的下标，牺牲者也是一个工作线程，然后当前工作线程便会从牺牲者的任务队列里面窃取一个任务来执行。当然如果算出的下标对应的位置上没有牺牲者(工作线程)，或者牺牲者的任务队列里没有任务，就会进行下一次尝试。整个for循环最多会尝试<code>4*m</code>次，前<code>2*m</code>次是随机算下标，每次会通过<code>xorshift算法</code>来生成新的k。后<code>2*m</code>次是顺序递增k来算下标。</li>
<li>如果for循环结束了还没有扫描到任务，那么就会从<code>Pool</code>的<code>submissionQueue</code>中窃取一个任务来执行了。<h3 id="ForkJoinWorkerThread-execTask"><a href="#ForkJoinWorkerThread-execTask" class="headerlink" title="ForkJoinWorkerThread#execTask()"></a>ForkJoinWorkerThread#execTask()</h3>由于是初始提交，<code>scan()</code>中一定是从<code>ForkJoinPool#submissionQueue()</code>中获取提交的任务，然后执行<code>execTask()</code>。<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Runs the given task, plus any local tasks until queue is empty</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">execTask</span><span class="hljs-params">(ForkJoinTask&lt;?&gt; t)</span> </span>&#123;</span><br><span class="line">     currentSteal = t;</span><br><span class="line">     <span class="hljs-keyword">for</span> (;;) &#123;</span><br><span class="line">         <span class="hljs-keyword">if</span> (t != <span class="hljs-keyword">null</span>)</span><br><span class="line">             <span class="hljs-comment">// 1</span></span><br><span class="line">             t.doExec();</span><br><span class="line">         <span class="hljs-comment">// 2</span></span><br><span class="line">         <span class="hljs-keyword">if</span> (queueTop == queueBase)</span><br><span class="line">             <span class="hljs-keyword">break</span>;</span><br><span class="line">         <span class="hljs-comment">// 3</span></span><br><span class="line">         t = locallyFifo ? locallyDeqTask() : popTask();</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="hljs-comment">// 4</span></span><br><span class="line">     ++stealCount;</span><br><span class="line">     currentSteal = <span class="hljs-keyword">null</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>标注代码分析</p>
<ol>
<li>执行任务。</li>
<li>如果当前工作线程的任务队列里没有任务了，退出循环。</li>
<li>根据模式来获取任务。如果<code>Pool</code>中指定为异步模式，这里从当前任务队列的尾部获取任务；否则，从任务队列头部获取任务。</li>
<li>最后累加窃取任务计数。<h3 id="ForJoinTask-doExec"><a href="#ForJoinTask-doExec" class="headerlink" title="ForJoinTask#doExec()"></a>ForJoinTask#doExec()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Primary execution method for stolen tasks. Unless done, calls</span></span><br><span class="line"><span class="hljs-comment">  * exec and records status if completed, but doesn't wait for</span></span><br><span class="line"><span class="hljs-comment">  * completion otherwise.</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doExec</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">     <span class="hljs-keyword">if</span> (status &gt;= <span class="hljs-number">0</span>) &#123;</span><br><span class="line">         <span class="hljs-keyword">boolean</span> completed;</span><br><span class="line">         <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">             <span class="hljs-comment">// 1</span></span><br><span class="line">             completed = exec();</span><br><span class="line">         &#125; <span class="hljs-keyword">catch</span> (Throwable rex) &#123;</span><br><span class="line">             <span class="hljs-comment">// 2</span></span><br><span class="line">             setExceptionalCompletion(rex);</span><br><span class="line">             <span class="hljs-keyword">return</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="hljs-keyword">if</span> (completed)</span><br><span class="line">             <span class="hljs-comment">// 3</span></span><br><span class="line">             setCompletion(NORMAL); <span class="hljs-comment">// must be outside try block</span></span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>标注代码分析</p>
<ol>
<li>调用<code>exec()</code>执行任务。</li>
<li>设置异常完成结果。</li>
<li>设置正常完成结果。</li>
</ol>
<p><code>ForJoinTask#exec()</code>是一个抽象方法，具体执行逻辑交给子类去实现，前面看到的适配类<code>AdaptedRunnable</code>和<code>AdaptedCallable</code>里面，会在<code>exec()</code>里面分别调用<code>runnable#run()</code>和<code>callable#call()</code>；而在<code>ForJoinTask</code>的两个子类<code>RecursiveAction</code>和<code>RecursiveTask</code>里面，<code>exec()</code>里面调用的是<code>compute()</code>。</p>
<h3 id="RecursiveAction-exec"><a href="#RecursiveAction-exec" class="headerlink" title="RecursiveAction#exec()"></a>RecursiveAction#exec()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Implements execution conventions for RecursiveActions.</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">exec</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">     compute();</span><br><span class="line">     <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="RecursiveAction-compute"><a href="#RecursiveAction-compute" class="headerlink" title="RecursiveAction#compute()"></a>RecursiveAction#compute()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * The main computation performed by this task.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">compute</span><span class="hljs-params">()</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="RecursiveTask-exec"><a href="#RecursiveTask-exec" class="headerlink" title="RecursiveTask#exec()"></a>RecursiveTask#exec()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Implements execution conventions for RecursiveTask.</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">exec</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">     result = compute();</span><br><span class="line">     <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="RecursiveTask-compute"><a href="#RecursiveTask-compute" class="headerlink" title="RecursiveTask#compute()"></a>RecursiveTask#compute()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * The main computation performed by this task.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> V <span class="hljs-title">compute</span><span class="hljs-params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p><code>ForJoinTask#exec()</code>有返回值，表示任务是否执行完毕。<br><code>doExec()</code>中会根据这个返回值来设置任务的完成状态，如果任务正常完成，会调用<code>setCompletion(NORMAL)</code>。</p>
<h3 id="ForkJoinTask-setCompletion"><a href="#ForkJoinTask-setCompletion" class="headerlink" title="ForkJoinTask#setCompletion()"></a>ForkJoinTask#setCompletion()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">volatile</span> <span class="hljs-keyword">int</span> status; <span class="hljs-comment">// accessed directly by pool and workers</span></span><br><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> NORMAL      = -<span class="hljs-number">1</span>;</span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * Marks completion and wakes up threads waiting to join this task,</span></span><br><span class="line"><span class="hljs-comment"> * also clearing signal request bits.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> completion one of NORMAL, CANCELLED, EXCEPTIONAL</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> completion status on exit</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> <span class="hljs-title">setCompletion</span><span class="hljs-params">(<span class="hljs-keyword">int</span> completion)</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> s;;) &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> ((s = status) &lt; <span class="hljs-number">0</span>)</span><br><span class="line">            <span class="hljs-keyword">return</span> s;</span><br><span class="line">        <span class="hljs-comment">// 1</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (UNSAFE.compareAndSwapInt(<span class="hljs-keyword">this</span>, statusOffset, s, completion)) &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>)</span><br><span class="line">                <span class="hljs-comment">// 2</span></span><br><span class="line">                <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>) &#123; notifyAll(); &#125;</span><br><span class="line">            <span class="hljs-keyword">return</span> completion;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>标注代码分析</p>
<ol>
<li>尝试将任务状态设置为正常完成。</li>
<li>同时唤醒合并当前任务的等待线程。<h3 id="ForkJoinTask-setExceptionalCompletion"><a href="#ForkJoinTask-setExceptionalCompletion" class="headerlink" title="ForkJoinTask#setExceptionalCompletion()"></a>ForkJoinTask#setExceptionalCompletion()</h3><code>doExec()</code>中如果执行<code>exec()</code>发生异常，会调用<code>setExceptionalCompletion()</code>来设置异常完成状态。<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Records exception and sets exceptional completion.</span></span><br><span class="line"><span class="hljs-comment">  *</span></span><br><span class="line"><span class="hljs-comment">  * <span class="hljs-doctag">@return</span> status on exit</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> <span class="hljs-title">setExceptionalCompletion</span><span class="hljs-params">(Throwable ex)</span> </span>&#123;</span><br><span class="line">     <span class="hljs-comment">// 1</span></span><br><span class="line">     <span class="hljs-keyword">int</span> h = System.identityHashCode(<span class="hljs-keyword">this</span>);</span><br><span class="line">     <span class="hljs-keyword">final</span> ReentrantLock lock = exceptionTableLock;</span><br><span class="line">     lock.lock();</span><br><span class="line">     <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">         <span class="hljs-comment">// 2</span></span><br><span class="line">         expungeStaleExceptions();</span><br><span class="line">         <span class="hljs-comment">// 3</span></span><br><span class="line">         ExceptionNode[] t = exceptionTable;</span><br><span class="line">         <span class="hljs-comment">// 4</span></span><br><span class="line">         <span class="hljs-keyword">int</span> i = h &amp; (t.length - <span class="hljs-number">1</span>);</span><br><span class="line">         <span class="hljs-keyword">for</span> (ExceptionNode e = t[i]; ; e = e.next) &#123;</span><br><span class="line">             <span class="hljs-keyword">if</span> (e == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">                 t[i] = <span class="hljs-keyword">new</span> ExceptionNode(<span class="hljs-keyword">this</span>, ex, t[i]);</span><br><span class="line">                 <span class="hljs-keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="hljs-keyword">if</span> (e.get() == <span class="hljs-keyword">this</span>) <span class="hljs-comment">// already present</span></span><br><span class="line">                 <span class="hljs-keyword">break</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">         lock.unlock();</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="hljs-keyword">return</span> setCompletion(EXCEPTIONAL);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>标注代码分析  </p>
<ol>
<li>计算当前对象的原生<code>hashCode</code>。</li>
<li>删除异常表中过期的异常。</li>
<li>获取异常数组。</li>
<li>通过当前对象<code>hashCode</code>获取在异常表中的下标。</li>
</ol>
<p>注意到<code>setExceptionalCompletion()</code>中最后还是调用<code>setCompletion</code>，但之前会做一下将异常放入一个异常表的工作。<br>看到这里可能会有疑问，我们通过2个问题来了解下这个异常表。</p>
<h4 id="这里为什么会有一个异常表呢？"><a href="#这里为什么会有一个异常表呢？" class="headerlink" title="这里为什么会有一个异常表呢？"></a>这里为什么会有一个异常表呢？</h4><p>因为异常很少发生，所以没有将异常保存在任务对象内，而是放在一个弱引用异常表里(异常表里不会保存取消异常)。</p>
<h4 id="异常表的结构是怎么样的呢？"><a href="#异常表的结构是怎么样的呢？" class="headerlink" title="异常表的结构是怎么样的呢？"></a>异常表的结构是怎么样的呢？</h4><p>这里的异常表结构上是一个哈希表，每个桶里是单链，弱引用Key。</p>
<h3 id="Exception-table"><a href="#Exception-table" class="headerlink" title="Exception table"></a>Exception table</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Table of exceptions thrown by tasks, to enable reporting by</span></span><br><span class="line"><span class="hljs-comment">     * callers. Because exceptions are rare, we don't directly keep</span></span><br><span class="line"><span class="hljs-comment">     * them with task objects, but instead use a weak ref table.  Note</span></span><br><span class="line"><span class="hljs-comment">     * that cancellation exceptions don't appear in the table, but are</span></span><br><span class="line"><span class="hljs-comment">     * instead recorded as status values.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * Note: These statics are initialized below in static block.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ExceptionNode[] exceptionTable;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ReentrantLock exceptionTableLock;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ReferenceQueue&lt;Object&gt; exceptionTableRefQueue;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Fixed capacity for exceptionTable.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> EXCEPTION_MAP_CAPACITY = <span class="hljs-number">32</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Key-value nodes for exception table.  The chained hash table</span></span><br><span class="line"><span class="hljs-comment">     * uses identity comparisons, full locking, and weak references</span></span><br><span class="line"><span class="hljs-comment">     * for keys. The table has a fixed capacity because it only</span></span><br><span class="line"><span class="hljs-comment">     * maintains task exceptions long enough for joiners to access</span></span><br><span class="line"><span class="hljs-comment">     * them, so should never become very large for sustained</span></span><br><span class="line"><span class="hljs-comment">     * periods. However, since we do not know when the last joiner</span></span><br><span class="line"><span class="hljs-comment">     * completes, we must use weak references and expunge them. We do</span></span><br><span class="line"><span class="hljs-comment">     * so on each operation (hence full locking). Also, some thread in</span></span><br><span class="line"><span class="hljs-comment">     * any ForkJoinPool will call helpExpungeStaleExceptions when its</span></span><br><span class="line"><span class="hljs-comment">     * pool becomes isQuiescent.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExceptionNode</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WeakReference</span>&lt;<span class="hljs-title">ForkJoinTask</span>&lt;?&gt;&gt;</span>&#123;</span><br><span class="line">        <span class="hljs-keyword">final</span> Throwable ex;</span><br><span class="line">        ExceptionNode next;</span><br><span class="line">        <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> thrower;  <span class="hljs-comment">// use id not ref to avoid weak cycles</span></span><br><span class="line">        ExceptionNode(ForkJoinTask&lt;?&gt; task, Throwable ex, ExceptionNode next) &#123;</span><br><span class="line">            <span class="hljs-keyword">super</span>(task, exceptionTableRefQueue);</span><br><span class="line">            <span class="hljs-keyword">this</span>.ex = ex;</span><br><span class="line">            <span class="hljs-keyword">this</span>.next = next;</span><br><span class="line">            <span class="hljs-keyword">this</span>.thrower = Thread.currentThread().getId();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// Unsafe mechanics</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> sun.misc.Unsafe UNSAFE;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> statusOffset;</span><br><span class="line">    <span class="hljs-keyword">static</span> &#123;</span><br><span class="line">        exceptionTableLock = <span class="hljs-keyword">new</span> ReentrantLock();</span><br><span class="line">        exceptionTableRefQueue = <span class="hljs-keyword">new</span> ReferenceQueue&lt;Object&gt;();</span><br><span class="line">        exceptionTable = <span class="hljs-keyword">new</span> ExceptionNode[EXCEPTION_MAP_CAPACITY];</span><br><span class="line">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">            UNSAFE = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">            statusOffset = UNSAFE.objectFieldOffset</span><br><span class="line">                (ForkJoinTask.class.getDeclaredField(<span class="hljs-string">"status"</span>));</span><br><span class="line">        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>继续流程，执行完<code>doExec()</code>，方法返回到<code>execTask()</code>，接下来由于当前工作线程自身的任务队列中并没有任务，所以<code>queueTop == queueBase</code>成立，<code>execTask()</code>退出到<code>scan()</code>，<code>scan()</code>返回false到<code>ForkJoinPool#work()</code>，进行下一次扫描(<code>scan</code>)，由于工作线程本身的任务队列和<code>Pool</code>的任务队列都为空，所以下一次扫描一定是个空扫描，然后程序会走到<code>work()</code>的<code>tryAwaitWork</code>分支，看下<code>tryAwaitWork()</code>。</p>
<h3 id="ForkJoinPool-tryAwaitWork"><a href="#ForkJoinPool-tryAwaitWork" class="headerlink" title="ForkJoinPool#tryAwaitWork()"></a>ForkJoinPool#tryAwaitWork()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Tries to enqueue worker w in wait queue and await change in</span></span><br><span class="line"><span class="hljs-comment">     * worker's eventCount.  If the pool is quiescent and there is</span></span><br><span class="line"><span class="hljs-comment">     * more than one worker, possibly terminates worker upon exit.</span></span><br><span class="line"><span class="hljs-comment">     * Otherwise, before blocking, rescans queues to avoid missed</span></span><br><span class="line"><span class="hljs-comment">     * signals.  Upon finding work, releases at least one worker</span></span><br><span class="line"><span class="hljs-comment">     * (which may be the current worker). Rescans restart upon</span></span><br><span class="line"><span class="hljs-comment">     * detected staleness or failure to release due to</span></span><br><span class="line"><span class="hljs-comment">     * contention. Note the unusual conventions about Thread.interrupt</span></span><br><span class="line"><span class="hljs-comment">     * here and elsewhere: Because interrupts are used solely to alert</span></span><br><span class="line"><span class="hljs-comment">     * threads to check termination, which is checked here anyway, we</span></span><br><span class="line"><span class="hljs-comment">     * clear status (using Thread.interrupted) before any call to</span></span><br><span class="line"><span class="hljs-comment">     * park, so that park does not immediately return due to status</span></span><br><span class="line"><span class="hljs-comment">     * being set via some other unrelated call to interrupt in user</span></span><br><span class="line"><span class="hljs-comment">     * code.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> w the calling worker</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> c the ctl value on entry</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> true if waited or another thread was released upon enq</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryAwaitWork</span><span class="hljs-params">(ForkJoinWorkerThread w, <span class="hljs-keyword">long</span> c)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">int</span> v = w.eventCount;</span><br><span class="line">        <span class="hljs-comment">// 1</span></span><br><span class="line">        w.nextWait = (<span class="hljs-keyword">int</span>)c;                      <span class="hljs-comment">// w's successor record</span></span><br><span class="line">        <span class="hljs-comment">// 2</span></span><br><span class="line">        <span class="hljs-keyword">long</span> nc = (<span class="hljs-keyword">long</span>)(v &amp; E_MASK) | ((c - AC_UNIT) &amp; (AC_MASK|TC_MASK));</span><br><span class="line">        <span class="hljs-keyword">if</span> (ctl != c || !UNSAFE.compareAndSwapLong(<span class="hljs-keyword">this</span>, ctlOffset, c, nc)) &#123;</span><br><span class="line">            <span class="hljs-keyword">long</span> d = ctl; <span class="hljs-comment">// return true if lost to a deq, to force scan</span></span><br><span class="line">            <span class="hljs-comment">// 3</span></span><br><span class="line">            <span class="hljs-keyword">return</span> (<span class="hljs-keyword">int</span>)d != (<span class="hljs-keyword">int</span>)c &amp;&amp; ((d - c) &amp; AC_MASK) &gt;= <span class="hljs-number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> sc = w.stealCount; sc != <span class="hljs-number">0</span>;) &#123;   <span class="hljs-comment">// accumulate stealCount</span></span><br><span class="line">            <span class="hljs-comment">// 4</span></span><br><span class="line">            <span class="hljs-keyword">long</span> s = stealCount;</span><br><span class="line">            <span class="hljs-keyword">if</span> (UNSAFE.compareAndSwapLong(<span class="hljs-keyword">this</span>, stealCountOffset, s, s + sc))</span><br><span class="line">                sc = w.stealCount = <span class="hljs-number">0</span>;</span><br><span class="line">            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (w.eventCount != v)</span><br><span class="line">                <span class="hljs-comment">// 5</span></span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;                      <span class="hljs-comment">// update next time</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-comment">// 6</span></span><br><span class="line">        <span class="hljs-keyword">if</span> ((!shutdown || !tryTerminate(<span class="hljs-keyword">false</span>)) &amp;&amp;</span><br><span class="line">            (<span class="hljs-keyword">int</span>)c != <span class="hljs-number">0</span> &amp;&amp; parallelism + (<span class="hljs-keyword">int</span>)(nc &gt;&gt; AC_SHIFT) == <span class="hljs-number">0</span> &amp;&amp;</span><br><span class="line">            blockedCount == <span class="hljs-number">0</span> &amp;&amp; quiescerCount == <span class="hljs-number">0</span>)</span><br><span class="line">            <span class="hljs-comment">// 7</span></span><br><span class="line">            idleAwaitWork(w, nc, c, v);           <span class="hljs-comment">// quiescent</span></span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">boolean</span> rescanned = <span class="hljs-keyword">false</span>;;) &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (w.eventCount != v)</span><br><span class="line">                <span class="hljs-comment">// 8</span></span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line">            <span class="hljs-keyword">if</span> (!rescanned) &#123;</span><br><span class="line">                <span class="hljs-keyword">int</span> g = scanGuard, m = g &amp; SMASK;</span><br><span class="line">                ForkJoinWorkerThread[] ws = workers;</span><br><span class="line">                <span class="hljs-keyword">if</span> (ws != <span class="hljs-keyword">null</span> &amp;&amp; m &lt; ws.length) &#123;</span><br><span class="line">                    rescanned = <span class="hljs-keyword">true</span>;</span><br><span class="line">                    <span class="hljs-comment">// 9</span></span><br><span class="line">                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt;= m; ++i) &#123;</span><br><span class="line">                        ForkJoinWorkerThread u = ws[i];</span><br><span class="line">                        <span class="hljs-keyword">if</span> (u != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">                            <span class="hljs-keyword">if</span> (u.queueBase != u.queueTop &amp;&amp;</span><br><span class="line">                                !tryReleaseWaiter())</span><br><span class="line">                                <span class="hljs-comment">// 10</span></span><br><span class="line">                                rescanned = <span class="hljs-keyword">false</span>; <span class="hljs-comment">// contended</span></span><br><span class="line">                            <span class="hljs-keyword">if</span> (w.eventCount != v)</span><br><span class="line">                                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="hljs-comment">// 11</span></span><br><span class="line">                <span class="hljs-keyword">if</span> (scanGuard != g ||              <span class="hljs-comment">// stale</span></span><br><span class="line">                    (queueBase != queueTop &amp;&amp; !tryReleaseWaiter()))</span><br><span class="line">                    rescanned = <span class="hljs-keyword">false</span>;</span><br><span class="line">                <span class="hljs-keyword">if</span> (!rescanned)</span><br><span class="line">                    <span class="hljs-comment">// 12</span></span><br><span class="line">                    Thread.yield();                <span class="hljs-comment">// reduce contention</span></span><br><span class="line">                <span class="hljs-keyword">else</span></span><br><span class="line">                    <span class="hljs-comment">// 13</span></span><br><span class="line">                    Thread.interrupted();          <span class="hljs-comment">// clear before park</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                <span class="hljs-comment">// 14</span></span><br><span class="line">                w.parked = <span class="hljs-keyword">true</span>;                   <span class="hljs-comment">// must recheck</span></span><br><span class="line">                <span class="hljs-keyword">if</span> (w.eventCount != v) &#123;</span><br><span class="line">                    w.parked = <span class="hljs-keyword">false</span>;</span><br><span class="line">                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                LockSupport.park(<span class="hljs-keyword">this</span>);</span><br><span class="line">                rescanned = w.parked = <span class="hljs-keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>标注代码分析</p>
<ol>
<li><code>w#nextWait</code>保存的是等待之前<code>Pool</code>的控制信息。</li>
<li>这里是将当前线程的ID信息(下标取反)记录到<code>Pool</code>控制信息上,同时将控制信息上的活动工作线程计数减1。</li>
<li>如果和另外的一个窃取线程竞争并失败，这里返回true，<code>work()</code>中会继续扫描。</li>
<li>将工作线程上的<code>stealCount</code>原子累加到<code>Pool#stealCount</code>上面。</li>
<li>如果<code>eventCount</code>发生变化，重试。</li>
<li><code>Pool</code>未关闭且有工作线程且活动的工作线程数量等于<code>cpu</code>核心数量，且没有工作线程在合并过程中阻塞且没有工作线程休眠。</li>
<li>如果满足条件，说明当前<code>Pool</code>休眠，需要调用下<code>idleAwaitWork</code>进行处理。</li>
<li>如果<code>eventCount</code>发生变化，重试。</li>
<li>这里再重新扫描一下，如果从其他工作线程任务队列里找到任务，尝试唤醒等待的工作线程。</li>
<li>发生竞争，再次扫描。</li>
<li><code>scanGuard</code>发生变化或者从<code>Pool</code>任务队列中找到任务,再次扫描。</li>
<li>出让cpu，减少竞争。</li>
<li><code>park</code>前清除中断标记。</li>
<li>设置<code>park</code>标记。</li>
</ol>
<p>这个方法的目的就是阻塞工作线程w，但过程中有一些细节。</p>
<ul>
<li>首先，方法中要调整<code>Pool</code>的控制信息<code>ctl</code>，将<code>w#ID</code>信息设置到<code>ctl</code>上并将<code>ctl</code>上保存的活动工作线程数量减1。</li>
<li>其次，在阻塞前，还会将w的窃取任务数量累计到<code>Pool</code>的总窃取任务数量(<code>stealCount</code>)上；再次，如果当前<code>Pool</code>正好处理休眠状态，那么要调用<code>idleAwaitWork</code>处理一下(可能会结束工作线程)。</li>
<li>最后，再真正阻塞前还要扫描一下工作线程任务队列和<code>Pool</code>任务队列，如果发现有任务，会尝试唤醒一个等待工作线程(可能是自己)，这个过程要结束时会清除一下当前线程的中断标记，然后进行阻塞(以<code>Pool</code>为<code>Blocker</code>，相当于进入<code>Pool</code>的等待队列)。<h3 id="ForkJoinPool-idleAwaitWork"><a href="#ForkJoinPool-idleAwaitWork" class="headerlink" title="ForkJoinPool#idleAwaitWork()"></a>ForkJoinPool#idleAwaitWork()</h3>如果按照流程，到这儿就结束了，工作线程已经执行提交的任务，然后阻塞等待了。<br>但如果当前<code>Pool</code>正好处于休眠状态了，看看会怎么样，继续看下上面方法中调用的<code>idleAwaitWork()</code>。<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * If inactivating worker w has caused pool to become</span></span><br><span class="line"><span class="hljs-comment"> * quiescent, check for pool termination, and wait for event</span></span><br><span class="line"><span class="hljs-comment"> * for up to SHRINK_RATE nanosecs (rescans are unnecessary in</span></span><br><span class="line"><span class="hljs-comment"> * this case because quiescence reflects consensus about lack</span></span><br><span class="line"><span class="hljs-comment"> * of work). On timeout, if ctl has not changed, terminate the</span></span><br><span class="line"><span class="hljs-comment"> * worker. Upon its termination (see deregisterWorker), it may</span></span><br><span class="line"><span class="hljs-comment"> * wake up another worker to possibly repeat this process.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> w the calling worker</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> currentCtl the ctl value after enqueuing w</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> prevCtl the ctl value if w terminated</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> v the eventCount w awaits change</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">idleAwaitWork</span><span class="hljs-params">(ForkJoinWorkerThread w, <span class="hljs-keyword">long</span> currentCtl,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                           <span class="hljs-keyword">long</span> prevCtl, <span class="hljs-keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (w.eventCount == v) &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (shutdown)</span><br><span class="line">            <span class="hljs-comment">// 1</span></span><br><span class="line">            tryTerminate(<span class="hljs-keyword">false</span>);</span><br><span class="line">        <span class="hljs-comment">// 2</span></span><br><span class="line">        ForkJoinTask.helpExpungeStaleExceptions(); <span class="hljs-comment">// help clean weak refs</span></span><br><span class="line">        <span class="hljs-keyword">while</span> (ctl == currentCtl) &#123;</span><br><span class="line">            <span class="hljs-keyword">long</span> startTime = System.nanoTime();</span><br><span class="line">            w.parked = <span class="hljs-keyword">true</span>;</span><br><span class="line">            <span class="hljs-keyword">if</span> (w.eventCount == v)             <span class="hljs-comment">// must recheck</span></span><br><span class="line">                <span class="hljs-comment">// 3</span></span><br><span class="line">                LockSupport.parkNanos(<span class="hljs-keyword">this</span>, SHRINK_RATE);</span><br><span class="line">            w.parked = <span class="hljs-keyword">false</span>;</span><br><span class="line">            <span class="hljs-keyword">if</span> (w.eventCount != v)</span><br><span class="line">                <span class="hljs-keyword">break</span>;</span><br><span class="line">            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (System.nanoTime() - startTime &lt;</span><br><span class="line">                     SHRINK_RATE - (SHRINK_RATE / <span class="hljs-number">10</span>)) <span class="hljs-comment">// timing slop</span></span><br><span class="line">                <span class="hljs-comment">// 4</span></span><br><span class="line">                Thread.interrupted();          <span class="hljs-comment">// spurious wakeup</span></span><br><span class="line">            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (UNSAFE.compareAndSwapLong(<span class="hljs-keyword">this</span>, ctlOffset,</span><br><span class="line">                                               currentCtl, prevCtl)) &#123;<span class="hljs-comment">// 5</span></span><br><span class="line">                </span><br><span class="line">                <span class="hljs-comment">// 6</span></span><br><span class="line">                w.terminate = <span class="hljs-keyword">true</span>;            <span class="hljs-comment">// restore previous</span></span><br><span class="line">                <span class="hljs-comment">// 7</span></span><br><span class="line">                w.eventCount = ((<span class="hljs-keyword">int</span>)currentCtl + EC_UNIT) &amp; E_MASK;</span><br><span class="line">                <span class="hljs-keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>标注代码分析  </p>
<ol>
<li>如果关闭方法已经被调用，那么调用<code>tryTerminate()</code>。</li>
<li>清理一下异常表中<code>weak key</code>。</li>
<li>阻塞给定时间(4秒)。</li>
<li>如果发生伪唤醒，清除中断标志。</li>
<li>恢复之前的<code>ctl</code>，如果<code>ctl</code>一直没发生变化，会进入if。</li>
<li>结束工作线程,设置结束标志。</li>
<li>设置<code>w#eventCount</code>。</li>
</ol>
<p><code>idleAwaitWork()</code>中开始会检测一下<code>Pool</code>是否正在关闭，是的话要调用<code>tryTerminate</code>；否则会先将工作线程w阻塞一段时间(4s)，如果超过了这个时间，<code>Pool</code>的控制信息还没发生变化(说明<code>Pool</code>还是休眠状态)，那么就需要将w结束掉，会设置w的结束标记为true，同时设置<code>w#eventCount</code>，然后退出到<code>tryAwaitWork()</code>，<code>tryAwaitWork()</code>中检测到<code>w#eventCount</code>发生变化，会退出到<code>work()</code>，<code>work()</code>中检测到w的结束标记为true，主循环回退出，工作线程w就要结束了，结束时会调用<code>w#onTermination()</code>。</p>
<h3 id="ForkJoinWorkerThread-onTermination-1"><a href="#ForkJoinWorkerThread-onTermination-1" class="headerlink" title="ForkJoinWorkerThread#onTermination()"></a>ForkJoinWorkerThread#onTermination()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Performs cleanup associated with termination of this worker</span></span><br><span class="line"><span class="hljs-comment">  * thread.  If you override this method, you must invoke</span></span><br><span class="line"><span class="hljs-comment">  * &#123;<span class="hljs-doctag">@code</span> super.onTermination&#125; at the end of the overridden method.</span></span><br><span class="line"><span class="hljs-comment">  *</span></span><br><span class="line"><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> exception the exception causing this thread to abort due</span></span><br><span class="line"><span class="hljs-comment">  * to an unrecoverable error, or &#123;<span class="hljs-doctag">@code</span> null&#125; if completed normally</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onTermination</span><span class="hljs-params">(Throwable exception)</span> </span>&#123;</span><br><span class="line">     <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">         terminate = <span class="hljs-keyword">true</span>;</span><br><span class="line">         cancelTasks();</span><br><span class="line">         pool.deregisterWorker(<span class="hljs-keyword">this</span>, exception);</span><br><span class="line">     &#125; <span class="hljs-keyword">catch</span> (Throwable ex) &#123;        <span class="hljs-comment">// Shouldn't ever happen</span></span><br><span class="line">         <span class="hljs-keyword">if</span> (exception == <span class="hljs-keyword">null</span>)      <span class="hljs-comment">// but if so, at least rethrown</span></span><br><span class="line">             exception = ex;</span><br><span class="line">     &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">         <span class="hljs-keyword">if</span> (exception != <span class="hljs-keyword">null</span>)</span><br><span class="line">             UNSAFE.throwException(exception);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="ForkJoinWorkerThread-cancelTasks"><a href="#ForkJoinWorkerThread-cancelTasks" class="headerlink" title="ForkJoinWorkerThread#cancelTasks()"></a>ForkJoinWorkerThread#cancelTasks()</h3><p>取消任务。<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Removes and cancels all tasks in queue.  Can be called from any</span></span><br><span class="line"><span class="hljs-comment">  * thread.</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">cancelTasks</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">     ForkJoinTask&lt;?&gt; cj = currentJoin; <span class="hljs-comment">// try to cancel ongoing tasks</span></span><br><span class="line">     <span class="hljs-keyword">if</span> (cj != <span class="hljs-keyword">null</span> &amp;&amp; cj.status &gt;= <span class="hljs-number">0</span>)</span><br><span class="line">         <span class="hljs-comment">// 1</span></span><br><span class="line">         cj.cancelIgnoringExceptions();</span><br><span class="line">     ForkJoinTask&lt;?&gt; cs = currentSteal;</span><br><span class="line">     <span class="hljs-keyword">if</span> (cs != <span class="hljs-keyword">null</span> &amp;&amp; cs.status &gt;= <span class="hljs-number">0</span>)</span><br><span class="line">         <span class="hljs-comment">// 2</span></span><br><span class="line">         cs.cancelIgnoringExceptions();</span><br><span class="line">     <span class="hljs-keyword">while</span> (queueBase != queueTop) &#123;</span><br><span class="line">         <span class="hljs-comment">// 3</span></span><br><span class="line">         ForkJoinTask&lt;?&gt; t = deqTask();</span><br><span class="line">         <span class="hljs-keyword">if</span> (t != <span class="hljs-keyword">null</span>)</span><br><span class="line">             t.cancelIgnoringExceptions();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>标注代码分析</p>
<ol>
<li>取消正在合并的任务。</li>
<li>取消窃取的任务。</li>
<li>取消工作线程任务队列中的所有任务。 <h3 id="ForkJoinTask-cancel"><a href="#ForkJoinTask-cancel" class="headerlink" title="ForkJoinTask#cancel()"></a>ForkJoinTask#cancel()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">.....</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">cancel</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> mayInterruptIfRunning)</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> setCompletion(CANCELLED) == CANCELLED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * Cancels, ignoring any exceptions thrown by cancel. Used during</span></span><br><span class="line"><span class="hljs-comment"> * worker and pool shutdown. Cancel is spec'ed not to throw any</span></span><br><span class="line"><span class="hljs-comment"> * exceptions, but if it does anyway, we have no recourse during</span></span><br><span class="line"><span class="hljs-comment"> * shutdown, so guard against this case.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">cancelIgnoringExceptions</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">        cancel(<span class="hljs-keyword">false</span>);</span><br><span class="line">    &#125; <span class="hljs-keyword">catch</span> (Throwable ignore) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * Marks completion and wakes up threads waiting to join this task,</span></span><br><span class="line"><span class="hljs-comment"> * also clearing signal request bits.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> completion one of NORMAL, CANCELLED, EXCEPTIONAL</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> completion status on exit</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> <span class="hljs-title">setCompletion</span><span class="hljs-params">(<span class="hljs-keyword">int</span> completion)</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> s;;) &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> ((s = status) &lt; <span class="hljs-number">0</span>)</span><br><span class="line">            <span class="hljs-keyword">return</span> s;</span><br><span class="line">        <span class="hljs-keyword">if</span> (UNSAFE.compareAndSwapInt(<span class="hljs-keyword">this</span>, statusOffset, s, completion)) &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>)</span><br><span class="line">                <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>) &#123; notifyAll(); &#125;</span><br><span class="line">            <span class="hljs-keyword">return</span> completion;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="ForkJoinPool-deregisterWorker"><a href="#ForkJoinPool-deregisterWorker" class="headerlink" title="ForkJoinPool#deregisterWorker()"></a>ForkJoinPool#deregisterWorker()</h3><p>从Pool中注销自己。<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Final callback from terminating worker.  Removes record of</span></span><br><span class="line"><span class="hljs-comment">  * worker from array, and adjusts counts. If pool is shutting</span></span><br><span class="line"><span class="hljs-comment">  * down, tries to complete termination.</span></span><br><span class="line"><span class="hljs-comment">  *</span></span><br><span class="line"><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> w the worker</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">deregisterWorker</span><span class="hljs-params">(ForkJoinWorkerThread w, Throwable ex)</span> </span>&#123;</span><br><span class="line">     <span class="hljs-keyword">int</span> idx = w.poolIndex;</span><br><span class="line">     <span class="hljs-keyword">int</span> sc = w.stealCount;</span><br><span class="line">     <span class="hljs-keyword">int</span> steps = <span class="hljs-number">0</span>;</span><br><span class="line">     <span class="hljs-comment">// Remove from array, adjust worker counts and collect steal count.</span></span><br><span class="line">     <span class="hljs-comment">// We can intermix failed removes or adjusts with steal updates</span></span><br><span class="line">     <span class="hljs-keyword">do</span> &#123;</span><br><span class="line">         <span class="hljs-keyword">long</span> s, c;</span><br><span class="line">         <span class="hljs-keyword">int</span> g;</span><br><span class="line">         <span class="hljs-keyword">if</span> (steps == <span class="hljs-number">0</span> &amp;&amp; ((g = scanGuard) &amp; SG_UNIT) == <span class="hljs-number">0</span> &amp;&amp;</span><br><span class="line">             UNSAFE.compareAndSwapInt(<span class="hljs-keyword">this</span>, scanGuardOffset,</span><br><span class="line">                                      g, g |= SG_UNIT)) &#123;</span><br><span class="line">             ForkJoinWorkerThread[] ws = workers;</span><br><span class="line">             <span class="hljs-keyword">if</span> (ws != <span class="hljs-keyword">null</span> &amp;&amp; idx &gt;= <span class="hljs-number">0</span> &amp;&amp;</span><br><span class="line">                 idx &lt; ws.length &amp;&amp; ws[idx] == w)</span><br><span class="line">                 ws[idx] = <span class="hljs-keyword">null</span>;    <span class="hljs-comment">// verify</span></span><br><span class="line">             nextWorkerIndex = idx;</span><br><span class="line">             scanGuard = g + SG_UNIT;</span><br><span class="line">             steps = <span class="hljs-number">1</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="hljs-keyword">if</span> (steps == <span class="hljs-number">1</span> &amp;&amp;</span><br><span class="line">             UNSAFE.compareAndSwapLong(<span class="hljs-keyword">this</span>, ctlOffset, c = ctl,</span><br><span class="line">                                       (((c - AC_UNIT) &amp; AC_MASK) |</span><br><span class="line">                                        ((c - TC_UNIT) &amp; TC_MASK) |</span><br><span class="line">                                        (c &amp; ~(AC_MASK|TC_MASK)))))</span><br><span class="line">             steps = <span class="hljs-number">2</span>;</span><br><span class="line">         <span class="hljs-keyword">if</span> (sc != <span class="hljs-number">0</span> &amp;&amp;</span><br><span class="line">             UNSAFE.compareAndSwapLong(<span class="hljs-keyword">this</span>, stealCountOffset,</span><br><span class="line">                                       s = stealCount, s + sc))</span><br><span class="line">             sc = <span class="hljs-number">0</span>;</span><br><span class="line">     &#125; <span class="hljs-keyword">while</span> (steps != <span class="hljs-number">2</span> || sc != <span class="hljs-number">0</span>);</span><br><span class="line">     <span class="hljs-keyword">if</span> (!tryTerminate(<span class="hljs-keyword">false</span>)) &#123;</span><br><span class="line">         <span class="hljs-keyword">if</span> (ex != <span class="hljs-keyword">null</span>)   <span class="hljs-comment">// possibly replace if died abnormally</span></span><br><span class="line">             signalWork();</span><br><span class="line">         <span class="hljs-keyword">else</span></span><br><span class="line">             tryReleaseWaiter();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p><code>deregisterWorker()</code>中首先在一个while无限循环中完成工作线程注销的工作，包括3个阶段，全部完成后再执行下一步。之所以这样做是由于每个阶段都可能发生竞争，需要重试。</p>
<ul>
<li>第1阶段，会在获取顺序锁(<code>scanGuard</code>高16位)的情况下将<code>Pool</code>中工作线程对应的数组位置置空，并调整<code>nextWorkerIndex</code>。</li>
<li>第2阶段，将控制信息<code>ctl</code>中的活动工作线程数量和总工作线程数量减1。</li>
<li>第3阶段，将要注销工作线程的窃取任务数量累加到<code>Pool</code>的总窃取任务数量上。</li>
</ul>
<p><code>deregisterWorker()</code>在完成注销线程工作后，还有可能会唤醒其他等待线程，首先会调用一下<code>tryTerminate(false)</code>。</p>
<h3 id="ForkJoinPool-tryTerminate"><a href="#ForkJoinPool-tryTerminate" class="headerlink" title="ForkJoinPool#tryTerminate()"></a>ForkJoinPool#tryTerminate()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Possibly initiates and/or completes termination.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> now if true, unconditionally terminate, else only</span></span><br><span class="line"><span class="hljs-comment">     * if shutdown and empty queue and no active workers</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> true if now terminating or terminated</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryTerminate</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> now)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">long</span> c;</span><br><span class="line">        <span class="hljs-keyword">while</span> (((c = ctl) &amp; STOP_BIT) == <span class="hljs-number">0</span>) &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (!now) &#123;</span><br><span class="line">                <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">int</span>)(c &gt;&gt; AC_SHIFT) != -parallelism)</span><br><span class="line">                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">                <span class="hljs-keyword">if</span> (!shutdown || blockedCount != <span class="hljs-number">0</span> || quiescerCount != <span class="hljs-number">0</span> ||</span><br><span class="line">                    queueBase != queueTop) &#123;</span><br><span class="line">                    <span class="hljs-keyword">if</span> (ctl == c) <span class="hljs-comment">// staleness check</span></span><br><span class="line">                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">                    <span class="hljs-keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">if</span> (UNSAFE.compareAndSwapLong(<span class="hljs-keyword">this</span>, ctlOffset, c, c | STOP_BIT))</span><br><span class="line">                startTerminating();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">short</span>)(c &gt;&gt;&gt; TC_SHIFT) == -parallelism) &#123; <span class="hljs-comment">// signal when 0 workers</span></span><br><span class="line">            <span class="hljs-keyword">final</span> ReentrantLock lock = <span class="hljs-keyword">this</span>.submissionLock;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                termination.signalAll();</span><br><span class="line">            &#125; <span class="hljs-keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="参数为false"><a href="#参数为false" class="headerlink" title="参数为false"></a>参数为<code>false</code></h4><p>参数为false(表示不会马上关闭Pool)，那么实现中会查看是否有活动的工作线程，有的话返回false。然后检查<code>Pool</code>是否还在运行中(包括<code>Pool</code>有没有被关闭、有没有等待合并的工作线程、有没有空闲的工作线程、提交队列中是否有任务等)，如果还在运行中，返回false。 否则会尝试设置关闭标志到控制信息，然后调用<code>startTerminating()</code>。</p>
<h4 id="参数为true"><a href="#参数为true" class="headerlink" title="参数为true"></a>参数为<code>true</code></h4><p>参数为true的话也会直接进行这些操作。然后再检测下如果当前总的工作线程为0，就会唤醒在<code>termination</code>条件上等待的线程了。</p>
<h3 id="ForkJoinPool-startTerminating"><a href="#ForkJoinPool-startTerminating" class="headerlink" title="ForkJoinPool#startTerminating()"></a>ForkJoinPool#startTerminating()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * Runs up to three passes through workers: (0) Setting</span></span><br><span class="line"><span class="hljs-comment"> * termination status for each worker, followed by wakeups up to</span></span><br><span class="line"><span class="hljs-comment"> * queued workers; (1) helping cancel tasks; (2) interrupting</span></span><br><span class="line"><span class="hljs-comment"> * lagging threads (likely in external tasks, but possibly also</span></span><br><span class="line"><span class="hljs-comment"> * blocked in joins).  Each pass repeats previous steps because of</span></span><br><span class="line"><span class="hljs-comment"> * potential lagging thread creation.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startTerminating</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">// 1</span></span><br><span class="line">    cancelSubmissions();</span><br><span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> pass = <span class="hljs-number">0</span>; pass &lt; <span class="hljs-number">3</span>; ++pass) &#123;</span><br><span class="line">        ForkJoinWorkerThread[] ws = workers;</span><br><span class="line">        <span class="hljs-keyword">if</span> (ws != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            <span class="hljs-keyword">for</span> (ForkJoinWorkerThread w : ws) &#123;</span><br><span class="line">                <span class="hljs-keyword">if</span> (w != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">                    <span class="hljs-comment">// 2</span></span><br><span class="line">                    w.terminate = <span class="hljs-keyword">true</span>;</span><br><span class="line">                    <span class="hljs-keyword">if</span> (pass &gt; <span class="hljs-number">0</span>) &#123;</span><br><span class="line">                        <span class="hljs-comment">// 3</span></span><br><span class="line">                        w.cancelTasks();</span><br><span class="line">                        <span class="hljs-keyword">if</span> (pass &gt; <span class="hljs-number">1</span> &amp;&amp; !w.isInterrupted()) &#123;</span><br><span class="line">                            <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                                <span class="hljs-comment">// 4</span></span><br><span class="line">                                w.interrupt();</span><br><span class="line">                            &#125; <span class="hljs-keyword">catch</span> (SecurityException ignore) &#123;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-comment">// 5</span></span><br><span class="line">            terminateWaiters();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>标注代码分析  </p>
<ol>
<li>取消<code>Pool</code>提交任务队列中的任务。</li>
<li>结束工作线程。</li>
<li>取消工作线程中任务队列的任务。</li>
<li>中断工作线程。</li>
<li>结束等待的工作线程。<h4 id="startTerminating流程"><a href="#startTerminating流程" class="headerlink" title="startTerminating流程"></a>startTerminating流程</h4></li>
<li>取消<code>Pool#submissionQueue</code>中的任务。</li>
<li>将所有的工作线程的结束状态设置为true。</li>
<li>取消所有工作线程的任务队列中未完成的任务。</li>
<li>中断所有工作线程。</li>
<li>结束还在等待的工作线程。<h3 id="ForkJoinPool-cancelSubmissions"><a href="#ForkJoinPool-cancelSubmissions" class="headerlink" title="ForkJoinPool#cancelSubmissions()"></a>ForkJoinPool#cancelSubmissions()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Polls and cancels all submissions. Called only during termination.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">cancelSubmissions</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">while</span> (queueBase != queueTop) &#123;</span><br><span class="line">            ForkJoinTask&lt;?&gt; task = pollSubmission();</span><br><span class="line">            <span class="hljs-keyword">if</span> (task != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">                <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                    task.cancel(<span class="hljs-keyword">false</span>);</span><br><span class="line">                &#125; <span class="hljs-keyword">catch</span> (Throwable ignore) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="ForkJoinPool-pollSubmission"><a href="#ForkJoinPool-pollSubmission" class="headerlink" title="ForkJoinPool#pollSubmission()"></a>ForkJoinPool#pollSubmission()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * Removes and returns the next unexecuted submission if one is</span></span><br><span class="line"><span class="hljs-comment"> * available.  This method may be useful in extensions to this</span></span><br><span class="line"><span class="hljs-comment"> * class that re-assign work in systems with multiple pools.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> the next submission, or &#123;<span class="hljs-doctag">@code</span> null&#125; if none</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">protected</span> ForkJoinTask&lt;?&gt; pollSubmission() &#123;</span><br><span class="line">    ForkJoinTask&lt;?&gt; t; ForkJoinTask&lt;?&gt;[] q; <span class="hljs-keyword">int</span> b, i;</span><br><span class="line">    <span class="hljs-keyword">while</span> ((b = queueBase) != queueTop &amp;&amp;</span><br><span class="line">           (q = submissionQueue) != <span class="hljs-keyword">null</span> &amp;&amp;</span><br><span class="line">           (i = (q.length - <span class="hljs-number">1</span>) &amp; b) &gt;= <span class="hljs-number">0</span>) &#123;</span><br><span class="line">        <span class="hljs-keyword">long</span> u = (i &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">        <span class="hljs-keyword">if</span> ((t = q[i]) != <span class="hljs-keyword">null</span> &amp;&amp;</span><br><span class="line">            queueBase == b &amp;&amp;</span><br><span class="line">            UNSAFE.compareAndSwapObject(q, u, t, <span class="hljs-keyword">null</span>)) &#123;</span><br><span class="line">            queueBase = b + <span class="hljs-number">1</span>;</span><br><span class="line">            <span class="hljs-keyword">return</span> t;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ForkJoinPool-terminateWaiters"><a href="#ForkJoinPool-terminateWaiters" class="headerlink" title="ForkJoinPool#terminateWaiters()"></a>ForkJoinPool#terminateWaiters()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Tries to set the termination status of waiting workers, and</span></span><br><span class="line"><span class="hljs-comment">     * then wakes them up (after which they will terminate).</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">terminateWaiters</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        ForkJoinWorkerThread[] ws = workers;</span><br><span class="line">        <span class="hljs-keyword">if</span> (ws != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            ForkJoinWorkerThread w; <span class="hljs-keyword">long</span> c; <span class="hljs-keyword">int</span> i, e;</span><br><span class="line">            <span class="hljs-keyword">int</span> n = ws.length;</span><br><span class="line">            <span class="hljs-keyword">while</span> ((i = ~(e = (<span class="hljs-keyword">int</span>)(c = ctl)) &amp; SMASK) &lt; n &amp;&amp;</span><br><span class="line">                   (w = ws[i]) != <span class="hljs-keyword">null</span> &amp;&amp; w.eventCount == (e &amp; E_MASK)) &#123;</span><br><span class="line">                <span class="hljs-keyword">if</span> (UNSAFE.compareAndSwapLong(<span class="hljs-keyword">this</span>, ctlOffset, c,</span><br><span class="line">                                              (<span class="hljs-keyword">long</span>)(w.nextWait &amp; E_MASK) |</span><br><span class="line">                                              ((c + AC_UNIT) &amp; AC_MASK) |</span><br><span class="line">                                              (c &amp; (TC_MASK|STOP_BIT)))) &#123;</span><br><span class="line">                    w.terminate = <span class="hljs-keyword">true</span>;</span><br><span class="line">                    w.eventCount = e + EC_UNIT;</span><br><span class="line">                    <span class="hljs-keyword">if</span> (w.parked)</span><br><span class="line">                        UNSAFE.unpark(w);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>隐式的等待工作线程组成的链(也叫<code>Treiber stack</code>)。这里可能猛地一看，方法内部只唤醒了一个等待线程，这个等待线程的<code>ID</code>信息存储在<code>Pool</code>的控制信息中。但仔细看会发现，在设置(调整)ctl的时候，有这句<code>w.nextWait &amp; E_MASK</code>，也就是说，唤醒<code>w</code>之后，<code>ctl</code>里又会有另一个等待工作线程的<code>ID</code>信息(这个信息之前是存在<code>w#nextWait</code>上面的)。<br><code>deregisterWorker()</code>里，假设当前<code>Pool</code>还在运行，那么<code>tryTerminate(false)</code>返回false，就会执行if里的语句。<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> (!tryTerminate(<span class="hljs-keyword">false</span>)) &#123;</span><br><span class="line">    <span class="hljs-comment">// 1</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (ex != <span class="hljs-keyword">null</span>)   <span class="hljs-comment">// possibly replace if died abnormally</span></span><br><span class="line">        signalWork();</span><br><span class="line">    <span class="hljs-keyword">else</span><span class="hljs-comment">// 2</span></span><br><span class="line">        tryReleaseWaiter();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>标注代码分析  </p>
<ol>
<li>如果有异常发生，会调用<code>signalWork()</code>来唤醒或者创建一个工作线程。</li>
<li>调用<code>tryReleaseWaiter()</code>来尝试唤醒一个等待工作线程。<h3 id="ForkJoinPool-tryReleaseWaiter"><a href="#ForkJoinPool-tryReleaseWaiter" class="headerlink" title="ForkJoinPool#tryReleaseWaiter()"></a>ForkJoinPool#tryReleaseWaiter()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Variant of signalWork to help release waiters on rescans.</span></span><br><span class="line"><span class="hljs-comment">  * Tries once to release a waiter if active count &lt; 0.</span></span><br><span class="line"><span class="hljs-comment">  *</span></span><br><span class="line"><span class="hljs-comment">  * <span class="hljs-doctag">@return</span> false if failed due to contention, else true</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryReleaseWaiter</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">     <span class="hljs-keyword">long</span> c; <span class="hljs-keyword">int</span> e, i; ForkJoinWorkerThread w; ForkJoinWorkerThread[] ws;</span><br><span class="line">     <span class="hljs-comment">// 1</span></span><br><span class="line">     <span class="hljs-keyword">if</span> ((e = (<span class="hljs-keyword">int</span>)(c = ctl)) &gt; <span class="hljs-number">0</span> &amp;&amp;</span><br><span class="line">         (<span class="hljs-keyword">int</span>)(c &gt;&gt; AC_SHIFT) &lt; <span class="hljs-number">0</span> &amp;&amp;</span><br><span class="line">         (ws = workers) != <span class="hljs-keyword">null</span> &amp;&amp;</span><br><span class="line">         (i = ~e &amp; SMASK) &lt; ws.length &amp;&amp;</span><br><span class="line">         (w = ws[i]) != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">         <span class="hljs-comment">// 2</span></span><br><span class="line">         <span class="hljs-keyword">long</span> nc = ((<span class="hljs-keyword">long</span>)(w.nextWait &amp; E_MASK) |</span><br><span class="line">                    ((c + AC_UNIT) &amp; (AC_MASK|TC_MASK)));</span><br><span class="line">         <span class="hljs-keyword">if</span> (w.eventCount != e ||</span><br><span class="line">             !UNSAFE.compareAndSwapLong(<span class="hljs-keyword">this</span>, ctlOffset, c, nc))</span><br><span class="line">             <span class="hljs-comment">// 3 </span></span><br><span class="line">             <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">         <span class="hljs-comment">// 4</span></span><br><span class="line">         w.eventCount = (e + EC_UNIT) &amp; E_MASK;</span><br><span class="line">         <span class="hljs-keyword">if</span> (w.parked)</span><br><span class="line">             <span class="hljs-comment">// 5</span></span><br><span class="line">             UNSAFE.unpark(w);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>标注代码分析  </p>
<ol>
<li><code>(e = (int)(c = ctl)) &gt; 0</code>如果有等待线程,<code>(int)(c &gt;&gt; AC_SHIFT) &lt; 0</code>当前活动线程数小于CPU核数,<code>(ws = workers) != null</code>检测工作线程数组合法性,<code>(i = ~e &amp; SMASK) &lt; ws.length</code>检测控制信息中等待的工作线程的<code>ID</code>信息的合法性,<code>(w = ws[i]) != null</code>检测工作线程的合法性。</li>
<li>尝试调整控制信息，增加活动工作线程计数，将<code>Treiber stack</code>下一个等待线程的<code>ID</code>信息设置到<code>ctl</code>。</li>
<li>如果发生冲突。</li>
<li>累加<code>w#eventCount</code>。</li>
<li>唤醒w。<h3 id="ForkJoinWorkerThread-execTask-1"><a href="#ForkJoinWorkerThread-execTask-1" class="headerlink" title="ForkJoinWorkerThread#execTask()"></a>ForkJoinWorkerThread#execTask()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Runs the given task, plus any local tasks until queue is empty</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">execTask</span><span class="hljs-params">(ForkJoinTask&lt;?&gt; t)</span> </span>&#123;</span><br><span class="line">     currentSteal = t;</span><br><span class="line">     <span class="hljs-keyword">for</span> (;;) &#123;</span><br><span class="line">         <span class="hljs-keyword">if</span> (t != <span class="hljs-keyword">null</span>)</span><br><span class="line">             t.doExec();</span><br><span class="line">         <span class="hljs-keyword">if</span> (queueTop == queueBase)</span><br><span class="line">             <span class="hljs-keyword">break</span>;</span><br><span class="line">         t = locallyFifo ? locallyDeqTask() : popTask();</span><br><span class="line">     &#125;</span><br><span class="line">     ++stealCount;</span><br><span class="line">     currentSteal = <span class="hljs-keyword">null</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>假如执行完t，发现当前工作的任务队列中还有任务，那么接下来就会根据当前<code>Pool</code>的工作模式(是否是同步模式)，来通过<code>locallyDeqTask()</code>或者<code>popTask()</code>获取一个任务出来继续执行。<br>工作线程中的任务队列(<code>Pool</code>中的任务队列也一样)，形式上是一个数组，但概念上是一个双端队列。但和其他双端队列(JDK里另外的双端队列实现)不一样的是，这里的队列只定义了三种操作：从队列首部入队(push)、从队列首部出队(pop)、从队列尾部出队(deg)。这里既然说是队列，但又说什么push、pop可能会让人感觉晕晕的，其实可以这样理解，双端队列就可以看成是栈和队列的混血。结合使用<code>Pool</code>内部工作原理来说，如果不是异步模式(默认)，那么就会把任务队列当成一个FIFO队列来使用；否则就相当于把任务队列当成一个栈来使用。</p>
<h3 id="ForkJoinWorkerThread-popTask"><a href="#ForkJoinWorkerThread-popTask" class="headerlink" title="ForkJoinWorkerThread#popTask()"></a>ForkJoinWorkerThread#popTask()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * Returns a popped task, or null if empty.</span></span><br><span class="line"><span class="hljs-comment">  * Called only by this thread.</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"> <span class="hljs-keyword">private</span> ForkJoinTask&lt;?&gt; popTask() &#123;</span><br><span class="line">     <span class="hljs-keyword">int</span> m;</span><br><span class="line">     ForkJoinTask&lt;?&gt;[] q = queue;</span><br><span class="line">     <span class="hljs-keyword">if</span> (q != <span class="hljs-keyword">null</span> &amp;&amp; (m = q.length - <span class="hljs-number">1</span>) &gt;= <span class="hljs-number">0</span>) &#123;</span><br><span class="line">         <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> s; (s = queueTop) != queueBase;) &#123;</span><br><span class="line">             <span class="hljs-keyword">int</span> i = m &amp; --s;</span><br><span class="line">             <span class="hljs-keyword">long</span> u = (i &lt;&lt; ASHIFT) + ABASE; <span class="hljs-comment">// raw offset</span></span><br><span class="line">             ForkJoinTask&lt;?&gt; t = q[i];</span><br><span class="line">             <span class="hljs-keyword">if</span> (t == <span class="hljs-keyword">null</span>)   <span class="hljs-comment">// lost to stealer</span></span><br><span class="line">                 <span class="hljs-keyword">break</span>;</span><br><span class="line">             <span class="hljs-keyword">if</span> (UNSAFE.compareAndSwapObject(q, u, t, <span class="hljs-keyword">null</span>)) &#123;</span><br><span class="line">                 queueTop = s; <span class="hljs-comment">// or putOrderedInt</span></span><br><span class="line">                 <span class="hljs-keyword">return</span> t;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>如果<code>Pool</code>不是异步模式(<code>locallyFifo</code>为false)，那么会执行<code>popTask()</code>。从当前任务队列pop一个任务出来。</p>
<h3 id="ForkJoinWorkerThread-locallyDeqTask"><a href="#ForkJoinWorkerThread-locallyDeqTask" class="headerlink" title="ForkJoinWorkerThread#locallyDeqTask()"></a>ForkJoinWorkerThread#locallyDeqTask()</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * Tries to take a task from the base of own queue.  Called only</span></span><br><span class="line"><span class="hljs-comment"> * by this thread.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> a task, or null if none</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">final</span> ForkJoinTask&lt;?&gt; locallyDeqTask() &#123;</span><br><span class="line">    ForkJoinTask&lt;?&gt; t; <span class="hljs-keyword">int</span> m, b, i;</span><br><span class="line">    ForkJoinTask&lt;?&gt;[] q = queue;</span><br><span class="line">    <span class="hljs-keyword">if</span> (q != <span class="hljs-keyword">null</span> &amp;&amp; (m = q.length - <span class="hljs-number">1</span>) &gt;= <span class="hljs-number">0</span>) &#123;</span><br><span class="line">        <span class="hljs-keyword">while</span> (queueTop != (b = queueBase)) &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> ((t = q[i = m &amp; b]) != <span class="hljs-keyword">null</span> &amp;&amp;</span><br><span class="line">                queueBase == b &amp;&amp;</span><br><span class="line">                UNSAFE.compareAndSwapObject(q, (i &lt;&lt; ASHIFT) + ABASE,</span><br><span class="line">                                            t, <span class="hljs-keyword">null</span>)) &#123;</span><br><span class="line">                queueBase = b + <span class="hljs-number">1</span>;</span><br><span class="line">                <span class="hljs-keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果<code>Pool</code>是异步模式(<code>locallyFifo</code>为<code>true</code>)，那么会执行<code>locallyDeqTask()</code>。就是从当前任务队列<code>deg</code>一个任务出来。</p>
<h1 id="5-总结"><a href="#5-总结" class="headerlink" title="5 总结"></a>5 总结</h1><ol>
<li>被创建，注册到<code>Pool</code>中，然后启动。</li>
<li>扫描所有工作线程的队列和<code>Pool</code>中的任务队列，窃取一个任务来执行。</li>
<li>执行完毕后，在从自身工作队列中获取任务来执行。</li>
<li>没任务执行了，会阻塞等待，如果正好赶上了<code>Pool</code>休眠，那么会被结束掉，从<code>Pool</code>中注销。 </li>
</ol>

        </div>
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link" href="/tags/JDK7-源码/">JDK7 源码</a>, <a class="has-link-grey -link" href="/tags/Java/">Java</a>, <a class="has-link-grey -link" href="/tags/设计模式/">设计模式</a>
                </div>
            </div>
        </div>
        
        
        
        <div class="social-share"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css">
<script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3>
        <div class="buttons is-centered">
            
                
<a class="button is-info donate">
    <span class="icon is-small">
        <i class="fab fa-alipay"></i>
    </span>
    <span>支付宝</span>
    <div class="qrcode"><img src="/images/alipaycode.jpg" alt="支付宝"></div>
</a>

                
                
<a class="button is-success donate">
    <span class="icon is-small">
        <i class="fab fa-weixin"></i>
    </span>
    <span>微信</span>
    <div class="qrcode"><img src="/images/wxcode.png" alt="微信"></div>
</a>

                
        </div>
    </div>
</div>



<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/Fork-Join-Other/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">Fork-Join其他方法</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/JDK1.8-Proxy/">
                <span class="level-item">JDK1.8 Proxy</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="title is-5 has-text-weight-normal">评论</h3>
        
<div id="comment-container"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.4.1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.4.1/dist/gitalk.min.js"></script>
<script>
    var gitalk = new Gitalk({
        clientID: 'a70be08270bc7c083f83',
        clientSecret: '1b08252e3cf4b0c29b5f52f431ad9a54eef0a74a',
        id: 'a1945d6f025f5df168bab2fe6f565bbb',
        repo: 'joeskye1701.github.io',
        owner: 'joeskye1701',
        admin: "joeskye1701"
    })
    gitalk.render('comment-container')
</script>

    </div>
</div>
</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered">
                <div>
                    
                        <img class="image is-128x128 has-mb-6" src="/images/thank-you-kobe.jpg" alt="Joe">
                    
                    
                    <p class="is-size-4 is-block">
                        Joe
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        Developer &amp; Designer
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>Shenzhen, China</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <p class="title has-text-weight-normal">
                        129
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <p class="title has-text-weight-normal">
                        26
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <p class="title has-text-weight-normal">
                        54
                    </p>
                </div>
            </div>
        </nav>
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/joeskye1701">
                关注我</a>
        </div>
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank" title="Github" href="https://github.com/joeskye1701">
                
                <i class="fab fa-github"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        

<div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            链接
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="http://wss.xxyseo.cn/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">西乡大佬</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">wss.xxyseo.cn</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>


    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分类
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Android/">
            <span class="level-start">
                <span class="level-item">Android</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/JDK6-源码/">
            <span class="level-start">
                <span class="level-item">JDK6 源码</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">18</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/JDK7-源码/">
            <span class="level-start">
                <span class="level-item">JDK7 源码</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">6</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/JDK8-源码/">
            <span class="level-start">
                <span class="level-item">JDK8 源码</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/JMM/">
            <span class="level-start">
                <span class="level-item">JMM</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">6</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/JVM/">
            <span class="level-start">
                <span class="level-item">JVM</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">10</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Java/">
            <span class="level-start">
                <span class="level-item">Java</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">20</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Linux/">
            <span class="level-start">
                <span class="level-item">Linux</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/MyBatis/">
            <span class="level-start">
                <span class="level-item">MyBatis</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/MySQL/">
            <span class="level-start">
                <span class="level-item">MySQL</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Redis/">
            <span class="level-start">
                <span class="level-item">Redis</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Spring/">
            <span class="level-start">
                <span class="level-item">Spring</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Tomcat/">
            <span class="level-start">
                <span class="level-item">Tomcat</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">7</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/书/">
            <span class="level-start">
                <span class="level-item">书</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/多线程/">
            <span class="level-start">
                <span class="level-item">多线程</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/并发/">
            <span class="level-start">
                <span class="level-item">并发</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/开源项目/">
            <span class="level-start">
                <span class="level-item">开源项目</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/数学/">
            <span class="level-start">
                <span class="level-item">数学</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/数据库/">
            <span class="level-start">
                <span class="level-item">数据库</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/数据结构/">
            <span class="level-start">
                <span class="level-item">数据结构</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">5</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/日语/">
            <span class="level-start">
                <span class="level-item">日语</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/机器学习/">
            <span class="level-start">
                <span class="level-item">机器学习</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/算法/">
            <span class="level-start">
                <span class="level-item">算法</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">23</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/计算机基础/">
            <span class="level-start">
                <span class="level-item">计算机基础</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/设计模式/">
            <span class="level-start">
                <span class="level-item">设计模式</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/面试/">
            <span class="level-start">
                <span class="level-item">面试</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/Android/" style="font-size: 10px;">Android</a> <a href="/tags/Centos/" style="font-size: 11.82px;">Centos</a> <a href="/tags/Effect-Java/" style="font-size: 10.91px;">Effect Java</a> <a href="/tags/JDK6-源码/" style="font-size: 18.18px;">JDK6 源码</a> <a href="/tags/JDK7-源码/" style="font-size: 14.55px;">JDK7 源码</a> <a href="/tags/JDK8-源码/" style="font-size: 10px;">JDK8 源码</a> <a href="/tags/JMM/" style="font-size: 15.45px;">JMM</a> <a href="/tags/JVM/" style="font-size: 16.36px;">JVM</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/Linux/" style="font-size: 12.73px;">Linux</a> <a href="/tags/MongoDB/" style="font-size: 10px;">MongoDB</a> <a href="/tags/Mongodb/" style="font-size: 10px;">Mongodb</a> <a href="/tags/MyBatis/" style="font-size: 11.82px;">MyBatis</a> <a href="/tags/MySQL/" style="font-size: 10.91px;">MySQL</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/Spring/" style="font-size: 12.73px;">Spring</a> <a href="/tags/Think-In-Java/" style="font-size: 10px;">Think In Java</a> <a href="/tags/Tomcat/" style="font-size: 15.45px;">Tomcat</a> <a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a> <a href="/tags/一致性哈希算法/" style="font-size: 10px;">一致性哈希算法</a> <a href="/tags/书/" style="font-size: 11.82px;">书</a> <a href="/tags/倒排索引/" style="font-size: 10px;">倒排索引</a> <a href="/tags/内存泄漏/" style="font-size: 10px;">内存泄漏</a> <a href="/tags/分支限界算法/" style="font-size: 10.91px;">分支限界算法</a> <a href="/tags/分治法/" style="font-size: 10px;">分治法</a> <a href="/tags/分治算法/" style="font-size: 10px;">分治算法</a> <a href="/tags/分词算法/" style="font-size: 10.91px;">分词算法</a> <a href="/tags/动态规划/" style="font-size: 10px;">动态规划</a> <a href="/tags/动态规划算法/" style="font-size: 10.91px;">动态规划算法</a> <a href="/tags/华为/" style="font-size: 10px;">华为</a> <a href="/tags/回溯算法/" style="font-size: 12.73px;">回溯算法</a> <a href="/tags/多线程/" style="font-size: 10.91px;">多线程</a> <a href="/tags/工具/" style="font-size: 10px;">工具</a> <a href="/tags/并发/" style="font-size: 13.64px;">并发</a> <a href="/tags/开源项目/" style="font-size: 17.27px;">开源项目</a> <a href="/tags/手机游戏/" style="font-size: 10px;">手机游戏</a> <a href="/tags/排序算法/" style="font-size: 10px;">排序算法</a> <a href="/tags/推荐/" style="font-size: 10px;">推荐</a> <a href="/tags/散列表/" style="font-size: 10px;">散列表</a> <a href="/tags/数学/" style="font-size: 10px;">数学</a> <a href="/tags/数据库/" style="font-size: 10.91px;">数据库</a> <a href="/tags/数据结构/" style="font-size: 13.64px;">数据结构</a> <a href="/tags/日语/" style="font-size: 10px;">日语</a> <a href="/tags/最优路径算法/" style="font-size: 10px;">最优路径算法</a> <a href="/tags/机器学习/" style="font-size: 10px;">机器学习</a> <a href="/tags/源码/" style="font-size: 11.82px;">源码</a> <a href="/tags/算法/" style="font-size: 19.09px;">算法</a> <a href="/tags/线程安全/" style="font-size: 10.91px;">线程安全</a> <a href="/tags/编程珠玑/" style="font-size: 11.82px;">编程珠玑</a> <a href="/tags/计算机基础/" style="font-size: 10px;">计算机基础</a> <a href="/tags/设计模式/" style="font-size: 12.73px;">设计模式</a> <a href="/tags/贪心算法/" style="font-size: 11.82px;">贪心算法</a> <a href="/tags/跳表/" style="font-size: 10px;">跳表</a> <a href="/tags/面试/" style="font-size: 10px;">面试</a>
    </div>
</div>

    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
            
        
            
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            <!-- 
            <a href="/VIM-Command/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="VIM 命令">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-12-10T02:31:22.000Z">2018-12-10</time></div>
                    <a href="/VIM-Command/" class="has-link-black-ter is-size-6">VIM 命令</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/Lock-Control/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="锁粒度的控制">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-04T04:37:22.000Z">2018-11-04</time></div>
                    <a href="/Lock-Control/" class="has-link-black-ter is-size-6">锁粒度的控制</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/Temporary-Menory-Table/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="临时表和内存表">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-04T04:37:22.000Z">2018-11-04</time></div>
                    <a href="/Temporary-Menory-Table/" class="has-link-black-ter is-size-6">临时表和内存表</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/MySQL/">MySQL</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/MySQL-Command/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="MySQL基本命令">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-03T04:37:22.000Z">2018-11-03</time></div>
                    <a href="/MySQL-Command/" class="has-link-black-ter is-size-6">MySQL基本命令</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/MySQL/">MySQL</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/Python2ToPython3/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Python2切换Python3">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-03T04:37:22.000Z">2018-11-03</time></div>
                    <a href="/Python2ToPython3/" class="has-link-black-ter is-size-6">Python2切换Python3</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2018/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/01/">
                <span class="level-start">
                    <span class="level-item">一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/01/">
                <span class="level-start">
                    <span class="level-item">一月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/10/">
                <span class="level-start">
                    <span class="level-item">十月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">9</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/09/">
                <span class="level-start">
                    <span class="level-item">九月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/08/">
                <span class="level-start">
                    <span class="level-item">八月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/07/">
                <span class="level-start">
                    <span class="level-item">七月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/06/">
                <span class="level-start">
                    <span class="level-item">六月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/05/">
                <span class="level-start">
                    <span class="level-item">五月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/04/">
                <span class="level-start">
                    <span class="level-item">四月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/03/">
                <span class="level-start">
                    <span class="level-item">三月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/02/">
                <span class="level-start">
                    <span class="level-item">二月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/10/">
                <span class="level-start">
                    <span class="level-item">十月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">13</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/09/">
                <span class="level-start">
                    <span class="level-item">九月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/08/">
                <span class="level-start">
                    <span class="level-item">八月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/07/">
                <span class="level-start">
                    <span class="level-item">七月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/06/">
                <span class="level-start">
                    <span class="level-item">六月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/05/">
                <span class="level-start">
                    <span class="level-item">五月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/04/">
                <span class="level-start">
                    <span class="level-item">四月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/03/">
                <span class="level-start">
                    <span class="level-item">三月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/02/">
                <span class="level-start">
                    <span class="level-item">二月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/01/">
                <span class="level-start">
                    <span class="level-item">一月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/09/">
                <span class="level-start">
                    <span class="level-item">九月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/03/">
                <span class="level-start">
                    <span class="level-item">三月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/10/">
                <span class="level-start">
                    <span class="level-item">十月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/08/">
                <span class="level-start">
                    <span class="level-item">八月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/07/">
                <span class="level-start">
                    <span class="level-item">七月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/06/">
                <span class="level-start">
                    <span class="level-item">六月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/04/">
                <span class="level-start">
                    <span class="level-item">四月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/03/">
                <span class="level-start">
                    <span class="level-item">三月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/02/">
                <span class="level-start">
                    <span class="level-item">二月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/01/">
                <span class="level-start">
                    <span class="level-item">一月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Android/">
                        <span class="tag">Android</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Centos/">
                        <span class="tag">Centos</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Effect-Java/">
                        <span class="tag">Effect Java</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JDK6-源码/">
                        <span class="tag">JDK6 源码</span>
                        <span class="tag is-grey">18</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JDK7-源码/">
                        <span class="tag">JDK7 源码</span>
                        <span class="tag is-grey">6</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JDK8-源码/">
                        <span class="tag">JDK8 源码</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JMM/">
                        <span class="tag">JMM</span>
                        <span class="tag is-grey">7</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JVM/">
                        <span class="tag">JVM</span>
                        <span class="tag is-grey">10</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Java/">
                        <span class="tag">Java</span>
                        <span class="tag is-grey">40</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Linux/">
                        <span class="tag">Linux</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MongoDB/">
                        <span class="tag">MongoDB</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Mongodb/">
                        <span class="tag">Mongodb</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MyBatis/">
                        <span class="tag">MyBatis</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MySQL/">
                        <span class="tag">MySQL</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Redis/">
                        <span class="tag">Redis</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Spring/">
                        <span class="tag">Spring</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Think-In-Java/">
                        <span class="tag">Think In Java</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Tomcat/">
                        <span class="tag">Tomcat</span>
                        <span class="tag is-grey">7</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Ubuntu/">
                        <span class="tag">Ubuntu</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/一致性哈希算法/">
                        <span class="tag">一致性哈希算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/书/">
                        <span class="tag">书</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/倒排索引/">
                        <span class="tag">倒排索引</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/内存泄漏/">
                        <span class="tag">内存泄漏</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分支限界算法/">
                        <span class="tag">分支限界算法</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分治法/">
                        <span class="tag">分治法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分治算法/">
                        <span class="tag">分治算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分词算法/">
                        <span class="tag">分词算法</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/动态规划/">
                        <span class="tag">动态规划</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/动态规划算法/">
                        <span class="tag">动态规划算法</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/华为/">
                        <span class="tag">华为</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/回溯算法/">
                        <span class="tag">回溯算法</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/多线程/">
                        <span class="tag">多线程</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/工具/">
                        <span class="tag">工具</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/并发/">
                        <span class="tag">并发</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/开源项目/">
                        <span class="tag">开源项目</span>
                        <span class="tag is-grey">17</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/手机游戏/">
                        <span class="tag">手机游戏</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/排序算法/">
                        <span class="tag">排序算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/推荐/">
                        <span class="tag">推荐</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/散列表/">
                        <span class="tag">散列表</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数学/">
                        <span class="tag">数学</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数据库/">
                        <span class="tag">数据库</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数据结构/">
                        <span class="tag">数据结构</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/日语/">
                        <span class="tag">日语</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/最优路径算法/">
                        <span class="tag">最优路径算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/机器学习/">
                        <span class="tag">机器学习</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/源码/">
                        <span class="tag">源码</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/算法/">
                        <span class="tag">算法</span>
                        <span class="tag is-grey">26</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/线程安全/">
                        <span class="tag">线程安全</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/编程珠玑/">
                        <span class="tag">编程珠玑</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/计算机基础/">
                        <span class="tag">计算机基础</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/设计模式/">
                        <span class="tag">设计模式</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/贪心算法/">
                        <span class="tag">贪心算法</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/跳表/">
                        <span class="tag">跳表</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/面试/">
                        <span class="tag">面试</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
        
        </div>
    
</div>

                




<div class="column is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only has-order-3 column-right ">
    
        
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            <!-- 
            <a href="/VIM-Command/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="VIM 命令">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-12-10T02:31:22.000Z">2018-12-10</time></div>
                    <a href="/VIM-Command/" class="has-link-black-ter is-size-6">VIM 命令</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/Lock-Control/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="锁粒度的控制">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-04T04:37:22.000Z">2018-11-04</time></div>
                    <a href="/Lock-Control/" class="has-link-black-ter is-size-6">锁粒度的控制</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/Temporary-Menory-Table/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="临时表和内存表">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-04T04:37:22.000Z">2018-11-04</time></div>
                    <a href="/Temporary-Menory-Table/" class="has-link-black-ter is-size-6">临时表和内存表</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/MySQL/">MySQL</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/MySQL-Command/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="MySQL基本命令">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-03T04:37:22.000Z">2018-11-03</time></div>
                    <a href="/MySQL-Command/" class="has-link-black-ter is-size-6">MySQL基本命令</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/MySQL/">MySQL</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            <!-- 
            <a href="/Python2ToPython3/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Python2切换Python3">
                </p>
            </a>
             -->
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2018-11-03T04:37:22.000Z">2018-11-03</time></div>
                    <a href="/Python2ToPython3/" class="has-link-black-ter is-size-6">Python2切换Python3</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2018/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/01/">
                <span class="level-start">
                    <span class="level-item">一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/01/">
                <span class="level-start">
                    <span class="level-item">一月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/10/">
                <span class="level-start">
                    <span class="level-item">十月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">9</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/09/">
                <span class="level-start">
                    <span class="level-item">九月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/08/">
                <span class="level-start">
                    <span class="level-item">八月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/07/">
                <span class="level-start">
                    <span class="level-item">七月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/06/">
                <span class="level-start">
                    <span class="level-item">六月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/05/">
                <span class="level-start">
                    <span class="level-item">五月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/04/">
                <span class="level-start">
                    <span class="level-item">四月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/03/">
                <span class="level-start">
                    <span class="level-item">三月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/02/">
                <span class="level-start">
                    <span class="level-item">二月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/10/">
                <span class="level-start">
                    <span class="level-item">十月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">13</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/09/">
                <span class="level-start">
                    <span class="level-item">九月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/08/">
                <span class="level-start">
                    <span class="level-item">八月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/07/">
                <span class="level-start">
                    <span class="level-item">七月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/06/">
                <span class="level-start">
                    <span class="level-item">六月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/05/">
                <span class="level-start">
                    <span class="level-item">五月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/04/">
                <span class="level-start">
                    <span class="level-item">四月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/03/">
                <span class="level-start">
                    <span class="level-item">三月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/02/">
                <span class="level-start">
                    <span class="level-item">二月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2015/01/">
                <span class="level-start">
                    <span class="level-item">一月 2015</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/09/">
                <span class="level-start">
                    <span class="level-item">九月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2014/03/">
                <span class="level-start">
                    <span class="level-item">三月 2014</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/10/">
                <span class="level-start">
                    <span class="level-item">十月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/08/">
                <span class="level-start">
                    <span class="level-item">八月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/07/">
                <span class="level-start">
                    <span class="level-item">七月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/06/">
                <span class="level-start">
                    <span class="level-item">六月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/04/">
                <span class="level-start">
                    <span class="level-item">四月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/03/">
                <span class="level-start">
                    <span class="level-item">三月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/02/">
                <span class="level-start">
                    <span class="level-item">二月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2013/01/">
                <span class="level-start">
                    <span class="level-item">一月 2013</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Android/">
                        <span class="tag">Android</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Centos/">
                        <span class="tag">Centos</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Effect-Java/">
                        <span class="tag">Effect Java</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JDK6-源码/">
                        <span class="tag">JDK6 源码</span>
                        <span class="tag is-grey">18</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JDK7-源码/">
                        <span class="tag">JDK7 源码</span>
                        <span class="tag is-grey">6</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JDK8-源码/">
                        <span class="tag">JDK8 源码</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JMM/">
                        <span class="tag">JMM</span>
                        <span class="tag is-grey">7</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JVM/">
                        <span class="tag">JVM</span>
                        <span class="tag is-grey">10</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Java/">
                        <span class="tag">Java</span>
                        <span class="tag is-grey">40</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Linux/">
                        <span class="tag">Linux</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MongoDB/">
                        <span class="tag">MongoDB</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Mongodb/">
                        <span class="tag">Mongodb</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MyBatis/">
                        <span class="tag">MyBatis</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MySQL/">
                        <span class="tag">MySQL</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Redis/">
                        <span class="tag">Redis</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Spring/">
                        <span class="tag">Spring</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Think-In-Java/">
                        <span class="tag">Think In Java</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Tomcat/">
                        <span class="tag">Tomcat</span>
                        <span class="tag is-grey">7</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Ubuntu/">
                        <span class="tag">Ubuntu</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/一致性哈希算法/">
                        <span class="tag">一致性哈希算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/书/">
                        <span class="tag">书</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/倒排索引/">
                        <span class="tag">倒排索引</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/内存泄漏/">
                        <span class="tag">内存泄漏</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分支限界算法/">
                        <span class="tag">分支限界算法</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分治法/">
                        <span class="tag">分治法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分治算法/">
                        <span class="tag">分治算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分词算法/">
                        <span class="tag">分词算法</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/动态规划/">
                        <span class="tag">动态规划</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/动态规划算法/">
                        <span class="tag">动态规划算法</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/华为/">
                        <span class="tag">华为</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/回溯算法/">
                        <span class="tag">回溯算法</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/多线程/">
                        <span class="tag">多线程</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/工具/">
                        <span class="tag">工具</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/并发/">
                        <span class="tag">并发</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/开源项目/">
                        <span class="tag">开源项目</span>
                        <span class="tag is-grey">17</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/手机游戏/">
                        <span class="tag">手机游戏</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/排序算法/">
                        <span class="tag">排序算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/推荐/">
                        <span class="tag">推荐</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/散列表/">
                        <span class="tag">散列表</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数学/">
                        <span class="tag">数学</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数据库/">
                        <span class="tag">数据库</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数据结构/">
                        <span class="tag">数据结构</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/日语/">
                        <span class="tag">日语</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/最优路径算法/">
                        <span class="tag">最优路径算法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/机器学习/">
                        <span class="tag">机器学习</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/源码/">
                        <span class="tag">源码</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/算法/">
                        <span class="tag">算法</span>
                        <span class="tag is-grey">26</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/线程安全/">
                        <span class="tag">线程安全</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/编程珠玑/">
                        <span class="tag">编程珠玑</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/计算机基础/">
                        <span class="tag">计算机基础</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/设计模式/">
                        <span class="tag">设计模式</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/贪心算法/">
                        <span class="tag">贪心算法</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/跳表/">
                        <span class="tag">跳表</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/面试/">
                        <span class="tag">面试</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
    
    
</div>

            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    Joe|博客
                
                </a>
                <p class="is-size-7">
                &copy; 2019 Joe&nbsp;
                <!-- Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        href="http://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a> -->
                
                </p>
            </div>
            <div class="level-end">
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么...">
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>